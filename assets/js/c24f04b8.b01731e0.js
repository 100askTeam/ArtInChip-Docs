"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5722],{4230:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>l,contentTitle:()=>c,default:()=>a,frontMatter:()=>d,metadata:()=>t,toc:()=>h});var i=s(5893),r=s(1151);const d={sidebar_position:10},c="SPI NOR \u4f7f\u7528\u6307\u5357",t={id:"D213-DevKit/part3/05-3_SPI_NORUserGuide",title:"SPI NOR \u4f7f\u7528\u6307\u5357",description:"1. \u914d\u7f6e\u6307\u5357",source:"@site/docs/D213-DevKit/part3/05-3_SPI_NORUserGuide.md",sourceDirName:"D213-DevKit/part3",slug:"/D213-DevKit/part3/05-3_SPI_NORUserGuide",permalink:"/docs/D213-DevKit/part3/05-3_SPI_NORUserGuide",draft:!1,unlisted:!1,editUrl:"https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part3/05-3_SPI_NORUserGuide.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"d213dkSidebar",previous:{title:"SPI NAND \u4f7f\u7528\u6307\u5357",permalink:"/docs/D213-DevKit/part3/05-2_SPI_NANDUserGuide"},next:{title:"\u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528\u6307\u5357",permalink:"/docs/D213-DevKit/part3/05-4_FileSystemUserGuide"}},l={},h=[{value:"1. \u914d\u7f6e\u6307\u5357",id:"1-\u914d\u7f6e\u6307\u5357",level:2},{value:"1.1. \u9a71\u52a8\u5c42\u6b21\u5173\u7cfb",id:"11-\u9a71\u52a8\u5c42\u6b21\u5173\u7cfb",level:3},{value:"1.2. \u4fee\u6539 DTS",id:"12-\u4fee\u6539-dts",level:3},{value:"1.3. Bus Width",id:"13-bus-width",level:3},{value:"2. U-Boot \u79fb\u690d",id:"2-u-boot-\u79fb\u690d",level:2},{value:"2.1. Kconfig",id:"21-kconfig",level:3},{value:"2.2. spi-nor-ids",id:"22-spi-nor-ids",level:3},{value:"2.3. flash_info",id:"23-flash_info",level:3},{value:"2.3.1. JEDEC ID",id:"231-jedec-id",level:4},{value:"2.3.2. sector_size",id:"232-sector_size",level:4},{value:"2.3.3. n_sectors",id:"233-n_sectors",level:4},{value:"2.3.4. flags",id:"234-flags",level:4},{value:"2.4. \u603b\u7ed3",id:"24-\u603b\u7ed3",level:3},{value:"3. Linux \u79fb\u690d",id:"3-linux-\u79fb\u690d",level:2},{value:"3.1. \u6587\u4ef6\u51c6\u5907",id:"31-\u6587\u4ef6\u51c6\u5907",level:3},{value:"3.2. \u9a71\u52a8\u7d22\u5f15",id:"32-\u9a71\u52a8\u7d22\u5f15",level:3},{value:"3.3. spi_nor_manufacturer",id:"33-spi_nor_manufacturer",level:3},{value:"3.4. flash_info",id:"34-flash_info",level:3},{value:"3.5. id_table",id:"35-id_table",level:3},{value:"3.6. \u603b\u7ed3",id:"36-\u603b\u7ed3",level:3}];function o(n){const e={a:"a",code:"code",del:"del",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h1,{id:"spi-nor-\u4f7f\u7528\u6307\u5357",children:"SPI NOR \u4f7f\u7528\u6307\u5357"}),"\n",(0,i.jsx)(e.h2,{id:"1-\u914d\u7f6e\u6307\u5357",children:"1. \u914d\u7f6e\u6307\u5357"}),"\n",(0,i.jsx)(e.h3,{id:"11-\u9a71\u52a8\u5c42\u6b21\u5173\u7cfb",children:"1.1. \u9a71\u52a8\u5c42\u6b21\u5173\u7cfb"}),"\n",(0,i.jsxs)(e.p,{children:["SPI NOR \u5c5e\u4e8e SPI \u7684\u4ece\u8bbe\u5907\uff0c\u5728\u5185\u6838\u4e2d\u76f8\u5173\u9a71\u52a8\u901a\u8fc7 ",(0,i.jsx)(e.code,{children:"SPI MEM"})," \u5bf9\u63a5\u5230 SPI\u5b50\u7cfb\u7edf\u3002 \u5728 SPI \u63a7\u5236\u5668\u521d\u59cb\u5316\u65f6\uff0cSPI \u9a71\u52a8\u4f1a\u68c0\u67e5\u8be5\u63a7\u5236\u5668\u4e0b\u662f\u5426\u6709\u6302\u8f7d\u7684 SPI NOR\uff0c\u6709\u5219\u6dfb\u52a0\u5230 SPI BUS \u4e2d\u3002"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"aic_spi_probe(dev);\n|-> spi_register_controller(ctlr);/spi_register_master(ctlr);// spi_register_master \u662f\u4e00\u4e2a\u5b8f\n    |-> of_register_spi_devices(ctlr);\n        |-> spi = of_register_spi_device(ctlr, nc);\n            |-> spi = spi_alloc_device(ctlr);\n            |-> of_spi_parse_dt(ctlr, spi, nc);\n            |-> rc = spi_add_device(spi);\n                // \u5c06 SPI device \u6dfb\u52a0\u5230 SPI \u603b\u7ebf spi_bus_type \u4e2d\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\u5728\u8c03\u7528 ",(0,i.jsx)(e.code,{children:"spi_add_device"})," \u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u67e5\u627e\u548c\u5339\u914d\u5bf9\u5e94\u8bbe\u5907\u7684\u9a71\u52a8\u7a0b\u5e8f\uff08\u5982\u679c\u8fd9\u65f6\u5019\u5bf9 \u5e94\u7684\u9a71\u52a8\u7a0b\u5e8f\u8fd8\u6ca1\u6709\u88ab\u6dfb\u52a0\u5230\u7cfb\u7edf\u4e2d\uff0c\u5219\u5728\u8fd9\u91cc\u5148\u5c06\u8bbe\u5907\u6dfb\u52a0\u5230 Bus\uff0c\u7b49\u5230\u5bf9\u5e94\u9a71\u52a8\u7a0b\u5e8f \u88ab\u6dfb\u52a0\u8fdb\u6765\u65f6\uff0c\u518d\u8fdb\u884c\u5339\u914d\u3002\uff09"]}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u6a21\u5757"}),(0,i.jsx)(e.th,{children:"\u9a71\u52a8\u6e90\u7801\u8def\u5f84"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Linux"}),(0,i.jsx)(e.td,{children:"source/linux-5.10/drivers/mtd/spi-nor/"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Uboot"}),(0,i.jsx)(e.td,{children:"source/uboot-2021.10/drivers/mtd/spi/"})]})]})]}),"\n",(0,i.jsx)(e.h3,{id:"12-\u4fee\u6539-dts",children:"1.2. \u4fee\u6539 DTS"}),"\n",(0,i.jsx)(e.p,{children:"\u8981\u5728\u5b9e\u9645\u9879\u76ee\u4e2d\u4f7f\u7528 SPI NOR \u8bbe\u5907\uff0c\u8fd8\u9700\u8981\u4fee\u6539 DTS \u914d\u7f6e\u3002"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"board.dts"})," \u5e94\u5728\u5177\u4f53\u7684 SPI \u63a7\u5236\u5668\u4e0b\u6dfb\u52a0 ",(0,i.jsx)(e.code,{children:"jedec,spi-nor"})," \u8bbe\u5907\u3002"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'&spi0 {\n    pinctrl-names = "default";\n    pinctrl-0 = <&spi0_pins_a>;\n    status = "okay";\n    spi-max-frequency = <100000000>;\n    spi-flash@0 {\n        #address-cells = <1>;\n        #size-cells = <1>;\n        compatible = "jedec,spi-nor";    //\u56fa\u5b9a\u503c\uff0c\u6240\u6709\u57fa\u4e8e dts \u7684 SPI NOR \u5747\u58f0\u660e\u6b64\n        spi-max-frequency = <100000000>; //\u6700\u5927\u9891\u7387\uff0c\u56fa\u5b9a\u503c\n        spi-tx-bus-width = <4>;\n        spi-rx-bus-width = <4>;\n        reg = <0>;                       //\u56fa\u5b9a\u503c\uff0c\u4e00\u822c\u4e0d\u9700\u4fee\u6539\n        status = "okay";\n    };\n};\n'})}),"\n",(0,i.jsxs)(e.p,{children:["\u540c\u65f6\u8fd8\u9700\u5728 ",(0,i.jsx)(e.code,{children:"board-u-boot.dtsi"})," \u6587\u4ef6\u4e2d\uff0c\u5c06\u8be5\u8bbe\u5907\u6807\u8bb0\u4e3a ",(0,i.jsx)(e.code,{children:"u-boot,dm-pre-reloc"})," \uff0c\u4e0d\u7136 SPL \u65e0\u6cd5\u8bc6\u522b\u548c\u4f7f\u7528\u3002"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"&spi0 {\n    u-boot,dm-pre-reloc;\n    spi-flash@0 {\n        u-boot,dm-pre-reloc;\n    };\n};\n"})}),"\n",(0,i.jsx)(e.h3,{id:"13-bus-width",children:"1.3. Bus Width"}),"\n",(0,i.jsx)(e.p,{children:"\u5bbd\u603b\u7ebf\u7684 SPI NOR \u82af\u7247\u53ef\u4ee5\u5de5\u4f5c\u5728\u7a84\u603b\u7ebf\u4e0b\uff0c\u59824\u7ebf\u7684 SPI NOR \u914d\u7f6e\u4e3a1\u7ebf\u4e5f\u53ef\u4ee5\u5de5\u4f5c\uff0c\u4f46\u8bfb\u5199\u901f\u5ea6\u635f\u5931\uff0c \u4f46\u7a84\u603b\u7ebf\u8bbe\u5907\u65e0\u6cd5\u5de5\u4f5c\u5728\u5bbd\u603b\u7ebf\u6a21\u5f0f\u4e0b\uff0c\u56e0\u6b64 spi-tx-bus-width \u8981\u6b63\u786e\u8bbe\u7f6e"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u6807\u51c6 SPI NOR \u914d\u7f6e\u4e3a1"}),"\n",(0,i.jsx)(e.li,{children:"Dual SPI NOR \u914d\u7f6e\u4e3a2"}),"\n",(0,i.jsx)(e.li,{children:"Quad SPI NOR \u914d\u7f6e\u4e3a4"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"2-u-boot-\u79fb\u690d",children:"2. U-Boot \u79fb\u690d"}),"\n",(0,i.jsxs)(e.p,{children:["SPI NOR \u8981\u5de5\u4f5c\u65e2\u9700\u8981 SOC \u7aef SPI \u6a21\u5757\u7684\u9a71\u52a8\u80fd\u529b\uff0c\u4e5f\u9700\u8981\u5bf9 SPI NOR \u6a21\u5757\u7684\u6b63\u786e\u914d\u7f6e\uff0c\u672c\u7ae0\u9610\u8ff0\u5982\u4f55\u8fdb\u884c SPI NOR \u5668\u4ef6\u7684\u79fb\u690d\u5de5\u4f5c\uff0c\u4ee5 ",(0,i.jsx)(e.code,{children:"CFX"})," \u7684 ",(0,i.jsx)(e.code,{children:"GM25Q128A"})," \u548c ",(0,i.jsx)(e.code,{children:"FudanMicro"})," \u7684 ",(0,i.jsx)(e.code,{children:"FM25Q128"})," \u4e3a\u4f8b"]}),"\n",(0,i.jsx)(e.p,{children:"U-Boot \u4e2d \u5bf9\u4e0d\u540c\u5382\u5bb6\u7684 SPI NOR \u5668\u4ef6\u7684\u7ba1\u7406\u96c6\u6210\u5ea6\u5f88\u9ad8\uff0c \u4e3b\u8981\u4ee3\u7801\u5728 source/uboot-2021.10/drivers/mtd/spi/spi-nor-ids.c \u4e2d\uff0c\u6dfb\u52a0\u4e00\u6b3e\u65b0\u5382\u5bb6\u7684\u65b0\u5668\u4ef6\u9700\u8981\u7ecf\u8fc7\u5982\u4e0b\u6b65\u9aa4"}),"\n",(0,i.jsx)(e.h3,{id:"21-kconfig",children:"2.1. Kconfig"}),"\n",(0,i.jsx)(e.p,{children:"\u6dfb\u52a0\u5382\u5bb6\u7684\u5b8f\u5b9a\u4e49"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'config SPI_FLASH_FMSH\n    bool "FudanMicro SPI flash support"\n    help\n      Add support for various FMSH (Shanghai Fudan Microelectronics Group Company)\n      SPI flash chips (FM25xxx).\n\nconfig SPI_FLASH_CFX\n    bool "CFX SPI flash support"\n    help\n      Add support for various CFX (Zhuhai ChuangFeiXin-Technology)\n      SPI flash chips (GM25xxx).\n'})}),"\n",(0,i.jsx)(e.h3,{id:"22-spi-nor-ids",children:"2.2. spi-nor-ids"}),"\n",(0,i.jsx)(e.p,{children:"\u5728 spi-nor-ids.c \u7684 spi_nor_ids \u7ed3\u6784\u4e2d\u6dfb\u52a0 FMHS \u548c CFX \u7684\u76f8\u5173\u5668\u4ef6\u7684\u652f\u6301"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'#ifdef CONFIG_SPI_FLASH_FMSH\n    /* Shanghai Fudan Microelectronics Group Company */\n    { INFO("FM25Q128", 0xa14017, 0, 64 * 1024, 256, SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ) },\n    { INFO("FM25Q64", 0xa14018, 0, 64 * 1024, 128, SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ) },\n#endif\n#ifdef CONFIG_SPI_FLASH_CFX\n    /* Zhuhai ChuangFeiXin Technology */\n    { INFO("GM25Q128A", 0x1c4018, 0, 64 * 1024, 256, SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ) },\n#endif\n'})}),"\n",(0,i.jsx)(e.h3,{id:"23-flash_info",children:"2.3. flash_info"}),"\n",(0,i.jsx)(e.p,{children:"flash_info \u6570\u636e\u7ed3\u6784\u4e3b\u8981\u7528\u6765\u63cf\u8ff0\u67d0\u4e00\u9897 SPI NOR \u7684\u53c2\u6570\uff0c\u901a\u8fc7 INFO \u5b8f\u6765\u8bbe\u7f6e\uff0c\u5176\u8be6\u7ec6\u7ed3\u6784\u4e3a\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"struct flash_info {\n    char    *name;                  //\u5668\u4ef6\u540d\u79f0\uff0c\u4e00\u822c\u7528\u5668\u4ef6\u7f16\u53f7\u66ff\u4ee3\n    u8      id[SPI_NOR_MAX_ID_LEN]; //JEDEC \u6388\u6743\u7684\u5668\u4ef6ID\n    u8      id_len;                 //ID \u957f\u5ea6\uff0c\u586b0\uff0c\u81ea\u52a8\u8ba1\u7b97\n    unsigned    sector_size;        //sector size\uff0c\u73b0\u5728\u7684\u610f\u4e49\u5df2\u7ecf\u6539\u53d8\n    u16     n_sectors;              //sector \u6570\u76ee\uff0c\u901a\u8fc7 flash size \u548c sector size \u8ba1\u7b97\u51fa\u6765\n    u16     page_size;              //\u9875\u5927\u5c0f\uff0c INFO \u5b8f\u56fa\u5b9a\u4e3a256\n    u16     addr_width;             //board.dts \u4e2d\u914d\u7f6e\n    u32     flags;                  //\u529f\u80fd\u6807\u8bc6\n"})}),"\n",(0,i.jsx)(e.h4,{id:"231-jedec-id",children:"2.3.1. JEDEC ID"}),"\n",(0,i.jsx)(e.p,{children:"\u548c SPI NAND \u4e0d\u540c\uff0c SPI NOR \u7684 ID \u5305\u542b Manufacture ID \u548c Device ID \u7b49\u591a\u9879\u5185\u5bb9\uff0c\u4e00\u822c\u4e3a24\u4f4d\uff0c\u63cf\u8ff0\u65b9\u5f0f\u4e3a"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u9608\u503c"}),(0,i.jsx)(e.th,{children:"\u540d\u79f0"}),(0,i.jsx)(e.th,{children:"\u793a\u4f8b"}),(0,i.jsx)(e.th,{children:"\u6807\u8bb0\u65b9\u5f0f"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"MID7 - IDF0"}),(0,i.jsx)(e.td,{children:"Maunfacture ID"}),(0,i.jsx)(e.td,{children:"0xa1"}),(0,i.jsx)(e.td,{children:"JEDEC \u5206\u914d"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"D15 - D8"}),(0,i.jsx)(e.td,{children:"Memory Type"}),(0,i.jsx)(e.td,{children:"0x40"}),(0,i.jsx)(e.td,{children:"0x9F \u547d\u4ee4"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"D7 - D0"}),(0,i.jsx)(e.td,{children:"Memory Desity"}),(0,i.jsx)(e.td,{children:"0x17"}),(0,i.jsx)(e.td,{children:"0x9F \u547d\u4ee4"})]})]})]}),"\n",(0,i.jsx)(e.p,{children:"\u4e0d\u540c\u5382\u5bb6\u5728\u6570\u636e\u624b\u518c\u4e2d\u63cf\u8ff0\u65b9\u6cd5\u4e0d\u4e00\u6837\uff0c\u4f46\u73b0\u4ee3\u7684 SPI NOR \u7684 MID \u4e00\u822c\u901a\u8fc7 \u201cMaunfacture/MID\u201d \u7b49\u5b57\u6bb5\u6807\u6ce8\uff0cDevice ID\u7684\uff08D15 - D0\uff09 \u4e00\u822c\u901a\u8fc7 0x9F \u547d\u4ee4\u6807\u6ce8\uff0c \u56e0\u6b64\u5728\u6570\u636e\u624b\u518c\u4e2d\u901a\u8fc7\u641c\u7d22 9F \u4e00\u822c\u80fd\u6784\u9020\u51fa JEDEC ID\uff0c \u5982\u4e0b\u56fe\u6240\u793a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"0xC84018"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/id-1-170669560000835.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/id-1.png"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"0xC22018"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/id-2-170669560670437.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/id-2.png"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"0xA14017"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/id-3-170669561586339.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/id-3.png"})}),"\n",(0,i.jsx)(e.h4,{id:"232-sector_size",children:"2.3.2. sector_size"}),"\n",(0,i.jsx)(e.p,{children:"Sector Size \u662f\u4e2a\u5386\u53f2\u4ea7\u7269\uff0c\u4e0d\u7ba1\u662f\u6587\u4ef6\u7cfb\u7edf\u8fd8\u662f\u5382\u5bb6\u7684\u5668\u4ef6\u89c4\u683c\u90fd\u5f00\u59cb\u5bf9\u5916\u63d0\u4f9b\u57fa\u4e8e Block \u7684\u63a5\u53e3\uff0c\u4f46\u5728\u540d\u79f0\u4e0a\u8fd8\u4fdd\u7559\u4e86 Sector \u7684\u540d\u79f0\uff0c\u800c\u9a71\u52a8\u4e2d\u5219\u5df2\u7ecf\u5b8c\u5168\u5207\u6362\u5230 Block \u7684\u903b\u8f91"}),"\n",(0,i.jsx)(e.p,{children:"Sector Size \u4e3b\u8981\u5b9a\u4e49\u7684\u662f\u64e6\u9664\u53c2\u6570\uff0c\u4e00\u822c\u7684\u5668\u4ef6\u63d0\u4f9b\u4e09\u79cd\u64e6\u9664\u64cd\u4f5c"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u64cd\u4f5c\u65b9\u5f0f"}),(0,i.jsx)(e.th,{children:"\u547d\u4ee4"}),(0,i.jsx)(e.th,{children:"\u64e6\u9664\u5927\u5c0f"}),(0,i.jsx)(e.th,{children:"\u5907\u6ce8"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Sector Erase( SE)"}),(0,i.jsx)(e.td,{children:"0x20"}),(0,i.jsx)(e.td,{children:"4K"}),(0,i.jsx)(e.td,{children:"\u57fa\u7840\u80fd\u529b\uff0c\u4e3b\u8981\u505a\u517c\u5bb9\uff0c\u4e0d\u505a\u4e3b\u529b"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"32K Block Erase (BE)"}),(0,i.jsx)(e.td,{children:"0x52"}),(0,i.jsx)(e.td,{children:"32K"}),(0,i.jsx)(e.td,{children:"\u4e0d\u518d\u4f7f\u7528\uff0c\u548c BE-64 \u6210\u5bf9"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"64K Block Erase (BE)"}),(0,i.jsx)(e.td,{children:"0xD8"}),(0,i.jsx)(e.td,{children:"64K"}),(0,i.jsx)(e.td,{children:"\u5927\u90e8\u5206\u90fd\u652f\u6301\uff0c\u5982\u679c\u4e0d\u652f\u6301\u5219\u5fc5\u987b\u652f\u6301SE"})]})]})]}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u9a71\u52a8\u4e2d\uff0cSector_Size \u63cf\u8ff0\u7684\u5b9e\u9645\u662f BE-64 \u7684\u53c2\u6570\uff0c\u800c BE-64 \u8981\u6c42\u7684 size \u53c8\u662f\u56fa\u5b9a\u7684 64K\uff0c\u56e0\u6b64\u8be5\u53c2\u6570\u7684\u8bbe\u7f6e\u539f\u5219\u662f\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5728\u6570\u636e\u624b\u518c\u4e2d\uff0c\u5982\u679c\u652f\u6301 64K Block Erase (0xD8\uff09\u547d\u4ee4\uff0c\u5219\u8bbe\u7f6e\u4e3a \u201864 * 1024\u2019"}),"\n",(0,i.jsx)(e.li,{children:"\u5728\u6570\u636e\u624b\u518c\u4e2d, \u5982\u679c\u4e0d\u652f\u6301 64K Block Erase (0xD8\uff09\u547d\u4ee4\uff0c\u5219\u8bbe\u7f6e\u4e3a \u20184 * 1024\u2019"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/se-170669563988241.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/se.png"})}),"\n",(0,i.jsx)(e.h4,{id:"233-n_sectors",children:"2.3.3. n_sectors"}),"\n",(0,i.jsx)(e.p,{children:"Sector (Block) \u6570\u76ee\u901a\u8fc7\u8ba1\u7b97\u5f97\u5230\uff0c \u8ba1\u7b97\u516c\u5f0f\u4e3a (\uff08flash size\uff09/ sector size)\uff0c\u9700\u8981\u6ce8\u610f\u4e0d\u540c\u53c2\u6570\u4f7f\u7528 Byte\uff08B\uff09 \u8fd8\u662f bit\uff08b\uff09 \u63cf\u8ff0"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"gd25q128\uff1a 128Mb / 64KB = 256"}),"\n",(0,i.jsx)(e.li,{children:"FM25Q128: 128Mb / 64KB = 256"}),"\n",(0,i.jsx)(e.li,{children:"FM25Q64: 64Mb / 64KB = 128"}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"234-flags",children:"2.3.4. flags"}),"\n",(0,i.jsx)(e.p,{children:"flags\u7528\u6765\u8bbe\u7f6e\u989d\u5916\u7684\u529f\u80fd\u6807\u5fd7"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"SECT_4K \u5efa\u8bae\u5747\u8bbe\u7f6e\uff0c\u6b64\u529f\u80fd\u7528\u6765\u517c\u5bb9 Sector Erase( SE) \u7684\u652f\u6301\uff0c\u5728\u4e00\u4e9b\u7279\u6b8a\u60c5\u51b5\u4e0b\u53ef\u4ee5\u7ee7\u7eed\u5de5\u4f5c"}),"\n",(0,i.jsx)(e.li,{children:"\u5982\u679c\u652f\u6301 0xBB \u547d\u4ee4\uff0c\u5219\u6253\u5f00 SPI_NOR_DUAL_READ"}),"\n",(0,i.jsx)(e.li,{children:"\u5982\u679c\u652f\u6301 0xEB \u547d\u4ee4\uff0c\u5219\u6253\u5f00 SPI_NOR_QUAD_READ"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/qspi-170669565585243.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/qspi.png"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5982\u679c\u6709 Status Register\uff0c\u5219\u6253\u5f00 USE_FSR\uff0c\u662f\u4e00\u79cd\u72b6\u6001\u5448\u73b0\uff0c\u975e\u5fc5\u987b"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/fsr-170669566099045.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/fsr.png"})}),"\n",(0,i.jsx)(e.h3,{id:"24-\u603b\u7ed3",children:"2.4. \u603b\u7ed3"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"U-Boot \u4e2d\u79fb\u690d\u4e00\u6b3e SPI NOR\uff0c\u6700\u91cd\u8981\u7684\u662f JEDEC ID\uff0c\u901a\u8fc7\u5728\u6570\u636e\u624b\u518c\u4e2d\u67e5\u627e 0x9F \u547d\u4ee4\u83b7\u5f97"}),"\n",(0,i.jsx)(e.li,{children:"\u5176\u4ed6\u7684\u53c2\u6570\u90fd\u53ef\u4ee5\u9ed8\u8ba4\u8bbe\u7f6e\uff0cINFO(0xa14017, 0, 64 * 1024, n_sectors, SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"3-linux-\u79fb\u690d",children:"3. Linux \u79fb\u690d"}),"\n",(0,i.jsxs)(e.p,{children:["SPI NOR \u9a71\u52a8 Linux \u548c U-Boot \u7684\u9a71\u52a8\u4e0d\u4e00\u6837\uff0cLinux \u4e2d\u9a71\u52a8\u66f4\u590d\u6742\u4e00\u4e9b\uff0c\u672c\u7ae0\u9610\u8ff0\u5982\u4f55\u5728 Linux \u4e2d\u8fdb\u884c SPI NOR \u5668\u4ef6\u7684\u79fb\u690d\u5de5\u4f5c\uff0c\u4ee5 ",(0,i.jsx)(e.code,{children:"Gigadevice"})," \u7684 ",(0,i.jsx)(e.code,{children:"gd25q128"})," \u548c ",(0,i.jsx)(e.code,{children:"FudanMicro"})," \u7684 ",(0,i.jsx)(e.code,{children:"FM25Q128"})," \u4e3a\u4f8b"]}),"\n",(0,i.jsx)(e.h3,{id:"31-\u6587\u4ef6\u51c6\u5907",children:"3.1. \u6587\u4ef6\u51c6\u5907"}),"\n",(0,i.jsx)(e.p,{children:"\u76f8\u8f83\u4e8e SPI NAND \u5668\u4ef6\uff0c SPI NOR \u7684\u63a5\u53e3\u66f4\u52a0\u6807\u51c6\uff0c\u4f46\u4e3a\u4e86\u7edf\u4e00\u7ba1\u7406\u7684\u65b9\u4fbf\uff0c\u8fd8\u662f\u4f1a\u4e3a\u67d0\u4e00\u4e2a\u516c\u53f8\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u8fdb\u884c\u7ba1\u7406\uff0c\u5982\u679c\u8be5\u516c\u53f8\u7684\u6587\u4ef6\u5df2\u7ecf\u5b58\u5728\uff0c\u5219\u76f4\u63a5\u6dfb\u52a0\u65b0\u5668\u4ef6\u652f\u6301\u5373\u53ef"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u5728source/linux-5.10/drivers/mtd/spi-nor/ \u4e0b\u5efa\u76f8\u5e94\u516c\u53f8\u7684\u6807\u8bc6\u7684\u6587\u4ef6\uff0c\u5982 fmsh.c cfx.c"}),"\n",(0,i.jsx)(e.li,{children:"\u5728Makefile\u4e2d\u6dfb\u52a0\u8be5\u6587\u4ef6\u7684\u7f16\u8bd1\uff1a spi-nor-objs += fmsh.o"}),"\n",(0,i.jsx)(e.li,{children:"\u5728source/linux-5.10/drivers/mtd/spi-nor/core.h \u4e2d\u58f0\u660e extern const struct spi_nor_manufacturer spi_nor_fmsh;"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"32-\u9a71\u52a8\u7d22\u5f15",children:"3.2. \u9a71\u52a8\u7d22\u5f15"}),"\n",(0,i.jsx)(e.p,{children:"\u5185\u6838\u4e2d\u6240\u652f\u6301\u7684 SPI NOR \u8bbe\u5907\u901a\u8fc7\u4e24\u7ea7\u5217\u8868\u8fdb\u884c\u8bbe\u7f6e\u3002"}),"\n",(0,i.jsxs)(e.p,{children:["\u9996\u5148\u68c0\u67e5 ",(0,i.jsx)(e.code,{children:"source/linux-5.10/drivers/mtd/spi-nor/core.c"})," \u4e2d\u7684 ",(0,i.jsx)(e.code,{children:"manufacturers"}),", \u67e5\u770b\u65b0\u8bbe\u5907\u7684\u5382\u5546\u662f\u5426\u5728\u5217\u8868\u4e4b\u4e2d\uff1a"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"static const struct spi_nor_manufacturer *manufacturers[] = {\n    &spi_nor_atmel,\n    &spi_nor_catalyst,\n    &spi_nor_eon,\n    &spi_nor_esmt,\n    &spi_nor_everspin,\n    &spi_nor_fujitsu,\n    &spi_nor_gigadevice,\n    &spi_nor_intel,\n    &spi_nor_issi,\n    &spi_nor_macronix,\n    &spi_nor_micron,\n    &spi_nor_st,\n    &spi_nor_spansion,\n    &spi_nor_sst,\n    &spi_nor_winbond,\n    &spi_nor_xilinx,\n    &spi_nor_xmc,\n    &spi_nor_boya,\n};\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u518d\u68c0\u67e5\u5177\u4f53\u7684\u8bbe\u5907\u5382\u5546\u6587\u4ef6\uff0c\u5177\u4f53\u7684\u578b\u53f7\u662f\u5426\u5728\u5217\u8868\u4e4b\u4e2d\uff08 \u4ee5gigadevice \u4e3a\u4f8b\uff09:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'static const struct flash_info gigadevice_parts[] = {\n    ......\n   { "gd25q128", INFO(0xc84018, 0, 64 * 1024, 256,\n                       SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ |\n                       SPI_NOR_HAS_LOCK | SPI_NOR_HAS_TB) },\n    ......\n};\n'})}),"\n",(0,i.jsxs)(e.p,{children:["\u6b64\u5904\u68c0\u67e5\uff0c\u9700\u8981\u67e5\u627e\u65b0\u8bbe\u5907\u7684 Datasheet\uff0c\u627e\u5230\u8be5\u8bbe\u5907\u7684 Manufacture \u548c Device ID\uff0c\u5e76\u67e5\u770b\u8be5 ID \u662f\u5426\u51fa\u73b0\u5728\u5217\u8868\u4e2d\u3002 \u4f8b\u5982\u6b64\u5904\u4e3a ",(0,i.jsx)(e.code,{children:"0xc84018"})," \uff0c\u5176\u4e2d Manufacture ID = ",(0,i.jsx)(e.code,{children:"0xc8"}),", Device ID ID[15",(0,i.jsxs)(e.del,{children:["8] = ",(0,i.jsx)(e.code,{children:"0x40"}),", Device ID[7"]}),"0] = ",(0,i.jsx)(e.code,{children:"0x18"})," \u3002"]}),"\n",(0,i.jsx)(e.h3,{id:"33-spi_nor_manufacturer",children:"3.3. spi_nor_manufacturer"}),"\n",(0,i.jsx)(e.p,{children:"\u8be5\u7ed3\u6784\u4e3a\u7b2c\u4e00\u7ea7\u7d22\u5f15\uff0c\u7528\u6765\u63cf\u8ff0\u5668\u4ef6\u5382\u5bb6\u7684\u4fe1\u606f"}),"\n",(0,i.jsx)(e.p,{children:"SPI NOR \u7684\u63a5\u53e3\u548c\u64cd\u4f5c\u547d\u4ee4\u5f88\u7edf\u4e00\uff0c\u57fa\u672c\u6ca1\u6709\u9700\u8981\u7279\u6b8a\u5904\u7406\u7684\u547d\u4ee4"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'const struct spi_nor_manufacturer spi_nor_fmsh = {\n    .name = "FudanMicro",                   //\u5382\u5bb6\u540d\u5b57\u6807\u8bc6\n    .parts = fmsh_parts,                    //\u672c\u9a71\u52a8\u652f\u6301\u7684\u5668\u4ef6\n    .nparts = ARRAY_SIZE(fmsh_parts),       //\u652f\u6301\u7684\u5668\u4ef6\u7684\u4e2a\u6570\n};\n'})}),"\n",(0,i.jsx)(e.h3,{id:"34-flash_info",children:"3.4. flash_info"}),"\n",(0,i.jsxs)(e.p,{children:["\u867d\u7136\u548c U-Boot \u7684\u4ee3\u7801\u7ed3\u6784\u4e0d\u540c\uff0c\u4f46 flash_info \u7684\u63cf\u8ff0\u57fa\u672c\u7c7b\u4f3c\uff0c\u8be6\u7ec6\u4fe1\u606f\u53c2\u8003 U-Boot \u7684\u7ae0\u8282: ",(0,i.jsx)(e.a,{href:"uboot_port.html#ref-to-spinor-flash-info",children:"flash_info"})]}),"\n",(0,i.jsx)(e.h3,{id:"35-id_table",children:"3.5. id_table"}),"\n",(0,i.jsx)(e.p,{children:"\u9664\u4e86\u4f7f\u7528 dts \u7684 .compatible = \u201cjedec,spi-nor\u201d \u7edf\u4e00\u5339\u914d\u6240\u6709\u7684 SPI NOR \u5916\uff0c\u9a71\u52a8\u8fd8\u517c\u5bb9\u4f7f\u7528\u975e\u6807\u51c6 dts \u7684\u4f7f\u7528\u65b9\u5f0f\uff0c \u5373\u76f4\u63a5\u5728 dts \u6587\u4ef6\u4e2d\u63cf\u8ff0\u8981\u4f7f\u7528\u7684 SPI NOR \u7684\u578b\u53f7\uff0c \u4f46\u8fd9\u4f1a\u9020\u6210\u56fa\u4ef6\u548c\u5668\u4ef6\u7684\u7d27\u8026\u5408\uff0c\u4e0d\u63a8\u8350\u4f7f\u7528"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'static struct spi_mem_driver spi_nor_driver = {\n    .spidrv = {\n            .driver = {\n                    .name = "spi-nor",\n                    .of_match_table = spi_nor_of_table,\n            },\n            .id_table = spi_nor_dev_ids,\n    },\n\nstatic const struct spi_device_id spi_nor_dev_ids[] = {\n\n    /*\n     * Entries not used in DTs that should be safe to drop after replacing\n     * them with "spi-nor" in platform data.\n     */\n    {"s25sl064a"},  {"w25x16"},     {"m25p10"},     {"m25px64"},\n\n    /*\n     * Entries that were used in DTs without "jedec,spi-nor" fallback and\n     * should be kept for backward compatibility.\n     */\n    {"at25df321a"}, {"at25df641"},  {"at26df081a"},\n    {"mx25l4005a"}, {"mx25l1606e"}, {"mx25l6405d"}, {"mx25l12805d"},\n    {"mx25l25635e"},{"mx66l51235l"},\n    {"n25q064"},    {"n25q128a11"}, {"n25q128a13"}, {"n25q512a"},\n    {"s25fl256s1"}, {"s25fl512s"},  {"s25sl12801"}, {"s25fl008k"},\n    {"s25fl064k"},\n'})}),"\n",(0,i.jsx)(e.h3,{id:"36-\u603b\u7ed3",children:"3.6. \u603b\u7ed3"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u79fb\u690d\u4e00\u6b3e SPI NOR\uff0c\u6700\u91cd\u8981\u7684\u662f JEDEC ID\uff0c\u901a\u8fc7\u5728\u6570\u636e\u624b\u518c\u4e2d\u67e5\u627e 0x9F \u547d\u4ee4\u83b7\u5f97"}),"\n",(0,i.jsx)(e.li,{children:"\u5176\u4ed6\u7684\u53c2\u6570\u90fd\u53ef\u4ee5\u9ed8\u8ba4\u8bbe\u7f6e\uff0cINFO(0xa14017, 0, 64 * 1024, n_sectors, SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ)"}),"\n",(0,i.jsx)(e.li,{children:"\u63a8\u8350\u4f7f\u7528\u6807\u51c6 dts \u8fdb\u884c SPI NOR \u7684\u517c\u5bb9"}),"\n"]})]})}function a(n={}){const{wrapper:e}={...(0,r.a)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(o,{...n})}):o(n)}},1151:(n,e,s)=>{s.d(e,{Z:()=>t,a:()=>c});var i=s(7294);const r={},d=i.createContext(r);function c(n){const e=i.useContext(d);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:c(n.components),i.createElement(d.Provider,{value:e},n.children)}}}]);