"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5883],{9475:(e,n,_)=>{_.r(n),_.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>t,frontMatter:()=>d,metadata:()=>l,toc:()=>a});var i=_(5893),o=_(1151);const d={sidebar_position:6},r="SPL \u9636\u6bb5",l={id:"D213-DevKit/part5/03-6_SPLStage",title:"SPL \u9636\u6bb5",description:"Artinchip \u5e73\u53f0\u4e0a\u7684 SPL(Secondary Program Loader) \u662f\u7b2c\u4e00\u7ea7\u5f15\u5bfc\u7a0b\u5e8f(FSBL, First Stage Boot Loader)\uff0c \u540c\u65f6\u4e5f\u662f\u7b2c\u4e8c\u7ea7\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002",source:"@site/docs/D213-DevKit/part5/03-6_SPLStage.md",sourceDirName:"D213-DevKit/part5",slug:"/D213-DevKit/part5/03-6_SPLStage",permalink:"/docs/D213-DevKit/part5/03-6_SPLStage",draft:!1,unlisted:!1,editUrl:"https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part5/03-6_SPLStage.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"d213dkSidebar",previous:{title:"DTS",permalink:"/docs/D213-DevKit/part5/03-5_DTS"},next:{title:"U-Boot \u9636\u6bb5",permalink:"/docs/D213-DevKit/part5/03-7_U-BootStage"}},s={},a=[{value:"1. RISCV SPL",id:"1-riscv-spl",level:2},{value:"2. \u542f\u52a8\u6d41\u7a0b",id:"2-\u542f\u52a8\u6d41\u7a0b",level:2},{value:"2.1. uboot \u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u6a21\u578b",id:"21-uboot-\u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u6a21\u578b",level:3},{value:"2.2. uboot \u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u642d\u5efa\u7684\u8fc7\u7a0b",id:"22-uboot-\u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u642d\u5efa\u7684\u8fc7\u7a0b",level:3},{value:"2.3. SPL RISCV \u7684\u542f\u52a8\u6574\u4f53\u6d41\u7a0b",id:"23-spl-riscv-\u7684\u542f\u52a8\u6574\u4f53\u6d41\u7a0b",level:3},{value:"3. MMC \u52a0\u8f7d",id:"3-mmc-\u52a0\u8f7d",level:2},{value:"4. SPI NAND \u52a0\u8f7d",id:"4-spi-nand-\u52a0\u8f7d",level:2},{value:"4.1. U-Boot \u4fdd\u5b58\u5728 MTD \u5206\u533a\u65f6",id:"41-u-boot-\u4fdd\u5b58\u5728-mtd-\u5206\u533a\u65f6",level:3},{value:"4.2. U-Boot \u4fdd\u5b58\u5728 UBI \u4e2d\u65f6",id:"42-u-boot-\u4fdd\u5b58\u5728-ubi-\u4e2d\u65f6",level:3},{value:"4.3. \u8bfb\u6570 SPI NAND \u6570\u636e\u7684\u6d41\u7a0b",id:"43-\u8bfb\u6570-spi-nand-\u6570\u636e\u7684\u6d41\u7a0b",level:3},{value:"5. SPI NOR \u52a0\u8f7d",id:"5-spi-nor-\u52a0\u8f7d",level:2},{value:"6. SDFAT32 \u52a0\u8f7d",id:"6-sdfat32-\u52a0\u8f7d",level:2},{value:"7. \u7b7e\u540d\u6821\u9a8c",id:"7-\u7b7e\u540d\u6821\u9a8c",level:2},{value:"7.1. FIT Image \u7b7e\u540d\u6821\u9a8c",id:"71-fit-image-\u7b7e\u540d\u6821\u9a8c",level:3},{value:"7.2. AIC Image \u7b7e\u540d\u6821\u9a8c",id:"72-aic-image-\u7b7e\u540d\u6821\u9a8c",level:3},{value:"8. \u8fd4\u56de BROM",id:"8-\u8fd4\u56de-brom",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"spl-\u9636\u6bb5",children:"SPL \u9636\u6bb5"}),"\n",(0,i.jsx)(n.p,{children:"Artinchip \u5e73\u53f0\u4e0a\u7684 SPL(Secondary Program Loader) \u662f\u7b2c\u4e00\u7ea7\u5f15\u5bfc\u7a0b\u5e8f(FSBL, First Stage Boot Loader)\uff0c \u540c\u65f6\u4e5f\u662f\u7b2c\u4e8c\u7ea7\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"BROM -> SPL -> U-Boot -> Kernel"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"SPL \u8fd0\u884c\u5728 SRAM \u4e2d\uff0c\u5176\u6700\u91cd\u8981\u7684\u4efb\u52a1\u6709\u4e24\u4e2a\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5b8c\u6210 DDR\uff0c\u5e76\u4e14\u4f7f\u80fd Cache"}),"\n",(0,i.jsx)(n.li,{children:"\u52a0\u8f7d\u548c\u9a8c\u8bc1 U-Boot"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u4e00\u4e9b\u542f\u52a8\u901f\u5ea6\u4f18\u5316\u7684\u65b9\u6848\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4ece SPL \u542f\u52a8 Kernel\u3002 \u672c\u7ae0\u8282\u63cf\u8ff0\u4e0d\u540c\u542f\u52a8\u4ecb\u8d28\u7684 SPL \u5904\u7406\u6d41\u7a0b\uff0c\u4ee5\u53ca\u5b89\u5168\u542f\u52a8\u7684\u76f8\u5173\u5904\u7406\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"1-riscv-spl",children:"1. RISCV SPL"}),"\n",(0,i.jsx)(n.p,{children:"SPL BSS \u7684\u914d\u7f6e"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"CONFIG_SPL_TEXT_BASE=0x103100\nCONFIG_SPL_SIZE_LIMIT=0x10000\n\n#define CONFIG_SPL_MAX_SIZE                 (CONFIG_SPL_SIZE_LIMIT)\n#define CONFIG_SPL_STACK                    (D211_SRAM_BASE + D211_SRAM_SIZE)\n\n#define CONFIG_SPL_BSS_START_ADDR   (CONFIG_SPL_TEXT_BASE + CONFIG_SPL_MAX_SIZE)\n#define CONFIG_SPL_BSS_MAX_SIZE             0x00002000 /* 8 KiB */\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5373 BSS \u4ece 0x113100 \u5f00\u59cb\uff0c\u540e\u7eed\u8fd8\u6709 SPL STACK \u7684\u7a7a\u95f4\uff0cHEAP \u7684\u7a7a\u95f4\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u5bf9\u4e8e spl.aic \u6587\u4ef6\uff0c\u5728 spl.bin \u7684\u540e\u9762\u8fd8\u5b58\u653e\u7740\u5176\u4ed6\u7684\u8d44\u6e90\u6570\u636e\uff0c\u5982\u679c\u8be5\u6570\u636e\u9700\u8981\u5728 SPL \u9636\u6bb5\u4f7f\u7528\uff0c \u5219\u9700\u8981\u6ce8\u610f\uff0c\u5728 SPL \u8fd0\u884c\u65f6\uff0c\u8d44\u6e90\u6570\u636e\u7684\u533a\u57df\u4e0e BSS \u533a\u57df\u4e0d\u80fd\u91cd\u5408\uff0c\u4e0d\u7136\u4f1a\u6709\u6570\u636e\u9519\u8bef\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"2-\u542f\u52a8\u6d41\u7a0b",children:"2. \u542f\u52a8\u6d41\u7a0b"}),"\n",(0,i.jsx)(n.p,{children:"\u7406\u89e3spl\u7684\u542f\u52a8\u6d41\u7a0b\uff0c\u5173\u952e\u662f\u8bbe\u5907\u6811\uff0c\u8bbe\u5907\u9a71\u52a8\u6a21\u578b\u3002\u5173\u4e8e\u8bbe\u5907\u6811\uff0c\u8bf7\u67e5\u770b\u8bbe\u5907\u6811\u76f8\u5173\u7ae0\u8282\uff0c\u8bbe\u5907\u9a71\u52a8\u6a21\u578b\u7684\u4ecb\u7ecd\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(n.h3,{id:"21-uboot-\u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u6a21\u578b",children:"2.1. uboot \u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u6a21\u578b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"> uclass <\u2013> uclass_driver <\u2013> udevice <\u2013> driver <\u2013> hardware\n"})}),"\n",(0,i.jsx)(n.p,{children:"uclass\u8868\u793a\u7ba1\u7406\u67d0\u4e00\u4e2a\u7c7b\u522b\u4e0b\u7684\u6240\u6709device;"}),"\n",(0,i.jsx)(n.p,{children:"uclass_driver\u8868\u793a\u5bf9\u5e94uclass\u7684ops\u96c6\u5408\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"22-uboot-\u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u642d\u5efa\u7684\u8fc7\u7a0b",children:"2.2. uboot \u8bbe\u5907\u9a71\u52a8\u6846\u67b6\u642d\u5efa\u7684\u8fc7\u7a0b"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u521b\u5efaudevice"}),"\n",(0,i.jsx)(n.li,{children:"\u5e94\u7528uclass\u5982\u679c\u6ca1\u6709\u5219\u5339\u914d\u751f\u6210uclass"}),"\n",(0,i.jsx)(n.li,{children:"udevice\u548cuclass\u7ed1\u5b9a"}),"\n",(0,i.jsx)(n.li,{children:"uclass_driver\u548cuclass\u7ed1\u5b9a"}),"\n",(0,i.jsx)(n.li,{children:"driver\u548cudevice\u7ed1\u5b9a"}),"\n",(0,i.jsx)(n.li,{children:"device_probe\u6267\u884c\uff0c\u4f1a\u89e6\u53d1uclass_driver\u8c03\u7528driver\u51fd\u6570"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"23-spl-riscv-\u7684\u542f\u52a8\u6574\u4f53\u6d41\u7a0b",children:"2.3. SPL RISCV \u7684\u542f\u52a8\u6574\u4f53\u6d41\u7a0b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'_start // arch/riscv/cpu/start.S\n|-> save_boot_params // arch/riscv/mach-artinchip/lowlevel_init.S\n|   // BROM \u8df3\u8f6c\u5230 SPL \u6267\u884c\u7684\u65f6\u5019\uff0c\u4f20\u9012\u4e86\u4e00\u4e9b\u53c2\u6570\uff0c\u8fd9\u91cc\u9996\u5148\u9700\u8981\u5c06\u8fd9\u4e9b\u53c2\u6570\u4fdd\u5b58\u8d77\u6765\n|\n|-> csrw    MODE_PREFIX(ie), zero // Disable irq\n|-> li      t1, CONFIG_SPL_STACK // \u8bbe\u7f6esp\u5bc4\u5b58\u5668\n|-> jal     board_init_f_alloc_reserve // common/init/board_init.c\n|   // \u9884\u7559\u521d\u59cb HEAP \u7684\u7a7a\u95f4\n|   // \u9884\u7559 GD \u5168\u5c40\u53d8\u91cf\u7684\u7a7a\u95f4\n|\n|-> jal     board_init_f_init_reserve\n|   // common/init/board_init.c, init gd area\n|   // \u6b64\u65f6 gd \u5728 SPL STACK \u4e2d\u3002\n|\n|-> jal     icache_enable // arch/riscv/cpu/c906/cache.c \u4f7f\u80fd\u6307\u4ee4\u9ad8\u901f\u7f13\u5b58\n|-> jal     dcache_enable // \u4f7f\u80fd\u6570\u636e\u9ad8\u901f\u7f13\u5b58\n|\n|-> jal     debug_uart_init // drivers/serial/ns16550.c\n| // \u521d\u59cb\u5316\u8c03\u8bd5\u4e32\u53e3\uff0c\u5982\u679c\u4f7f\u80fd\n|\n|-> board_init_f // arch/riscv/lib/spl.c\n|   |-> spl_early_init() // common/spl/spl.c\n|       |-> spl_common_init(setup_malloc = true) // common/spl/spl.c\n|           |-> fdtdec_setup();  // lib/fdtdec.c \u83b7\u53d6dtb\u7684\u5730\u5740\uff0c\u5e76\u9a8c\u8bc1\u5408\u6cd5\u6027\n|           | // \u53ea\u5bf9\u5e26\u6709\u201cu-boot,dm-pre-reloc\u201d\u5c5e\u6027\u8282\u70b9\u8fdb\u884c\u89e3\u6790\uff0c\u521d\u59cb\u5316\u9a71\u52a8\u6a21\u578b\u7684\u6839\u8282\u70b9\uff0c\u626b\u63cf\u8bbe\u5907\u6811\u521b\u5efaudevice,uclass\n|           |-> dm_init_and_scan(!CONFIG_IS_ENABLED(OF_PLATDATA)); // drivers/core/root.c\n|               |-> dm_init(); // driver model, initiate virtual root driver\n|               |   |-> INIT_LIST_HEAD(DM_UCLASS_ROOT_NON_CONST); // \u521d\u59cb\u5316uclass\u94fe\u8868\n|               |   |-> device_bind_by_name()\n|               |   |   |   // drivers/core/device.c\n|               |   |   |   // \u52a0\u8f7d"root_driver"name, gd->dm_root\n|               |   |   |-> lists_driver_lookup_name()\n|               |   |   |   |-> ll_entry_start(struct driver, driver); // \u83b7\u53d6driver table\u8d77\u59cb\u4f4d\u7f6e\n|               |   |   |   |-> ll_entry_count(struct driver, driver); // \u83b7\u53d6driver table\u957f\u5ea6\n|               |   |   |   // drivers/core/lists.c\n|               |   |   |   // \u91c7\u7528 U_BOOT_DRIVER(name) \u58f0\u660e\u7684 driver\uff0c\u4ecedriver table\u4e2d\u83b7\u53d6struct driver\u6570\u636e\n|               |   |   |\n|               |   |   |   // \u521d\u59cb\u5316udevice \u4e0e\u5bf9\u5e94\u7684uclass,driver\u7ed1\u5b9a\n|               |   |   |-> device_bind_common(); // drivers/core/device.c\n|               |   |       |-> uclass_get(&uc)\n|               |   |       |   |-> uclass_find(id); // \u5224\u65ad\u5bf9\u5e94\u7684uclass\u662f\u5426\u5b58\u5728\n|               |   |       |   |-> uclass_add(id, ucp); // \u5982\u679c\u4e0d\u5b58\u5728\u5c31\u521b\u5efa\n|               |   |       |       |-> lists_uclass_lookup(id); // \u83b7\u53d6uclass_driver\u7ed3\u6784\u4f53\u6570\u636e\n|               |   |       |-> uclass_bind_device(dev) // uclass\u7ed1\u5b9audevice drivers/core/uclass.c\n|               |   |       |-> drv->bind(dev)  // driver\u7ed1\u5b9audevice\n|               |   |       |-> parent->driver->child_post_bind(dev)\n|               |   |       |-> uc->uc_drv->post_bind(dev)\n|               |   |\n|               |   |-> device_probe(gd->dm_root) // drivers/core/device.c\n|               |       |-> uclass_resolve_seq(dev) // \u901a\u8fc7dtb\u89e3\u6790\u83b7\u5f97\u8bbe\u5907\u5dee\u5f02\u6570\u636e\n|               |       |-> uclass_pre_probe_device(dev); // probe\u524d\u64cd\u4f5c\n|               |       |-> drv->probe(dev); // \u6267\u884cdriver\u7684probe\u64cd\u4f5c\n|               |       |-> uclass_post_probe_device(dev); // probe\u540e\u64cd\u4f5c\n|               |\n|               |-> dm_scan(pre_reloc_only);\n|                   |   // \u626b\u63cf\u548c\u7ed1\u5b9a\u7531 U_BOOT_DEVICE \u58f0\u660e\u7684\u9a71\u52a8\u3002\n|                   |   // \u4e00\u822c\u7528\u5728 SPL OF_PLATDATA \u7684\u60c5\u51b5\n|                   |-> dm_scan_plat(pre_reloc_only);\n|                   |   |-> lists_bind_drivers(DM_ROOT_NON_CONST, pre_reloc_only);\n|                   |       |-> bind_drivers_pass(parent, pre_reloc_only);\n|                   |           |-> device_bind_by_name();\n|                   |\n|                   |-> dm_extended_scan(pre_reloc_only);\n|                   |   |-> dm_scan_fdt(pre_reloc_only); // \u626b\u63cf\u8bbe\u5907\u6811\u5e76\u4e0e\u8bbe\u5907\u9a71\u52a8\u5efa\u7acb\u8054\u7cfb\n|                   |   |   |-> dm_scan_fdt_node(gd->dm_root, ofnode_root(), pre_reloc_only); //\u626b\u63cf\u8bbe\u5907\u6811\u5e76\u7ed1\u5b9aroot\u8282\u70b9\u4e0b\u7684\u8bbe\u5907\n|                   |   |       |-> ofnode_first_subnode(parent_node) // \u83b7\u53d6\u8bbe\u5907\u6811\u7684\u7b2c\u4e00\u4e2a\u5b50\u8282\u70b9\n|                   |   |       |-> ofnode_next_subnode(node) // \u904d\u5386\u6240\u6709\u7684\u5b50\u8282\u70b9\n|                   |   |       |-> ofnode_is_enabled(node) // \u5224\u65ad\u8bbe\u5907\u6811\u7684\u5b50\u8282\u70b9\u662f\u5426\u4f7f\u80fd\n|                   |   |       |-> lists_bind_fdt(parent, node, NULL, pre_reloc_only); // \u7ed1\u5b9a\u8bbe\u5907\u6811\u8282\u70b9\uff0c\u521b\u5efa\u65b0\u7684udevicd drivers/core/lists.c\n|                   |   |           |-> ofnode_get_property(node, "compatible", &compat_length); // \u83b7\u53d6compatible\n|                   |   |           |-> driver_check_compatible() // \u548cdriver\u6bd4\u8f83compatible\u503c\n|                   |   |           |-> device_bind_with_driver_data() // \u521b\u5efa\u4e00\u4e2a\u8bbe\u5907\u5e76\u7ed1\u5b9a\u5230driver drivers/core/device.c\n|                   |   |               |-> device_bind_common() // \u521b\u5efa\u521d\u59cb\u5316udevice \u4e0e\u5bf9\u5e94\u7684uclass,driver\u7ed1\u5b9a\n|                   |   |\n|                   |   | // /chosen /clocks /firmware \u4e00\u4e9b\u8282\u70b9\u672c\u8eab\u4e0d\u662f\u8bbe\u5907\uff0c\u4f46\u5305\u542b\u4e00\u4e9b\u8bbe\u5907\uff0c\u904d\u5386\u5176\u5305\u542b\u7684\u8bbe\u5907\n|                   |   |-> dm_scan_fdt_ofnode_path(nodes[i], pre_reloc_only);\n|                   |       |-> ofnode_path(path); // \u627e\u5230\u8282\u70b9\u4e0b\u5305\u542b\u7684\u8bbe\u5907\n|                   |       |-> dm_scan_fdt_node(gd->dm_root, node, pre_reloc_only);\n|                   |\n|                   |-> dm_scan_other(pre_reloc_only);\n|                   |   // \u626b\u63cf\u4f7f\u7528\u8005\u81ea\u5b9a\u4e49\u7684\u8282\u70b9 nothing\n|\n|-> spl_clear_bss // arch/riscv/cpu/start.S\n|-> spl_relocate_stack_gd   // \u5207\u6362stack \u548c gd \u5230dram\u7a7a\u95f4\n|-> board_init_r()    // common/spl/spl.c\n    |-> spl_set_bd()  // board data info\n    |   // \u8bbe\u7f6e\u5b8c bd \u4e4b\u540e\uff0c\u624d\u80fd enable d-cache\n    |-> mem_malloc_init()\n    |   // init heap\n    |   //  - CONFIG_SYS_SPL_MALLOC_START\n    |   //  - CONFIG_SYS_SPL_MALLOC_SIZE>\n    |\n    |-> spl_init\n    |   |-> spl_common_init\n    |       // \u7531\u4e8e\u524d\u9762\u5df2\u7ecf\u8c03\u7528\u4e86 spl_early_init,\n    |       // \u8fd9\u91cc\u4e0d\u518d\u8c03\u7528 spl_common_init\n    |\n    |-> timer_init(); // lib/time.c nothing\n    |-> spl_board_init(); // arch/riscv/mach-artinchip/spl.c nothing\n    |\n    |-> initr_watchdog  // enable watchdog\uff0c\u5982\u679c\u4f7f\u80fd\n    |-> dram_init_banksize(); // \u5982\u679c\u4f7f\u80fd\n    |-> board_boot_order() // common/spl/spl.c\n    |   |-> spl_boot_device(); // arch/riscv/mach-artinchip/spl.c\n    |       |-> aic_get_boot_device(); // arch/riscv/mach-artinchip/boot_param.c\n    |           // \u4ece boot param \u4e2d\u83b7\u53d6\u542f\u52a8\u4ecb\u8d28\u4fe1\u606f\n    |\n    |-> boot_from_devices(spl_boot_list)\n    |   |-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n    |   |       // \u8fd9\u91cc\u53ef\u80fd\u662f\u5404\u79cd\u4ecb\u8d28\u7684 load image \u51fd\u6570\n    |   |       // SPL_LOAD_IMAGE_METHOD() \u5b9a\u4e49\u7684 Loader\n    |   |       // \u53ef\u80fd\u662f MMC/SPI/BROM/...\n    |   |\n    |   |-> spl_load_image  // \u4ee5emmc\u542f\u52a8\u4e3a\u4f8b\n    |       |-> spl_mmc_load_image  // common/spl/spl_mmc.c\n    |           |-> spl_mmc_load // \u5177\u4f53\u53ef\u770b\u540e\u9762\u7684\u6d41\u7a0b\n    |\n    |-> spl_perform_fixups  // vendor hook\uff0c\u7528\u4e8e\u4fee\u6539device-tree\u4f20\u9012\u53c2\u6570\n    |-> spl_board_prepare_for_boot  // vendor hook, \u53ef\u4e0d\u5b9e\u73b0\n    |-> jump_to_image_no_args   // \u8df3\u8f6c\u5230u-boot\u6267\u884c\n'})}),"\n",(0,i.jsx)(n.h2,{id:"3-mmc-\u52a0\u8f7d",children:"3. MMC \u52a0\u8f7d"}),"\n",(0,i.jsx)(n.p,{children:"SPL \u4ece MMC \u52a0\u8f7d U-Boot \u7684\u5904\u7406\u8fc7\u7a0b\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u7a0b\u5e8f\u7f16\u7801\u7684\u65f6\u5019\uff0c\u9488\u5bf9 MMC \u8bbe\u5907\u6dfb\u52a0\u4e86\u5bf9\u5e94\u7684\u52a0\u8f7d\u7a0b\u5e8f\u652f\u6301\uff0c\u5982 spl_mmc.c \u4e2d\uff0c\u901a\u8fc7\u4f7f\u7528\u5b8f:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"SPL_LOAD_IMAGE_METHOD(\u201cMMC1\u201d, 0, BOOT_DEVICE_MMC1, spl_mmc_load_image);"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5c06 ",(0,i.jsx)(n.code,{children:"spl_mmc_load_image"})," \u51fd\u6570\u6dfb\u52a0\u5230 .u_boot_list_2_spl_image_loader_* \u6bb5\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 SPL \u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"boot_from_devices(spl_boot_list)"})," \u51fd\u6570\u8c03\u7528\uff0c\u68c0\u67e5\u5f53\u524d\u9879\u76ee \u6240\u652f\u6301\u7684 SPL \u8bfb\u53d6\u7684\u5b58\u50a8\u4ecb\u8d28\u7c7b\u578b\uff0c\u7136\u540e\u4f9d\u6b21\u68c0\u67e5\u662f\u5426\u5b58\u5728\u5bf9\u5e94\u7684\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"board_init_r()    // common/spl/spl.c\n|-> boot_from_devices(spl_boot_list)\n    |-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n            // \u8fd9\u91cc\u53ef\u80fd\u662f\u5404\u79cd\u4ecb\u8d28\u7684 load image \u51fd\u6570\n            // SPL_LOAD_IMAGE_METHOD() \u5b9a\u4e49\u7684 Loader\n            // \u53ef\u80fd\u662f MMC/SPI/BROM/...\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u627e\u5230 SPL MMC Loader \u4e4b\u540e\uff0c\u4ece\u9879\u76ee\u914d\u7f6e\u7684\u6307\u5b9a Sector \u8bfb\u53d6\u6570\u636e\u3002"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'boot_from_devices(spl_boot_list); // common/spl/spl.c\n|-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n|   // \u6b64\u5904\u901a\u8fc7\u904d\u5386\u56fa\u4ef6\u7684 .u_boot_list_2_spl_image_loader_* \u6bb5\n|   // \u627e\u5230\u5f53\u524d\u652f\u6301\u7684\u5b58\u50a8\u4ecb\u8d28\uff0c\u7136\u540e\u9010\u4e2a\u5c1d\u8bd5\n|\n|-> spl_load_image(loader);\n    |-> loader->load_image(spl_image, &bootdev);\n        spl_mmc_load_image();  // common/spl/spl_mmc.c\n        |-> spl_mmc_load();\n                    |\n      +-------------+\n      |\nspl_mmc_load();\n|-> spl_mmc_find_device(&mmc, bootdev->boot_device);\n|   |-> mmc_initialize\n|       |-> mmc_probe\n|           |-> uclass_get(UCLASS_MMC, &uc)\n|           |-> device_probe(dev)\n|               |-> uclass_resolve_seq(dev)\n|               |-> pinctrl_select_state(dev, "default")\n|               |   |-> pinctrl_select_state_full(dev, "default")\n|               |   |   |-> state = dev_read_stringlist_search(dev,\n|               |   |   |                       "pinctrl-names", "default");\n|               |   |   |-> dev_read_prop(dev, propname, &size)\n|               |   |   |   // snprintf(propname, sizeof(propname),\n|               |   |   |   //              "pinctrl-%d", state)\n|               |   |   |\n|               |   |   |-> pinctrl_config_one(config)\n|               |   |       |-> ops = pinctrl_get_ops(pctldev)\n|               |   |       |-> ops->set_state(pctldev, config)\n|               |   |\n|               |   |-> pinctrl_select_state_simple(dev)\n|               |       |-> uclass_get_device_by_seq(UCLASS_PINCTRL, 0, &pctldev)\n|               |       |-> ops=pinctrl_get_ops(pctldev)\n|               |       |   // #define pinctrl_get_ops(dev)\n|               |       |   //         ((struct pinctrl_ops *)(dev)->driver->ops)\n|               |       |\n|               |       |-> ops->set_state_simple(pctldev, dev)\n|               |\n|               |-> power_domain_on(&powerdomain)\n|               |-> uclass_pre_probe_device(dev)\n|               |-> clk_set_defaults(dev)\n|               |   |-> clk_set_default_parents(dev)\n|               |   |-> clk_set_default_rates(dev)\n|               |\n|               |-> drv->probe(dev)\n|               |-> uclass_post_probe_device(dev)\n|\n|-> mmc_init\n|-> boot_mode=spl_boot_mode(bootdev->boot_device)\n|-> mmc_load_image_raw_sector\n    |-> header=spl_get_load_buffer(-sizeof(*header), bd->blksz)\n    |   // header\u4f4d\u4e8eload_addr\u504f\u79fb-head_size\u5904\n    |\n    |-> blk_dread(bd, sector, 1, header)\n    |   // \u8bfb\u53d6\u4e00\u4e2asector\u7684u-boot image header\n    |\n    |-> mmc_load_legacy(spl_image, mmc, sector, header)\n    |   |-> spl_parse_image_header(spl_image, header)\n    |   // \u89e3\u6790u-boot image header\u4fe1\u606f\uff0c\u5f97\u5230u-boot\u7684addr\u548csize\u4fe1\u606f\n    |\n    |-> blk_dread(bd, sector, cnt, load_addr)\n        // \u8bfb\u53d6\u5b8c\u6574\u7684u-boot image\uff0c\u5305\u62echeader\uff0c\u6ce8\u610fload_addr\u662f\u5411\u524d\u504f\u79fb\u8fc7\u7684\u5730\u5740\n'})}),"\n",(0,i.jsx)(n.h2,{id:"4-spi-nand-\u52a0\u8f7d",children:"4. SPI NAND \u52a0\u8f7d"}),"\n",(0,i.jsx)(n.p,{children:"\u5b98\u65b9\u7248\u672c\u7684 SPL \u5e76\u4e0d\u652f\u6301\u4ece SPI NAND \u542f\u52a8\uff0cArtinchip \u589e\u52a0\u4e86\u4ece SPI NAND \u7684 MTD \u5206\u533a \u548c UBI \u52a0\u8f7d U-Boot \u7684\u652f\u6301\u3002"}),"\n",(0,i.jsx)(n.p,{children:"common/spl/spl_spi_nand.c \u4e2d\u6ce8\u518c\u4e86\u4e24\u4e2a\u4e0d\u540c\u7684 SPL \u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'#ifdef CONFIG_SPL_UBI\n/* Use priorty 0 to override other SPI device when this device is enabled. */\nSPL_LOAD_IMAGE_METHOD("SPINAND_UBI", 0, BOOT_DEVICE_SPI, spl_ubi_load_image);\n#else\nSPL_LOAD_IMAGE_METHOD("SPINAND", 0, BOOT_DEVICE_SPI, spl_spi_nand_load_image);\n#endif\n'})}),"\n",(0,i.jsx)(n.h3,{id:"41-u-boot-\u4fdd\u5b58\u5728-mtd-\u5206\u533a\u65f6",children:"4.1. U-Boot \u4fdd\u5b58\u5728 MTD \u5206\u533a\u65f6"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 SPL \u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"boot_from_devices(spl_boot_list)"})," \u51fd\u6570\u8c03\u7528\uff0c\u68c0\u67e5\u5f53\u524d\u9879\u76ee \u6240\u652f\u6301\u7684 SPL \u8bfb\u53d6\u7684\u5b58\u50a8\u4ecb\u8d28\u7c7b\u578b\uff0c\u7136\u540e\u4f9d\u6b21\u68c0\u67e5\u662f\u5426\u5b58\u5728\u5bf9\u5e94\u7684\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"board_init_r()    // common/spl/spl.c\n|-> boot_from_devices(spl_boot_list)\n    |-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n            // \u8fd9\u91cc\u53ef\u80fd\u662f\u5404\u79cd\u4ecb\u8d28\u7684 load image \u51fd\u6570\n            // SPL_LOAD_IMAGE_METHOD() \u5b9a\u4e49\u7684 Loader\n            // \u53ef\u80fd\u662f MMC/SPI/BROM/...\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u627e\u5230 SPL SPINAND Loader \u4e4b\u540e\uff0c\u4ece\u9879\u76ee\u914d\u7f6e\u7684\u6307\u5b9a\u4f4d\u7f6e\u8bfb\u53d6\u6570\u636e\u3002"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CONFIG_SYS_SPI_NAND_U_BOOT_OFFS"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"boot_from_devices(spl_boot_list); // common/spl/spl.c\n|-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n|   // \u6b64\u5904\u901a\u8fc7\u904d\u5386\u56fa\u4ef6\u7684 .u_boot_list_2_spl_image_loader_* \u6bb5\n|   // \u627e\u5230\u5f53\u524d\u4f7f\u80fd\u7684\u5b58\u50a8\u4ecb\u8d28\u9a71\u52a8\uff0c\u7136\u540e\u9010\u4e2a\u5c1d\u8bd5\n|\n|-> spl_load_image(loader);\n    |-> loader->load_image(spl_image, &bootdev);\n        spl_spi_nand_load_image();  // arch/arm/mach-artinchip/spl_spi_nand.c\n        |-> spl_spi_nand_init();\n        |   |-> uclass_first_device(UCLASS_MTD, &dev); // drivers/core/uclass.c\n        |   |-> mtd_probe(dev);\n        |   |-> get_mtd_device(NULL, 0);\n        |-> spl_get_load_buffer(-sizeof(*header), sizeof(*header));\n        |-> spl_spi_nand_read();\n        |   // \u8bfb\u53d6\u5934\u4fe1\u606f\n        |-> spl_parse_image_header(spl_image, header);\n        |-> spl_spi_nand_read();// arch/arm/mach-artinchip/spl_spi_nand.c\n            |  // \u8bfb\u53d6\u6574\u4e2a U-Boot \u955c\u50cf\n            |-> mtd_block_isbad(mtd, off);\n            |   // \u8df3\u8fc7\u574f\u5757\n            |-> mtd_read(); // drivers/mtd/mtdcore.c\n"})}),"\n",(0,i.jsx)(n.h3,{id:"42-u-boot-\u4fdd\u5b58\u5728-ubi-\u4e2d\u65f6",children:"4.2. U-Boot \u4fdd\u5b58\u5728 UBI \u4e2d\u65f6"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 SPL \u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"boot_from_devices(spl_boot_list)"})," \u51fd\u6570\u8c03\u7528\uff0c\u68c0\u67e5\u5f53\u524d\u9879\u76ee \u6240\u652f\u6301\u7684 SPL \u8bfb\u53d6\u7684\u5b58\u50a8\u4ecb\u8d28\u7c7b\u578b\uff0c\u7136\u540e\u4f9d\u6b21\u68c0\u67e5\u662f\u5426\u5b58\u5728\u5bf9\u5e94\u7684\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"board_init_r()    // common/spl/spl.c\n|-> boot_from_devices(spl_boot_list)\n    |-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n            // \u8fd9\u91cc\u53ef\u80fd\u662f\u5404\u79cd\u4ecb\u8d28\u7684 load image \u51fd\u6570\n            // SPL_LOAD_IMAGE_METHOD() \u5b9a\u4e49\u7684 Loader\n            // \u53ef\u80fd\u662f MMC/SPI/BROM/...\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u627e\u5230 SPL SPINAND UBI Loader \u4e4b\u540e\uff0c\u4ece\u9879\u76ee\u914d\u7f6e\u7684\u6307\u5b9a\u4f4d\u7f6e\u8bfb\u53d6\u6570\u636e\u3002"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CONFIG_SPL_UBI_INFO_ADDR"}),"\n",(0,i.jsx)(n.li,{children:"CONFIG_SPL_UBI_PEB_OFFSET"}),"\n",(0,i.jsx)(n.li,{children:"CONFIG_SPL_UBI_VID_OFFSET"}),"\n",(0,i.jsx)(n.li,{children:"CONFIG_SPL_UBI_LEB_START"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u6216\u8005\u4ece\u6307\u5b9a Volume \u4e2d\u8bfb\u53d6"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CONFIG_SPL_UBI_LOAD_MONITOR_VOLNAME"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"boot_from_devices(spl_boot_list); // common/spl/spl.c\n|-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n|   // \u6b64\u5904\u901a\u8fc7\u904d\u5386\u56fa\u4ef6\u7684 .u_boot_list_2_spl_image_loader_* \u6bb5\n|   // \u627e\u5230\u5f53\u524d\u652f\u6301\u7684\u5b58\u50a8\u4ecb\u8d28\uff0c\u7136\u540e\u9010\u4e2a\u5c1d\u8bd5\n|\n|-> spl_load_image(loader);\n    |-> loader->load_image(spl_image, &bootdev);\n        spl_ubi_load_image(); // arch/arm/mach-artinchip/spl_spi_nand.c\n        |-> spl_spi_nand_init();\n        |   |-> uclass_first_device(UCLASS_MTD, &dev); // drivers/core/uclass.c\n        |   |-> mtd_probe(dev);\n        |   |-> get_mtd_device(NULL, 0);\n        |-> spl_get_load_buffer(-sizeof(*header), sizeof(*header));\n        |-> ubispl_load_volumes(&info, volumes, 1); // drivers/mtd/ubispl/ubispl.c\n        |   |  // \u8bfb\u53d6\u6574\u4e2a U-Boot \u955c\u50cf\u7684\u5185\u5bb9\n        |   |-> ipl_scan(ubi);\n        |   |-> ipl_load(ubi, lv->vol_id, lv->load_addr);\n        |       |   // drivers/mtd/ubispl/ubispl.c\n        |       |-> ubi_load_block(ubi, laddr, vi, vol_id, lnum, last);\n        |           |-> ubi_io_is_bad(ubi, pnum); // drivers/mtd/ubi/io.c\n        |           |   // drivers/mtd/ubispl/ubispl.c\n        |           |-> ubi_io_read(ubi, laddr, pnum, ubi->leb_start, dlen);\n        |               |  // drivers/mtd/ubispl/ubispl.c\n        |               |-> ubi->read(pnum + ubi->peb_offset, from, len, buf);\n        |                   nand_spl_read_block(pnum + ubi->peb_offset,\n        |                   |                       from, len, buf);\n        |                   |  // arch/arm/mach-artinchip/spl_spi_nand.c\n        |                   |-> mtd_read();\n        |\n        |-> spl_parse_image_header(spl_image, header);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"43-\u8bfb\u6570-spi-nand-\u6570\u636e\u7684\u6d41\u7a0b",children:"4.3. \u8bfb\u6570 SPI NAND \u6570\u636e\u7684\u6d41\u7a0b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"mtd_read(); // drivers/mtd/mtdcore.c\n|-> mtd->_read_oob(mtd, from, &ops);\n    part_read_oob(mtd, from, ops); // drivers/mtd/mtdpart.c\n        spinand_mtd_read(mtd, from, &ops); // drivers/mtd/nand/spi/core.c\n        |-> spinand_read_page(spinand, &iter.req, enable_ecc);\n            |-> spinand_load_page_op(spinand, req);\n            |   |-> spi_mem_exec_op(spinand->slave, &op);\n            |       |   // drivers/spi/spi-mem-nodm.c\n            |       |-> spi_xfer(slave, op_len * 8, op_buf, NULL, flag);\n            |\n            |-> spinand_read_from_cache_op(spinand, req);\n                |-> spi_mem_exec_op(spinand->slave, &op);\n                    |-> spi_xfer(slave, op_len * 8, op_buf, NULL, flag);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"5-spi-nor-\u52a0\u8f7d",children:"5. SPI NOR \u52a0\u8f7d"}),"\n",(0,i.jsx)(n.p,{children:"common/spl/spl_spi.c \u4e2d\u901a\u8fc7\u5b8f\u6ce8\u518c\u4e86 SPI NOR \u7684\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'SPL_LOAD_IMAGE_METHOD("SPI", 1, BOOT_DEVICE_SPI, spl_spi_load_image);\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 SPL \u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\uff0c\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"boot_from_devices(spl_boot_list)"})," \u51fd\u6570\u8c03\u7528\uff0c\u68c0\u67e5\u5f53\u524d\u9879\u76ee \u6240\u652f\u6301\u7684 SPL \u8bfb\u53d6\u7684\u5b58\u50a8\u4ecb\u8d28\u7c7b\u578b\uff0c\u7136\u540e\u4f9d\u6b21\u68c0\u67e5\u662f\u5426\u5b58\u5728\u5bf9\u5e94\u7684\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"board_init_r()    // common/spl/spl.c\n|-> boot_from_devices(spl_boot_list)\n    |-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n            // \u8fd9\u91cc\u53ef\u80fd\u662f\u5404\u79cd\u4ecb\u8d28\u7684 load image \u51fd\u6570\n            // SPL_LOAD_IMAGE_METHOD() \u5b9a\u4e49\u7684 Loader\n            // \u53ef\u80fd\u662f MMC/SPI/BROM/...\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u627e\u5230 SPL SPI NOR Loader \u4e4b\u540e\uff0c\u4ece\u9879\u76ee\u914d\u7f6e\u7684\u6307\u5b9a\u4f4d\u7f6e\u8bfb\u53d6\u6570\u636e\u3002"}),"\n",(0,i.jsx)(n.p,{children:"SPI NOR \u52a0\u8f7d\u5668\u9700\u8981\u7f16\u8bd1\u65f6\u914d\u7f6e\u6240\u7528\u7684 SPI \u4fe1\u606f\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CONFIG_SF_DEFAULT_BUS"}),"\n",(0,i.jsx)(n.li,{children:"CONFIG_SF_DEFAULT_CS"}),"\n",(0,i.jsx)(n.li,{children:"CONFIG_SF_DEFAULT_SPEED"}),"\n",(0,i.jsx)(n.li,{children:"CONFIG_SF_DEFAULT_MODE"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u8bfb\u53d6\u6570\u636e\u7684\u4f4d\u7f6e\u901a\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\u6307\u5b9a:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CONFIG_SYS_SPI_U_BOOT_OFFS"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"boot_from_devices(spl_boot_list); // common/spl/spl.c\n|-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n|   // \u6b64\u5904\u901a\u8fc7\u904d\u5386\u56fa\u4ef6\u7684 .u_boot_list_2_spl_image_loader_* \u6bb5\n|   // \u627e\u5230\u5f53\u524d\u652f\u6301\u7684\u5b58\u50a8\u4ecb\u8d28\uff0c\u7136\u540e\u9010\u4e2a\u5c1d\u8bd5\n|\n|-> spl_load_image(loader);\n    |-> loader->load_image(spl_image, &bootdev);\n        spl_spi_load_image();  // common/spl/spl_spi.c\n        |-> spi_flash_probe();\n        |-> spl_get_load_buffer(-sizeof(*header), sizeof(*header));\n        |-> spi_flash_read(header);\n        |-> spl_parse_image_header();\n        |-> spi_flash_read();\n            |-> spi_flash_read_dm(flash->dev, offset, len, buf);\n                |-> sf_get_ops(dev)->read(dev, offset, len, buf);\n                    spi_flash_std_read(dev, offset, len, buf);\n                    | // drivers/mtd/spi/sf_probe.c\n                    |-> mtd->_read(mtd, offset, len, &retlen, buf);\n                            spi_flash_mtd_read(mtd, offset, len, &retlen, buf);\n                            // drivers/mtd/spi/sf_mtd.c\n"})}),"\n",(0,i.jsx)(n.h2,{id:"6-sdfat32-\u52a0\u8f7d",children:"6. SDFAT32 \u52a0\u8f7d"}),"\n",(0,i.jsx)(n.p,{children:"SDFAT32\u542f\u52a8\u65b9\u5f0f\u66f4\u4e3a\u7b80\u5355\uff0c\u4e0d\u9700\u8981\u4e13\u4e1a\u7684\u70e7\u5f55\u5de5\u5177\u8fdb\u884c\u70e7\u5199\uff0c\u53ea\u9700\u8981\u5c06\u955c\u50cf\u6587\u4ef6\u590d\u5236\u5230SD\u5361\u5373\u53ef\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/load_diff-17066876090051.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/load_diff.png"})}),"\n",(0,i.jsxs)(n.p,{children:["\u56fe 3.3 ",(0,i.jsx)(n.em,{children:"MMC\u4e0eSD\u5361\u542f\u52a8\u5dee\u5f02"})]}),"\n",(0,i.jsx)(n.p,{children:"SDFAT32\u662f\u57fa\u4e8eMMC\u5efa\u7acb\u7684\uff0c\u52a0\u8f7d\u7a0b\u5e8f\u4e5f\u5728spl_mmc.c\u4e2d\u5b9e\u73b0\uff0c\u901a\u8fc7\u4f7f\u7528\u5b8f\uff1a"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"SPL_LOAD_IMAGE_METHOD(\u201cMMC2\u201d, 0, BOOT_DEVICE_MMC2, spl_mmc_load_image);"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5c06 ",(0,i.jsx)(n.code,{children:"spl_mmc_load_image"})," \u51fd\u6570\u6dfb\u52a0\u5230 .u_boot_list_2_spl_image_loader_* \u6bb5\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u5728board_init_r(gd_t *dummy1, ulong dummy2)\u51fd\u6570\u4e2d\uff0c\u4f1a\u8c03\u7528boot_from_devices\u4ecedevice\u4e2d\u53bb\u9009\u62e9\u542f\u52a8\u4ecb\u8d28\uff0c\u901a\u8fc7\u542f\u52a8\u4ecb\u8d28\u9009\u62e9\u5bf9\u5e94\u7684\u52a0\u8f7d\u7a0b\u5e8f\uff0c\u83b7\u53d6\u542f\u52a8\u955c\u50cf\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"// source/uboot-2021.10/common/spl/spl.c\nboot_from_devices\n|   // \u8fd9\u91cc\u4f1a\u4f20\u9012\u4e00\u4e2a\u7a7a\u7684spl_image_info\u7ed3\u6784\u4f53\uff0c\u4ee5\u53ca\u4f20\u9012\u4e00\u4e2a\u542f\u52a8\u8bbe\u5907\u7684\u5217\u8868\uff0c\u8fd9\u91cc\u4e3a\u7b2c\u4e00\u4e2a\u503c\u4e3aBOOT_DEVICE_MMC2\n|->spl_ll_find_loader(bootdev); // bootdev=BOOT_DEVICE_MMC2,\u6839\u636ebootdev\u67e5\u627espl_load_image\u6307\u9488\n|->spl_load_image(spl_image, loader); // \u8fd9\u91cc\u5df2\u7ecf\u83b7\u53d6\u5230\u5bf9\u5e94\u542f\u52a8\u8bbe\u5907\u7684\u52a0\u8f7d\u5668\n        |->loader->load_image(spl_image, &bootdev); // \u8c03\u7528\u52a0\u8f7d\u5668\u7684\u5b9e\u73b0\u51fd\u6570spl_mmc_load_image\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8fdb\u5165\u5230\u5bf9\u5e94\u542f\u52a8\u4ecb\u8d28\u7684\u52a0\u8f7d\u7a0b\u5e8f\u4e2d\uff0c\u901a\u8fc7CONFIG_SPL_FS_LOAD_PAYLOAD_NAME\u6307\u5b9a\u542f\u52a8\u955c\u50cf\u914d\u7f6e\u6587\u4ef6\uff0c\u4ece\u4e2d\u83b7\u53d6\u955c\u50cf\u5728SD\u5361\u4e2d\u7684\u5b9e\u9645\u5730\u5740\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'// source/uboot-2021.10/common/spl/spl_fat.c\nspl_mmc_load_image\n|->spl_mmc_load(spl_image, bootdev,...); // \u8fd9\u91ccCONFIG_SPL_FS_LOAD_PAYLOAD_NAME=bootcfg.txt\n    |->spl_mmc_find_device(&mmc, bootdev->boot_device); // \u5148\u627emmc\u8bbe\u5907\n    |->mmc_init(mmc); // \u518d\u8fdb\u884cmmc\u8bbe\u5907\u7684\u521d\u59cb\u5316\n    |->spl_mmc_boot_mode(bootdev->boot_device);\n    |       // \u9009\u62e9\u542f\u52a8\u65b9\u5f0f\uff0c\u8fd9\u91cc\u83b7\u53d6\u5230\u7684\u662fMMCSD_MODE_FS\u65b9\u5f0f\u542f\u52a8\n    |->spl_mmc_do_fs_boot(spl_image, mmc, filename); // filename\u4e3abootcfg.txt\n        |->aic_spl_load_image_fat(spl_image, mmc_get_blk_desc(mmc), filename);\n            |->blk_dread(cur_dev, 0, 1, header);\n            |       // \u8bfb\u53d6SD\u5361\u7684\u7b2c0\u5757\u3002\n            |->check_identifier(header); // \u68c0\u6d4bSD\u5361\u7684\u5206\u533a\u7c7b\u578b\u9009\u62e9\u542f\u52a8\u65b9\u5f0f\n            |->load_image_from_mbr_part_fat32(header, filename); // \u4ee5MBR\u5206\u533a\u683c\u5f0f\u53bb\u52a0\u8f7d\u955c\u50cf\n                |->blk_dread(cur_dev, part.lba_start, 1, header);\n                |   // \u8bfb\u53d6LBA\u8d77\u59cb\u5730\u5740\n                |->check_identifier(header); // \u68c0\u6d4bSD\u5361\u5206\u533a\u7c7b\u578b\u662f\u5426\u4e3aFAT32\n                |->load_image_from_raw_volume_fat32(part.lba_start, header, filename);\n                |   // \u83b7\u53d6BPB\u5185\u5bb9\n                    |->load_image_file(header, filename);\n                        |->aic_fat_read_file(filename, (u8 *)header, 0, 1024, &actread);\n                        |   // \u67e5\u627e\u5e76\u8bfb\u53d6bootcfg.txt\u6587\u4ef6\u5185\u5bb9\u5230header\u5730\u5740\n                        |->boot_cfg_parse_file((u8 *)header, actread, "boot1", ...);\n                        |   // \u89e3\u6790bootcfg.txt\u4fe1\u606f\uff0c\u83b7\u53d6image\u540d\u79f0\uff0c\u89e3\u6790U-Boot\u7684\u5927\u5c0f\uff0c\u4ee5\u53ca\u76f8\u5bf9\n                        |   // image\u6587\u4ef6\u4e2dU-Boot\u6240\u5728\u7684\u504f\u79fb\u5730\u5740\n                        |->aic_fat_read_file(imgname, header, ...); //\u8bfb\u53d6image\u6587\u4ef6\u7684header\n                        |->spl_parse_image_header(spl_image, header);\n                        |   // \u89e3\u6790U-Boot\u4e2d\u524d64\u4e2a\u5b57\u8282\u5185\u5bb9\uff0c\u8bbe\u7f6e\u52a0\u8f7d\u5730\u5740\n                        |->aic_fat_read_file(imgname, (u8 *)spl_image->load_addr, ...);\n                        |   // \u8bfb\u53d6U-Boot\u955c\u50cf\u5230spl_image->load_addr\u5730\u5740\u3002\n                        |->board_init_r(); // \u8df3\u8f6c\u56deboard_init_r()\u7ee7\u7eed\u6267\u884c\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u8bfb\u53d6U-Boot\u955c\u50cf\u5230\u5185\u5b58\u540e\uff0c\u8df3\u8f6c\u56deboard_init_r()\u7ee7\u7eed\u6267\u884c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"// source/uboot-2021.10/common/spl/spl.c\nboard_init_r()\n|->spl_perform_fixups // vendor hook\uff0c\u7528\u4e8e\u4fee\u6539device-tree\u4f20\u9012\u53c2\u6570\n|->jump_to_image_no_args(&spl_image);\n    |->image_entry = (image_entry_withargs_t)spl_image->entry_point; // \u83b7\u53d6U-Boot\u52a0\u8f7d\u5730\u5740\n    |->set_boot_device(boot_param, aic_get_boot_device()); // \u8bbe\u7f6e\u542f\u52a8\u4ecb\u8d28\n    |->set_boot_reason(boot_param, aic_get_boot_reason()); // \u8bbe\u7f6e\u542f\u52a8\u539f\u56e0\uff08\u51b7\u542f\u52a8\u6216\u8005\u70ed\u542f\u52a8\uff09\n    |->image_entry(boot_param, cur_tm); // \u8fdb\u5165U-Boot\u6267\u884c\uff0c\u5e76\u4f20\u9012\u4e00\u4e9b\u53c2\u6570\n"})}),"\n",(0,i.jsx)(n.h2,{id:"7-\u7b7e\u540d\u6821\u9a8c",children:"7. \u7b7e\u540d\u6821\u9a8c"}),"\n",(0,i.jsx)(n.p,{children:"U-Boot \u5b98\u65b9\u7684\u4ee3\u7801\uff0cSPL \u652f\u6301 FIT image \u7684\u7b7e\u540d\u3002\u5982\u679c\u56fa\u4ef6\u4f7f\u7528\u5176\u4ed6\u683c\u5f0f\uff0c \u9700\u8981\u81ea\u884c\u6dfb\u52a0\u76f8\u5e94\u7684\u6821\u9a8c\u652f\u6301\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"71-fit-image-\u7b7e\u540d\u6821\u9a8c",children:"7.1. FIT Image \u7b7e\u540d\u6821\u9a8c"}),"\n",(0,i.jsx)(n.p,{children:"\u8981\u5b9e\u73b0\u9a8c\u8bc1 FIT Image \u7684\u7b7e\u540d\uff0c\u9700\u8981\u5728\u914d\u7f6e\u4e2d\u6253\u5f00\u9009\u9879\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CONFIG_SPL_FIT_SIGNATURE"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'mmc_load_image_raw_sector(); // common/spl/spl_mmc.c\n|-> spl_get_load_buffer(-sizeof(*header), bd->blksz);\n|-> blk_dread(bd, sector, 1, header);\n|-> image_get_magic(header) == FDT_MAGIC // \u5224\u65ad\u662f\u5426\u4e3a FIT Image\n|-> spl_load_simple_fit(spl_image, &load, sector, header); // common/spl/spl_fit.c\n    |-> info->read(info, sector, sectors, fit);\n    |   h_spl_load_read(info, sector, sectors, fit); // common/spl/spl_mmc.c\n    |   |-> blk_dread(mmc_get_blk_desc(mmc), sector, count, buf);\n    |-> node = spl_fit_get_image_node(fit, images, "loadables", 0);\n        |-> spl_load_fit_image(info, sector, fit, base_offset, node,\n            |                 spl_image); // common/spl/spl_fit.c\n            |-> // \u4e2d\u95f4\u52a0\u8f7d\u8fc7\u7a0b\n            |-> fit_image_verify_with_data(fit, node, src, length);\n                | // common/image-fit.c\n                |-> fit_image_check_sig(fit, noffset, data, size, -1, &err_msg);\n                    |  // common/image-sig.c\n                    |-> fit_image_setup_verify();\n                    |-> fit_image_hash_get_value();\n                    |-> info.crypto->verify(&info, &region, 1,\n                                            fit_value, fit_value_len);\n                        rsa_verify(&info, &region, 1,\n                                   fit_value, fit_value_len);\n                                   // lib/rsa/rsa-verify.c\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u6b64\u5904\u7684 rsa-verify \u53ef\u4ee5\u5bf9\u63a5\u5230\u786c\u4ef6 CE\uff0c\u5177\u4f53\u53ef\u770b ",(0,i.jsx)(n.code,{children:"UCLASS_MOD_EXP"})," \u7684\u76f8\u5173\u5185\u5bb9\u3002 \u5982\u679c\u6ca1\u6709\u786c\u4ef6\u52a0\u901f\u5668\u7684\u5b9e\u73b0\uff0c\u5219\u4f7f\u7528\u8f6f\u4ef6\u8fdb\u884c\u8ba1\u7b97\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"72-aic-image-\u7b7e\u540d\u6821\u9a8c",children:"7.2. AIC Image \u7b7e\u540d\u6821\u9a8c"}),"\n",(0,i.jsx)(n.p,{children:"\u5236\u4f5c SD \u91cf\u4ea7\u5361\u65f6\uff0c\u7531\u4e8e Updater U-Boot \u56fa\u4ef6\u9700\u8981\u4f7f\u7528 AIC Image \u683c\u5f0f\uff0c \u56e0\u6b64 SD \u91cf\u4ea7\u5361\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0c SPL-Updater \u9700\u8981\u89e3\u6790 AIC Image \u683c\u5f0f\u3002"}),"\n",(0,i.jsx)(n.p,{children:"(TODO: \u9700\u8981\u4fee\u6539\u539f\u672c\u6d41\u7a0b\uff0c\u6dfb\u52a0 AIC \u683c\u5f0f\u7684\u652f\u6301)"}),"\n",(0,i.jsx)(n.p,{children:"Updater U-Boot \u5728\u4e24\u79cd\u60c5\u51b5\u4e0b\u4f1a\u88ab\u4f7f\u7528\u3002\u7b2c\u4e00\u79cd\u60c5\u51b5\u662f\u901a\u8fc7 USB \u5347\u7ea7\u65f6\uff0cUpdater U-Boot \u901a\u8fc7 BROM \u4e0b\u8f7d\u5230 DRAM\uff0c\u5e76\u4e14\u7531 BROM \u6267\u884c\u3002\u7b2c\u4e8c\u79cd\u60c5\u51b5\u662f\u5c06\u5176\u70e7\u5f55\u5230 SD \u91cf\u4ea7\u5361\uff0c \u4ece SD \u5361\u542f\u52a8\u5230 Updater U-Boot \u8fdb\u5165\u5347\u7ea7\u7a0b\u5e8f\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u4e3a\u4e86\u5e73\u53f0\u7684\u5b89\u5168\uff0cBROM \u6240\u6267\u884c\u7684\u7a0b\u5e8f\u5fc5\u987b\u7ecf\u8fc7\u5b89\u5168\u9a8c\u8bc1\uff0cBROM \u53ea\u652f\u6301 AIC Image \u683c\u5f0f\u7684\u56fa\u4ef6\uff0c\u56e0\u6b64\u8fd9\u91cc Updater U-Boot \u5fc5\u987b\u4f7f\u7528 AIC Image \u683c\u5f0f\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"8-\u8fd4\u56de-brom",children:"8. \u8fd4\u56de BROM"}),"\n",(0,i.jsx)(n.p,{children:"\u5728 USB \u5347\u7ea7\u7684\u5e94\u7528\u4e2d\uff0c\u4e3b\u673a\u901a\u8fc7 USB \u4e0b\u8f7d SPL \u5230 SRAM\uff0c\u5e76\u4e14\u7531 BROM \u8df3\u8f6c\u6267\u884c\uff0cSPL \u4ee3\u7801\u5bf9 DDR \u521d\u59cb\u5316\u7ed3\u675f\u4e4b\u540e\u9700\u8981\u8fd4\u56de\u5230 BROM \u4e2d\u7ee7\u7eed\u6267\u884c\u4e0b\u8f7d\u5176\u4ed6\u6570\u636e\u7684\u64cd\u4f5c\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u79cd\u5e94\u7528\u573a\u666f\u4e2d\uff0c\u5c06\u8fd4\u56de BROM \u770b\u505a\u662f\u4ece BROM \u4e2d\u52a0\u8f7d\u6570\u636e\uff0c\u56e0\u6b64\u8fd4\u56de BROM \u88ab\u5b9e\u73b0\u4e3a\u4e00\u4e2a\u7a0b\u5e8f\u52a0\u8f7d\u5668\u3002"}),"\n",(0,i.jsx)(n.p,{children:"common/spl/spl_bootrom.c \u4e2d\u901a\u8fc7\u6ce8\u518c BOOT_DEVICE_BOOTROM \u6765\u5b9e\u73b0\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'SPL_LOAD_IMAGE_METHOD("BOOTROM", 0, BOOT_DEVICE_BOOTROM, spl_return_to_bootrom);\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u5177\u4f53\u8fd4\u56de\u7684\u51fd\u6570\u662f ",(0,i.jsx)(n.code,{children:"board_return_to_bootrom()"})," \u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"board_init_r()    // common/spl/spl.c\n|-> board_boot_order()\n|   |-> spl_boot_device(); // arch/arm/mach-artinchip/spl.c\n|       |-> aic_get_boot_device(); // arch/arm/mach-artinchip/boot_param.c\n|           // \u4ece boot param \u4e2d\u83b7\u53d6\u542f\u52a8\u4ecb\u8d28\u4fe1\u606f\uff0c\n|           // \u6b64\u5904\u8fd4\u56de BD_BOOTROM\n|\n|-> boot_from_devices(spl_boot_list)\n    |-> spl_ll_find_loader()  // \u6839\u636eboot device\u627e\u5230spl_load_image\u6307\u9488\n    |       // \u8fd9\u91cc\u53ef\u80fd\u662f\u5404\u79cd\u4ecb\u8d28\u7684 load image \u51fd\u6570\n    |       // SPL_LOAD_IMAGE_METHOD() \u5b9a\u4e49\u7684 Loader\n    |       // \u6b64\u5904\u627e\u5230\u7684\u662f BOOT_DEVICE_BOOTROM\n    |\n    |-> spl_return_to_bootrom();// common/spl/spl_bootrom.c\n        |-> board_return_to_bootrom();\n            // arch/arm/mach-artinchip/lowlevel_init.S\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 ",(0,i.jsx)(n.a,{href:"../boot_param_1602/index.html#ref-boot-param-1602",children:"\u542f\u52a8\u53c2\u6570"})," \u7ae0\u8282\u63cf\u8ff0\u4e86 BROM \u8df3\u8f6c SPL \u8fd0\u884c\u65f6\u6240\u4f20\u9012\u7684\u53c2\u6570\uff0cSPL \u5728\u5f00\u59cb\u8fd0\u884c\u65f6\u5df2\u7ecf\u4fdd\u5b58\u4e86 BROM \u8df3\u8f6c\u65f6\u7684\u6240\u6709\u91cd\u8981\u5bc4\u5b58\u5668\uff0c\u56e0\u6b64\u5728 ",(0,i.jsx)(n.code,{children:"board_return_to_bootrom()"})," \u53ef\u4ee5\u901a\u8fc7\u6062\u590d\u73b0\u573a\uff0c\u5b9e\u73b0\u8fd4\u56de\u3002"]})]})}function t(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},1151:(e,n,_)=>{_.d(n,{Z:()=>l,a:()=>r});var i=_(7294);const o={},d=i.createContext(o);function r(e){const n=i.useContext(d);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);