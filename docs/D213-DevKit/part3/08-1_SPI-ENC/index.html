<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-D213-DevKit/part3/08-1_SPI-ENC" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">SPI ENC | 东山Π</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://artinchip.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://artinchip.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://artinchip.100ask.net/docs/D213-DevKit/part3/08-1_SPI-ENC"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SPI ENC | 东山Π"><meta data-rh="true" name="description" content="1. 模块介绍"><meta data-rh="true" property="og:description" content="1. 模块介绍"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://artinchip.100ask.net/docs/D213-DevKit/part3/08-1_SPI-ENC"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part3/08-1_SPI-ENC" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part3/08-1_SPI-ENC" hreflang="en"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part3/08-1_SPI-ENC" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d875fe7e.css">
<script src="/assets/js/runtime~main.981e9d4c.js" defer="defer"></script>
<script src="/assets/js/main.abeb38c7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">东山Π</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/D213-DevKit/BoardIntroduction">D213-DevKit</a><a class="navbar__item navbar__link" href="/docs/category/luban-sdk使用指南">Luban-SDK</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/D213-DevKit/part3/08-1_SPI-ENC" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/en/docs/D213-DevKit/part3/08-1_SPI-ENC" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/ArtInChip-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/BoardIntroduction">匠心创D213-DevKit开发板</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/SupportingResources">源码工具文档手册</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/快速启动">快速启动</a><button aria-label="展开侧边栏分类 &#x27;快速启动&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/ConfigHostEnv">安装并配置开发环境</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/luban-sdk开发">Luban-SDK开发</a><button aria-label="展开侧边栏分类 &#x27;Luban-SDK开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/luban-linux系统开发">Luban-Linux系统开发</a><button aria-label="折叠侧边栏分类 &#x27;Luban-Linux系统开发&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/04-1_BWMUserGuide">BWM 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/04-2_CMUUserGuide">CMU 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/04-3_DMABook">DMA 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/04-4_RTCUserGuide">RTC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/04-5_TSensorUserGuide">TSensor 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/04-6_WatchdogUserGuide">Watchdog 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/04-7_WRIUserGuide">WRI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/05-1_SDMCUserGuide">SDMC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/05-2_SPI_NANDUserGuide">SPI NAND 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/05-3_SPI_NORUserGuide">SPI NOR 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/05-4_FileSystemUserGuide">文件系统使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/06-1_GE-Useguide">GE 开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/06-2_VE-Useguide">VE 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/06-3_Display-Useguide">Display 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/06-4_DVP-Useguide">DVP开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/06-8_I2S-Useguide">I2S 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/06-9_AudioCodec-Useguide">AudioCodec 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-1_CAN-Useguide">CAN 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-2_ CIR-Useguide">CIR 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-3_ GPAI-Useguide">GPAI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-4_I2C-Useguide">I2C 开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-5_MAC-Useguide">MAC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-6_PBus-Useguide">PBus 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-7_PINCTRL-Useguide">PINCTRL 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-8_PWM-Useguide">PWM 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-9_RTP-Useguide">RTP 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-10_SPI-Useguide">SPI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-11_UART-Useguide">UART 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-12_USB-Useguide">USB 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/07-13_PSADC-Useguide">PSADC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/D213-DevKit/part3/08-1_SPI-ENC">SPI ENC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/08-2_CE-Useguide">CE 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/08-3_eFuse-Useguide">eFuse 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/08-4_HardwareAuthorizationCertification">硬件授权认证</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/10-1_TouchscreenDebuggingGuide">触摸屏调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/10-2_DisplayDebuggingGuide">显示屏调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/10-3_WiFiDebuggingGuide">WiFi调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part3/10-4_GuideToUsingTheKeyMatrix">按键矩阵使用指南</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux-bringup参考">Linux-Bringup参考</a><button aria-label="展开侧边栏分类 &#x27;Linux-Bringup参考&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux-uboot开发">Linux-Uboot开发</a><button aria-label="展开侧边栏分类 &#x27;Linux-Uboot开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/luban-linux系统开发"><span itemprop="name">Luban-Linux系统开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SPI ENC</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>SPI ENC</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-模块介绍">1. 模块介绍<a href="#1-模块介绍" class="hash-link" aria-label="1. 模块介绍的直接链接" title="1. 模块介绍的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-术语定义">1.1. 术语定义<a href="#11-术语定义" class="hash-link" aria-label="1.1. 术语定义的直接链接" title="1.1. 术语定义的直接链接">​</a></h3>
<table><thead><tr><th>术语</th><th>定义</th><th>注释说明</th></tr></thead><tbody><tr><td>AES</td><td>Advanced Encryption Standard</td><td>一种对称分组密钥算法</td></tr><tr><td>ECB</td><td>Electronic Code Book</td><td>电子密码本模式</td></tr><tr><td>CTR</td><td>Counter</td><td>计数器模式</td></tr><tr><td>SPI</td><td>Serial Peripheral Interface</td><td>串行外设接口</td></tr><tr><td>BROM</td><td>Boot ROM</td><td>固化在芯片中的启动程序</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-模块简介">1.2. 模块简介<a href="#12-模块简介" class="hash-link" aria-label="1.2. 模块简介的直接链接" title="1.2. 模块简介的直接链接">​</a></h3>
<p>SPI_ENC 是一个对 SPI 总线上的数据进行在线加密和解密的模块。 使用该模块，可实现对 CPU 透明的 SPI 数据加密存储，即 CPU 对 SPI 存储设备的读写数据都是明文， 但存储在 SPI 设备上的数据是密文，数据的加密和解密操作在 SPI 总线数据传输过程中完成。</p>
<p>SPI_ENC 具备下列功能特性：</p>
<blockquote>
<ul>
<li>使用 AES-128-CTR 加密和解密</li>
<li>可通过配置连接到不同的 SPI 控制器</li>
<li>可通过 eFuse 配置密钥</li>
<li>支持明文和密文混合传输</li>
<li>不影响 SPI 总线传输带宽</li>
<li>不支持 SPI 全双工模式</li>
<li>使用所连接的 SPI 控制器的 HCLK</li>
<li>内置 64 字节分组密钥 Buffer</li>
<li>支持空 Page 检测</li>
</ul>
</blockquote>
<p>用途：</p>
<blockquote>
<ul>
<li>可用于实现 SPI NAND / SPI NOR 的全盘加密</li>
<li>SPI NAND / SPI NOR 上的固件防拷贝</li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-原理框图">1.3. 原理框图<a href="#13-原理框图" class="hash-link" aria-label="1.3. 原理框图的直接链接" title="1.3. 原理框图的直接链接">​</a></h3>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_block_diagram2-17067679072711.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_block_diagram2.png" class="img_ev3q"></p>
<p>图 8.6 <em>SPI ENC 原理框图</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-参数配置">2. 参数配置<a href="#2-参数配置" class="hash-link" aria-label="2. 参数配置的直接链接" title="2. 参数配置的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-内核配置">2.1. 内核配置<a href="#21-内核配置" class="hash-link" aria-label="2.1. 内核配置的直接链  接" title="2.1. 内核配置的直接链接">​</a></h3>
<p>使能 SPI_ENC 相关的内核驱动，可在通过下列命令进行配置（在 SDK 顶层目录执行）:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make linux-menuconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在内核的配置界面中，进行下列的选择:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Cryptographic API  ---&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [*]   Hardware crypto devices  ---&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [*]   Support for artinchip cryptographic accelerator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;*&gt;     Artinchip&#x27;s SPI Bus on-the-fly encryption driver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>进行如上的配置之后，内核 SPI_ENC 驱动使能，SPI NOR / SPI NAND 驱动在数据访问时， 自动进行数据加解密。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-dts-配置">2.2. DTS 配置<a href="#22-dts-配置" class="hash-link" aria-label="2.2. DTS 配置的直接链接" title="2.2. DTS 配置的直接链接">​</a></h3>
<p>芯片级的 DTS:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spienc: spienc@18100000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compatible = &quot;artinchip,aic-spienc-v1.0&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reg = &lt;0x18100000 0x1000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interrupts-extended = &lt;&amp;plic0 41 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clocks = &lt;&amp;cmu CLK_SPIENC&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resets = &lt;&amp;rst RESET_SPIENC&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aic,spienc-tweak = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中板级的配置 <code>board.dts</code> 中需要使能该模块:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&amp;spienc {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aic,spienc-tweak = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>board-u-boot.dtsi</code> 需要设置 <code>u-boot,dm-pre-reloc</code> ，只有设置了该标记，SPL 中才可以使用 SPI_ENC:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&amp;spienc {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u-boot,dm-pre-reloc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>DTS 中的 <code>aic,spienc-tweak</code> 可以影响 COUNTER 的生成，进而改变加密的结果。 如果需要让在不同的产品对相同的数据有不同的加密结果，则可以在 DTS 中调整该值。</p>
<p>并且需要配置具体的 SPI NAND / SPI NOR 设备是否使能加密:</p>
<blockquote>
<ul>
<li><code>aic,encrypt</code></li>
<li><code>aic,spi-id</code></li>
</ul>
</blockquote>
<p>例如： <code>board.dts</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&amp;spi0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-names = &quot;default&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-0 = &lt;&amp;spi0_pins_a&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spi-flash@0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #address-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #size-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        compatible = &quot;spi-nand&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spi-max-frequency = &lt;24000000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spi-tx-bus-width = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spi-rx-bus-width = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reg = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aic,encrypt;            // 标记该存储设备使能 SPI_ENC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aic,spi-id = &lt;0&gt;;       // 设置当前存储设备所挂载的 SPI 控制器 ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;spi1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-names = &quot;default&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-0 = &lt;&amp;spi1_pins_a&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spi-flash@0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #address-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #size-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        compatible = &quot;jedec,spi-nor&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spi-max-frequency = &lt;24000000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spi-tx-bus-width = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spi-rx-bus-width = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reg = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aic,encrypt;            // 标记该存储设备使能 SPI_ENC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aic,spi-id = &lt;1&gt;;       // 设置当前存储设备所挂载的 SPI 控制器 ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-密钥配置">2.3. 密钥配置<a href="#23-密钥配置" class="hash-link" aria-label="2.3. 密钥配置的直接链接" title="2.3. 密钥配置的直接链接">​</a></h3>
<p>SPI_ENC 模块使用 AES-128-CTR 算法对 SPI 总线数据进行加解密，该算法在计算时的密钥有两部分</p>
<blockquote>
<ul>
<li>128 bit AES 密钥(KEY)</li>
<li>128 bit 数据块的 COUNTER 值</li>
</ul>
</blockquote>
<p>其中 KEY 直接使用 eFuse 中的 <code>SPI_ENC_KEY</code> ，COUNTER 值则由几部分共同产生</p>
<blockquote>
<ul>
<li>eFuse 中的 <code>SPI_ENC_NONCE</code></li>
<li>DTS 中配置的 <code>aic,spienc-tweak</code></li>
<li>访问数据所在的地址 <code>address</code></li>
</ul>
</blockquote>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_counter_value1-17067679436853.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_counter_value1.png" class="img_ev3q"></p>
<p>图 8.7 <em>COUNTER 值的生成</em></p>
<p>因此在使能 SPI_ENC 时，需要设置以下的 eFuse 信息：</p>
<table><thead><tr><th>eFuse 区域</th><th>大小(BIT)</th><th>说明</th></tr></thead><tbody><tr><td>SPI_ENC_KEY</td><td>128</td><td>AES 密钥，烧录后应设置不可读写</td></tr><tr><td>SPI_ENC_NONCE</td><td>64</td><td>用于生成 COUTNER 的随机数，烧录后应设置不可读写</td></tr><tr><td>SPI_ENC_ENABLE BIT</td><td>1</td><td>使能 BROM 的 SPI_ENC 功能，才可正确启动</td></tr></tbody></table>
<p>具体 eFuse 区域的地址，请参考芯片的数据手册。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-调试指南">3. 调试指南<a href="#3-调试指南" class="hash-link" aria-label="3. 调试指南的直接链接" title="3. 调试指南的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-调试开关">3.1. 调试开关<a href="#31-调试开关" class="hash-link" aria-label="3.1. 调试开关的直接链接" title="3.1. 调试开关的直接链接">​</a></h3>
<p>可通过内核配置使能 SPI_ENC 模块的 DEBUG 选项。在 SDK 根目录下执行:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make linux-menuconfig (or make km)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>进入内核的配置界面:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Kernel hacking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Artinchip Debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*] SPI ENC driver debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>勾选使能该 DEBUG 选项后：</p>
<blockquote>
<ol>
<li>SPI_ENC 的驱动源码将以 <code>-O0</code> 编译</li>
<li>SPI_ENC 驱动中的 pr_dbg() 和 dev_dbg() 调试信息会被编译</li>
<li>Sysfs 中新增 <code>/sys/devices/platform/soc/18100000.spienc/bypass</code> 节点</li>
</ol>
</blockquote>
<p>如果需要看到 pr_dbg() 和 dev_dbg() 的打印信息，还需要设置 <code>loglevel=8</code> 。</p>
<p>若需要在启动过程中即可看到打印，需要在 <code>env.txt</code> 中修改 bootargs，增加 <code>loglevel=8</code> 。 若仅需要在板子启动到 Linux shell 后使能相关打印，可以通过下列命令调整 loglevel：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo 8 &gt; /proc/sys/kernel/printk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-sysfs-节点">3.2. Sysfs 节点<a href="#32-sysfs-节点" class="hash-link" aria-label="3.2. Sysfs 节点的直接链接" title="3.2. Sysfs 节点的直接链接">​</a></h3>
<p>SPI_ENC 驱动在 <code>/sys/devices/platform/soc/</code> 目录下创建了 Sysfs 节点 <code>18100000.spienc/</code></p>
<p>其中通过下列命  令可读取当前硬件状态：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat /sys/devices/platform/soc/18100000.spienc/status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果按照上一节的指引，使能了调试开关，还可以看到节点：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/sys/devices/platform/soc/18100000.spienc/bypass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过下列命令，可以开关 ByPass SPIENC 加密功能：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;1&quot; &gt; /sys/devices/platform/soc/18100000.spienc/bypass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;0&quot; &gt; /sys/devices/platform/soc/18100000.spienc/bypass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ByPass 之后，读写 SPI 存储的数据都是原始数据，不会做加密或者解密。</p>
<p>小技巧</p>
<p>Bypass 是一个调试功能，如果没有按照上节的指引勾选 [*] SPI ENC driver debug，则 Sysfs 中没有 bypass 文件节点。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-测试指南">4. 测试指南<a href="#4-测试指南" class="hash-link" aria-label="4. 测试指南的直接链接" title="4. 测试指南的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-测试的配置">4.1. 测试的配置<a href="#41-测试的配置" class="hash-link" aria-label="4.1. 测试的配置的直接链接" title="4.1. 测试的配置的直接链接">​</a></h3>
<blockquote>
<ol>
<li>需要按照 <a href="/docs/D213-DevKit/part3/3_debug_guide.html#ref-to-spienc-debug">调试指南</a> 使能调试开关</li>
<li>编译 mtd-util 中的 Flash 工具</li>
</ol>
</blockquote>
<p>mtd-util 的使能方法：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make menuconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后勾选：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Third-party packages  ---&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [*] mtd, jffs2 and ubi/ubifs tools  ---&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [*]   mtd_debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-测试的命令">4.2. 测试的命令<a href="#42-测试的命令" class="hash-link" aria-label="4.2. 测试的命令的直接链接" title="4.2. 测试的命令的直接链接">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug info &lt;device&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e.g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug info /dev/mtd0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>擦除数据：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug erase &lt;device&gt; &lt;offset&gt; &lt;len&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e.g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug erase /dev/mtd0 0x0 0x40000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>写入数据：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug write &lt;device&gt; &lt;offset&gt; &lt;len&gt; &lt;source-filename&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e.g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug write /dev/mtd0/ 0 0x40000 data.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>读取数据：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug read &lt;device&gt; &lt;offset&gt; &lt;len&gt; &lt;dest-filename&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e.g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug read /dev/mtd0/ 0 0x40000 data.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-读写的测试">4.3. 读写的测试<a href="#43-读写的测试" class="hash-link" aria-label="4.3. 读写的测试的直接链接" title="4.3. 读写的测试的直接链接">​</a></h3>
<p>测试写入到 Flash 的数据是否被加密：</p>
<blockquote>
<ol>
<li>
<p>写之前注意确认 SPI_ENC 没有被 Bypass</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat /sys/devices/platform/soc/18100000.spienc/bypass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>应得到</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bypass = 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>写入测试数据</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug write /dev/mtd0/ 0 0x40000 data.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Bypass SPI_ENC 然后读取 Flash Raw data</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;1&quot; &gt; /sys/devices/platform/soc/18100000.spienc/bypass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug read /dev/mtd0/ 0 0x40000 raw_data.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>对比两份数据，应该不同</p>
</li>
</ol>
</blockquote>
<p>测试 Bypass 写入的数据没有被加密：</p>
<blockquote>
<ol>
<li>
<p>设置 Bypass</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;1&quot; &gt; /sys/devices/platform/soc/18100000.spienc/bypass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>写入测试数据</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug write /dev/mtd0/ 0 0x40000 data.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>读取数据</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_debug read /dev/mtd0/ 0 0x40000 raw_data.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>对比两份数据，应该相同</p>
</li>
</ol>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-设计说明">5. 设计说明<a href="#5-设计说明" class="hash-link" aria-label="5. 设计说明的直接链接" title="5. 设计说明的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-源码说明">5.1. 源码说明<a href="#51-源码说明" class="hash-link" aria-label="5.1. 源码说明的直接链接" title="5.1. 源码说明的直接链接">​</a></h3>
<table><thead><tr><th>相关模块</th><th>源码路径</th></tr></thead><tbody><tr><td>Crypto subsystem</td><td>source/linux-5.10/crypto/</td></tr><tr><td>Driver</td><td>source/linux-5.10/drivers/crypto/artinchip/spienc/</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-模块架构">5.2. 模块架构<a href="#52-模块架构" class="hash-link" aria-label="5.2. 模块架构的直接链接" title="5.2. 模块架构的直接链接">​</a></h3>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_arch-17067680415425.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_arch.png" class="img_ev3q"></p>
<p>文件系统或者应用程序通过 MTD 层访问 SPI NOR / SPI NAND 设备的数据，SPI NOR / SPI NAND 驱动在通过 SPI 总线传输数据  。</p>
<p>在 SPI NOR / SPI NAND 驱动通过 SPI 总线访问相关数据时，其实需要发送一系列的命令来进行数据的读写。 这个过程中，命令通信的数据，包括一些读写 SPI NOR / SPI NAND 的寄存器数据都不能加密， 仅存储数据部分需要进行加密处理。因此，虽然 SPI_ENC 是在硬件总线上对数据进行加密， 但是软件使用时需要在 SPI NOR / SPI NAND 驱动 根据需要，提供必要的加解密信息（数据地址和长度）， 并且启动相应的数据传输加解密。</p>
<p>因此在软件层次上，SPI NOR / SPI NAND 驱动依赖 SPI 驱动以及 SPI_ENC 驱动，而 SPI 驱动与 SPI_ENC 驱动是并列关系。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-设计要点">5.3. 设计要点<a href="#53-设计要点" class="hash-link" aria-label="5.3. 设计要点的直接链接" title="5.3. 设计要点的直接链接">​</a></h3>
<p>在设计实现 SPI_ENC 的驱动时，主要考虑了 SPI_ENC 的本身特点，以及与 SPI NOR / SPI NAND 驱动的结合。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="531-融入内核加密子系统">5.3.1. 融入内核加密子系统<a href="#531-融入内核加密子系统" class="hash-link" aria-label="5.3.1. 融入内核加密子系统的直接链接" title="5.3.1. 融入内核加密子系统的直接链接">​</a></h4>
<p>内核加密子系统提供了一个框架，通过该框架提供了不同算法的对接方法， 常见的算法以及对应的硬件加速实现都可以通过该框架提供给使用者。</p>
<p>SPI_ENC 硬件模块实现了 AES-128-CTR 算法，但是由于 COUNTER 的生成方式是通过自定义规则生成， 密钥由硬件从 eFuse 中读取等，使得该算法与正常的 AES-128-CTR 不同，因此融入内核加密子系统时， <strong>将 SPI_ENC 抽象为一种特殊的 AES-128-CTR 算法实现</strong> ，通过 AES-128-CTR 的 API 进行使用， 但是做一些特殊处理。</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_kenerl_crypto_arch-17067680630857.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_kenerl_crypto_arch.png" class="img_ev3q"></p>
<p>图 8.8 <em>加入内核加密子系统</em></p>
<p>将 SPI_ENC 的 AES-128-CTR 算法注册到内核加密子系统：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static struct aic_spienc_alg spienc_alg = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .alg = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_name = &quot;ctr(aes)&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_driver_name = &quot;ctr-aes-spienc-aic&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_priority = 200,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_flags = CRYPTO_ALG_ASYNC |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  CRYPTO_ALG_ALLOCATES_MEMORY |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  CRYPTO_ALG_KERN_DRIVER_ONLY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_blocksize = 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_ctxsize = sizeof(struct aic_spienc_ctx),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_alignmask = 0xf,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .base.cra_module = THIS_MODULE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .init = aic_spienc_alg_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .decrypt = aic_spienc_decrypt,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .encrypt = aic_spienc_encrypt,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ivsize = AES_BLOCK_SIZE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设置说明：</p>
<blockquote>
<ul>
<li><code>cra_blocksize</code>: 设置为 1，即使用本算法，可以按字节设置加解密的数据长度。</li>
<li><code>ivsize</code>: 设置为 AES_BLOCK_SIZE，外部通过 IV 来提供地址、SPI ID 等信息</li>
<li><code>min_keysize</code>/<code>max_keysize</code>: 不设置，使用 eFuse 密钥，非外部密钥</li>
</ul>
</blockquote>
<p>提供给外部（SPI NAND / SPI NOR）使用的 API：</p>
<table><thead><tr><th></th><th>加密子系统 API</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>struct crypto_skcipher *crypto_alloc_skcipher( const char *alg_name, u32 type, u32 mask)</td><td>直接指定算法驱动名字<code>ctr-aes-spienc-aic</code></td></tr><tr><td>2</td><td>struct skcipher_request *skcipher_request_alloc( struct crypto_skcipher *tfm, gfp_t gfp)</td><td>分配一个数据请求结构体</td></tr><tr><td>3</td><td>void skcipher_request_set_callback(struct skcipher_request *req, u32 flags,crypto_completion_t compl, void *data)</td><td>设置处理完毕时的回调函数</td></tr><tr><td>4</td><td>void skcipher_request_set_crypt(struct skcipher_request *req,struct scatterlist *src, struct scatterlist *dst, unsigned int cryptlen, void *iv)</td><td>无输入输出 buffer，仅提供数据长度。通过 IV 提供地址、SPI ID</td></tr><tr><td>5</td><td>int crypto_skcipher_decrypt(struct skcipher_request *req)</td><td>启动解密，用于读</td></tr><tr><td>6</td><td>int crypto_skcipher_encrypt(struct skcipher_request *req)</td><td>启动加密，用于写</td></tr><tr><td>7</td><td>void skcipher_request_free(struct skcipher_request *req)</td><td>释放资源</td></tr><tr><td>8</td><td>void crypto_free_skcipher(struct crypto_skcipher *tfm)</td><td>释放资源</td></tr></tbody></table>
<p>注解</p>
<p>由于 SPI_ENC 内部使用 eFuse 所提供的密钥，因此不需要通过外部设置密钥函数：</p>
<p>int crypto_skcipher_setkey(struct crypto_skcipher *tfm, const u8 *key, unsigned int keylen);</p>
<p>来设置密钥。</p>
<p>调用 <code>skcipher_request_set_crypt()</code> API 时，通过 <code>iv</code> 提供的并不是 COUNTER 值，而是用于生成 COUNTER 值的信息，具体为：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_spienc_iv {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 addr;       // 要读写的数据在 SPI NAND / SPI NOR 上的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 cpos;       // 密文在本次传输数据中开始位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 tweak;      // 生成 COUNTER 的调整值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 spi_id;     // 要使用的 SPI 控制器 ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="532-数据读写时启用">5.3.2. 数据读写时启用<a href="#532-数据读写时启用" class="hash-link" aria-label="5.3.2. 数据读写时启用的直接链接" title="5.3.2. 数据读写时启用的直接链接">​</a></h4>
<p>SPI NAND / SPI NOR 驱动通过发送命令的方式与 SPI NAND / SPI NOR 器件进行交互，从而实现数据的读写。 在使能 SPI_ENC 之后，SPI NAND / SPI NOR 驱动需要进行区分：</p>
<blockquote>
<ul>
<li>非存储数据的 SPI 传输，不启动 SPI_ENC，按照原有驱动的流程执行</li>
<li>存储数据的 SPI 传输，启动 SPI_ENC 进行加密  或者解密</li>
</ul>
</blockquote>
<p>因此 SPI NAND / SPI NOR 驱动需要做一些改动，在对存储数据进行读写时，使用 Crypto API 启动 SPI_ENC。</p>
<p>以 SPI NAND 为例： probe 时首先进行加密相关的初始，读取 DTS 中的 <code>aic,encrypt</code> 和 <code>aic,spi-id</code> 等信息。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> spinand_probe();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-&gt; spinand_init(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;|-&gt; spinand_enc_init(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-&gt; mtd_device_register(mtd, NULL, 0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>读操作流程：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spinand_read_page();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spinand_load_page_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spinand_wait(spinand, &amp;status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spinand_read_from_cache_op();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;   |-&gt; spinand_enc_xfer_cfg(spinand, addr, clen);                          // 配置访问地址，以及密文的长度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;   |-&gt; spinand_enc_read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |-&gt; spinand_enc_get_skcipher(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |   |-&gt; crypto_alloc_skcipher(&quot;ctr-aes-spienc-aic&quot;, 0, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |   |-&gt; req = skcipher_request_alloc(tfm, GFP_NOFS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |-&gt; skcipher_request_set_callback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |-&gt; skcipher_request_set_crypt(req, 0, 0, decrypt_len, &amp;ivinfo);    // 设置本次加密数据信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |-&gt; crypto_skcipher_decrypt(req);                                   // 启动 SPI_ENC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spi_mem_exec_op(desc-&gt;mem, &amp;op);                                // 调用标准的 SPI API 进行数据传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;       |-&gt; spinand_enc_wait(spinand-&gt;priv);                                // 等待解密处理结束</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>写操作流程：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spinand_write_page();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spinand_write_enable_op(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spinand_write_to_cache_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;|-&gt; spinand_enc_xfer_cfg(spinand, addr, clen);                          // 配置访问地址，以及密文的长度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;|-&gt; spinand_enc_write();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |-&gt; spinand_enc_get_skcipher(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |   |-&gt; crypto_alloc_skcipher(&quot;ctr-aes-spienc-aic&quot;, 0, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |   |-&gt; req = skcipher_request_alloc(tfm, GFP_NOFS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |-&gt; skcipher_request_set_callback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |-&gt; skcipher_request_set_crypt(req, 0, 0, decrypt_len, &amp;ivinfo);    // 设置本次加密数据信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |-&gt; crypto_skcipher_encrypt(req);                                   // 启动 SPI_ENC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; spi_mem_exec_op(desc-&gt;mem, &amp;op);                                // 调用标准的 SPI API 进行数据传输</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  &quot;    |-&gt; spinand_enc_wait(spinand-&gt;priv);                                // 等待加密处理结束</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spinand_program_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spinand_wait(spinand, &amp;status);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="533-空数据块的检测">5.3.3. 空数据块的检测<a href="#533-空数据块的检测" class="hash-link" aria-label="5.3.3. 空数据块的检测的直接链接" title="5.3.3. 空数据块的检测的直接链接">​</a></h4>
<p>SPI NAND / SPI NOR 在执行了擦除之后，存储单元上的数据被认为是空的，值都是 <code>0xFF</code> 。 但是在使用过程中，读取程序并不一定知道所读取的区域是否是被擦除过，因此在使能了 SPI_ENC 之后， 通过 SPI 读取回来该区域的数据都是被 SPI_ENC 解密后的数据。原本是被擦除后的 <code>0xFF</code> ， 读回来的却是其他数据。</p>
<p>带来的问题：</p>
<blockquote>
<p>有些程序，如文件系统，会判断读回来的数据是否都为 <code>0xFF</code> ，如果是，则认为是未使用的块，做特殊处理。 现在读回来的数据却被改变了，会导致原来的处理逻辑全部失效。</p>
</blockquote>
<p>为了解决上述问题，SPI_ENC 提供了一个空块检测功能。如下图所示：</p>
<blockquote>
<ul>
<li>首先按照正常的流程读取一块数据</li>
<li>传输完成之后，检查 SPI_ENC 的状态，如果提示解密前的所有数据都是 <code>0xFF</code> ，则软件将读取的结果全部置为 <code>0xFF</code></li>
</ul>
</blockquote>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_empty_detect1-17067680895009.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/spienc_empty_detect1.png" class="img_ev3q"></p>
<p>图 8.9 <em>空块检测</em><a href="#id15">¶</a></p>
<p>相关的软件操作，在 <code>spinand_enc_read()</code> 和 <code>spi_nor_enc_read()</code> 中完成。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="54-关键流程">5.4. 关键流程<a href="#54-关键流程" class="hash-link" aria-label="5.4. 关键流程的直接链接" title="5.4. 关键流程的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="541-初始化">5.4.1. 初始化<a href="#541-初始化" class="hash-link" aria-label="5.4.1. 初始化的直接链接" title="5.4.1. 初始化的直接链接">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aic_spienc_probe();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; drvdata-&gt;base = devm_platform_ioremap_resource(pdev, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; irq = platform_get_irq(pdev, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; devm_request_threaded_irq(dev, irq, aic_spienc_irq_handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              aic_spienc_irq_thread, IRQF_ONESHOT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              dev_name(dev), drvdata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; drvdata-&gt;clk = devm_clk_get(dev, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; clk_prepare_enable(drvdata-&gt;clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; devm_reset_control_get(dev, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; platform_set_drvdata(pdev, drvdata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; crypto_register_skcipher(&amp;spienc_alg.alg);  // 注册算法</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="542-加解密配置">5.4.2. 加解密配置<a href="#542-加解密配置" class="hash-link" aria-label="5.4.2. 加解密配置的直接链接" title="5.4.2. 加解密配置的直接链接">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aic_spienc_encrypt(req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; aic_spienc_xcrypt(req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; aic_spienc_attach_bus(drvdata, ivinfo-&gt;spi_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; writel(ivinfo-&gt;addr, (drvdata-&gt;base + SPIE_REG_ADDR));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; writel(ivinfo-&gt;cpos, (drvdata-&gt;base + SPIE_REG_CPOS));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; writel(clen, (drvdata-&gt;base + SPIE_REG_CLEN));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; writel(tweak, (drvdata-&gt;base + SPIE_REG_TWEAK));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>解密流程相同。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="543-中断流程">5.4.3. 中断流程<a href="#543-中断流程" class="hash-link" aria-label="5.4.3. 中断流程的直接链接" title="5.4.3. 中断流程的直接链接">​</a></h4>
<p>当中断发生时，首先在 irq handler 中读取并保存状态寄存器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static irqreturn_t aic_spienc_irq_handler(int irq, void *arg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_spienc_drvdata *drvdata = arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    drvdata-&gt;irq_sts = readl(drvdata-&gt;base + SPIE_REG_ISR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return IRQ_WAKE_THREAD;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后唤醒对应的处理线程进行处理。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static irqreturn_t aic_spienc_irq_thread(int irq, void *arg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_spienc_drvdata *drvdata = arg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct crypto_async_request *base;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int err = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 val = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (drvdata-&gt;irq_sts &amp; SPIE_INTR_ENC_DEC_FIN_MSK) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (drvdata-&gt;irq_sts &amp; SPIE_INTR_ALL_EMP_MSK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            err = AIC_SPIENC_ALL_FF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        base = &amp;drvdata-&gt;req-&gt;base;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        base-&gt;complete(base, err);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /* Stop it */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val = readl((drvdata-&gt;base + SPIE_REG_CTL));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val &amp;= ~SPIE_START_MSK;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        writel(val, (drvdata-&gt;base + SPIE_REG_CTL));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /* Clear interrupts */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        drvdata-&gt;irq_sts = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        writel(SPIE_INTR_ALL_MSK, (drvdata-&gt;base + SPIE_REG_ISR));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return IRQ_HANDLED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="55-数据结构">5.5. 数据结构<a href="#55-数据结构" class="hash-link" aria-label="5.5. 数据结构的直接链接" title="5.5. 数据结构的直接链接">​</a></h3>
<p>设备数据结构。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_spienc_drvdata {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct attribute_group attrs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct device *dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void __iomem *base;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct clk *clk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct skcipher_request *req;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 tweak; /* Tweak value for hardware to generate counter */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 irq_sts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="56-接口设计">5.6. 接口设计<a href="#56-接口设计" class="hash-link" aria-label="5.6. 接口设计的直接链接" title="5.6. 接口设计的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="561-aic_spienc_alg_init">5.6.1. aic_spienc_alg_init<a href="#561-aic_spienc_alg_init" class="hash-link" aria-label="5.6.1. aic_spienc_alg_init的直接链接" title="5.6.1. aic_spienc_alg_init的直接链接">​</a></h4>
<table><thead><tr><th><strong>函数原型</strong></th><th>int aic_spienc_alg_init(struct crypto_skcipher *tfm)</th></tr></thead><tbody><tr><td><strong>功能说明</strong></td><td>对称密钥算法的初始化函数</td></tr><tr><td><strong>参数定义</strong></td><td>struct crypto_skcipher *tfm算法实例指针</td></tr><tr><td><strong>返回值</strong></td><td>0: 成功其他: 失败</td></tr><tr><td><strong>注意事项</strong></td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="562-aic_spienc_probe">5.6.2. aic_spienc_probe<a href="#562-aic_spienc_probe" class="hash-link" aria-label="5.6.2. aic_spienc_probe的直接链接" title="5.6.2. aic_spienc_probe的直接链接">​</a></h4>
<table><thead><tr><th><strong>函数原型</strong></th><th>int aic_spienc_probe(struct platform_device *pdev)</th></tr></thead><tbody><tr><td><strong>功能说明</strong></td><td>驱动的初始化函数</td></tr><tr><td><strong>参数定义</strong></td><td>struct platform_device *pdev设备指针</td></tr><tr><td><strong>返回值</strong></td><td>0: 成功其他: 失败</td></tr><tr><td><strong>注意事项</strong></td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="563-aic_spienc_attach_bus">5.6.3. aic_spienc_attach_bus<a href="#563-aic_spienc_attach_bus" class="hash-link" aria-label="5.6.3. aic_spienc_attach_bus的直接链接" title="5.6.3. aic_spienc_attach_bus的直接链接">​</a></h4>
<table><thead><tr><th><strong>函数原型</strong></th><th>int aic_spienc_attach_bus(struct aic_spienc_drvdata *drvdata, u32 bus)</th></tr></thead><tbody><tr><td><strong>功能说明</strong></td><td>将 SPI ENC 连接到指定的 SPI 控制器</td></tr><tr><td><strong>参数定义</strong></td><td>struct aic_spienc_drvdata *drvdata设备驱动数据指针u32 busSPI 控制器 ID</td></tr><tr><td><strong>返回值</strong></td><td>0: 成功其他: 失败</td></tr><tr><td><strong>注意事项</strong></td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="564-aic_spienc_encrypt">5.6.4. aic_spienc_encrypt<a href="#564-aic_spienc_encrypt" class="hash-link" aria-label="5.6.4. aic_spienc_encrypt的直接链接" title="5.6.4. aic_spienc_encrypt的直接链接">​</a></h4>
<table><thead><tr><th><strong>函数原型</strong></th><th>int aic_spienc_encrypt(struct skcipher_request *req)</th></tr></thead><tbody><tr><td><strong>功能说明</strong></td><td>配置 SPI_ENC 启动数据加密</td></tr><tr><td><strong>参数定义</strong></td><td>struct skcipher_request *req加密请求指针</td></tr><tr><td><strong>返回值</strong></td><td>0: 成功其他: 失败</td></tr><tr><td><strong>注意事项</strong></td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="565-aic_spienc_decrypt">5.6.5. aic_spienc_decrypt<a href="#565-aic_spienc_decrypt" class="hash-link" aria-label="5.6.5. aic_spienc_decrypt的直接链接" title="5.6.5. aic_spienc_decrypt的直接链接">​</a></h4>
<table><thead><tr><th><strong>函数原型</strong></th><th>int aic_spienc_decrypt(struct skcipher_request *req)</th></tr></thead><tbody><tr><td><strong>功能说明</strong></td><td>配置 SPI_ENC 启动数据解密</td></tr><tr><td><strong>参数定义</strong></td><td>struct skcipher_request *req解密请求指针</td></tr><tr><td><strong>返回值</strong></td><td>0: 成功其他: 失败</td></tr><tr><td><strong>注意事项</strong></td><td></td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-常见问题">6. 常见问题<a href="#6-常见问题" class="hash-link" aria-label="6. 常见问题的直接链接" title="6. 常见问题的直接链接">​</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part3/08-1_SPI-ENC.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/D213-DevKit/part3/07-13_PSADC-Useguide"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">PSADC 使用指南</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/D213-DevKit/part3/08-2_CE-Useguide"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">CE 使用指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-模块介绍" class="table-of-contents__link toc-highlight">1. 模块介绍</a><ul><li><a href="#11-术语定义" class="table-of-contents__link toc-highlight">1.1. 术语定义</a></li><li><a href="#12-模块简介" class="table-of-contents__link toc-highlight">1.2. 模块简介</a></li><li><a href="#13-原理框图" class="table-of-contents__link toc-highlight">1.3. 原理框图</a></li></ul></li><li><a href="#2-参数配置" class="table-of-contents__link toc-highlight">2. 参数配置</a><ul><li><a href="#21-内核配置" class="table-of-contents__link toc-highlight">2.1. 内核配置</a></li><li><a href="#22-dts-配置" class="table-of-contents__link toc-highlight">2.2. DTS 配置</a></li><li><a href="#23-密钥配置" class="table-of-contents__link toc-highlight">2.3. 密钥配置</a></li></ul></li><li><a href="#3-调试指南" class="table-of-contents__link toc-highlight">3. 调试指南</a><ul><li><a href="#31-调试开关" class="table-of-contents__link toc-highlight">3.1. 调试开关</a></li><li><a href="#32-sysfs-节点" class="table-of-contents__link toc-highlight">3.2. Sysfs 节点</a></li></ul></li><li><a href="#4-测试指南" class="table-of-contents__link toc-highlight">4. 测试指南</a><ul><li><a href="#41-测试的配置" class="table-of-contents__link toc-highlight">4.1. 测试的配置</a></li><li><a href="#42-测试的命令" class="table-of-contents__link toc-highlight">4.2. 测试的命令</a></li><li><a href="#43-读写的测试" class="table-of-contents__link toc-highlight">4.3. 读写的测试</a></li></ul></li><li><a href="#5-设计说明" class="table-of-contents__link toc-highlight">5. 设计说明</a><ul><li><a href="#51-源码说明" class="table-of-contents__link toc-highlight">5.1. 源码说明</a></li><li><a href="#52-模块架构" class="table-of-contents__link toc-highlight">5.2. 模块架构</a></li><li><a href="#53-设计要点" class="table-of-contents__link toc-highlight">5.3. 设计要点</a></li><li><a href="#54-关键流程" class="table-of-contents__link toc-highlight">5.4. 关键流程</a></li><li><a href="#55-数据结构" class="table-of-contents__link toc-highlight">5.5. 数据结构</a></li><li><a href="#56-接口设计" class="table-of-contents__link toc-highlight">5.6. 接口设计</a></li></ul></li><li><a href="#6-常见问题" class="table-of-contents__link toc-highlight">6. 常见问题</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>