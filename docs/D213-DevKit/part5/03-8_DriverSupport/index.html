<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-D213-DevKit/part5/03-8_DriverSupport" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">驱动支持 | 东山Π</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://artinchip.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://artinchip.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-8_DriverSupport"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="驱动支持 | 东山Π"><meta data-rh="true" name="description" content="1. Clock 驱动"><meta data-rh="true" property="og:description" content="1. Clock 驱动"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-8_DriverSupport"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-8_DriverSupport" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part5/03-8_DriverSupport" hreflang="en"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-8_DriverSupport" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d875fe7e.css">
<script src="/assets/js/runtime~main.3b2e3a9b.js" defer="defer"></script>
<script src="/assets/js/main.498bbc78.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">东山Π</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/D213-DevKit/BoardIntroduction">D213-DevKit</a><a class="navbar__item navbar__link" href="/docs/category/luban-sdk使用指南">Luban-SDK</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/D213-DevKit/part5/03-8_DriverSupport" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/en/docs/D213-DevKit/part5/03-8_DriverSupport" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/ArtInChip-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/BoardIntroduction">匠芯创D213-DevKit开发板</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/SupportingResources">源码工具文档手册</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/快速启动">快速启动</a><button aria-label="展开侧边栏分类 &#x27;快速启动&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/ConfigHostEnv">安装并配置开发环境</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/luban-sdk开发">Luban-SDK开发</a><button aria-label="展开侧边栏分类 &#x27;Luban-SDK开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/luban-linux系统开发">Luban-Linux系统开发</a><button aria-label="展开侧边栏分类 &#x27;Luban-Linux系统开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux-bringup参考">Linux-Bringup参考</a><button aria-label="展开侧边栏分类 &#x27;Linux-Bringup参考&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/linux-uboot开发">Linux-Uboot开发</a><button aria-label="折叠侧边栏分类 &#x27;Linux-Uboot开发&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-1_BasicIntroduction">ArtInChip U-Boot介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-2_StartupParameter">启动参数</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-3_MemoryDependent">内存相关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-4_EnvironmentVariables">环境变量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-5_DTS">DTS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-6_SPLStage">SPL 阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-7_U-BootStage">U-Boot 阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/D213-DevKit/part5/03-8_DriverSupport">驱动支持</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-9_PartitionConfiguration">分区配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-10_BootKernel">启动内核</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-11_PackImage">打包镜像</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-12_ImageBurn">镜像烧录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-13_UserIDBurn">模块介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-14_ImageDisplay">图像显示</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-15_DebugConfiguration">调试配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-16_OpenSBI">OpenSBI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-17_PBP">Pre-Boot Program</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/linux-uboot开发"><span itemprop="name">Linux-Uboot开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">驱动支持</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>驱动支持</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-clock-驱动">1. Clock 驱动<a href="#1-clock-驱动" class="hash-link" aria-label="1. Clock 驱动的直接链接" title="1. Clock 驱动的直接链接">​</a></h2>
<p>本章节描述 ArtInChip 平台的 U-Boot 时钟配置相关内容。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-驱动框架">1.1. 驱动框架<a href="#11-驱动框架" class="hash-link" aria-label="1.1. 驱动框架的直接链接" title="1.1. 驱动框架的直接链接">​</a></h3>
<p>U-Boot 驱动模型支持 Clock，ArtInChip 平台中 Clock 驱动基于该框架进行实现。 相关配置为：</p>
<blockquote>
<ul>
<li>CONFIG_CLK</li>
<li>CONFIG_CLK_ARTINCHIP</li>
<li>CONFIG_CLK_ARTINCHIP_CMU</li>
<li>CONFIG_SPL_CLK_ARTINCHIP</li>
<li>CONFIG_SPL_CLK_ARTINCHIP_CMU</li>
</ul>
</blockquote>
<p>相关源码有：</p>
<blockquote>
<ul>
<li><code>include/clk.h</code></li>
<li><code>include/clk-uclass.h</code></li>
<li><code>drivers/clk/clk.c</code></li>
<li><code>drivers/clk/clk-uclass.c</code></li>
<li><code>drivers/clk/artinchip/clk-aic.h</code></li>
<li><code>drivers/clk/artinchip/clk-artinchip.c</code></li>
<li><code>drivers/clk/artinchip/clk-cmu.c</code></li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-驱动接口">1.2. 驱动接口<a href="#12-驱动接口" class="hash-link" aria-label="1.2. 驱动接口的直接链接" title="1.2. 驱动接口的直接链接">​</a></h3>
<p>相关的 Clock 驱动接口有：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int clk_get_by_index_platdata(struct udevice *dev, int index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              struct phandle_1_arg *cells, struct clk *clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int clk_get_by_index(struct udevice *dev, int index, struct clk *clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int clk_get_by_index_nodev(ofnode node, int index, struct clk *clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int clk_get_bulk(struct udevice *dev, struct clk_bulk *bulk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int clk_get_by_name(struct udevice *dev, const char *name, struct clk *clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int clk_release_all(struct clk *clk, int count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int clk_enable(struct clk *clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int clk_disable(struct clk *clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ulong clk_set_rate(struct clk *clk, ulong rate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ulong clk_get_rate(struct clk *clk);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-初始化和使用">1.3. 初始化和使用<a href="#13-初始化和使用" class="hash-link" aria-label="1.3. 初始化和使用的直接链接" title="1.3. 初始化和使用的直接链接">​</a></h3>
<p>通常硬件设备初始化时，需要配置对应的时钟。Clock 驱动的 probe 在时钟设备第一次被获取时触发。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clk_get_by_index(); // drivers/clk/clk-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; clk_get_by_index_tail();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; uclass_get_device_by_ofnode(UCLASS_CLK, args-&gt;node, &amp;dev_clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_find_device_by_ofnode(id, node, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_get_device_tail(dev, ret, devp); // drivers/core/uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; device_probe(dev); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; drv-&gt;probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    aic_clk_probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // drivers/clk/artinchip/clk-cmu.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设备使用的时钟通过时钟树进行管理。在时钟树中，每一个时钟都被分配一个具体的 ID， 并且在 DTS 中配置给需要的硬件设备。设备初始化时，通过 FDT 获取对应的时钟设备。</p>
<p>DTS 中时钟配置示例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dma: dma-controller@10000000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compatible = &quot;artinchip,aic-dma&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clocks = &lt;&amp;ccu CLK_DMA&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>相关 ID 定义可参考：</p>
<blockquote>
<ul>
<li><code>include/dt-bindings/clock/artinchip,aic-cmu.h</code></li>
</ul>
</blockquote>
<p>获取时钟设备的流程：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clk_get_by_index(dev, index, clk); // drivers/clk/clk-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 此处 index 是 DTS 中配置给该设备的第几个时钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; clk_get_by_index_tail();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; uclass_get_device_by_ofnode(UCLASS_CLK, args-&gt;node, &amp;dev_clk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; clk_of_xlate_default(clk, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; clk-&gt;id = args-&gt;args[0]; // 获取到具体的时钟 ID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要设置和获取相关时钟信息时，通过 <code>clk-&gt;id</code> 访问时钟树。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clk_set_rate(clk, rate); // drivers/clk/clk-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ops-&gt;set_rate(clk, rate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    artinchip_clk_set_rate(clk, rate); // drivers/clk/artinchip/clk-artinchip.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; aic_get_clk_info(priv-&gt;tree, clk-&gt;id, &amp;index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 驱动内部，使用 clk-id 获取对应的时钟节点</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-reset-驱动">2. Reset 驱动<a href="#2-reset-驱动" class="hash-link" aria-label="2. Reset 驱动的直接链接" title="2. Reset 驱动的直接链接">​</a></h2>
<p>本章节描述 ArtInChip 平台的 U-Boot 复位驱动相关内容。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-驱动框架">2.1. 驱动框架<a href="#21-驱动框架" class="hash-link" aria-label="2.1. 驱动框架的直接链接" title="2.1. 驱动框架的直接链接">​</a></h3>
<p>U-Boot 驱动模型支持 Reset，ArtInChip 平台中 Reset 驱动基于该框架进行实现。 相关配置为：</p>
<blockquote>
<ul>
<li>CONFIG_DM_RESET</li>
<li>CONFIG_RESET_ARTINCHIP</li>
</ul>
</blockquote>
<p>相关源码有：</p>
<blockquote>
<ul>
<li><code>include/reset.h</code></li>
<li><code>include/reset-uclass.h</code></li>
<li><code>drivers/reset/reset-uclass.c</code></li>
<li><code>drivers/reset/reset-artinchip.c</code></li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-驱动接口">2.2. 驱动接口<a href="#22-驱动接口" class="hash-link" aria-label="2.2. 驱动接口的直接链接" title="2.2. 驱动接口的直接链接">​</a></h3>
<p>相关的复位驱动接口有：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int reset_get_by_index(struct udevice *dev, int index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        struct reset_ctl *reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int reset_get_by_name(struct udevice *dev, const char *name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        struct reset_ctl *reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int reset_get_by_index_nodev(ofnode node, int index,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                struct reset_ctl *reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int reset_get_bulk(struct udevice *dev, struct reset_ctl_bulk *bulk);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int reset_request(struct reset_ctl *reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int reset_free(struct reset_ctl *reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int reset_assert(struct reset_ctl *reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int reset_deassert(struct reset_ctl *reset_ctl);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-初始化和使用">2.3. 初始化和使用<a href="#23-初始化和使用" class="hash-link" aria-label="2.3. 初始化和使用的直接链接" title="2.3. 初始化和使用的直接链接">​</a></h3>
<p>通常硬件设备初始化时，需要对其进行一次复位。Reset 驱动的 probe 在复位控制器第一次被获取时触发。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reset_get_by_index(); // drivers/reset/reset-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; reset_get_by_index_tail(ret, dev_ofnode(dev), &amp;args, &quot;resets&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |                       index &gt; 0, reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; uclass_get_device_by_ofnode(UCLASS_RESET, args-&gt;node, &amp;dev_reset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_find_device_by_ofnode(id, node, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_get_device_tail(dev, ret, devp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; device_probe(dev); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; drv-&gt;probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    artinchip_reset_probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // drivers/reset/reset-artinchip.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>系统给每一个设备的复位控制器分配了一个 ID，并且在设备的 DTS 配置中将 ID 分配到具体的设备。 设备初始化时，通过 FDT 的配置获取相应的复位控制设备。</p>
<p>DTS 中复位控制器配置示例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dma: dma-controller@10000000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compatible = &quot;artinchip,aic-dma&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resets = &lt;&amp;rst RESET_DMA&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>相关 ID 定义可参考：</p>
<blockquote>
<ul>
<li><code>include/dt-bindings/reset/artinchip,aic-reset.h</code></li>
</ul>
</blockquote>
<p>获取复位控制器的流程：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reset_get_by_index(dev, index, reset_ctl); // drivers/reset/reset-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 此处 index 是 DTS 中配置给该设备的第几个复位控制设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; reset_get_by_index_tail();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; uclass_get_device_by_ofnode(UCLASS_RESET, args-&gt;node, &amp;dev_reset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; resetof_xlate_default(reset_ctl, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; reset_ctl-&gt;id = args-&gt;args[0]; // 获取到具体的复位控制器 ID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要对设备进行复位时，通过 <code>reset_ctl-&gt;id</code> 进行访问和设置硬件。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reset_assert(reset_ctl); // drivers/reset/reset-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ops-&gt;rst_assert(reset_ctl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    artinchip_reset_assert(reset_ctrl); // drivers/reset/reset-artinchip.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-dma-驱动">3. DMA 驱动<a href="#3-dma-驱动" class="hash-link" aria-label="3. DMA 驱动的直接链接" title="3. DMA 驱动的直接链接">​</a></h2>
<p>此处描述的 DMA 是 ArtInChip 平台上的系统 DMA。一些硬件 IP 内部自带的 DMA 不在这里描述的范围。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-驱动框架">3.1. 驱动框架<a href="#31-驱动框架" class="hash-link" aria-label="3.1. 驱动框架的直接链接" title="3.1. 驱动框架的直接链接">​</a></h3>
<p>U-Boot 驱动模型支持 DMA，ArtInChip 平台中 DMA 驱动基于该框架进行实现。 相关配置为：</p>
<blockquote>
<ul>
<li>CONFIG_DMA</li>
<li>CONFIG_ARTINCHIP_DMA</li>
</ul>
</blockquote>
<p>相关源码有：</p>
<blockquote>
<ul>
<li><code>include/dma.h</code></li>
<li><code>drivers/dma/dma-uclass.c</code></li>
<li><code>drivers/dma/artinchip_dma.c</code></li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-驱动接口">3.2. 驱动接口<a href="#32-驱动接口" class="hash-link" aria-label="3.2. 驱动接口的直接链接" title="3.2. 驱动接口的直接链接">​</a></h3>
<p>常用接口</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int dma_enable(struct dma *dma);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dma_disable(struct dma *dma);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dma_request(struct udevice *dev, struct dma *dma);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dma_free(struct dma *dma);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dma_memcpy(void *dst, void *src, size_t len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dma_prepare_rcv_buf(struct dma *dma, void *dst, size_t size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dma_receive(struct dma *dma, void **dst, void *metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dma_send(struct dma *dma, void *src, size_t len, void *metadata);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-实现说明">3.3. 实现说明<a href="#33-实现说明" class="hash-link" aria-label="3.3. 实现说明的直接链接" title="3.3. 实现说明的直接链接">​</a></h3>
<p>ArtInChip 平台上有一个系统 DMA，其支持8个通道同时工作。如规格书所定义，DMA 可以在不同的硬件 IP 之间搬运数据，系统为各硬件 IP 分配了固定的数据端口号。 使用 DMA 时，软件需要先申请到一个空闲的 DMA 通道，并将源数据端口和目标数据端口等信息配置给 DMA 通道，然后启动 DMA 进行工作。</p>
<p>然而上述的描述和使用方式并不能直接对应到 DTS 的配置方式以及 U-Boot 中的 DMA 表示方式， 中间需要做一些转换和说明。</p>
<p>在 DTS 中，可以描述某个控制器是否支持 DMA，并且配置所使用的 DMA ID 号。 在 ArtInChip 平台中，实际只有一个 DMA，各硬件 IP 共享使用。在配置 DTS 时， 使用设备对应的 DMA 数据端口号作为 DMA ID，在运行时再给该 ID 分配可用的 DMA 通道。</p>
<p>如下面的示例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spi0: spi@10400000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compatible = &quot;artinchip,aic-spi-v1.0&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reg = &lt;0x0 0x10400000 0x0 0x1000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interrupts-extended = &lt;&amp;plic0 44 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clocks = &lt;&amp;cmu CLK_SPI0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resets = &lt;&amp;rst RESET_SPI0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dmas = &lt;&amp;dma DMA_SPI0&gt;, &lt;&amp;dma DMA_SPI0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma-names = &quot;rx&quot;, &quot;tx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #address-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #size-cells = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spi-max-frequency = &lt;24000000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的 DMA 配置中，描述了 SPI0 控制器使用两个 DMA，分别是 “rx”, “tx”，它们的 DMA ID 都是 SPI0 对应的 DMA 数据端口号 10。</p>
<p>上述的配置对应到 U-Boot 的 DMA 驱动实现时，会有一些问题。U-Boot DMA 在运行时使用下面的结构体表示：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct dma {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct udevice *dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unsigned long id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>DMA 的实例化在 DMA 驱动框架 <code>dma-uclass.c</code> 中进行，其中的 <code>id</code> 值即为 DTS 中配置的 DMA ID。这里两个 DMA 使用了相同的 ID 号，如果直接使用，无法区分不同 DMA 所映射的 DMA 通道。</p>
<p>ArtInChip 平台上通过对 DMA 结构体中的 <code>id</code> 进行了扩展，以方便区分实际使用的不同 DMA， 如下所示：</p>
<blockquote>
<ul>
<li>bit[15:0] 表示 IP 端口号</li>
<li>bit[31:16] 表示 DMA 通道号</li>
</ul>
</blockquote>
<p>在 DMA 创建时赋值端口号区域，DMA request 时赋值通道号区域。由于上述两个动作是在一个调用中完成的， 因此不会有问题：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dma_get_by_name(bus, &quot;tx&quot;, &amp;priv-&gt;tx_dma); // drivers/dma/dma-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; dma_get_by_index(dev, index, dma); // drivers/dma/dma-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; dma_of_xlate_default(dma, &amp;args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; dma-&gt;id = args-&gt;args[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; dma_request(dev_dma, dma); // drivers/dma/dma-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; aic_dma_request(dma); // drivers/dma/artinchip_dma.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; phy_ch = aic_dma_phy_request(ud);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; dma-&gt;id |= (phy_ch &lt;&lt; AIC_DMA_PHY_CH_OFF);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>U-Boot 对 <code>struct dma</code> 结构体中 <code>id</code> 的定义是唯一标识，只要 能够做 DMA 区分即可， 因此上述扩展不会造成其他问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-初始化流程">3.4. 初始化流程<a href="#34-初始化流程" class="hash-link" aria-label="3.4. 初始化流程的直接链接" title="3.4. 初始化流程的直接链接">​</a></h3>
<p>DMA 驱动的初始化，在 DMA 第一次被使用时触发进行。</p>
<p><strong>情况1：</strong> DRAM DMA 数据传输</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dma_memcpy(dst_buf, src_buf, len);// drivers/dma/dma-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; dma_get_device(DMA_SUPPORTS_MEM_TO_MEM, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; uclass_first_device(UCLASS_DMA, &amp;dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_find_first_device(id, index, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_get_device_tail(dev, ret, devp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; device_probe(dev); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; drv-&gt;probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    aic_dma_probe(dev); // drivers/dma/artinchip_dma.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>情况2：</strong> 根据 DTS 配置申请 DMA</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dma_get_by_name(bus, &quot;tx&quot;, &amp;priv-&gt;tx_dma); // drivers/dma/dma-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; dma_get_by_index(dev, index, dma); // drivers/dma/dma-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; uclass_get_device_by_ofnode(UCLASS_DMA, args.node, &amp;dev_dma);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   // drivers/core/uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_find_device_by_ofnode(id, node, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_get_device_tail(dev, ret, devp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; device_probe(dev); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; drv-&gt;probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    aic_dma_probe(dev); // drivers/dma/artinchip_dma.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-spi-驱动">4. SPI 驱动<a href="#4-spi-驱动" class="hash-link" aria-label="4. SPI 驱动的直接链接" title="4. SPI 驱动的直接链接">​</a></h2>
<p>SPI 在 U-Boot 中主要用于支持 SPI NAND/NOR 存储设备。目前 ArtInChip 平台上 SPI 的实现只支持半双工模式(Half-duplex)。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-驱动框架">4.1. 驱动框架<a href="#41-驱动框架" class="hash-link" aria-label="4.1. 驱动框架的直接链接" title="4.1. 驱动框架的直接链接">​</a></h3>
<p>U-Boot 驱动模型支持 SPI，ArtInChip 平台中 SPI 驱动基于该框架进行实现。 相关配置为：</p>
<blockquote>
<ul>
<li>CONFIG_DM_SPI</li>
<li>CONFIG_SPI</li>
<li>CONFIG_SPL_SPI_SUPPORT</li>
<li>CONFIG_ARTINCHIP_SPI</li>
</ul>
</blockquote>
<p>相关源码有：</p>
<blockquote>
<ul>
<li><code>drivers/spi/spi-uclass.c</code></li>
<li><code>include/spi.h</code></li>
<li><code>drivers/spi/artinchip_spi.c</code></li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-驱动接口">4.2. 驱动接口<a href="#42-驱动接口" class="hash-link" aria-label="4.2. 驱 动接口的直接链接" title="4.2. 驱动接口的直接链接">​</a></h3>
<p>常用接口：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int dm_spi_claim_bus(struct udevice *dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void dm_spi_release_bus(struct udevice *dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dm_spi_xfer(struct udevice *dev, unsigned int bitlen,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                const void *dout, void *din, unsigned long flags);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int spi_claim_bus(struct spi_slave *slave);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void spi_release_bus(struct spi_slave *slave);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int  spi_xfer(struct spi_slave *slave, unsigned int bitlen, const void *dout,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              void *din, unsigned long flags);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-初始化流程">4.3. 初始化流程<a href="#43-初始化流程" class="hash-link" aria-label="4.3. 初始化流程的直接链接" title="4.3. 初始化流程的直接链接">​</a></h3>
<p>SPI 设备挂载在 SPI 总线上，当 SPI 设备初始化时，如果父设备还没有被初始化， 则会自动触发父设备的初始化。下面是 SPI NAND 初始化时触发 SPI 初始化的流程。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; device_probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   // 此时 SPI 还没有 probe，则先 probe SPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; device_probe(dev-&gt;parent); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; drv-&gt;probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       aic_spi_probe(dev); // drivers/spi/artinchip_spi.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; drv-&gt;probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spinand_probe(dev) // drivers/mtd/nand/spi/core.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-dma-的支持">4.4. DMA 的支持<a href="#44-dma-的支持" class="hash-link" aria-label="4.4. DMA 的支持的直接链接" title="4.4. DMA 的支持的直接链接">​</a></h3>
<p>ArtInChip SPI 驱动支持使用 DMA 收发数据和使用 FIFO 通过 CPU 读写的方式收发数据， 在 DMA 使能的情况下，对于数据长度大于等于 <code>SPI_FIFO_DEPTH</code> 的传输，驱动自动切换使用 DMA 进行传输，否则默认使用 FIFO 模式。</p>
<p>如果系统没有使能 DMA，则所有传输都使用 FIFO 模式。</p>
<p>使能 DMA 的 Kconfig 配置为：</p>
<blockquote>
<ul>
<li>CONFIG_ARTINCHIP_DMA</li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="45-quad-spi-的支持">4.5. QUAD SPI 的支持<a href="#45-quad-spi-的支持" class="hash-link" aria-label="4.5. QUAD SPI 的支持的直接链接" title="4.5. QUAD SPI 的支持的直接链接">​</a></h3>
<p>对于非存储 SPI 设备，SPI 驱动只支持标准 SPI 模式，即 Single Mode，数据传输都使用一根线进行(MOSI 和 MISO)。 对于 SPI 存储设备(SPI NAND/SPI NOR)，通过对接 <code>spi-mem</code> 框架，可以支持 DUAL SPI 和 QUAD SPI。</p>
<p>相关代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static const struct spi_controller_mem_ops aic_spi_mem_ops = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .supports_op = aic_spi_mem_supports_op,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .exec_op = aic_spi_mem_exec_op,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static const struct dm_spi_ops aic_spi_ops = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .claim_bus   = aic_spi_claim_bus,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .release_bus = aic_spi_release_bus,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .xfer        = aic_spi_xfer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .set_speed   = aic_spi_set_speed,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .set_mode    = aic_spi_set_mode,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .mem_ops     = &amp;aic_spi_mem_ops,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过设置 <code>.exec_op</code> ，SPI MEM 设备的所有操作都由 <code>aic_spi_mem_exec_op</code> 进行处理。 由于该接口可以获取到 SPI 操作的数据位宽等详细信息，驱动可以为每一个传输操作设置准确的模式(Single/Dual/Quad)。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-spi-nand-驱动">5. SPI NAND 驱动<a href="#5-spi-nand-驱动" class="hash-link" aria-label="5. SPI NAND 驱动的直接链接" title="5. SPI NAND 驱动的直接链接">​</a></h2>
<p>本章节描述 SPI NAND 驱动的相关配置和使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-驱动框架">5.1. 驱动框架<a href="#51-驱动框架" class="hash-link" aria-label="5.1. 驱动框架的直接链接" title="5.1. 驱动框架的直接链接">​</a></h3>
<p>SPI NAND 的操作基于 SPI 命令，除了个别型号可能有不同之外，基本上操作和行为都是一致的， 所以 U-Boot 中已经实现了共用版本的 SPI NAND 驱动，具体器件只需要添加小部分驱动代码即可。</p>
<p>相关配置：</p>
<blockquote>
<ul>
<li>CONFIG_MTD</li>
<li>CONFIG_DM_SPI</li>
<li>CONFIG_SPI_MEM</li>
<li>CONFIG_MTD_SPI_NAND</li>
<li>CONFIG_SPL_SPI_NAND_ARTINCHIP</li>
</ul>
</blockquote>
<p>具体源码在：</p>
<blockquote>
<ul>
<li><code>drivers/mtd/nand/spi/</code></li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-驱动接口">5.2. 驱动接口<a href="#52-驱动接口" class="hash-link" aria-label="5.2. 驱动接口的直接链接" title="5.2. 驱动接口的直接链接">​</a></h3>
<p>SPI NAND 属于 MTD 设备，使用 MTD 相关接口。具体参考：</p>
<blockquote>
<ul>
<li><code>include/linux/mtd/mtd.h</code></li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-初始化和读写">5.3. 初始化和读写<a href="#53-初始化和读写" class="hash-link" aria-label="5.3. 初始化和读写的直接链接" title="5.3. 初始化和读写的直接链接">​</a></h3>
<p>SPI NAND 是挂载在 SPI 总线上的 MTD 设备，初始化 probe 在 MTD 设备第一次被使用时触发。 调用 <code>mtd_probe_devices()</code> 是对 MTD 设备驱动初始化的常用方式。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_probe_devices(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mtd_probe_uclass_mtd_devs(void) // drivers/mtd/mtd_uboot.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   // 通过 while 循环，逐个 UCLASS_MTD 设备 find</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; uclass_find_device(UCLASS_MTD, idx, &amp;dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mtd_probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; device_probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_probe(dev) // drivers/mtd/nand/spi/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // spinand = dev_get_priv(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // slave = dev_get_parent_priv(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // mtd = dev_get_uclass_priv(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // nand = &amp;spinand-&gt;base;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // spinand-&gt;slave = slave;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; spinand_init(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |-&gt; spinand_detect(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |   |-&gt; spinand_manufacturer_detect(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |       |                 // drivers/mtd/nand/spi/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |       |-&gt; spinand_manufacturers[i]-&gt;ops-&gt;detect(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |           // 尝试厂商的 detect 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |-&gt; spinand_manufacturer_init(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |-&gt; nanddev_init(nand, &amp;spinand_ops, THIS_MODULE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |   |                         // drivers/mtd/nand/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |   |   // mtd-&gt;type = memorg-&gt;bits_per_cell == 1 ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |   |   //          MTD_NANDFLASH : MTD_MLCNANDFLASH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |   |-&gt; nanddev_bbt_init(nand) // drivers/mtd/nand/bbt.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |       // 此处仅申请标记坏块的 Cache 空间，不做坏块检查</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   |-&gt; // mtd = spinand-&gt;base.mtd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       // mtd-&gt;_read_oob = spinand_mtd_read;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       // mtd-&gt;_write_oob = spinand_mtd_write;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       // mtd-&gt;_block_isbad = spinand_mtd_block_isbad;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       // mtd-&gt;_block_markbad = spinand_mtd_block_markbad;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       // mtd-&gt;_block_isreserved = spinand_mtd_block_isreserved;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       // mtd-&gt;_erase = spinand_mtd_erase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |       // 此处完成 mtd 的初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; add_mtd_device(mtd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; idr_alloc(&amp;mtd_idr, mtd, 0, 0, GFP_KERNEL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 添加到 mtd_idr 列表中</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>NAND 存储设备在访问前，通常要做一次坏块检查。U-Boot 中在添加分区的时候进行检查坏块：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">do_mtd_list();  // cmd/mtd.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mtd_probe_devices(); // drivers/mtd/mtd_uboot.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; add_mtd_partitions(); // drivers/mtd/mtdpart.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; allocate_partition(); // drivers/mtd/mtdpart.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |   // 这里做坏块统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; mtd_block_isbad(); // drivers/mtd/mtdcore.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |       |-&gt; mtd-&gt;_block_isbad(mtd, ofs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           spinand_mtd_block_isbad(); // drivers/mtd/nand/spi/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |-&gt; nanddev_isbad(); // drivers/mtd/nand/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |               |-&gt; spinand_isbad(); // drivers/mtd/nand/spi/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; spinand_read_page();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; add_mtd_device(slave); // drivers/mtd/mtdcore.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上层应用，如 mtd 命令和 UBI，通过 <code>mtd_read</code> / <code>mtd_write</code> API 进行读写等操作。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mtd-&gt;_read_oob(mtd, from, &amp;ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    part_read_oob(mtd, from, &amp;ops); // drivers/mtd/mtdpart.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mtd-&gt;parent-&gt;_read_oob(mtd-&gt;parent, from + mtd-&gt;offset, ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spinand_mtd_read(mtd, from, &amp;ops); // drivers/mtd/nand/spi/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spinand_read_page(spinand, &amp;iter.req, enable_ecc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_load_page_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |   |-&gt; spi_mem_exec_op(spinand-&gt;slave, &amp;op); // drivers/spi/spi-mem.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |       |-&gt; ops-&gt;mem_ops-&gt;exec_op(slave, op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |           aic_spi_mem_exec_op(slave, op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |           // drivers/spi/artinchip_spi.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_read_from_cache_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; spi_mem_exec_op(spinand-&gt;slave, &amp;op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; ops-&gt;mem_ops-&gt;exec_op(slave, op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        aic_spi_mem_exec_op(slave, op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // drivers/spi/artinchip_spi.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mtd_write</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mtd-&gt;_write_oob(mtd, to, &amp;ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    part_write_oob(mtd, to, &amp;ops); // drivers/mtd/mtdpart.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mtd-&gt;parent-&gt;_write_oob(mtd-&gt;parent, to + mtd-&gt;offset, ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spinand_mtd_write(mtd, to, &amp;ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spinand_write_page(spinand, &amp;iter.req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_write_enable_op(spinand);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_write_to_cache_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_program_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; spi_mem_exec_op(spinand-&gt;slave, &amp;op); // drivers/spi/spi-mem.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; ops-&gt;mem_ops-&gt;exec_op(slave, op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        aic_spi_mem_exec_op(slave, op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // drivers/spi/artinchip_spi.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="54-添加新器件">5.4. 添加新器件<a href="#54-添加新器件" class="hash-link" aria-label="5.4. 添加新器件的直接链接" title="5.4. 添加新器件的直接链接">​</a></h3>
<p>U-Boot 的代码仅配置了数量有限的 SPI NAND 器件，在使用新器件时，需要在代码中增加对新器件的支持。 由于只需配置有限的信息，并且具体的配置已经模板化，因此只需参照现有代码添加即可。</p>
<p>具体流程如下：</p>
<ul>
<li>
<p>检查该器件的厂商是否在支持列表</p>
<p>查看 <code>drivers/mtd/nand/spi/</code> 源码目录是否有该器件厂商的驱动。如</p>
<p><code>winbond.c</code></p>
<p>如果不存在，则需要添加新厂商支持。</p>
</li>
<li>
<p>添加新厂商支持之后，需要将将该厂商的配置添加到系统中</p>
<p><code>drivers/mtd/nand/spi/core.c</code></p>
<p><code>struct spinand_manufacturer *spinand_manufacturers[]</code></p>
</li>
<li>
<p>检查厂商驱动中是否支持该器件</p>
<p>如 <code>winbond.c</code> 中</p>
<p><code>struct spinand_info winbond_spinand_table[]</code></p>
<p>如果没有，则添加新器件到列表中即可。</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-spi-nor-驱动">6. SPI NOR 驱动<a href="#6-spi-nor-驱动" class="hash-link" aria-label="6. SPI NOR 驱动的直接链接" title="6. SPI NOR 驱动的直接链接">​</a></h2>
<p>本章节描述 SPI NOR 驱动的相关配置和使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-驱动框架">6.1. 驱动框架<a href="#61-驱动框架" class="hash-link" aria-label="6.1. 驱动框架的直接链接" title="6.1. 驱动框架的直接链接">​</a></h3>
<p>待完善</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-驱动接口">6.2. 驱动接口<a href="#62-驱动接口" class="hash-link" aria-label="6.2. 驱动接口的直接链接" title="6.2. 驱动接口的直接链接">​</a></h3>
<p>待完善</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="63-初始化和读写">6.3. 初始化和读写<a href="#63-初始化和读写" class="hash-link" aria-label="6.3. 初始化和读写的直接链接" title="6.3. 初始化和读写的直接链接">​</a></h3>
<p>待完善</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="64-添加新器件">6.4. 添加新器件<a href="#64-添加新器件" class="hash-link" aria-label="6.4. 添加新器件的直接链接" title="6.4. 添加新器件的直接链接">​</a></h3>
<p>待完善</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-mmc-驱动">7. MMC 驱动<a href="#7-mmc-驱动" class="hash-link" aria-label="7. MMC 驱动的直接链接" title="7. MMC 驱动的直接链接">​</a></h2>
<p>本章节描述 MMC 驱动的相关配置和使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-驱动框架">7.1. 驱动框架<a href="#71-驱动框架" class="hash-link" aria-label="7.1. 驱动框架的直接链接" title="7.1. 驱动框架的直接链接">​</a></h3>
<p>U-Boot 驱动模型支持 MMC，并且通过块设备接口对 MMC 进行访问。ArtInChip 平台中， SPL 和 U-Boot 阶段都支持 MMC 已经块设备接口。 相关配置为：</p>
<blockquote>
<ul>
<li>CONFIG_MMC</li>
<li>CONFIG_DM_MMC</li>
<li>CONFIG_SPL_DM_MMC</li>
<li>CONFIG_BLK</li>
<li>CONFIG_SPL_BLK</li>
<li>CONFIG_MMC_ARTINCHIP</li>
</ul>
</blockquote>
<p>相关源码有：</p>
<blockquote>
<ul>
<li><code>include/mmc.h</code></li>
<li><code>include/blk.h</code></li>
<li><code>drivers/block/blk-uclass.c</code></li>
<li><code>drivers/mmc/mmc-uclass.c</code></li>
<li><code>drivers/mmc/artinchip_mmc.c</code></li>
</ul>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-驱动接口">7.2. 驱动接口<a href="#72-驱动接口" class="hash-link" aria-label="7.2. 驱动接口的直接链接" title="7.2. 驱动接口的直接链接">​</a></h3>
<p>常用驱动接口：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unsigned long blk_dread(struct blk_desc *block_dev, lbaint_t start,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lbaint_t blkcnt, void *buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned long blk_dwrite(struct blk_desc *block_dev, lbaint_t start,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             lbaint_t blkcnt, const void *buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned long blk_derase(struct blk_desc *block_dev, lbaint_t start,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             lbaint_t blkcnt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct mmc *mmc_create(const struct mmc_config *cfg, void *priv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_bind(struct udevice *dev, struct mmc *mmc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         const struct mmc_config *cfg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void mmc_destroy(struct mmc *mmc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_unbind(struct udevice *dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_initialize(bd_t *bis);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_init(struct mmc *mmc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_send_tuning(struct mmc *mmc, u32 opcode, int *cmd_error);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_of_parse(struct udevice *dev, struct mmc_config *cfg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_read(struct mmc *mmc, u64 src, uchar *dst, int size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int mmc_set_clock(struct mmc *mmc, uint clock, bool disable);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="73-初始化和使用">7.3. 初始化和使用<a href="#73-初始化和使用" class="hash-link" aria-label="7.3. 初始化和使用的直接链接" title="7.3. 初始化和使用的直接链接">​</a></h3>
<p>本章节主要介绍 MMC 以及对应的 BLK 设备的初始化流程，以及读写流程。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="731-绑定阶段">7.3.1. 绑定阶段<a href="#731-绑定阶段" class="hash-link" aria-label="7.3.1. 绑定阶段的直接链接" title="7.3.1. 绑定阶段的直接链接">​</a></h4>
<p>使用时，MMC 设备通过 BLK 块设备接口进行使用。MMC 设备与 BLK 设备之间的关系如 <a href="#ref-mmc-blk">图 3.4</a> 所示。</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/mmc_relation-17066883824881.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/mmc_relation.png" class="img_ev3q"></p>
<p>图 3.4 <em>MMC 与 BLK 设备的关系</em></p>
<p>对于每一个 MMC 设备，在绑定阶段，都会创建一个对应的 MMC_BLK 块设备，并且 MMC_BLK 设备的 <code>parent</code> 指向当前 MMC 设备。 ArtInChip MMC 设备绑定对应的 MMC 设备驱动， MMC_BLK 设备绑定 <code>mmc-uclass</code> 中的 <code>mmc_blk</code> 驱动。</p>
<p>读写操作时，通过 <code>mmc_blk</code> 驱动的读写函数，转为对 mmc 的操作。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static const struct blk_ops mmc_blk_ops = { // drivers/mmc/mmc-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .read   = mmc_bread,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if CONFIG_IS_ENABLED(MMC_WRITE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .write  = mmc_bwrite,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .erase  = mmc_berase,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .select_hwpart  = mmc_select_hwpart,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面的绑定流程演示了创建 MMC_BLK 设备，并且进行关联的过程。</p>
<p><strong>使用 PLATDATA 时</strong></p>
<p>在 SPL 中，使能 PLATDATA 时的绑定流程如下。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reset // arch/arm/cpu/armv7/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; _main   // arch/arm/lib/crt0.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; board_init_f(); // arch/arm/mach-artinchip/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_early_init() // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spl_common_init(setup_malloc = true) // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; dm_init_and_scan(!CONFIG_IS_ENABLED(OF_PLATDATA));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; dm_scan_platdata(pre_reloc_only=false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt; lists_bind_drivers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            |-&gt; device_bind_by_name(parent, false, entry, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                |-&gt; drv = lists_driver_lookup_name(info-&gt;name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                |   // 搜索 U_BOOT_DRIVER(name) 声明的 driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                |-&gt; device_bind_common(); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    |-&gt; uclass_get(&amp;uc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    |-&gt; uclass_bind_device(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    |-&gt; drv-&gt;bind(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        aic_dwmmc_bind(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aic_dwmmc_bind(dev); // drivers/mmc/artinchip_dw_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; dwmci_bind(dev, ...); // drivers/mmc/dw_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mmc_bind(dev, &amp;plat-&gt;mmc, &amp;plat-&gt;cfg) // drivers/mmc/mmc-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |  // 绑定一个 IF_TYPE_MMC 的 Block 子设备，这样可以通过块设备的接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |  // 使用 MMC。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; blk_create_devicef(dev, &quot;mmc_blk&quot;, &quot;blk&quot;,IF_TYPE_MMC, devnum,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |                   512, 0, &amp;bdev); // drivers/block/blk-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; blk_create_device(parent, &quot;mmc_blk&quot;, dev_name, if_type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |       |                 devnum, blksz, lba, devp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |       |-&gt; device_bind_driver(parent, drv_name, name, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |   // drivers/core/lists.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |-&gt; ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |               |-&gt; device_bind_common(dm_root, ...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; uclass_get(drv-&gt;id, &amp;uc); id = UCLASS_BLK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; dev = calloc(1, sizeof(struct udevice));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;name = name // 块设备名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;parent = parent // 指向 MMC 设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;driver = drv // &quot;mmc_blk&quot; driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;uclass = uc // UCLASS_BLK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   // 创建设备 mmc_blk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; uclass_bind_device(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                       // 将设备添加到 UCLASS_BLK 列表中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; dev_get_uclass_platdata(bdev);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>使用 DTS 时</strong></p>
<p>使用 DTS 时，SPL 和 U-Boot 中的绑定流程如下。在 DTS 中，MMC 控制器是 <code>soc</code> 的子节点， 挂载到 <code>simple-bus</code> 中，因此相关绑定在 <code>soc</code> 设备绑定 <code>simple-bus</code> 驱动后被触发， 因此在 <code>simple_bus_post_build()</code> 中处理。</p>
<p>U-Boot 阶段的 MMC 绑定在 <code>initf_dm</code> 中进行。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">simple_bus_post_bind(); // drivers/core/simple-bus.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; dm_scan_fdt_dev(dev); // drivers/core/root.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; dm_scan_fdt_node();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; lists_bind_fdt(); // drivers/core/lists.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |   // 通过 compatible 匹配设备和驱动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; device_bind_with_driver_data();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; device_bind_common(); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; uclass_get(&amp;uc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; uclass_bind_device(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; drv-&gt;bind(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        aic_dwmmc_bind(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         +------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aic_dwmmc_bind(dev); // drivers/mmc/artinchip_dw_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; dwmci_bind(dev, ...); // drivers/mmc/dw_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mmc_bind(dev, &amp;plat-&gt;mmc, &amp;plat-&gt;cfg); // drivers/mmc/mmc-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |  // 绑定一个 IF_TYPE_MMC 的 Block 子设备，这样可以通过块设备的接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |  // 使用 MMC。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; blk_create_devicef(dev, &quot;mmc_blk&quot;, &quot;blk&quot;,IF_TYPE_MMC, devnum,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |                   512, 0, &amp;bdev); // drivers/block/blk-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; blk_create_device(parent, &quot;mmc_blk&quot;, dev_name, if_type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |       |                   devnum, blksz, lba, devp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |       |-&gt; device_bind_driver(parent, drv_name, name, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |   // drivers/core/lists.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |-&gt; ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |               |-&gt; device_bind_common(dm_root, ...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; uclass_get(drv-&gt;id, &amp;uc); id = UCLASS_BLK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; dev = calloc(1, sizeof(struct udevice));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;name = name; // 块设备名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;parent = parent; // 指向 MMC 设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;driver = drv; // &quot;mmc_blk&quot; driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   dev-&gt;uclass = uc; // UCLASS_BLK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |   // 创建设备 mmc_blk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; uclass_bind_device(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                       // 将设备添加到 UCLASS_BLK 列表中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; dev_get_uclass_platdata(bdev);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="732-probe-流程">7.3.2. Probe 流程<a href="#732-probe-流程" class="hash-link" aria-label="7.3.2. Probe 流程的直接链接" title="7.3.2. Probe 流程的直接链接">​</a></h4>
<p>SPL 中的 Probe 流程如下。由于 BLK 设备的 probe 的目的是调用 <code>mmc_init()</code> ， 这里直接调用，所以不需要单独的 Probe 了。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spl_mmc_load(); // common/spl/spl_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_mmc_find_device(&amp;mmc, bootdev-&gt;boot_device);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; mmc_initialize(NULL); // drivers/mmc/mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |   |-&gt; mmc_probe(bis);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |-&gt; uclass_get(UCLASS_MMC, &amp;uc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |-&gt; device_probe(dev); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |  // 这里对 UCLASS_MMC 列表中的设备逐个调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |  // device_probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |--&gt; aic_dwmmc_probe(...) // 具体驱动的 probe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mmc_init(mmc);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>U-Boot 中 MMC 设备和对应的 BLK 设备 Probe 流程如下。</p>
<p>MMC 设备的 Probe 在 <code>board_init_r()</code> 调用 <code>initr_mmc()</code> 时进行。对应的 BLK 设备的 Probe 在第一次使用时进行，通常是 <code>initr_env()</code> ，该函数加载 MMC 上的环境变量。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r(gd_t *new_gd, ulong dest_addr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_dm(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_mmc(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_env(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">initr_mmc(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mmc_initialize(gd-&gt;bd); // drivers/mmc/mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mmc_probe(bis = gd-&gt;bd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; uclass_get(UCLASS_MMC, &amp;uc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; device_probe(dev); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |  // 这里对 UCLASS_MMC 列表中的设备逐个调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |  // device_probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |--&gt; aic_dwmmc_probe(...) // 具体驱动的 probe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">initr_env(void) // common/board_r.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; env_relocate(void) // env/common.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; env_load(void) // env/env.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | // 这个函数执行读取环境变量的动作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; drv = env_driver_lookup(ENVOP_LOAD, prio)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   // u-boot 通过 U_BOOT_ENV_LOCATION 宏定义了各种可以用于加载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   // 环境变量的驱动 (struct env_driver)，并且在 lds 中将这些</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   // 驱动收集到一个固定的段中，这里遍历各个驱动，尝试加载 ENV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; drv-&gt;load()/env_mmc_load(void) // env/mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            env_mmc_load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env_mmc_load(); // env/mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|--&gt; devno = mmc_get_env_dev();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|--&gt; mmc = find_mmc_device(devno);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |--&gt; init_mmc_for_env(mmc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |--&gt; blk_get_from_parent(mmc-&gt;dev, &amp;dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |--&gt; device_find_first_child(parent, &amp;blkdev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |    // 获取 mmc_blk 设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |--&gt; device_probe(blkdev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |--&gt; mmc_blk_probe(...) // drivers/mmc/mmc-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         |--&gt; mmc_init(mmc) // drivers/mmc/mmc.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="733-读写流程">7.3.3. 读写流程<a href="#733-读写流程" class="hash-link" aria-label="7.3.3. 读写流程的直接链接" title="7.3.3. 读写流程的直接链接">​</a></h4>
<p>通过 BLK 接口对 MMC 进行读写的调用流程如下。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">blk_dread(mmc_get_blk_desc(mmc), blk, cnt, addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    // drivers/block/blk-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|--&gt; ops-&gt;read(dev, start, blkcnt, buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     mmc_bread(dev, start, blkcnt, buffer); // drivers/mmc/mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |--&gt; mmc_read_blocks(mmc, dst, start, cur); // drivers/mmc/mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |--&gt; mmc_send_cmd(mmc, &amp;cmd, &amp;data) //drivers/mmc/mmc-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |--&gt; ops-&gt;send_cmd(dev, cmd, data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dwmci_send_cmd(dev, cmd, data); // drivers/mmc/dw_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blk_dwrite(mmc_get_blk_desc(mmc), blk, cnt, addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    // drivers/block/blk-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|--&gt; ops-&gt;write(dev, start, blkcnt, buffer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     mmc_bwrite(dev, start, blkcnt, buffer); // drivers/mmc/mmc_write.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-&gt; mmc_write_blocks(mmc, start, cur, src); // drivers/mmc/mmc_write.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |--&gt; mmc_send_cmd(mmc, &amp;cmd, &amp;data) //drivers/mmc/mmc-uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |--&gt; ops-&gt;send_cmd(dev, cmd, data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dwmci_send_cmd(dev, cmd, data); // drivers/mmc/dw_mmc.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part5/03-8_DriverSupport.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/D213-DevKit/part5/03-7_U-BootStage"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">U-Boot 阶段</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/D213-DevKit/part5/03-9_PartitionConfiguration"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">分区配置</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-clock-驱动" class="table-of-contents__link toc-highlight">1. Clock 驱动</a><ul><li><a href="#11-驱动框架" class="table-of-contents__link toc-highlight">1.1. 驱动框架</a></li><li><a href="#12-驱动接口" class="table-of-contents__link toc-highlight">1.2. 驱动接口</a></li><li><a href="#13-初始化和使用" class="table-of-contents__link toc-highlight">1.3. 初始化和使用</a></li></ul></li><li><a href="#2-reset-驱动" class="table-of-contents__link toc-highlight">2. Reset 驱动</a><ul><li><a href="#21-驱动框架" class="table-of-contents__link toc-highlight">2.1. 驱动框架</a></li><li><a href="#22-驱动接口" class="table-of-contents__link toc-highlight">2.2. 驱动接口</a></li><li><a href="#23-初始化和使用" class="table-of-contents__link toc-highlight">2.3. 初始化和使用</a></li></ul></li><li><a href="#3-dma-驱动" class="table-of-contents__link toc-highlight">3. DMA 驱动</a><ul><li><a href="#31-驱动框架" class="table-of-contents__link toc-highlight">3.1. 驱动框架</a></li><li><a href="#32-驱动接口" class="table-of-contents__link toc-highlight">3.2. 驱动接口</a></li><li><a href="#33-实现说明" class="table-of-contents__link toc-highlight">3.3. 实现说明</a></li><li><a href="#34-初始化流程" class="table-of-contents__link toc-highlight">3.4. 初始化流程</a></li></ul></li><li><a href="#4-spi-驱动" class="table-of-contents__link toc-highlight">4. SPI 驱动</a><ul><li><a href="#41-驱动框架" class="table-of-contents__link toc-highlight">4.1. 驱动框架</a></li><li><a href="#42-驱动接口" class="table-of-contents__link toc-highlight">4.2. 驱动接口</a></li><li><a href="#43-初始化流程" class="table-of-contents__link toc-highlight">4.3. 初始化流程</a></li><li><a href="#44-dma-的支持" class="table-of-contents__link toc-highlight">4.4. DMA 的支持</a></li><li><a href="#45-quad-spi-的支持" class="table-of-contents__link toc-highlight">4.5. QUAD SPI 的支持</a></li></ul></li><li><a href="#5-spi-nand-驱动" class="table-of-contents__link toc-highlight">5. SPI NAND 驱动</a><ul><li><a href="#51-驱动框架" class="table-of-contents__link toc-highlight">5.1. 驱动框架</a></li><li><a href="#52-驱动接口" class="table-of-contents__link toc-highlight">5.2. 驱动接口</a></li><li><a href="#53-初始化和读写" class="table-of-contents__link toc-highlight">5.3. 初始化和读写</a></li><li><a href="#54-添加新器件" class="table-of-contents__link toc-highlight">5.4. 添加新器件</a></li></ul></li><li><a href="#6-spi-nor-驱动" class="table-of-contents__link toc-highlight">6. SPI NOR 驱动</a><ul><li><a href="#61-驱动框架" class="table-of-contents__link toc-highlight">6.1. 驱动框架</a></li><li><a href="#62-驱动接口" class="table-of-contents__link toc-highlight">6.2. 驱动接口</a></li><li><a href="#63-初始化和读写" class="table-of-contents__link toc-highlight">6.3. 初始化和读写</a></li><li><a href="#64-添加新器件" class="table-of-contents__link toc-highlight">6.4. 添加新器件</a></li></ul></li><li><a href="#7-mmc-驱动" class="table-of-contents__link toc-highlight">7. MMC 驱动</a><ul><li><a href="#71-驱动框架" class="table-of-contents__link toc-highlight">7.1. 驱动框架</a></li><li><a href="#72-驱动接口" class="table-of-contents__link toc-highlight">7.2. 驱动接口</a></li><li><a href="#73-初始化和使用" class="table-of-contents__link toc-highlight">7.3. 初始化和使用</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>