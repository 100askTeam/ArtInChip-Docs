<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-D213-DevKit/part5/03-6_SPLStage" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">SPL 阶段 | 东山Π</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://artinchip.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://artinchip.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-6_SPLStage"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SPL 阶段 | 东山Π"><meta data-rh="true" name="description" content="Artinchip 平台上的 SPL(Secondary Program Loader) 是第一级引导程序(FSBL, First Stage Boot Loader)， 同时也是第二级程序加载器。"><meta data-rh="true" property="og:description" content="Artinchip 平台上的 SPL(Secondary Program Loader) 是第一级引导程序(FSBL, First Stage Boot Loader)， 同时也是第二级程序加载器。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-6_SPLStage"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-6_SPLStage" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part5/03-6_SPLStage" hreflang="en"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-6_SPLStage" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d875fe7e.css">
<script src="/assets/js/runtime~main.ccbe88ba.js" defer="defer"></script>
<script src="/assets/js/main.498bbc78.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">东山Π</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/D213-DevKit/BoardIntroduction">D213-DevKit</a><a class="navbar__item navbar__link" href="/docs/category/luban-sdk使用指南">Luban-SDK</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/docs/D213-DevKit/part5/03-6_SPLStage" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/en/docs/D213-DevKit/part5/03-6_SPLStage" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/ArtInChip-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/BoardIntroduction">匠心创D213-DevKit开发板</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/SupportingResources">源码工具文档手册</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/快速启动">快速启动</a><button aria-label="展开侧边栏分类 &#x27;快速启动&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/D213-DevKit/ConfigHostEnv">安装并配置开发环境</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/luban-sdk开发">Luban-SDK开发</a><button aria-label="展开侧边栏分类 &#x27;Luban-SDK开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/luban-linux系统开发">Luban-Linux系统开发</a><button aria-label="展开侧边栏分类 &#x27;Luban-Linux系统开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux-bringup参考">Linux-Bringup参考</a><button aria-label="展开侧边栏分类 &#x27;Linux-Bringup参考&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/linux-uboot开发">Linux-Uboot开发</a><button aria-label="折叠侧边栏分类 &#x27;Linux-Uboot开发&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-1_BasicIntroduction">ArtInChip U-Boot介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-2_StartupParameter">启动参数</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-3_MemoryDependent">内存相关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-4_EnvironmentVariables">环境变量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-5_DTS">DTS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/D213-DevKit/part5/03-6_SPLStage">SPL 阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-7_U-BootStage">U-Boot 阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-8_DriverSupport">驱动支持</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-9_PartitionConfiguration">分区配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-10_BootKernel">启动内核</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-11_PackImage">打包镜像</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-12_ImageBurn">镜像烧录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-13_UserIDBurn">模块介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-14_ImageDisplay">图像显示</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-15_DebugConfiguration">调试配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-16_OpenSBI">OpenSBI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/D213-DevKit/part5/03-17_PBP">Pre-Boot Program</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/linux-uboot开发"><span itemprop="name">Linux-Uboot开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SPL 阶段</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>SPL 阶段</h1>
<p>Artinchip 平台上的 SPL(Secondary Program Loader) 是第一级引导程序(FSBL, First Stage Boot Loader)， 同时也是第二级程序加载器。</p>
<blockquote>
<p>BROM -&gt; SPL -&gt; U-Boot -&gt; Kernel</p>
</blockquote>
<p>SPL 运行在 SRAM 中，其最重要的任务有两个：</p>
<ul>
<li>完成 DDR，并且使能 Cache</li>
<li>加载和验证 U-Boot</li>
</ul>
<p>在一些启动速度优化的方案中，也可以直接从 SPL 启动 Kernel。 本章节描述不同启动介质的 SPL 处理流程，以及安全启动的相关处理。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-riscv-spl">1. RISCV SPL<a href="#1-riscv-spl" class="hash-link" aria-label="1. RISCV SPL的直接链接" title="1. RISCV SPL的直接链接">​</a></h2>
<p>SPL BSS 的配置</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CONFIG_SPL_TEXT_BASE=0x103100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONFIG_SPL_SIZE_LIMIT=0x10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define CONFIG_SPL_MAX_SIZE                 (CONFIG_SPL_SIZE_LIMIT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define CONFIG_SPL_STACK                    (D211_SRAM_BASE + D211_SRAM_SIZE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define CONFIG_SPL_BSS_START_ADDR   (CONFIG_SPL_TEXT_BASE + CONFIG_SPL_MAX_SIZE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define CONFIG_SPL_BSS_MAX_SIZE             0x00002000 /* 8 KiB */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>即 BSS 从 0x113100 开始，后续还有 SPL STACK 的空间，HEAP 的空间。</p>
<p>对于 spl.aic 文件，在 spl.bin 的后面还存放着其他的资源数据，如果该数据需要在 SPL 阶段使用， 则需要注意，在 SPL 运行时，资源数据的区域与 BSS 区域不能重合，不然会有数据错误。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-启动流程">2. 启动流程<a href="#2-启动流程" class="hash-link" aria-label="2. 启动流程的直接链接" title="2. 启动流程的直接链接">​</a></h2>
<p>理解spl的启动流程，关键是设备树，设备驱动模型。关于设备树，请查看设备树相关章节，设备驱动模型的介绍如下：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-uboot-设备驱动框架模型">2.1. uboot 设备驱动框架模型<a href="#21-uboot-设备驱动框架模型" class="hash-link" aria-label="2.1. uboot 设备驱动框架模型的直接链接" title="2.1. uboot 设备驱动框架模型的直接链接">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; uclass &lt;–&gt; uclass_driver &lt;–&gt; udevice &lt;–&gt; driver &lt;–&gt; hardware</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>uclass表示管理某一个类别下的所有device;</p>
<p>uclass_driver表示对应uclass的ops集合。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-uboot-设备驱动框架搭建的过程">2.2. uboot 设备驱动框架搭建的过程<a href="#22-uboot-设备驱动框架搭建的过程" class="hash-link" aria-label="2.2. uboot 设备驱动框架搭建的过程的直接链接" title="2.2. uboot 设备驱动框架搭建的过程的直接链接">​</a></h3>
<blockquote>
<ol>
<li>创建udevice</li>
<li>应用uclass如果没有则匹配生成uclass</li>
<li>udevice和uclass绑定</li>
<li>uclass_driver和uclass绑定</li>
<li>driver和udevice绑定</li>
<li>device_probe执行，会触发uclass_driver调用driver函数</li>
</ol>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-spl-riscv-的启动整体流程">2.3. SPL RISCV 的启动整体流程<a href="#23-spl-riscv-的启动整体流程" class="hash-link" aria-label="2.3. SPL RISCV 的启动整体流程的直接链接" title="2.3. SPL RISCV 的启动整体流程的直接链接">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">_start // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; save_boot_params // arch/riscv/mach-artinchip/lowlevel_init.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // BROM 跳转到 SPL 执行的时候，传递了一些参数，这里首先需要将这些参数保存起来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; csrw    MODE_PREFIX(ie), zero // Disable irq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; li      t1, CONFIG_SPL_STACK // 设置sp寄存器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; jal     board_init_f_alloc_reserve // common/init/board_init.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 预留初始 HEAP 的空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 预留 GD 全局变量的空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; jal     board_init_f_init_reserve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // common/init/board_init.c, init gd area</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 此时 gd 在 SPL STACK 中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; jal     icache_enable // arch/riscv/cpu/c906/cache.c 使能指令高速缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; jal     dcache_enable // 使能数据高速缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; jal     debug_uart_init // drivers/serial/ns16550.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| // 初始化调试串口，如果使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; board_init_f // arch/riscv/lib/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; spl_early_init() // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; spl_common_init(setup_malloc = true) // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |-&gt; fdtdec_setup();  // lib/fdtdec.c 获取dtb的地址，并验证合法性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           | // 只对带有“u-boot,dm-pre-reloc”属性节点进行解析，初始化驱动模型的根节点，扫描设备树创建udevice,uclass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |-&gt; dm_init_and_scan(!CONFIG_IS_ENABLED(OF_PLATDATA)); // drivers/core/root.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; dm_init(); // driver model, initiate virtual root driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |-&gt; INIT_LIST_HEAD(DM_UCLASS_ROOT_NON_CONST); // 初始化uclass链表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |-&gt; device_bind_by_name()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   // 加载&quot;root_driver&quot;name, gd-&gt;dm_root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |-&gt; lists_driver_lookup_name()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   |-&gt; ll_entry_start(struct driver, driver); // 获取driver table起始位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   |-&gt; ll_entry_count(struct driver, driver); // 获取driver table长度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   // drivers/core/lists.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   // 采用 U_BOOT_DRIVER(name) 声明的 driver，从driver table中获取struct driver数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   // 初始化udevice 与对应的uclass,driver绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |-&gt; device_bind_common(); // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |-&gt; uclass_get(&amp;uc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |   |-&gt; uclass_find(id); // 判断对应的uclass是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |   |-&gt; uclass_add(id, ucp); // 如果不存在就创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |       |-&gt; lists_uclass_lookup(id); // 获取uclass_driver结构体数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |-&gt; uclass_bind_device(dev) // uclass绑定udevice drivers/core/uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |-&gt; drv-&gt;bind(dev)  // driver绑定udevice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |-&gt; parent-&gt;driver-&gt;child_post_bind(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |-&gt; uc-&gt;uc_drv-&gt;post_bind(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |-&gt; device_probe(gd-&gt;dm_root) // drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |-&gt; uclass_resolve_seq(dev) // 通过dtb解析获得设备差异数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |-&gt; uclass_pre_probe_device(dev); // probe前操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |-&gt; drv-&gt;probe(dev); // 执行driver的probe操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |-&gt; uclass_post_probe_device(dev); // probe后操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; dm_scan(pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   // 扫描和绑定由 U_BOOT_DEVICE 声明的驱动。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   // 一般用在 SPL OF_PLATDATA 的情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |-&gt; dm_scan_plat(pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |-&gt; lists_bind_drivers(DM_ROOT_NON_CONST, pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |       |-&gt; bind_drivers_pass(parent, pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |           |-&gt; device_bind_by_name();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |-&gt; dm_extended_scan(pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |-&gt; dm_scan_fdt(pre_reloc_only); // 扫描设备树并与设备驱动建立联系</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |   |-&gt; dm_scan_fdt_node(gd-&gt;dm_root, ofnode_root(), pre_reloc_only); //扫描设备树并绑定root节点下的设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |       |-&gt; ofnode_first_subnode(parent_node) // 获取设备树的第一个子节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |       |-&gt; ofnode_next_subnode(node) // 遍历所有的子节点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |       |-&gt; ofnode_is_enabled(node) // 判断设备树的子节点是否使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |       |-&gt; lists_bind_fdt(parent, node, NULL, pre_reloc_only); // 绑定设备树节点，创建新的udevicd drivers/core/lists.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |           |-&gt; ofnode_get_property(node, &quot;compatible&quot;, &amp;compat_length); // 获取compatible</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |           |-&gt; driver_check_compatible() // 和driver比较compatible值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |           |-&gt; device_bind_with_driver_data() // 创建一个设备并绑定到driver drivers/core/device.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |               |-&gt; device_bind_common() // 创建初始化udevice 与对应的uclass,driver绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   | // /chosen /clocks /firmware 一些节点本身不是设备，但包含一些设备，遍历其包含的设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   |-&gt; dm_scan_fdt_ofnode_path(nodes[i], pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |       |-&gt; ofnode_path(path); // 找到节点下包含的设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |       |-&gt; dm_scan_fdt_node(gd-&gt;dm_root, node, pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |-&gt; dm_scan_other(pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                   |   // 扫描使用者自定义的节点 nothing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_clear_bss // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_relocate_stack_gd   // 切换stack 和 gd 到dram空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; board_init_r()    // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_set_bd()  // board data info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   // 设置完 bd 之后，才能 enable d-cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mem_malloc_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   // init heap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   //  - CONFIG_SYS_SPL_MALLOC_START</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   //  - CONFIG_SYS_SPL_MALLOC_SIZE&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; spl_common_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       // 由于前面已经调用了 spl_early_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       // 这里不再调用 spl_common_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; timer_init(); // lib/time.c nothing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_board_init(); // arch/riscv/mach-artinchip/spl.c nothing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; initr_watchdog  // enable watchdog，如果使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; dram_init_banksize(); // 如果使能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; board_boot_order() // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; spl_boot_device(); // arch/riscv/mach-artinchip/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       |-&gt; aic_get_boot_device(); // arch/riscv/mach-artinchip/boot_param.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |           // 从 boot param 中获取启动介质信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; boot_from_devices(spl_boot_list)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |       // 这里可能是各种介质的 load image 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |       // SPL_LOAD_IMAGE_METHOD() 定义的 Loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |       // 可能是 MMC/SPI/BROM/...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; spl_load_image  // 以emmc启动为例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       |-&gt; spl_mmc_load_image  // common/spl/spl_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |           |-&gt; spl_mmc_load // 具体可看后面的流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_perform_fixups  // vendor hook，用于修改device-tree传递参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_board_prepare_for_boot  // vendor hook, 可不实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; jump_to_image_no_args   // 跳转到u-boot执行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-mmc-加载">3. MMC 加载<a href="#3-mmc-加载" class="hash-link" aria-label="3. MMC 加载的直接链接" title="3. MMC 加载的直接链接">​</a></h2>
<p>SPL 从 MMC 加载 U-Boot 的处理过程。</p>
<p>程序编码的时候，针对 MMC 设备添加了对应的加载程序支持，如 spl_mmc.c 中，通过使用宏:</p>
<blockquote>
<p>SPL_LOAD_IMAGE_METHOD(“MMC1”, 0, BOOT_DEVICE_MMC1, spl_mmc_load_image);</p>
</blockquote>
<p>将 <code>spl_mmc_load_image</code> 函数添加到 .u_boot_list_2_spl_image_loader_* 段。</p>
<p>在 SPL 初始化过程中，通过 <code>boot_from_devices(spl_boot_list)</code> 函数调用，检查当前项目 所支持的 SPL 读取的存储介质类型，然后依次检查是否存在对应的程序加载器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r()    // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; boot_from_devices(spl_boot_list)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 这里可能是各种介质的 load image 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // SPL_LOAD_IMAGE_METHOD() 定义的 Loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 可能是 MMC/SPI/BROM/...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>找到 SPL MMC Loader 之后，从项目配置的指定 Sector 读取数据。</p>
<ul>
<li>CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_SECTOR</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">boot_from_devices(spl_boot_list); // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 此处通过遍历固件的 .u_boot_list_2_spl_image_loader_* 段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 找到当前支持的存储介质，然后逐个尝试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_load_image(loader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; loader-&gt;load_image(spl_image, &amp;bootdev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spl_mmc_load_image();  // common/spl/spl_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_mmc_load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      +-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spl_mmc_load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_mmc_find_device(&amp;mmc, bootdev-&gt;boot_device);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; mmc_initialize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; mmc_probe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |-&gt; uclass_get(UCLASS_MMC, &amp;uc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           |-&gt; device_probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; uclass_resolve_seq(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; pinctrl_select_state(dev, &quot;default&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |-&gt; pinctrl_select_state_full(dev, &quot;default&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |-&gt; state = dev_read_stringlist_search(dev,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |                       &quot;pinctrl-names&quot;, &quot;default&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |-&gt; dev_read_prop(dev, propname, &amp;size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   // snprintf(propname, sizeof(propname),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |   //              &quot;pinctrl-%d&quot;, state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |   |-&gt; pinctrl_config_one(config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |-&gt; ops = pinctrl_get_ops(pctldev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |       |-&gt; ops-&gt;set_state(pctldev, config)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |-&gt; pinctrl_select_state_simple(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |-&gt; uclass_get_device_by_seq(UCLASS_PINCTRL, 0, &amp;pctldev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |-&gt; ops=pinctrl_get_ops(pctldev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |   // #define pinctrl_get_ops(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |   //         ((struct pinctrl_ops *)(dev)-&gt;driver-&gt;ops)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |       |-&gt; ops-&gt;set_state_simple(pctldev, dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; power_domain_on(&amp;powerdomain)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; uclass_pre_probe_device(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; clk_set_defaults(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |-&gt; clk_set_default_parents(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |   |-&gt; clk_set_default_rates(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; drv-&gt;probe(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               |-&gt; uclass_post_probe_device(dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mmc_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; boot_mode=spl_boot_mode(bootdev-&gt;boot_device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mmc_load_image_raw_sector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; header=spl_get_load_buffer(-sizeof(*header), bd-&gt;blksz)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   // header位于load_addr偏移-head_size处</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; blk_dread(bd, sector, 1, header)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   // 读取一个sector的u-boot image header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; mmc_load_legacy(spl_image, mmc, sector, header)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; spl_parse_image_header(spl_image, header)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   // 解析u-boot image header信息，得到u-boot的addr和size信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; blk_dread(bd, sector, cnt, load_addr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读取完整的u-boot image，包括header，注意load_addr是向前偏移过的地址</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-spi-nand-加载">4. SPI NAND 加载<a href="#4-spi-nand-加载" class="hash-link" aria-label="4. SPI NAND 加载的直接链接" title="4. SPI NAND 加载的直接链接">​</a></h2>
<p>官方版本的 SPL 并不支持从 SPI NAND 启动，Artinchip 增加了从 SPI NAND 的 MTD 分区 和 UBI 加载 U-Boot 的支持。</p>
<p>common/spl/spl_spi_nand.c 中注册了两个不同的 SPL 程序加载器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_SPL_UBI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Use priorty 0 to override other SPI device when this device is enabled. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SPL_LOAD_IMAGE_METHOD(&quot;SPINAND_UBI&quot;, 0, BOOT_DEVICE_SPI, spl_ubi_load_image);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SPL_LOAD_IMAGE_METHOD(&quot;SPINAND&quot;, 0, BOOT_DEVICE_SPI, spl_spi_nand_load_image);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-u-boot- 保存在-mtd-分区时">4.1. U-Boot 保存在 MTD 分区时<a href="#41-u-boot-保存在-mtd-分区时" class="hash-link" aria-label="4.1. U-Boot 保存在 MTD 分区时的直接链接" title="4.1. U-Boot 保存在 MTD 分区时的直接链接">​</a></h3>
<p>在 SPL 初始化过程中，通过 <code>boot_from_devices(spl_boot_list)</code> 函数调用，检查当前项目 所支持的 SPL 读取的存储介质类型，然后依次检查是否存在对应的程序加载器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r()    // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; boot_from_devices(spl_boot_list)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 这里可能是各种介质的 load image 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // SPL_LOAD_IMAGE_METHOD() 定义的 Loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 可能是 MMC/SPI/BROM/...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>找到 SPL SPINAND Loader 之后，从项目配置的指定位置读取数据。</p>
<ul>
<li>CONFIG_SYS_SPI_NAND_U_BOOT_OFFS</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">boot_from_devices(spl_boot_list); // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 此处通过遍历固件的 .u_boot_list_2_spl_image_loader_* 段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 找到当前使能的存储介质驱动，然后逐个尝试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_load_image(loader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; loader-&gt;load_image(spl_image, &amp;bootdev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spl_spi_nand_load_image();  // arch/arm/mach-artinchip/spl_spi_nand.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_spi_nand_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; uclass_first_device(UCLASS_MTD, &amp;dev); // drivers/core/uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; mtd_probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; get_mtd_device(NULL, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_get_load_buffer(-sizeof(*header), sizeof(*header));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_spi_nand_read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   // 读取头信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_parse_image_header(spl_image, header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_spi_nand_read();// arch/arm/mach-artinchip/spl_spi_nand.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |  // 读取整个 U-Boot 镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; mtd_block_isbad(mtd, off);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |   // 跳过坏块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; mtd_read(); // drivers/mtd/mtdcore.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-u-boot-保存在-ubi-中时">4.2. U-Boot 保存在 UBI 中时<a href="#42-u-boot-保存在-ubi-中时" class="hash-link" aria-label="4.2. U-Boot 保存在 UBI 中时的直接链接" title="4.2. U-Boot 保存在 UBI 中时的直接链接">​</a></h3>
<p>在 SPL 初始化过程中，通过 <code>boot_from_devices(spl_boot_list)</code> 函数调用，检查当前项目 所支持的 SPL 读取的存储介质类型，然后依次检查是否存在对应的程序加载器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r()    // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; boot_from_devices(spl_boot_list)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 这里可能是各种介质的 load image 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // SPL_LOAD_IMAGE_METHOD() 定义的 Loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 可能是 MMC/SPI/BROM/...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>找到 SPL SPINAND UBI Loader 之后，从项目配置的指定位置读取数据。</p>
<ul>
<li>CONFIG_SPL_UBI_INFO_ADDR</li>
<li>CONFIG_SPL_UBI_PEB_OFFSET</li>
<li>CONFIG_SPL_UBI_VID_OFFSET</li>
<li>CONFIG_SPL_UBI_LEB_START</li>
</ul>
<p>或者从指定 Volume 中读取</p>
<ul>
<li>CONFIG_SPL_UBI_LOAD_MONITOR_VOLNAME</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">boot_from_devices(spl_boot_list); // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 此处通过遍历固件的 .u_boot_list_2_spl_image_loader_* 段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 找到当前支持的存储介质，然后逐个尝试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_load_image(loader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; loader-&gt;load_image(spl_image, &amp;bootdev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spl_ubi_load_image(); // arch/arm/mach-artinchip/spl_spi_nand.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_spi_nand_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; uclass_first_device(UCLASS_MTD, &amp;dev); // drivers/core/uclass.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; mtd_probe(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; get_mtd_device(NULL, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_get_load_buffer(-sizeof(*header), sizeof(*header));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; ubispl_load_volumes(&amp;info, volumes, 1); // drivers/mtd/ubispl/ubispl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |  // 读取整个 U-Boot 镜像的内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; ipl_scan(ubi);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; ipl_load(ubi, lv-&gt;vol_id, lv-&gt;load_addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |       |   // drivers/mtd/ubispl/ubispl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |       |-&gt; ubi_load_block(ubi, laddr, vi, vol_id, lnum, last);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |-&gt; ubi_io_is_bad(ubi, pnum); // drivers/mtd/ubi/io.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |   // drivers/mtd/ubispl/ubispl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           |-&gt; ubi_io_read(ubi, laddr, pnum, ubi-&gt;leb_start, dlen);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |               |  // drivers/mtd/ubispl/ubispl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |               |-&gt; ubi-&gt;read(pnum + ubi-&gt;peb_offset, from, len, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   nand_spl_read_block(pnum + ubi-&gt;peb_offset,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |                       from, len, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |  // arch/arm/mach-artinchip/spl_spi_nand.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                   |-&gt; mtd_read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_parse_image_header(spl_image, header);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-读数-spi-nand-数据的流程">4.3. 读数 SPI NAND 数据的流程<a href="#43-读数-spi-nand-数据的流程" class="hash-link" aria-label="4.3. 读数 SPI NAND 数据的流程的直接链接" title="4.3. 读数 SPI NAND 数据的流程的直接链接">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mtd_read(); // drivers/mtd/mtdcore.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; mtd-&gt;_read_oob(mtd, from, &amp;ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    part_read_oob(mtd, from, ops); // drivers/mtd/mtdpart.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spinand_mtd_read(mtd, from, &amp;ops); // drivers/mtd/nand/spi/core.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spinand_read_page(spinand, &amp;iter.req, enable_ecc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_load_page_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |   |-&gt; spi_mem_exec_op(spinand-&gt;slave, &amp;op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |       |   // drivers/spi/spi-mem-nodm.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |       |-&gt; spi_xfer(slave, op_len * 8, op_buf, NULL, flag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spinand_read_from_cache_op(spinand, req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; spi_mem_exec_op(spinand-&gt;slave, &amp;op);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; spi_xfer(slave, op_len * 8, op_buf, NULL, flag);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-spi-nor-加载">5. SPI NOR 加载<a href="#5-spi-nor-加载" class="hash-link" aria-label="5. SPI NOR 加载的直接链接" title="5. SPI NOR 加载的直接链接">​</a></h2>
<p>common/spl/spl_spi.c 中通过宏注册了 SPI NOR 的程序加载器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SPL_LOAD_IMAGE_METHOD(&quot;SPI&quot;, 1, BOOT_DEVICE_SPI, spl_spi_load_image);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 SPL 初始化过程中，通过 <code>boot_from_devices(spl_boot_list)</code> 函数调用，检查当前项目 所支持的 SPL 读取的存储介质类型，然后依次检查是否存在对应的程序加载器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r()    // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; boot_from_devices(spl_boot_list)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 这里可能是各种介质的 load image 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // SPL_LOAD_IMAGE_METHOD() 定义的 Loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 可能是 MMC/SPI/BROM/...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制 代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>找到 SPL SPI NOR Loader 之后，从项目配置的指定位置读取数据。</p>
<p>SPI NOR 加载器需要编译时配置所用的 SPI 信息：</p>
<ul>
<li>CONFIG_SF_DEFAULT_BUS</li>
<li>CONFIG_SF_DEFAULT_CS</li>
<li>CONFIG_SF_DEFAULT_SPEED</li>
<li>CONFIG_SF_DEFAULT_MODE</li>
</ul>
<p>读取数据的位置通过下面的配置指定:</p>
<ul>
<li>CONFIG_SYS_SPI_U_BOOT_OFFS</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">boot_from_devices(spl_boot_list); // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 此处通过遍历固件的 .u_boot_list_2_spl_image_loader_* 段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 找到当前支持的存储介质，然后逐个尝试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_load_image(loader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; loader-&gt;load_image(spl_image, &amp;bootdev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spl_spi_load_image();  // common/spl/spl_spi.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spi_flash_probe();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_get_load_buffer(-sizeof(*header), sizeof(*header));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spi_flash_read(header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_parse_image_header();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spi_flash_read();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; spi_flash_read_dm(flash-&gt;dev, offset, len, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; sf_get_ops(dev)-&gt;read(dev, offset, len, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    spi_flash_std_read(dev, offset, len, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    | // drivers/mtd/spi/sf_probe.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; mtd-&gt;_read(mtd, offset, len, &amp;retlen, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            spi_flash_mtd_read(mtd, offset, len, &amp;retlen, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // drivers/mtd/spi/sf_mtd.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-sdfat32-加载">6. SDFAT32 加载<a href="#6-sdfat32-加载" class="hash-link" aria-label="6. SDFAT32 加载的直接链接" title="6. SDFAT32 加载的直接链接">​</a></h2>
<p>SDFAT32启动方式更为简单，不需要专业的烧录工具进行烧写，只需要将镜像文件复制到SD卡即可。</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/load_diff-17066876090051.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/load_diff.png" class="img_ev3q"></p>
<p>图 3.3 <em>MMC与SD卡启动差异</em></p>
<p>SDFAT32是基于MMC建立的，加载程序也在spl_mmc.c中实现，通过使用宏：</p>
<blockquote>
<p>SPL_LOAD_IMAGE_METHOD(“MMC2”, 0, BOOT_DEVICE_MMC2, spl_mmc_load_image);</p>
</blockquote>
<p>将 <code>spl_mmc_load_image</code> 函数添加到 .u_boot_list_2_spl_image_loader_* 段。</p>
<p>在board_init_r(gd_t *dummy1, ulong dummy2)函数中，会调用boot_from_devices从device中去选择启动介质，通过启动介质选择对应的加载程序，获取启动镜像。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// source/uboot-2021.10/common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boot_from_devices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 这里会传递一个空的spl_image_info结构体，以及传递一个启动设备的列表，这里为第一个值为BOOT_DEVICE_MMC2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt;spl_ll_find_loader(bootdev); // bootdev=BOOT_DEVICE_MMC2,根据bootdev查找spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt;spl_load_image(spl_image, loader); // 这里已经获取到对应启动设备的加载器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt;loader-&gt;load_image(spl_image, &amp;bootdev); // 调用加载器的实现函数spl_mmc_load_image</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>进入到对应启动介质的加载程序中，通过CONFIG_SPL_FS_LOAD_PAYLOAD_NAME指定启动镜像配置文件，从中获取镜像在SD卡中的实际地址。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// source/uboot-2021.10/common/spl/spl_fat.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spl_mmc_load_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt;spl_mmc_load(spl_image, bootdev,...); // 这里CONFIG_SPL_FS_LOAD_PAYLOAD_NAME=bootcfg.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;spl_mmc_find_device(&amp;mmc, bootdev-&gt;boot_device); // 先找mmc设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;mmc_init(mmc); // 再进行mmc设备的初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;spl_mmc_boot_mode(bootdev-&gt;boot_device);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       // 选择启动方式，这里获取到的是MMCSD_MODE_FS方式启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;spl_mmc_do_fs_boot(spl_image, mmc, filename); // filename为bootcfg.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt;aic_spl_load_image_fat(spl_image, mmc_get_blk_desc(mmc), filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt;blk_dread(cur_dev, 0, 1, header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |       // 读取SD卡的第0块。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt;check_identifier(header); // 检测SD卡的分区类型选择启动方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt;load_image_from_mbr_part_fat32(header, filename); // 以MBR分区格式去加载镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt;blk_dread(cur_dev, part.lba_start, 1, header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // 读取LBA起始地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt;check_identifier(header); // 检测SD卡分区类型是否为FAT32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt;load_image_from_raw_volume_fat32(part.lba_start, header, filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // 获取BPB内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt;load_image_file(header, filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt;aic_fat_read_file(filename, (u8 *)header, 0, 1024, &amp;actread);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |   // 查找并读取bootcfg.txt文件内容到header地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt;boot_cfg_parse_file((u8 *)header, actread, &quot;boot1&quot;, ...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |   // 解析bootcfg.txt信息，获取image名称，解析U-Boot的大小，以及相对</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |   // image文件中U-Boot所在的偏移地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt;aic_fat_read_file(imgname, header, ...); //读取image文件的header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt;spl_parse_image_header(spl_image, header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |   // 解析U-Boot中前64个字节内容，设置加载地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt;aic_fat_read_file(imgname, (u8 *)spl_image-&gt;load_addr, ...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |   // 读取U-Boot镜像到spl_image-&gt;load_addr地址。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt;board_init_r(); // 跳转回board_init_r()继续执行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>读取U-Boot镜像到内存后，跳转回board_init_r()继续执行</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// source/uboot-2021.10/common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt;spl_perform_fixups // vendor hook，用于修改device-tree传递参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt;jump_to_image_no_args(&amp;spl_image);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;image_entry = (image_entry_withargs_t)spl_image-&gt;entry_point; // 获取U-Boot加载地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;set_boot_device(boot_param, aic_get_boot_device()); // 设置启动介质</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;set_boot_reason(boot_param, aic_get_boot_reason()); // 设置启动原因（冷启动或者热启动）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt;image_entry(boot_param, cur_tm); // 进入U-Boot执行，并传递一些参数</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-签名校验">7. 签名校验<a href="#7-签名校验" class="hash-link" aria-label="7. 签名校验的直接链接" title="7. 签名校验的直接链接">​</a></h2>
<p>U-Boot 官方的代码，SPL 支持 FIT image 的签名。如果固件使用其他格式， 需要自行添加相应的校验支持。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-fit-image-签名校验">7.1. FIT Image 签名校验<a href="#71-fit-image-签名校验" class="hash-link" aria-label="7.1. FIT Image 签名校验的直接链接" title="7.1. FIT Image 签名校验的直接链接">​</a></h3>
<p>要实现验证 FIT Image 的签名，需要在配置中打开选项：</p>
<ul>
<li>CONFIG_SPL_FIT_SIGNATURE</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mmc_load_image_raw_sector(); // common/spl/spl_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_get_load_buffer(-sizeof(*header), bd-&gt;blksz);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; blk_dread(bd, sector, 1, header);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; image_get_magic(header) == FDT_MAGIC // 判断是否为 FIT Image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; spl_load_simple_fit(spl_image, &amp;load, sector, header); // common/spl/spl_fit.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; info-&gt;read(info, sector, sectors, fit);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   h_spl_load_read(info, sector, sectors, fit); // common/spl/spl_mmc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   |-&gt; blk_dread(mmc_get_blk_desc(mmc), sector, count, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; node = spl_fit_get_image_node(fit, images, &quot;loadables&quot;, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; spl_load_fit_image(info, sector, fit, base_offset, node,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |                 spl_image); // common/spl/spl_fit.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; // 中间加载过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; fit_image_verify_with_data(fit, node, src, length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                | // common/image-fit.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; fit_image_check_sig(fit, noffset, data, size, -1, &amp;err_msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |  // common/image-sig.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; fit_image_setup_verify();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; fit_image_hash_get_value();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; info.crypto-&gt;verify(&amp;info, &amp;region, 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            fit_value, fit_value_len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        rsa_verify(&amp;info, &amp;region, 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   fit_value, fit_value_len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   // lib/rsa/rsa-verify.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此处的 rsa-verify 可以对接到硬件 CE，具体可看 <code>UCLASS_MOD_EXP</code> 的相关内容。 如果没有硬件加速器的实现，则使用软件进行计算。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-aic-image-签名校验">7.2. AIC Image 签名校验<a href="#72-aic-image-签名校验" class="hash-link" aria-label="7.2. AIC Image 签名校验的直接链接" title="7.2. AIC Image 签名校验的直接链接">​</a></h3>
<p>制作 SD 量产卡时，由于 Updater U-Boot 固件需要使用 AIC Image 格式， 因此 SD 量产卡启动过程中， SPL-Updater 需要解析 AIC Image 格式。</p>
<p>(TODO: 需要修改原本流程，添加 AIC 格式的支持)</p>
<p>Updater U-Boot 在两种情况下会被使用。第一种情况是通过 USB 升级时，Updater U-Boot 通过 BROM 下载到 DRAM，并且由 BROM 执行。第二种情况是将其烧录到 SD 量产卡， 从 SD 卡启动到 Updater U-Boot 进入升级程序。</p>
<p>为了平台的安全，BROM 所执行 的程序必须经过安全验证，BROM 只支持 AIC Image 格式的固件，因此这里 Updater U-Boot 必须使用 AIC Image 格式。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-返回-brom">8. 返回 BROM<a href="#8-返回-brom" class="hash-link" aria-label="8. 返回 BROM的直接链接" title="8. 返回 BROM的直接链接">​</a></h2>
<p>在 USB 升级的应用中，主机通过 USB 下载 SPL 到 SRAM，并且由 BROM 跳转执行，SPL 代码对 DDR 初始化结束之后需要返回到 BROM 中继续执行下载其他数据的操作。</p>
<p>这种应用场景中，将返回 BROM 看做是从 BROM 中加载数据，因此返回 BROM 被实现为一个程序加载器。</p>
<p>common/spl/spl_bootrom.c 中通过注册 BOOT_DEVICE_BOOTROM 来实现。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SPL_LOAD_IMAGE_METHOD(&quot;BOOTROM&quot;, 0, BOOT_DEVICE_BOOTROM, spl_return_to_bootrom);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>具体返回的函数是 <code>board_return_to_bootrom()</code> 。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r()    // common/spl/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; board_boot_order()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; spl_boot_device(); // arch/arm/mach-artinchip/spl.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; aic_get_boot_device(); // arch/arm/mach-artinchip/boot_param.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           // 从 boot param 中获取启动介质信息，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|           // 此处返回 BD_BOOTROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; boot_from_devices(spl_boot_list)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_ll_find_loader()  // 根据boot device找到spl_load_image指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       // 这里可能是各种介质的 load image 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       // SPL_LOAD_IMAGE_METHOD() 定义的 Loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |       // 此处找到的是 BOOT_DEVICE_BOOTROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; spl_return_to_bootrom();// common/spl/spl_bootrom.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; board_return_to_bootrom();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // arch/arm/mach-artinchip/lowlevel_init.S</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <a href="/docs/D213-DevKit/boot_param_1602/index.html#ref-boot-param-1602">启动参数</a> 章节描述了 BROM 跳转 SPL 运行时所传递的参数，SPL 在开始运行时已经保存了 BROM 跳转时的所有重要寄存器，因此在 <code>board_return_to_bootrom()</code> 可以通过恢复现场，实现返回。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part5/03-6_SPLStage.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/D213-DevKit/part5/03-5_DTS"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">DTS</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/D213-DevKit/part5/03-7_U-BootStage"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">U-Boot 阶段</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-riscv-spl" class="table-of-contents__link toc-highlight">1. RISCV SPL</a></li><li><a href="#2-启动流程" class="table-of-contents__link toc-highlight">2. 启动流程</a><ul><li><a href="#21-uboot-设备驱动框架模型" class="table-of-contents__link toc-highlight">2.1. uboot 设备驱动框架模型</a></li><li><a href="#22-uboot-设备驱动框架搭建的过程" class="table-of-contents__link toc-highlight">2.2. uboot 设备驱动框架搭建的过程</a></li><li><a href="#23-spl-riscv-的启动整体流程" class="table-of-contents__link toc-highlight">2.3. SPL RISCV 的启动整体流程</a></li></ul></li><li><a href="#3-mmc-加载" class="table-of-contents__link toc-highlight">3. MMC 加载</a></li><li><a href="#4-spi-nand-加载" class="table-of-contents__link toc-highlight">4. SPI NAND 加载</a><ul><li><a href="#41-u-boot-保存在-mtd-分区时" class="table-of-contents__link toc-highlight">4.1. U-Boot 保存在 MTD 分区时</a></li><li><a href="#42-u-boot-保存在-ubi-中时" class="table-of-contents__link toc-highlight">4.2. U-Boot 保存在 UBI 中时</a></li><li><a href="#43-读数-spi-nand-数据的流程" class="table-of-contents__link toc-highlight">4.3. 读数 SPI NAND 数据的流程</a></li></ul></li><li><a href="#5-spi-nor-加载" class="table-of-contents__link toc-highlight">5. SPI NOR 加载</a></li><li><a href="#6-sdfat32-加载" class="table-of-contents__link toc-highlight">6. SDFAT32 加载</a></li><li><a href="#7-签名校验" class="table-of-contents__link toc-highlight">7. 签名校验</a><ul><li><a href="#71-fit-image-签名校验" class="table-of-contents__link toc-highlight">7.1. FIT Image 签名校验</a></li><li><a href="#72-aic-image-签名校验" class="table-of-contents__link toc-highlight">7.2. AIC Image 签名校验</a></li></ul></li><li><a href="#8-返回-brom" class="table-of-contents__link toc-highlight">8. 返回 BROM</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>