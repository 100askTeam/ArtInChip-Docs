"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9352],{1788:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>l,contentTitle:()=>t,default:()=>_,frontMatter:()=>c,metadata:()=>r,toc:()=>a});var s=i(5893),d=i(1151);const c={sidebar_position:14},t="I2S \u4f7f\u7528\u6307\u5357",r={id:"D213-DevKit/part3/06-8_I2S-Useguide",title:"I2S \u4f7f\u7528\u6307\u5357",description:"1. \u6a21\u5757\u4ecb\u7ecd",source:"@site/docs/D213-DevKit/part3/06-8_I2S-Useguide.md",sourceDirName:"D213-DevKit/part3",slug:"/D213-DevKit/part3/06-8_I2S-Useguide",permalink:"/en/docs/D213-DevKit/part3/06-8_I2S-Useguide",draft:!1,unlisted:!1,editUrl:"https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part3/06-8_I2S-Useguide.md",tags:[],version:"current",sidebarPosition:14,frontMatter:{sidebar_position:14},sidebar:"d213dkSidebar",previous:{title:"DVP\u5f00\u53d1\u6307\u5357",permalink:"/en/docs/D213-DevKit/part3/06-4_DVP-Useguide"},next:{title:"AudioCodec \u4f7f\u7528\u6307\u5357",permalink:"/en/docs/D213-DevKit/part3/06-9_AudioCodec-Useguide"}},l={},a=[{value:"1. \u6a21\u5757\u4ecb\u7ecd",id:"1-\u6a21\u5757\u4ecb\u7ecd",level:2},{value:"1.1. \u672f\u8bed\u5b9a\u4e49",id:"11-\u672f\u8bed\u5b9a\u4e49",level:3},{value:"1.2. \u6a21\u5757\u7b80\u4ecb",id:"12-\u6a21\u5757\u7b80\u4ecb",level:3},{value:"2. I2S\u914d\u7f6e",id:"2-i2s\u914d\u7f6e",level:2},{value:"2.1. \u5185\u6838\u914d\u7f6e",id:"21-\u5185\u6838\u914d\u7f6e",level:3},{value:"2.2. DTS\u914d\u7f6e",id:"22-dts\u914d\u7f6e",level:3},{value:"2.2.1. D211",id:"221-d211",level:4},{value:"3. \u8c03\u8bd5\u6307\u5357",id:"3-\u8c03\u8bd5\u6307\u5357",level:2},{value:"4. \u6d4b\u8bd5\u6307\u5357",id:"4-\u6d4b\u8bd5\u6307\u5357",level:2},{value:"4.1. \u6d4b\u8bd5\u73af\u5883",id:"41-\u6d4b\u8bd5\u73af\u5883",level:3},{value:"4.1.1. \u786c\u4ef6",id:"411-\u786c\u4ef6",level:4},{value:"4.1.2. \u8f6f\u4ef6",id:"412-\u8f6f\u4ef6",level:4},{value:"4.2. \u521b\u5efa\u58f0\u5361",id:"42-\u521b\u5efa\u58f0\u5361",level:3},{value:"4.2.1. machine\u9a71\u52a8",id:"421-machine\u9a71\u52a8",level:4},{value:"4.2.2. \u58f0\u5361DTS\u914d\u7f6e",id:"422-\u58f0\u5361dts\u914d\u7f6e",level:4},{value:"4.3. \u97f3\u9891\u6d4b\u8bd5",id:"43-\u97f3\u9891\u6d4b\u8bd5",level:3},{value:"4.3.1. \u6d4b\u8bd5\u97f3\u9891\u64ad\u653e",id:"431-\u6d4b\u8bd5\u97f3\u9891\u64ad\u653e",level:4},{value:"4.3.2. \u6d4b\u8bd5\u97f3\u9891\u5f55\u97f3",id:"432-\u6d4b\u8bd5\u97f3\u9891\u5f55\u97f3",level:4},{value:"5. \u8bbe\u8ba1\u8bf4\u660e",id:"5-\u8bbe\u8ba1\u8bf4\u660e",level:2},{value:"5.1. \u6e90\u7801\u8bf4\u660e",id:"51-\u6e90\u7801\u8bf4\u660e",level:3},{value:"5.2. \u6a21\u5757\u67b6\u6784",id:"52-\u6a21\u5757\u67b6\u6784",level:3},{value:"5.2.1. CPU DAI\u9a71\u52a8",id:"521-cpu-dai\u9a71\u52a8",level:4},{value:"5.2.2. \u97f3\u9891DMA\u9a71\u52a8",id:"522-\u97f3\u9891dma\u9a71\u52a8",level:4},{value:"5.3. \u5173\u952e\u6d41\u7a0b\u8bbe\u8ba1",id:"53-\u5173\u952e\u6d41\u7a0b\u8bbe\u8ba1",level:3},{value:"5.3.1. \u64cd\u4f5c\u51fd\u6570\u96c6\u5b9e\u73b0",id:"531-\u64cd\u4f5c\u51fd\u6570\u96c6\u5b9e\u73b0",level:4},{value:"5.3.2. I2S\u65f6\u949f\u8bbe\u7f6e",id:"532-i2s\u65f6\u949f\u8bbe\u7f6e",level:4},{value:"5.3.2.1. MCLK",id:"5321-mclk",level:5},{value:"5.3.2.2. LRCK\u548cBCLK",id:"5322-lrck\u548cbclk",level:5},{value:"5.3.3. period bytes\u5bf9\u9f50",id:"533-period-bytes\u5bf9\u9f50",level:4},{value:"5.4. \u6570\u636e\u7ed3\u6784\u8bbe\u8ba1",id:"54-\u6570\u636e\u7ed3\u6784\u8bbe\u8ba1",level:3},{value:"5.4.1. aic_i2s",id:"541-aic_i2s",level:4},{value:"5.4.2. aic_i2s_clk_div",id:"542-aic_i2s_clk_div",level:4},{value:"5.5. \u63a5\u53e3\u8bbe\u8ba1",id:"55-\u63a5\u53e3\u8bbe\u8ba1",level:3},{value:"5.5.1. aic_i2s_set_sysclk",id:"551-aic_i2s_set_sysclk",level:4},{value:"5.5.2. aic_i2s_set_bclk_ratio",id:"552-aic_i2s_set_bclk_ratio",level:4},{value:"5.5.3. aic_i2s_set_fmt",id:"553-aic_i2s_set_fmt",level:4},{value:"5.5.4. aic_i2s_set_tdm_slot",id:"554-aic_i2s_set_tdm_slot",level:4},{value:"5.5.5. aic_i2s_hw_params",id:"555-aic_i2s_hw_params",level:4},{value:"5.5.6. aic_i2s_trigger",id:"556-aic_i2s_trigger",level:4},{value:"6. \u5e38\u89c1\u95ee\u9898",id:"6-\u5e38\u89c1\u95ee\u9898",level:2}];function h(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.a)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"i2s-\u4f7f\u7528\u6307\u5357",children:"I2S \u4f7f\u7528\u6307\u5357"}),"\n",(0,s.jsx)(e.h2,{id:"1-\u6a21\u5757\u4ecb\u7ecd",children:"1. \u6a21\u5757\u4ecb\u7ecd"}),"\n",(0,s.jsx)(e.h3,{id:"11-\u672f\u8bed\u5b9a\u4e49",children:"1.1. \u672f\u8bed\u5b9a\u4e49"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u672f\u8bed"}),(0,s.jsx)(e.th,{children:"\u5b9a\u4e49"}),(0,s.jsx)(e.th,{children:"\u6ce8\u91ca\u8bf4\u660e"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"MCLK"}),(0,s.jsx)(e.td,{children:"master clock"}),(0,s.jsx)(e.td,{children:"\u4e3b\u65f6\u949f\uff0c\u4e3aCODEC\u63d0\u4f9b\u5de5\u4f5c\u65f6\u949f"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"LRCK"}),(0,s.jsx)(e.td,{children:"left right clock"}),(0,s.jsx)(e.td,{children:"\u5de6\u53f3\u58f0\u9053\u65f6\u949f\uff0c\u4e00\u4e2a\u5468\u671f\u5b8c\u6210\u4e00\u6b21\u5de6\u53f3\u58f0\u9053\u97f3\u9891\u6570\u636e\u8f93\u51fa"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"BCLK"}),(0,s.jsx)(e.td,{children:"bit clock"}),(0,s.jsx)(e.td,{children:"\u6bd4\u7279\u65f6\u949f\uff0c\u6bcf\u4e2a\u65f6\u949f\u5468\u671f\u4f20\u8f931bit\u97f3\u9891\u6570\u636e"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"DAI"}),(0,s.jsx)(e.td,{children:"\u6570\u5b57\u97f3\u9891\u63a5\u53e3"}),(0,s.jsx)(e.td,{children:"\u97f3\u9891\u63a5\u53e3\u7684\u7edf\u79f0\uff0c\u5982I2S\uff0cPCM\u7b49\u63a5\u53e3"})]})]})]}),"\n",(0,s.jsx)(e.h3,{id:"12-\u6a21\u5757\u7b80\u4ecb",children:"1.2. \u6a21\u5757\u7b80\u4ecb"}),"\n",(0,s.jsx)(e.p,{children:"I2S\u662f\u4e00\u79cd\u5e38\u89c1\u7684\u97f3\u9891\u63a5\u53e3\uff0c\u4e3b\u8981\u7528\u4e8e\u97f3\u9891\u6570\u636e\u7684\u4f20\u8f93\u3002\u5e38\u89c1\u7684\u5e94\u7528\u573a\u666f\u662fSOC\u548c\u97f3\u9891codec\u901a\u8fc7I2S\u63a5\u53e3\u5b9e\u73b0\u97f3\u9891\u7684\u64ad\u653e\u4e0e\u5f55\u97f3\u3002\u7531\u4e8e\u97f3\u9891\u6570\u636e\u91cf\u8f83\u5927\uff0cSOC\u4e00\u822c\u662f\u901a\u8fc7DMA\u5b9e\u73b0\u97f3\u9891\u6570\u636e\u5728\u5185\u5b58\u548cI2S\u63a5\u53e3\u4e4b\u95f4\u7684\u4f20\u8f93\uff0c\u6240\u4ee5\u9700\u8981DMA\u9a71\u52a8\u7684\u652f\u6301\u3002AIC\u7684I2S\u6a21\u5757\u652f\u6301I2S\u3001\u5de6\u5bf9\u9f50\u53f3\u5bf9\u9f50\u3001PCM\u548cTDM\u683c\u5f0f\uff1b\u652f\u6301I2S\u7684\u4e3b\u4ece\u6a21\u5f0f\uff0c\u91c7\u6837\u7cbe\u5ea6\u652f\u63018bit~32bit"}),"\n",(0,s.jsx)(e.p,{children:"I2S\u6a21\u5757\u7684\u57fa\u672c\u7279\u6027\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u652f\u6301I2S\u3001\u5de6\u5bf9\u9f50\u3001\u53f3\u5bf9\u9f50\u3001PCM\u683c\u5f0f"}),"\n",(0,s.jsx)(e.li,{children:"\u652f\u6301TDM"}),"\n",(0,s.jsx)(e.li,{children:"\u652f\u6301I2S\u4e3b\u4ece\u6a21\u5f0f"}),"\n",(0,s.jsx)(e.li,{children:"\u91c7\u6837\u7cbe\u5ea6\u652f\u63018~32bit"}),"\n",(0,s.jsx)(e.li,{children:"\u91c7\u6837\u7387\u652f\u63018K~384KHz"}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"2-i2s\u914d\u7f6e",children:"2. I2S\u914d\u7f6e"}),"\n",(0,s.jsx)(e.h3,{id:"21-\u5185\u6838\u914d\u7f6e",children:"2.1. \u5185\u6838\u914d\u7f6e"}),"\n",(0,s.jsx)(e.p,{children:"\u6309\u7167ALSA\u7684\u6846\u67b6\u8bbe\u8ba1\uff0cI2S\u7684\u6570\u636e\u4f20\u8f93\u4f7f\u7528DMA\u65b9\u5f0f\uff0c\u9700\u8981DMA-engine\u7684\u652f\u6301\uff0c\u6240\u4ee5\u5728menuconfig\u4e2d \u9700\u8981\u6253\u5f00DMA-engine\u7684\u9a71\u52a8\u652f\u6301\u3002"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"Device Drivers---\x3e\n    [*] DMA Engine support---\x3e\n            <*> Artinchip SoCs DMA support\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u5728menuconfig\u4e2d\u6253\u5f00ALSA\u6846\u67b6\u7684\u652f\u6301\uff0c\u4f7f\u80fdAIC\u7684I2S\u9a71\u52a8"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"Device Drivers---\x3e\n    <*> Sound card support---\x3e\n            <*> Advanced Linux Sound Architecture---\x3e\n                    <*> ALSA for SoC audio support---\x3e\n                            <*> ArtInChip I2S Support\n"})}),"\n",(0,s.jsx)(e.h3,{id:"22-dts\u914d\u7f6e",children:"2.2. DTS\u914d\u7f6e"}),"\n",(0,s.jsx)(e.h4,{id:"221-d211",children:"2.2.1. D211"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:'i2s0: i2s@18600000 {\n    #sound-dai-cells = <0>;\n    compatible = "artinchip,aic-i2s-v1.0";\n    reg = <0x18600000 0x400>;\n    interrupts = <GIC_SPI 20 IRQ_TYPE_LEVEL_HIGH>;\n    clocks = <&cmu CLK_I2S0>;\n    resets = <&rst RESET_I2S0>;\n    dmas = <&dma DMA_I2S0>, <&dma DMA_I2S0>;\n    dma-names = "rx", "tx";\n};\n\ni2s1: i2s@18601000 {\n    #sound-dai-cells = <0>;\n    compatible = "artinchip,aic-i2s-v1.0";\n    reg = <0x18601000 0x400>;\n    interrupts = <GIC_SPI 21 IRQ_TYPE_LEVEL_HIGH>;\n    clocks = <&cmu CLK_I2S1>;\n    resets = <&rst RESET_I2S1>;\n    dmas = <&dma DMA_I2S1>, <&dma DMA_I2S1>;\n    dma-names = "rx", "tx";\n};\n'})}),"\n",(0,s.jsx)(e.p,{children:"xxx/board.dts\u4e2d\u7684\u914d\u7f6e"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:'&i2s0 {\n    pinctrl-names = "default";\n    pinctrl-0 = <&i2s0_clk_pins>;\n    status = "disabled";\n};\n\n&i2s1 {\n    pinctrl-names = "default";\n    pinctrl-0 = <&i2s1_clk_pins>, <&i2s1_mclk_pins>, <&i2s1_din_pins_b>;\n    status = "okay";\n};\n'})}),"\n",(0,s.jsx)(e.p,{children:"\u6839\u636e\u5b9e\u9645\u7684\u677f\u578b\u914d\u7f6e\uff0c\u4f7f\u80fd\u76f8\u5e94\u7684I2S"}),"\n",(0,s.jsx)(e.h2,{id:"3-\u8c03\u8bd5\u6307\u5357",children:"3. \u8c03\u8bd5\u6307\u5357"}),"\n",(0,s.jsx)(e.h2,{id:"4-\u6d4b\u8bd5\u6307\u5357",children:"4. \u6d4b\u8bd5\u6307\u5357"}),"\n",(0,s.jsx)(e.h3,{id:"41-\u6d4b\u8bd5\u73af\u5883",children:"4.1. \u6d4b\u8bd5\u73af\u5883"}),"\n",(0,s.jsx)(e.h4,{id:"411-\u786c\u4ef6",children:"4.1.1. \u786c\u4ef6"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u6d4b\u8bd5\u677f\uff1a\u5e26\u6709\u7b2c\u4e09\u65b9codec\u82af\u7247\u7684\u6d4b\u8bd5\u677f"}),"\n",(0,s.jsx)(e.li,{children:"PC\uff1a\u7528\u4e8e\u548c\u6d4b\u8bd5\u677f\u4ea4\u4e92"}),"\n",(0,s.jsx)(e.li,{children:"\u4e32\u53e3\u7ebf\uff1a\u8fde\u63a5\u6d4b\u8bd5\u677f\u7684\u8c03\u8bd5\u4e32\u53e3"}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"412-\u8f6f\u4ef6",children:"4.1.2. \u8f6f\u4ef6"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"PC\u7aef\u4e32\u53e3\u7ec8\u7aef\u8f6f\u4ef6"}),"\n",(0,s.jsx)(e.li,{children:"alsa-lib\u548calsa-utils\u7b2c\u4e09\u65b9\u8f6f\u4ef6\u5305"}),"\n",(0,s.jsx)(e.li,{children:"\u7b2c\u4e09\u65b9codec\u9a71\u52a8"}),"\n",(0,s.jsx)(e.li,{children:"\u521b\u5efa\u58f0\u5361\u7684machine\u9a71\u52a8"}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"42-\u521b\u5efa\u58f0\u5361",children:"4.2. \u521b\u5efa\u58f0\u5361"}),"\n",(0,s.jsx)(e.h4,{id:"421-machine\u9a71\u52a8",children:"4.2.1. machine\u9a71\u52a8"}),"\n",(0,s.jsx)(e.p,{children:"\u58f0\u5361\u7684\u9a71\u52a8\u5206\u4e3a\u4e09\u90e8\u5206\uff1aplatform\u9a71\u52a8\u3001codec\u9a71\u52a8\u3001machine\u9a71\u52a8\u3002\u5bf9\u4e8e\u672c\u7ae0\u8282\u6765\u8bf4\uff0cplatform\u9a71\u52a8\u5373I2S\u9a71\u52a8\u3002codec\u9a71\u52a8\u4e00\u822c\u4f1a\u7531codec\u5382\u5bb6\u63d0\u4f9b\uff0c\u5185\u6838\u4e2d\u4e5f\u63d0\u4f9b\u4e86\u5927\u91cf\u7684codec\u9a71\u52a8\u6e90\u7801\uff0c\u53ef\u4ee5\u9009\u62e9\u76f8\u5e94\u7684codec\u82af\u7247\u8fdb\u884c\u6d4b\u8bd5\uff0c\u672c\u7ae0\u8282\u4f1a\u9009\u7528allwinner\u7684ac102\u82af\u7247\u3002\u6240\u4ee5\u5728\u6d4b\u8bd5\u524d\u9700\u8981\u505a\u7684\u5c31\u662f\u7f16\u5199\u58f0\u5361\u7684machine\u9a71\u52a8\uff0cmachine\u9a71\u52a8\u5b9e\u73b0platform\u9a71\u52a8\u548ccodec\u9a71\u52a8\u7684\u8026\u5408\uff0c\u521b\u5efa\u58f0\u5361\uff0c\u540c\u65f6\u786e\u5b9acpu_dai\u548ccodec_dai\u7684\u8fde\u63a5\u65b9\u5f0f\u4ee5\u53ca\u652f\u6301\u7684\u683c\u5f0f\u3001\u91c7\u6837\u6df1\u5ea6\u7b49\u4fe1\u606f\u3002"}),"\n",(0,s.jsx)(e.p,{children:"\u521b\u5efa\u58f0\u5361\u7684\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7ed3\u6784\u4f53\u662fstruct snd_soc_dai_link\uff0c\u8be5\u7ed3\u6784\u4f53\u7528\u6765\u6307\u5b9aplatform\u548ccodec\u7684\u8026\u5408\u5173\u7cfb\uff0c\u4e3b\u8981\u7684\u6210\u5458\u53d8\u91cf\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"struct snd_soc_dai_link {\n    /* config - must be set by machine driver */\n    const char *name;\n    const char *stream_name;\n    struct snd_soc_dai_link_component *cpus;\n    unsigned int num_cpus;\n    struct snd_soc_dai_link_component *codecs;\n    unsigned int num_codecs;\n    struct snd_soc_dai_link_component *platforms;\n    unsigned int num_platforms;\n    /* format to set on init */\n    unsigned int dai_fmt;\n    /* machine stream operations */\n    const struct snd_soc_ops *ops;\n    ...\n};\n"})}),"\n",(0,s.jsx)(e.p,{children:"dai_link\u4e2d\u6210\u5458\u53d8\u91cf\u7684\u4e00\u4e9b\u5b9a\u4e49\u89c4\u5219(\u89c4\u5219\u5b9a\u4e49\u53ef\u53c2\u8003snd_soc_dai_link\u7ed3\u6784\u4f53\u5b9a\u4e49\u6216\u51fd\u6570soc_dai_link_sanity_check)\uff1a"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"codecs\u5fc5\u987b\u5b9a\u4e49\uff0ccodecs->name\u548ccodecs->of_node\u5fc5\u987b\u5b9a\u4e49\u5176\u4e00\uff0c\u4e0d\u53ef\u4ee5\u90fd\u5b9a\u4e49\uff0c\u4e5f\u4e0d\u53ef\u4ee5\u90fd\u4e0d\u5b9a\u4e49\u3002codecs->dai_name\u5fc5\u987b\u5b9a\u4e49"}),"\n",(0,s.jsx)(e.li,{children:"cpus\u53ef\u4e0d\u5b9a\u4e49\u3002\u4f46\u5b9a\u4e49\u65f6\uff0ccpus->name\u548ccpus->of_node\u4e8c\u8005\u5b9a\u4e49\u5176\u4e00\uff0c\u4e0d\u53ef\u4ee5\u90fd\u5b9a\u4e49\u3002cpus->dai_name\u53ef\u5b9a\u4e49\uff0c\u4e5f\u53ef\u4e0d\u5b9a\u4e49\u3002cpus->name\u548ccpus->of_node\u672a\u5b9a\u4e49\u65f6\uff0c\u5c06\u4f1a\u901a\u8fc7cpus->dai_name\u8fdb\u884c\u5339\u914d\u3002cpus->dai_name\u672a\u5b9a\u4e49\u65f6\uff0c\u5c06\u4f1a\u901a\u8fc7cpus->name\u6216cpus->of_node\u8fdb\u884c\u5339\u914d\u3002"}),"\n",(0,s.jsx)(e.li,{children:"platforms\u53ef\u4e0d\u5b9a\u4e49\u3002\u4f46\u5b9a\u4e49\u65f6platforms->name\u548cplatforms->of_node\u4e8c\u8005\u5b9a\u4e49\u5176\u4e00\uff0c\u4e0d\u53ef\u4ee5\u90fd\u5b9a\u4e49\u3002platforms->dai_name\u5728ALSA\u6846\u67b6\u4e2d\u5e76\u672a\u4f7f\u7528\u3002"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"ALSA\u6846\u67b6\u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5b8f\uff0c\u7528\u6765\u5b9a\u4e49\u4e0a\u8ff0\u7684\u4e00\u4e9b\u6210\u5458\u53d8\u91cf\uff0c\u6bd4\u8f83\u5e38\u7528\u7684\u662f\u901a\u8fc7\u5b8fSND_SOC_DAILINK_DEFS\u8fdb\u884c\u5b9a\u4e49\u3002\u73b0\u5728\u5185\u6838\u4e2d\u6bd4\u8f83\u901a\u7528\u7684\u505a\u6cd5\u662f\u901a\u8fc7SND_SOC_DAILINK_DEFS\u5c06\u6210\u5458\u53d8\u91cf\u5b9a\u4e49\u4e3a\u7a7a\uff0c\u5728\u58f0\u5361\u7684probe\u51fd\u6570\u4e2d\u901a\u8fc7\u8bfb\u53d6DTS\u5b9a\u4e49cpus/codecs/platforms\u7684of_node\u53d8\u91cf\u3002\u8fd9\u6837\u505a\u7684\u4f18\u70b9\u662f\u4fee\u6539codec\u5916\u90e8\u914d\u7f6e\u6216\u8fde\u63a5\u65b9\u5f0f\u65f6\uff0c\u53ea\u9700\u7f16\u8bd1DTS\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u7f16\u8bd1\u5185\u6838\u3002"}),"\n",(0,s.jsx)(e.p,{children:"dai_fmt\u53d8\u91cf\u5b9a\u4e49I2S\u548ccodec\u4e4b\u95f4\u7684\u97f3\u9891\u6570\u636e\u4f20\u8f93\u65b9\u5f0f\u3002"}),"\n",(0,s.jsx)(e.p,{children:"ops\u5b9a\u4e49machine\u9a71\u52a8\u6240\u652f\u6301\u7684\u64cd\u4f5c\u51fd\u6570\u96c6\u3002"}),"\n",(0,s.jsx)(e.p,{children:"\u5c06\u5b9a\u4e49\u7684struct snd_soc_dai_link\u7ed3\u6784\u4f53\u53d8\u91cf\u8d4b\u503c\u7ed9struct snd_soc_card\u7ed3\u6784\u4f53\u7684dai_link\u6210\u5458\u53d8\u91cf\uff0c\u7136\u540e\u8c03\u7528snd_soc_register_card\u5373\u53ef\u5b8c\u6210\u58f0\u5361\u7684\u6ce8\u518c\uff0c\u5177\u4f53\u53ef\u53c2\u8003\u5185\u6838\u4e2d\u63d0\u4f9b\u7684\u4e00\u4e9bmachine\u9a71\u52a8\u3002"}),"\n",(0,s.jsx)(e.h4,{id:"422-\u58f0\u5361dts\u914d\u7f6e",children:"4.2.2. \u58f0\u5361DTS\u914d\u7f6e"}),"\n",(0,s.jsx)(e.p,{children:"\u9700\u8981\u5728DTS\u4e2d\u914d\u7f6e\u58f0\u5361\u7684\u7ed3\u70b9\uff0c\u624d\u80fd\u6b63\u786e\u8c03\u7528\u58f0\u5361\u7684machine\u9a71\u52a8\u3002DTS\u4e2d\u58f0\u5361\u7684\u7ed3\u70b9\u914d\u7f6e\u5982\u4e0b(\u4ee5allwinner\u7684ac102\u4e3a\u4f8b\u8bf4\u660e)\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:'soundCard {\n            compatible = "artinchip,aic-ac102";\n            aic,codec-chip = <&ac102>;\n            aic,i2s-controller = <&i2s1>;\n            status = "okay";\n    };\n'})}),"\n",(0,s.jsx)(e.p,{children:"machine\u9a71\u52a8\u901a\u8fc7\u8bfb\u53d6aic,codec-chip\u548caic,i2s-controller\u5c5e\u6027\u83b7\u53d6\u76f8\u5e94\u7684i2s\u548ccodec\u7ed3\u70b9\u3002SOC\u4e00\u822c\u662f\u901a\u8fc7I2C\u63a5\u53e3\u5bf9codec\u82af\u7247\u8fdb\u884c\u63a7\u5236\uff0c\u6240\u4ee5\u9700\u8981\u5728I2C\u63a7\u5236\u5668\u4e0b\u6302\u63a5codec\u82af\u7247"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:'&i2c3 {\n        pinctrl-names = "default";\n        pinctrl-0 = <&i2c3_pins_b>;\n        status = "okay";\n        ac102: ac102@33 {\n                compatible = "allwinner,ac102";\n                reg = <0x33>;\n        };\n};\n'})}),"\n",(0,s.jsx)(e.h3,{id:"43-\u97f3\u9891\u6d4b\u8bd5",children:"4.3. \u97f3\u9891\u6d4b\u8bd5"}),"\n",(0,s.jsx)(e.h4,{id:"431-\u6d4b\u8bd5\u97f3\u9891\u64ad\u653e",children:"4.3.1. \u6d4b\u8bd5\u97f3\u9891\u64ad\u653e"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"aplay test.wav\n"})}),"\n",(0,s.jsx)(e.h4,{id:"432-\u6d4b\u8bd5\u97f3\u9891\u5f55\u97f3",children:"4.3.2. \u6d4b\u8bd5\u97f3\u9891\u5f55\u97f3"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"arecord -d 10 -f dat -t wav test.wav\n"})}),"\n",(0,s.jsx)(e.p,{children:"-d\uff1a\u6307\u5b9a\u5f55\u97f3\u65f6\u957f\uff0c\u5355\u4f4d\u4e3a\u79d2"}),"\n",(0,s.jsx)(e.p,{children:"-f\uff1a\u6307\u5b9a\u5f55\u5236\u7684\u683c\u5f0f\uff0cdat\u8868\u793a16bit\u5c0f\u7aef\u6570\u636e\uff0c48K\u91c7\u6837\u7387\uff0c\u7acb\u4f53\u58f0"}),"\n",(0,s.jsx)(e.p,{children:"-t\uff1a\u6307\u5b9a\u751f\u6210\u7684\u6587\u4ef6\u683c\u5f0f\uff0c\u4e3awav\u6587\u4ef6"}),"\n",(0,s.jsx)(e.p,{children:"test.wav\uff1a\u751f\u6210\u7684wav\u6587\u4ef6\u540d"}),"\n",(0,s.jsx)(e.h2,{id:"5-\u8bbe\u8ba1\u8bf4\u660e",children:"5. \u8bbe\u8ba1\u8bf4\u660e"}),"\n",(0,s.jsx)(e.h3,{id:"51-\u6e90\u7801\u8bf4\u660e",children:"5.1. \u6e90\u7801\u8bf4\u660e"}),"\n",(0,s.jsx)(e.p,{children:"\u6e90\u4ee3\u7801\u4f4d\u4e8e\uff1alinux-5.10/sound/soc/artinchip/aic-i2s.c"}),"\n",(0,s.jsx)(e.h3,{id:"52-\u6a21\u5757\u67b6\u6784",children:"5.2. \u6a21\u5757\u67b6\u6784"}),"\n",(0,s.jsx)(e.p,{children:"\u5185\u6838\u4e2d\u97f3\u9891\u91c7\u7528ALSA\u9a71\u52a8\u6846\u67b6\uff0c\u8be5\u6846\u67b6\u7ba1\u7406\u6240\u6709\u4e0e\u97f3\u9891\u76f8\u5173\u7684\u8f6f\u4ef6\u4e0e\u786c\u4ef6\uff0cI2S\u7684\u9a71\u52a8\u8bbe\u8ba1\u9700\u8981\u9075\u5faa\u8be5\u6846\u67b6\u7684\u57fa\u672c\u8981\u6c42\u3002ALSA\u97f3\u9891\u6846\u67b6\u5c06\u5e95\u5c42\u7684\u786c\u4ef6\u9a71\u52a8\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\uff1amachine\u3001pltform\u4e0ecodec\u3002\u4e09\u8005\u7684\u5173\u7cfb\u5982\u4e0b\u56fe\u6240\u793a\uff1a"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/design_12-17067515322761.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/design_12.png"})}),"\n",(0,s.jsx)(e.p,{children:"ALSA\u6846\u67b6\u5c06\u5e95\u5c42\u5212\u5206\u4e3a\u4e09\u90e8\u5206\u540e\uff0c\u4f7f\u5f97platform\u548ccodec\u7684\u9a71\u52a8\u5b9e\u73b0\u53d8\u5f97\u66f4\u52a0\u7b80\u5355\uff0c\u4e8c\u8005\u53ea\u4e13\u6ce8\u4e8e\u5b9e\u73b0\u81ea\u5df1\u7684\u529f\u80fd\u4ee3\u7801\uff0c\u7531machine\u9a71\u52a8\u6765\u5b9e\u73b0platform\u548ccodec\u7684\u8026\u5408\uff0c\u4e8c\u8005\u4f9d\u9760cpu_dai\u548ccodec_dai\u8fdb\u884c\u6570\u636e\u4f20\u8f93\u3002platform\u9a71\u52a8\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u5b8c\u6210\u97f3\u9891\u6570\u636e\u7684\u7ba1\u7406\uff0c\u6700\u7ec8\u901a\u8fc7SOC\u7684\u6570\u5b57\u97f3\u9891\u63a5\u53e3(cpu_dai)\u628a\u97f3\u9891\u6570\u636e\u4f20\u9001\u7ed9codec\u8fdb\u884c\u64ad\u653e\u6216\u5c06codec\u91c7\u96c6\u7684\u97f3\u9891\u6570\u636e\u5b58\u50a8\u5230\u5185\u5b58\u4e2d\u3002"}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u5177\u4f53\u7684\u5b9e\u73b0\u4e0a\uff0cALSA\u5c06platform\u9a71\u52a8\uff08platform\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3aSOC\u7aef\u7684\u9a71\u52a8\uff09\u5206\u4e3a\u4e24\u90e8\u5206\uff1a\u5b9e\u73b0\u97f3\u9891\u6570\u636e\u4f20\u8f93\u548c\u7ba1\u7406\u7684DMA\u9a71\u52a8\u548cCPU DAI\u7684\u9a71\u52a8\u3002\u4e14ALSA\u6846\u67b6\u4e2d\u5df2\u5b9e\u73b0\u4e86DMA\u5bf9\u97f3\u9891\u6570\u636e\u7ba1\u7406\u90e8\u5206\u7684\u9a71\u52a8 \u4ee3\u7801\uff0c\u6240\u4ee5I2S\u7684\u9a71\u52a8\u53ea\u9700\u8981\u5b9e\u73b0CPU DAI\u90e8\u5206\u7684\u9a71\u52a8\uff0c\u97f3\u9891\u6570\u636e\u7ba1\u7406\u90e8\u5206\u53ea\u9700\u8981\u6307\u5b9a\u6570\u636e\u4f20\u8f93\u7684\u8d77\u59cb\u5730\u5740\u6216\u76ee\u7684\u5730\u5740\uff0c\u4ee5\u53ca\u4f20\u8f93\u4f4d\u5bbd\u5373\u53ef\u3002"}),"\n",(0,s.jsx)(e.h4,{id:"521-cpu-dai\u9a71\u52a8",children:"5.2.1. CPU DAI\u9a71\u52a8"}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u9a71\u52a8\u5b9e\u73b0\u4e0a\uff0c\u65e0\u8bba\u662fcodec\u8fd8\u662fplatform\uff0cALSA\u5c06\u5b83\u4eec\u7edf\u4e00\u5212\u5206\u4e3asnd_soc_component\u548csnd_soc_dai\uff0c\u6240\u4ee5\uff0c\u5c31\u8981\u76f8\u5e94\u7684\u5b9e\u73b0snd_soc_component_driver\u548csnd_soc_dai_driver\u3002 \u7136\u540e\u8c03\u7528snd_soc_register_component\u8fdb\u884c\u7edf\u4e00\u6ce8\u518c\u3002snd_soc_component_driver\u4e3b\u8981\u662f\u6ce8\u518c\u4e0edapm\u76f8\u5173\u7684\u97f3\u9891\u63a7\u4ef6\u7b49\u4fe1\u606f\uff0csnd_soc_dai_driver\u4e3b\u8981\u662f\u6ce8\u518c\u6570\u5b57\u97f3\u9891\u63a5\u53e3I2S\u6216PCM\u7b49\u7684\u4fe1\u606f\u53ca\u5e95\u5c42\u64cd\u4f5c\u51fd\u6570\u3002"}),"\n",(0,s.jsx)(e.p,{children:"\u7531\u4e8e\u5728platform\u7aef\uff0c\u4e3b\u8981\u662fI2S\u63a5\u53e3\u548cDMA\u7684\u4f20\u8f93\u914d\u7f6e\uff0c\u4e0d\u5b58\u5728\u97f3\u9891\u63a7\u4ef6\uff0c\u6240\u4ee5CPU DAI\u7684\u9a71\u52a8\u4e3b\u8981\u662f\u5b9e\u73b0snd_soc_dai_driver\u3002\u5305\u62ec\u6307\u5b9aI2S\u63a5\u53e3\u652f\u6301\u7684\u901a\u9053\u6570\u3001\u91c7\u6837\u7387\u3001\u652f\u6301\u7684\u6570\u636e\u683c\u5f0f\uff0c\u4ee5\u53ca\u5bf9I2S\u914d\u7f6e\u548c\u63a7\u5236\u7684\u56de\u8c03\u51fd\u6570\u96c6\u5408snd_soc_dai_ops\u7684\u5b9e\u73b0"}),"\n",(0,s.jsx)(e.h4,{id:"522-\u97f3\u9891dma\u9a71\u52a8",children:"5.2.2. \u97f3\u9891DMA\u9a71\u52a8"}),"\n",(0,s.jsx)(e.p,{children:"ALSA\u67b6\u6784\u4e2d\uff0c\u5bf9DMA\u7684\u4e00\u4e9b\u914d\u7f6e\u548c\u4f20\u8f93\u7684\u51fd\u6570\u5df2\u7ecf\u7531ALSA\u6846\u67b6\u5b9e\u73b0\uff0c\u6240\u4ee5\u8fd9\u90e8\u5206\u9a71\u52a8\u5b9e\u73b0\u53ea\u9700\u8981\u6307\u5b9aplayback\u548ccapture\u4e2dDMA\u4f20\u8f93\u7684\u5730\u5740\u4ee5\u53ca\u4f20\u8f93\u7684\u4f4d\u5bbd\uff0c\u7136\u540e\u8c03\u7528devm_snd_dmaengine_pcm_register \u8fdb\u884c\u6ce8\u518c\u5373\u53ef\u3002"}),"\n",(0,s.jsx)(e.h3,{id:"53-\u5173\u952e\u6d41\u7a0b\u8bbe\u8ba1",children:"5.3. \u5173\u952e\u6d41\u7a0b\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h4,{id:"531-\u64cd\u4f5c\u51fd\u6570\u96c6\u5b9e\u73b0",children:"5.3.1. \u64cd\u4f5c\u51fd\u6570\u96c6\u5b9e\u73b0"}),"\n",(0,s.jsx)(e.p,{children:"\u5728I2S\u7684\u9a71\u52a8\u8bbe\u8ba1\u4e2d\uff0csnd_soc_dai_ops\u662f\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7ed3\u6784\u4f53\uff0c\u5b83\u662fcpu_dai\u7684\u64cd\u4f5c\u51fd\u6570\u96c6\uff0c\u6240\u6709\u5bf9I2S\u63a5\u53e3\u7684\u8bbe\u7f6e\u90fd\u662f\u901a\u8fc7\u6b64\u7ed3\u6784\u4f53\u5b8c\u6210\u3002\u6240\u4ee5\uff0cI2S\u9a71\u52a8\u4e2d\u4e00\u9879\u975e\u5e38\u91cd\u8981\u7684\u90e8\u5206\u5c31\u662f\u5b9e\u73b0\u6b64\u7ed3\u6784\u4f53\u4e2d\u7684\u51fd\u6570\u63a5\u53e3\u3002snd_soc_dai_ops\u51fd\u6570\u96c6\u53ef\u4ee5\u5206\u4e3a\u5982\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["cpu_dai\u65f6\u949f\u914d\u7f6e\u51fd\u6570\uff0c\u901a\u5e38\u7531machine\u9a71\u52a8\u8c03\u7528","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"set_sysclk\uff1a\u8bbe\u7f6ecpu_dai\u7684\u4e3b\u65f6\u949fMCLK"}),"\n",(0,s.jsx)(e.li,{children:"set_clkdiv\uff1a\u8bbe\u7f6e\u5206\u9891\u7cfb\u6570\uff0c\u7528\u4e8e\u5b9e\u73b0BCLK\u548cLRCK\u7684\u5206\u9891\u7cfb\u6570"}),"\n",(0,s.jsx)(e.li,{children:"set_bclk_ratio\uff1a\u8bbe\u7f6eBCLK\u548cLRCK\u7684\u6bd4\u7387"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["cpu_dai\u683c\u5f0f\u8bbe\u7f6e\uff0c\u901a\u5e38\u7531machine\u9a71\u52a8\u8c03\u7528","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"set_fmt\uff1a\u8bbe\u7f6e\u4e3b\u4ece\u6a21\u5f0f(LRCK\u548cBCLK\u65f6\u949f\u7531SOC\u63d0\u4f9b\u8fd8\u662f\u7531codec\u63d0\u4f9b)\uff0cBCLK\u548cLRCK\u7684\u6781\u6027\uff0c\u4ee5\u53ca\u4f20\u8f93\u6a21\u5f0f"}),"\n",(0,s.jsx)(e.li,{children:"set_tdm_slot\uff1acpu_dai\u652f\u6301\u65f6\u5206\u590d\u7528\u65f6\uff0c\u7528\u4e8e\u8bbe\u7f6e\u65f6\u5206\u590d\u7528\u7684slot"}),"\n",(0,s.jsx)(e.li,{children:"set_channel_map\uff1a\u58f0\u9053\u65f6\u5206\u590d\u7528\u65f6\u7684\u6620\u5c04\u5173\u7cfb\u8bbe\u7f6e"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["ALSA PCM\u97f3\u9891\u64cd\u4f5c\uff0c\u7531ALSA\u7684soc-core\u5728\u6267\u884c\u97f3\u9891\u64cd\u4f5c\u65f6\u8c03\u7528","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"hw_params\uff1a\u786c\u4ef6\u53c2\u6570\u8bbe\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u91c7\u6837\u7cbe\u5ea6\uff0c\u901a\u9053\u4f4d\u5bbd\u7684\u8bbe\u7f6e"}),"\n",(0,s.jsx)(e.li,{children:"trigger\uff1a\u547d\u4ee4\u89e6\u53d1\u51fd\u6570\uff0c\u7528\u4e8e\u6267\u884c\u97f3\u9891\u6570\u636e\u4f20\u8f93\u7684\u5f00\u59cb\u3001\u7ed3\u675f\u3001\u6682\u505c\u3001\u6062\u590d\u7b49"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"\u5728I2S\u7684\u9a71\u52a8\u4e2d\uff0c\u9700\u8981\u5b9e\u73b0\u7684\u63a5\u53e3\u6709\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"static const struct snd_soc_dai_ops aic_i2s_dai_ops = {\n        .set_sysclk = aic_i2s_set_sysclk,\n        .set_bclk_ratio = aic_i2s_set_bclk_ratio,\n        .set_fmt = aic_i2s_set_fmt,\n        .set_tdm_slot = aic_i2s_set_tdm_slot,\n        .hw_params = aic_i2s_hw_params,\n        .trigger = aic_i2s_trigger,\n};\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u5b9e\u73b0\u7684\u51e0\u4e2a\u63a5\u53e3\u51fd\u6570\u4e2d\uff0c\u9664hw_params\u548ctrigger\u5916\uff0c\u5176\u5b83\u51fd\u6570\u662f\u9700\u8981\u5728machine\u9a71\u52a8\u4e2d\u6839\u636eI2S\u548ccodec\u53cc\u65b9\u6240\u652f\u6301\u7684\u683c\u5f0f\u3001\u65f6\u949f\u7b49\u8fdb\u884c\u8c03\u7528\u8bbe\u7f6e\u7684\uff0c\u4f7fI2S\u548ccodec\u4e24\u8fb9\u7684\u683c\u5f0f\u8bbe\u7f6e\u76f8\u540c\u3002"}),"\n",(0,s.jsx)(e.h4,{id:"532-i2s\u65f6\u949f\u8bbe\u7f6e",children:"5.3.2. I2S\u65f6\u949f\u8bbe\u7f6e"}),"\n",(0,s.jsx)(e.h5,{id:"5321-mclk",children:"5.3.2.1. MCLK"}),"\n",(0,s.jsx)(e.p,{children:"MCLK\u662fI2S\u7684\u4e3b\u65f6\u949f\uff0c\u4e3b\u8981\u4f5c\u7528\u662f\u5411\u5916\u90e8\u7684codec\u82af\u7247\u63d0\u4f9b\u5de5\u4f5c\u65f6\u949f\uff0c\u7531I2S\u6a21\u5757\u7684\u5de5\u4f5c\u65f6\u949f\u5206\u9891\u5f97\u5230\u3002\u5728\u9a71\u52a8\u4e2d\u7531aic_i2s_set_sysclk\u8bbe\u7f6eMCLK\u7684\u9891\u7387\uff0cMCLK\u4e00\u822c\u91c7\u7528128fs\uff0c256fs\uff0c512fs\u7684\u8868\u793a\u65b9\u5f0f\uff0c\u5177\u4f53\u7684\u8bbe\u7f6e\u9700\u8981\u53c2\u8003\u5b9e\u9645\u4f7f\u7528\u7684codec\u82af\u7247\u89c4\u683c\u4e66\u3002Fs\u662f\u91c7\u6837\u9891\u7387\uff0c\u5e38\u89c1\u7684\u91c7\u6837\u9891\u7387\u670944.1khz\uff0c48khz\uff0c32khz\u7b49\uff0c\u53ef\u4ee5\u636e\u6b64\u7b97\u51faMCLK\u7684\u9891\u7387\u503c\u3002\u4e00\u822c\u4f1a\u5728machine\u9a71\u52a8\u4e2d\u8c03\u7528\u8bbe\u7f6eMCLK\u7684\u51fd\u6570\u3002"}),"\n",(0,s.jsx)(e.h5,{id:"5322-lrck\u548cbclk",children:"5.3.2.2. LRCK\u548cBCLK"}),"\n",(0,s.jsx)(e.p,{children:"LRCK\u662f\u5de6\u53f3\u58f0\u9053\u65f6\u949f\u3002LRCK\u7684\u65f6\u949f\u9891\u7387\u7b49\u4e8efs\uff0c\u5728D211\u4e2d\uff0c\u901a\u8fc7LRCK_PERIOD\u4f4d\u57df\u8bbe\u7f6eLRCK\u7684\u9891\u7387\uff0cLRCK_PERIOD\u8868\u793a\u4e00\u4e2aLRCK\u65f6\u949f\u5468\u671f\u5185\uff0c\u6709\u591a\u5c11\u4e2aBCLK\u5468\u671f\u3002\u5728I2S\u6a21\u5f0f\u4e0b\uff0c\u82e5\u4e3a\u7acb\u4f53\u58f0\uff082\u901a\u9053\uff09\uff0c32bit\u91c7\u6837\u6df1\u5ea6\uff0c\u5219BCLK=64fs\uff0c\u5219LRCK_PERIOD\u5e94\u8bbe\u7f6e\u4e3a(64/2-1)\u3002\u82e5\u4e3a4\u901a\u9053\uff0c24bit\u91c7\u6837\u6df1\u5ea6\uff0c\u5219BCLK=96fs\uff0c\u5219LRCK_PERIOD\u5e94\u8bbe\u7f6e\u4e3a\uff0896/2-1\uff09\u3002\u7531\u91c7\u6837\u9891\u7387\u53ef\u4ee5\u7b97\u51faBCLK\u65f6\u949f\u7684\u9891\u7387\u3002\u5e76\u7531BCLK\u7684\u9891\u7387\u7b97\u51faLRCK\uff0c\u5373\u91c7\u6837\u7387\u3002"}),"\n",(0,s.jsx)(e.h4,{id:"533-period-bytes\u5bf9\u9f50",children:"5.3.3. period bytes\u5bf9\u9f50"}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u4f7f\u7528DMA\u4f20\u8f93\u97f3\u9891\u6570\u636e\u65f6\uff0cDMA\u8981\u6c42\u6bcf\u6b21\u4f20\u8f93\u7684\u6570\u636e\u957f\u5ea6\u5fc5\u987b128bytes/8bytes\u5bf9\u9f50\u3002\u5728ALSA\u6846\u67b6\u4e0b\uff0c\u97f3\u9891\u6570\u636e\u4ee5period\u4e3a\u5468\u671f\u8c03\u7528DMA\u4f20\u8f93\uff0c\u6bcf\u6b21\u4f20\u8f93\u7684\u6570\u636e\u957f\u5ea6\u4e3aperiod bytes\u3002\u6240\u4ee5\uff0c\u5fc5\u987b\u6ee1\u8db3period bytes\u6309\u7167128bytes/8bytes\u5bf9\u9f50\u3002ALSA\u4e2d\u63d0\u4f9b\u4e86\u76f8\u5e94\u7684API\u63a5\u53e3(snd_pcm_hw_constraint_step)\u6765\u6ee1\u8db3\u8fd9\u4e00\u9700\u6c42\u3002"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:'static int aic_i2s_startup(struct snd_pcm_substream *substream,\n            struct snd_soc_dai *dai)\n{\n    int ret;\n\n    /* Make sure that the period bytes are 8/128 bytes aligned according to\n    * the DMA transfer requested.\n    */\n    if (of_device_is_compatible(dai->dev->of_node,\n        "artinchip,aic-i2s-v1.0")) {\n        ret = snd_pcm_hw_constraint_step(substream->runtime, 0,\n                    SNDRV_PCM_HW_PARAM_PERIOD_BYTES, 8);\n        if (ret < 0) {\n            dev_err(dai->dev,\n                "Could not apply period step: %d\\n", ret);\n            return ret;\n        }\n\n        ret = snd_pcm_hw_constraint_step(substream->runtime, 0,\n                    SNDRV_PCM_HW_PARAM_BUFFER_BYTES, 8);\n        if (ret < 0) {\n            dev_err(dai->dev,\n                "Could not apply buffer step: %d\\n", ret);\n            return ret;\n        }\n    } else {\n        ret = snd_pcm_hw_constraint_step(substream->runtime, 0,\n                    SNDRV_PCM_HW_PARAM_PERIOD_BYTES, 128);\n        if (ret < 0) {\n            dev_err(dai->dev,\n                "Could not apply period step: %d\\n", ret);\n            return ret;\n        }\n\n        ret = snd_pcm_hw_constraint_step(substream->runtime, 0,\n                    SNDRV_PCM_HW_PARAM_BUFFER_BYTES, 128);\n        if (ret < 0) {\n            dev_err(dai->dev,\n                "Could not apply buffer step: %d\\n", ret);\n            return ret;\n        }\n    }\n\n    return ret;\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"54-\u6570\u636e\u7ed3\u6784\u8bbe\u8ba1",children:"5.4. \u6570\u636e\u7ed3\u6784\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h4,{id:"541-aic_i2s",children:"5.4.1. aic_i2s"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"struct aic_i2s {\n        struct clk *clk;\n        struct reset_control *rst;\n        struct regmap *regmap;\n\n        struct snd_dmaengine_dai_dma_data playback_dma_data;\n        struct snd_dmaengine_dai_dma_data capture_dma_data;\n        unsigned int mclk_freq;\n        unsigned int bclk_ratio;\n        unsigned int format;\n        unsigned int slots;\n        unsigned int slot_width;\n};\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u90e8\u5206\u53d8\u91cf\u8bf4\u660e\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"playback_dma_data\uff1a\u64ad\u653e\u65f6\u7684\u97f3\u9891\u6570\u636e\u7ed3\u6784\uff0c\u7528\u4e8e\u914d\u7f6eDMA\u4f20\u8f93\u7684\u76ee\u7684\u5730\u5740\uff0c\u6570\u636e\u5bbd\u5ea6\u7b49\u4fe1\u606f"}),"\n",(0,s.jsx)(e.li,{children:"capture_dma_data\uff1a\u5f55\u97f3\u65f6\u97f3\u9891\u6570\u636e\u7ed3\u6784\uff0c\u7528\u4e8e\u914d\u7f6eDMA\u4f20\u8f93\u7684\u8d77\u59cb\u5730\u5740\uff0c\u6570\u636e\u5bbd\u5ea6\u7b49\u4fe1\u606f"}),"\n",(0,s.jsx)(e.li,{children:"mclk_freq\uff1aI2S\u7684MCLK\u65f6\u949f\u9891\u7387"}),"\n",(0,s.jsx)(e.li,{children:"bclk_ratio\uff1aLRCK\u4e0eBCLK\u7684\u6bd4\u7387"}),"\n",(0,s.jsx)(e.li,{children:"format\uff1a\u8bbe\u7f6eI2S\u7684\u4f20\u8f93\u683c\u5f0f"}),"\n",(0,s.jsx)(e.li,{children:"slots\uff1a\u8bbe\u7f6eI2S\u7684\u901a\u9053\u6570"}),"\n",(0,s.jsx)(e.li,{children:"slot_width\uff1a\u8bbe\u7f6eI2S\u7684\u6bcf\u4e2a\u901a\u9053\u5360\u7528\u4f4d\u6570"}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"542-aic_i2s_clk_div",children:"5.4.2. aic_i2s_clk_div"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"struct aic_i2s_clk_div {\n        u8 div; /* bclk\u548cmclk\u7684\u5206\u9891\u7cfb\u6570 */\n        u8 val; /* \u5206\u9891\u7cfb\u6570div\u6240\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\u7684\u503c */\n};\n"})}),"\n",(0,s.jsx)(e.h3,{id:"55-\u63a5\u53e3\u8bbe\u8ba1",children:"5.5. \u63a5\u53e3\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h4,{id:"551-aic_i2s_set_sysclk",children:"5.5.1. aic_i2s_set_sysclk"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u51fd\u6570\u539f\u578b"}),(0,s.jsx)(e.th,{children:"static int aic_i2s_set_sysclk(struct snd_soc_dai *dai, int clk_id, unsigned int freq, int dir)"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u529f\u80fd\u8bf4\u660e"}),(0,s.jsx)(e.td,{children:"\u8bbe\u7f6eI2S\u6a21\u5757\u8f93\u51fa\u7684mclk\u65f6\u949f\u9891\u7387"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u53c2\u6570\u5b9a\u4e49"}),(0,s.jsx)(e.td,{children:"dai\uff1a\u6307\u5411cpu_dai\u7684\u6307\u9488 | clk_id\uff1a\u8981\u8bbe\u7f6e\u7684\u65f6\u949fid | freq\uff1a\u8bbe\u7f6e\u7684\u65f6\u949f\u9891\u7387 | dir\uff1a unused"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u8fd4\u56de\u503c"}),(0,s.jsx)(e.td,{children:"0\uff1a\u6267\u884c\u6210\u529f | -EINVAL\uff1a\u53c2\u6570\u975e\u6cd5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u6ce8\u610f\u4e8b\u9879"}),(0,s.jsx)(e.td,{})]})]})]}),"\n",(0,s.jsx)(e.h4,{id:"552-aic_i2s_set_bclk_ratio",children:"5.5.2. aic_i2s_set_bclk_ratio"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u51fd\u6570\u539f\u578b"}),(0,s.jsx)(e.th,{children:"static int aic_i2s_set_bclk_ratio(struct snd_soc_dai *dai, unsigned int ratio)"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u529f\u80fd\u8bf4\u660e"}),(0,s.jsx)(e.td,{children:"\u8bbe\u7f6eI2S\u6a21\u5757LRCK\u4e0eBCLK\u65f6\u949f\u9891\u7387\u7684\u6bd4\u7387"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u53c2\u6570\u5b9a\u4e49"}),(0,s.jsx)(e.td,{children:"dai\uff1a\u6307\u5411cpu_dai\u7684\u6307\u9488 | ratio\uff1a\u9700\u8981\u8bbe\u7f6e\u7684\u6bd4\u7387"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u8fd4\u56de\u503c"}),(0,s.jsx)(e.td,{children:"0\uff1a\u6267\u884c\u6210\u529f | -EINVAL\uff1a\u53c2\u6570\u975e\u6cd5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u6ce8\u610f\u4e8b\u9879"}),(0,s.jsx)(e.td,{})]})]})]}),"\n",(0,s.jsx)(e.h4,{id:"553-aic_i2s_set_fmt",children:"5.5.3. aic_i2s_set_fmt"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u51fd\u6570\u539f\u578b"}),(0,s.jsx)(e.th,{children:"static int aic_i2s_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u529f\u80fd\u8bf4\u660e"}),(0,s.jsx)(e.td,{children:"\u8bbe\u7f6eI2S\u6a21\u5757\u7684\u683c\u5f0f"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u53c2\u6570\u5b9a\u4e49"}),(0,s.jsx)(e.td,{children:"dai\uff1a\u6307\u5411cpu_dai\u7684\u6307\u9488 | fmt\uff1a\u9700\u8981\u8bbe\u7f6e\u7684\u683c\u5f0f"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u8fd4\u56de\u503c"}),(0,s.jsx)(e.td,{children:"0\uff1a\u6267\u884c\u6210\u529f | -EINVAL\uff1a\u53c2\u6570\u975e\u6cd5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u6ce8\u610f\u4e8b\u9879"}),(0,s.jsx)(e.td,{children:"\u901a\u8fc7\u8be5\u51fd\u6570\u53ef\u4ee5\u8bbe\u7f6e\u7684\u683c\u5f0f\u6709\uff1a | 1. I2S\u7684\u4e3b\u4ece\u6a21\u5f0f | 2. BCLK\u548cLRCK\u7684\u6781\u6027 | 3. I2S\u7684\u6570\u636e\u683c\u5f0f"})]})]})]}),"\n",(0,s.jsx)(e.h4,{id:"554-aic_i2s_set_tdm_slot",children:"5.5.4. aic_i2s_set_tdm_slot"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u51fd\u6570\u539f\u578b"}),(0,s.jsx)(e.th,{children:"static int aic_i2s_set_tdm_slot(struct snd_soc_dai *dai,unsigned int tx_mask, unsigned int rx_mask,int slots, int slot_width)"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u529f\u80fd\u8bf4\u660e"}),(0,s.jsx)(e.td,{children:"\u8bbe\u7f6eI2S\u6a21\u5757TDM\u6a21\u5f0f\u4e0b\u7684\u901a\u9053\u4e2a\u6570\u548c\u5bbd\u5ea6"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u53c2\u6570\u5b9a\u4e49"}),(0,s.jsx)(e.td,{children:"dai\uff1a\u6307\u5411cpu_dai\u7684\u6307\u9488 | tx_mask\uff1atx slot\u7684mask | rx_mask\uff1arx slot\u7684mask | slots\uff1a\u8bbe\u7f6e\u7684\u901a\u9053\u4e2a\u6570 | slot_width\uff1a\u8bbe\u7f6e\u7684\u901a\u9053\u5bbd\u5ea6"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u8fd4\u56de\u503c"}),(0,s.jsx)(e.td,{children:"0\uff1a\u6267\u884c\u6210\u529f | -EINVAL\uff1a\u53c2\u6570\u975e\u6cd5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u6ce8\u610f\u4e8b\u9879"}),(0,s.jsx)(e.td,{})]})]})]}),"\n",(0,s.jsx)(e.h4,{id:"555-aic_i2s_hw_params",children:"5.5.5. aic_i2s_hw_params"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u51fd\u6570\u539f\u578b"}),(0,s.jsx)(e.th,{children:"static int aic_i2s_hw_params(struct snd_pcm_substream *substream, struct snd_pcm_hw_params *params, struct snd_soc_dai *dai)"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u529f\u80fd\u8bf4\u660e"}),(0,s.jsx)(e.td,{children:"\u8bbe\u7f6eI2S\u6a21\u5757\u786c\u4ef6\u53c2\u6570"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u53c2\u6570\u5b9a\u4e49"}),(0,s.jsx)(e.td,{children:"substream\uff1a\u6307\u5411playback\u6216capture\u7684substream | params\uff1a\u6307\u5411\u786c\u4ef6\u53c2\u6570\u6307\u9488 | dai\uff1a\u6307\u5411cpu_dai\u7684\u6307\u9488"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u8fd4\u56de\u503c"}),(0,s.jsx)(e.td,{children:"0\uff1a\u6267\u884c\u6210\u529f | -EINVAL\uff1a\u53c2\u6570\u975e\u6cd5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u6ce8\u610f\u4e8b\u9879"}),(0,s.jsx)(e.td,{children:"\u901a\u8fc7\u8be5\u51fd\u6570\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u91c7\u6837\u7cbe\u5ea6\uff0c\u5e27\u7387\uff0c\u4ee5\u53ca\u65f6\u949f\u7b49\u53c2\u6570"})]})]})]}),"\n",(0,s.jsx)(e.h4,{id:"556-aic_i2s_trigger",children:"5.5.6. aic_i2s_trigger"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u51fd\u6570\u539f\u578b"}),(0,s.jsx)(e.th,{children:"static int aic_i2s_trigger(struct snd_pcm_substream *substream, int cmd, struct snd_soc_dai *dai)"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u529f\u80fd\u8bf4\u660e"}),(0,s.jsx)(e.td,{children:"I2S\u7684\u89e6\u53d1\u51fd\u6570"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u53c2\u6570\u5b9a\u4e49"}),(0,s.jsx)(e.td,{children:"substream\uff1a\u6307\u5411playback\u6216capture\u7684substream | cmd\uff1a\u89e6\u53d1\u7684\u547d\u4ee4 | dai\uff1a\u6307\u5411cpu_dai\u7684\u6307\u9488"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u8fd4\u56de\u503c"}),(0,s.jsx)(e.td,{children:"0\uff1a\u6267\u884c\u6210\u529f | -EINVAL\uff1a\u53c2\u6570\u975e\u6cd5"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u6ce8\u610f\u4e8b\u9879"}),(0,s.jsx)(e.td,{children:"\u901a\u8fc7\u8be5\u51fd\u6570\uff0c\u53ef\u4ee5\u5f00\u59cb\u6216\u505c\u6b62\u97f3\u9891\u7684\u64ad\u653e\u6216\u5f55\u97f3"})]})]})]}),"\n",(0,s.jsx)(e.h2,{id:"6-\u5e38\u89c1\u95ee\u9898",children:"6. \u5e38\u89c1\u95ee\u9898"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u6267\u884camixer\u65f6\u62a5\u9519\uff0c\u663e\u793a\u627e\u4e0d\u5230alsa.conf\u914d\u7f6e\u6587\u4ef6"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{src:"https://photos.100ask.net/artinchip-docs/d213-devkit/amixer_error1-17067516245563.png",alt:"../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/amixer_error1.png"})}),"\n",(0,s.jsx)(e.p,{children:"\u8be5\u95ee\u9898\u7684\u539f\u56e0\u662f\u627e\u4e0d\u5230ALSA\u7684\u8def\u5f84\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u89e3\u51b3\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"export ALSA_CONFIG_DIR=/usr/share/alsa/\n\u5f85\u540e\u7eed\u5b8c\u5584\n"})})]})}function _(n={}){const{wrapper:e}={...(0,d.a)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(h,{...n})}):h(n)}},1151:(n,e,i)=>{i.d(e,{Z:()=>r,a:()=>t});var s=i(7294);const d={},c=s.createContext(d);function t(n){const e=s.useContext(c);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(d):n.components||d:t(n.components),s.createElement(c.Provider,{value:e},n.children)}}}]);