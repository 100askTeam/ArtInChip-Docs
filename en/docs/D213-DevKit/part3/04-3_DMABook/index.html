<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-D213-DevKit/part3/04-3_DMABook" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">DMA 使用指南 | 东山Π</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://artinchip.100ask.net/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://artinchip.100ask.net/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://artinchip.100ask.net/en/docs/D213-DevKit/part3/04-3_DMABook"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="DMA 使用指南 | 东山Π"><meta data-rh="true" name="description" content="1. 模块介绍"><meta data-rh="true" property="og:description" content="1. 模块介绍"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part3/04-3_DMABook"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part3/04-3_DMABook" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part3/04-3_DMABook" hreflang="en"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part3/04-3_DMABook" hreflang="x-default"><link rel="stylesheet" href="/en/assets/css/styles.d875fe7e.css">
<script src="/en/assets/js/runtime~main.b47c3da8.js" defer="defer"></script>
<script src="/en/assets/js/main.880773af.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/en/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">东山Π</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/D213-DevKit/BoardIntroduction">D213-DevKit</a><a class="navbar__item navbar__link" href="/en/docs/category/luban-sdk使用指南">Luban-SDK</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/D213-DevKit/part3/04-3_DMABook" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">简体中文</a></li><li><a href="/en/docs/D213-DevKit/part3/04-3_DMABook" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/ArtInChip-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/BoardIntroduction">匠心创D213-DevKit开发板</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/SupportingResources">源码工具文档手册</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/快速启动">快速启动</a><button aria-label="Expand sidebar category &#x27;快速启动&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/ConfigHostEnv">安装并配置开发环境</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/luban-sdk开发">Luban-SDK开发</a><button aria-label="Expand sidebar category &#x27;Luban-SDK开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/luban-linux系统开发">Luban-Linux系统开发</a><button aria-label="Collapse sidebar category &#x27;Luban-Linux系统开发&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-1_BWMUserGuide">BWM 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-2_CMUUserGuide">CMU 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/D213-DevKit/part3/04-3_DMABook">DMA 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-4_RTCUserGuide">RTC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-5_TSensorUserGuide">TSensor 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-6_WatchdogUserGuide">Watchdog 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-7_WRIUserGuide">WRI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-1_SDMCUserGuide">SDMC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-2_SPI_NANDUserGuide">SPI NAND 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-3_SPI_NORUserGuide">SPI NOR 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-4_FileSystemUserGuide">文件系统使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-1_GE-Useguide">GE 开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-2_VE-Useguide">VE 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-3_Display-Useguide">Display 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-4_DVP-Useguide">DVP开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-8_I2S-Useguide">I2S 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-9_AudioCodec-Useguide">AudioCodec 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-1_CAN-Useguide">CAN 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-2_ CIR-Useguide">CIR 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-3_ GPAI-Useguide">GPAI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-4_I2C-Useguide">I2C 开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-5_MAC-Useguide">MAC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-6_PBus-Useguide">PBus 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-7_PINCTRL-Useguide">PINCTRL 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-8_PWM-Useguide">PWM 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-9_RTP-Useguide">RTP 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-10_SPI-Useguide">SPI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-11_UART-Useguide">UART 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-12_USB-Useguide">USB 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-13_PSADC-Useguide">PSADC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-1_SPI-ENC">SPI ENC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-2_CE-Useguide">CE 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-3_eFuse-Useguide">eFuse 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-4_HardwareAuthorizationCertification">硬件授权认证</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-1_TouchscreenDebuggingGuide">触摸屏调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-2_DisplayDebuggingGuide">显示屏调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-3_WiFiDebuggingGuide">WiFi调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-4_GuideToUsingTheKeyMatrix">按键矩阵使用指南</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux-bringup参考">Linux-Bringup参考</a><button aria-label="Expand sidebar category &#x27;Linux-Bringup参考&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux-uboot开发">Linux-Uboot开发</a><button aria-label="Expand sidebar category &#x27;Linux-Uboot开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/luban-linux系统开发"><span itemprop="name">Luban-Linux系统开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">DMA 使用指南</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>DMA 使用指南</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-模块介绍">1. 模块介绍<a href="#1-模块介绍" class="hash-link" aria-label="Direct link to 1. 模块介绍" title="Direct link to 1. 模块介绍">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-术语定义">1.1. 术语定义<a href="#11-术语定义" class="hash-link" aria-label="Direct link to 1.1. 术语定义" title="Direct link to 1.1. 术语定义">​</a></h3>
<table><thead><tr><th>术语</th><th>定义</th><th>注释说明</th></tr></thead><tbody><tr><td>DMA</td><td>Direct Memory Access</td><td>直接存储器访问</td></tr><tr><td>DRQ</td><td>DMA Request</td><td>指DMA请求的端口号</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-模块简介">1.2. 模块简介<a href="#12-模块简介" class="hash-link" aria-label="Direct link to 1.2. 模块简介" title="Direct link to 1.2. 模块简介">​</a></h3>
<p>DMA 模块允许总线上的不同设备间的数据自动直接传输，最大优点是可减少CPU负载，并且具有高带宽、低延迟的特性。</p>
<p>DMA 模块的功能特性：</p>
<ul>
<li>支持8个DMA通道，每通道有32个源端和32个终端可选</li>
<li>采用链表配置方式，寄存器描述通道状态</li>
<li>设备位宽支持8/16/32/64位，Burst长度支持1/4/8/16个</li>
<li>DMA 源端、终端地址 8Byte 对齐</li>
</ul>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/hw_system10-170669106435917.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/hw_system10.png" class="img_ev3q"></p>
<p>图 4.5 <em>DMA 硬件的原理框图</em></p>
<p>从上图中可以看出，根据数据的源、目的可以将DMA操作分为以下3种情况：</p>
<table><thead><tr><th></th><th>内核中类型定义</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>DMA_MEM_TO_MEM</td><td>从内存到内存（包括DRAM、SRAM），可看作memcpy()的硬件加速</td></tr><tr><td>2</td><td>DMA_MEM_TO_DEV</td><td>从内存到设备，支持DMA操作的设备一般需要提供握手信号、FIFO</td></tr><tr><td>3</td><td>DMA_DEV_TO_MEM</td><td>从设备到内存，是情况2的逆操作</td></tr><tr><td>4</td><td>DMA_DEV_TO_DEV</td><td>从设备到设备，这种比较少用</td></tr></tbody></table>
<p>表中的类型定义详见Linux代码：include/linux/dmaengine.h</p>
<p>注解</p>
<p>USB、GMAC、eMMC等模块都有自己内置的DMA，为了区分开，所以有时候也将本 模块称作 “通用 DMA” 模块。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-参数配置">2. 参数配置<a href="#2-参数配置" class="hash-link" aria-label="Direct link to 2. 参数配置" title="Direct link to 2. 参数配置">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-内核配置">2.1. 内核配置<a href="#21-内核配  置" class="hash-link" aria-label="Direct link to 2.1. 内核配置" title="Direct link to 2.1. 内核配置">​</a></h3>
<p>在luban根目录下执行 make kernel-menuconfig，进入kernel的功能配置，按如下选择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Device Drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [*] DMA Engine support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;*&gt;   Artinchip SoCs DMA support</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-dts-参数配置">2.2. DTS 参数配置<a href="#22-dts-参数配置" class="hash-link" aria-label="Direct link to 2.2. DTS 参数配置" title="Direct link to 2.2. DTS 参数配置">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="221-d211-配置">2.2.1. D211 配置<a href="#221-d211-配置" class="hash-link" aria-label="Direct link to 2.2.1. D211 配置" title="Direct link to 2.2.1. D211 配置">​</a></h4>
<p>common/d211.dtsi中的参数配置：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dma: dma-controller@10000000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compatible = &quot;artinchip,aic-dma-v1.0&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reg = &lt;0x0 0x10000000 0x0 0x1000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interrupts-extended = &lt;&amp;plic0 32 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clocks = &lt;&amp;cmu CLK_DMA&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resets = &lt;&amp;rst RESET_DMA&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #dma-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="222-引用dma通道">2.2.2. 引用DMA通道<a href="#222-引用dma通道" class="hash-link" aria-label="Direct link to 2.2.2. 引用DMA通道" title="Direct link to 2.2.2. 引用DMA通道">​</a></h4>
<p>使用DMA进行数据传输的模块，可以通过DTS来配置。以SPI为例，要配置RX、TX对应的DMA端口号（DRQ Port）：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spi0: spi@10400000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compatible = &quot;artinchip,aic-spi-v1.0&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reg = &lt;0x10400000 0x1000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interrupts = &lt;GIC_SPI 12 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clocks = &lt;&amp;cmu CLK_SPI0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resets = &lt;&amp;rst RESET_SPI0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dmas = &lt;&amp;dma DMA_SPI0&gt;, &lt;&amp;dma DMA_SPI0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma-names = &quot;rx&quot;, &quot;tx&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #address-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #size-cells = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spi-max-frequency = &lt;24000000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中端口号 DMA_SPI0 的定义见 U-Boot中代码 include/dt-bindings/dma/d211-dma.h</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_SRAM   0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_DRAM   1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_SPI0   10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_SPI1   11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_I2S0   12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_I2S1   13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_CODEC  14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART0  16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART1  17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART2  18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART3  19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART4  20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART5  21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART6  22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_UART7  23</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注解</p>
<p>DMA端口号的宏定义仅在DTS编译过程中用到，我们的DTS编译过程是放在U-Boot编译中，所以将这些宏定义放在U-Boot。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-调试指南">3. 调试指南<a href="#3-调试指南" class="hash-link" aria-label="Direct link to 3. 调试指南" title="Direct link to 3. 调试指南">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-调试  开关">3.1. 调试开关<a href="#31-调试开关" class="hash-link" aria-label="Direct link to 3.1. 调试开关" title="Direct link to 3.1. 调试开关">​</a></h3>
<p>在luban根目录下执行 make kernel-menuconfig，进入kernel的功能配置，可以打开DMA模块的DEBUG选项：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Kernel hacking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [*] DMA Engine support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*]   DMA Engine debugging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*]     DMA Engine verbose debugging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此DEBUG选项打开的影响：</p>
<ol>
<li>DMA 子系统的pr_dbg()和dev_dbg()调试信息会被编译</li>
<li>DMA 子系统的Verbose debug信息也会被打开编译</li>
</ol>
<p>在系统运行时，如果要打印pr_dbg()和dev_dbg()信息，还需要调整loglevel为8，两个方法：</p>
<ol>
<li>在board.dts中修改bootargs，增加“loglevel=8”</li>
<li>在板子启动到Linux shell后，执行命令：</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo 8 &gt; /proc/sys/kernel/printk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-测试指南">4. 测试指南<a href="#4-测试指南" class="hash-link" aria-label="Direct link to 4. 测试指南" title="Direct link to 4. 测试指南">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-测试环境">4.1. 测试环境<a href="#41-测试环境" class="hash-link" aria-label="Direct link to 4.1. 测试环境" title="Direct link to 4.1. 测试环境">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="411-硬件">4.1.1. 硬件<a href="#411-硬件" class="hash-link" aria-label="Direct link to 4.1.1. 硬件" title="Direct link to 4.1.1. 硬件">​</a></h4>
<ul>
<li>开发板，或FPGA板</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="412-软件">4.1.2. 软件<a href="#412-软件" class="hash-link" aria-label="Direct link to 4.1.2. 软件" title="Direct link to 4.1.2. 软件">​</a></h4>
<ul>
<li>PC端的串口终端软件，用于PC和开发板进行串口通信</li>
<li>Linux内核原生的dmatest模块</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="413-软件配置">4.1.3. 软件配置<a href="#413-软件配置" class="hash-link" aria-label="Direct link to 4.1.3. 软件配置" title="Direct link to 4.1.3. 软件配置">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="4131-dmttest">4.1.3.1. dmttest<a href="#4131-dmttest" class="hash-link" aria-label="Direct link to 4.1.3.1. dmttest" title="Direct link to 4.1.3.1. dmttest">​</a></h5>
<p>dmatest是 Linux 内核中原生的一个模块，在luban的根目录下通过make kernel-menuconfig，按如下选择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Device Drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [*] DMA Engine support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             &lt;*&gt;   DMA Test client</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注解</p>
<p>dmatest模块只限于测试 Mem To Mem 的数据传输操作。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-dmatest-测试">4.2. dmatest 测试<a href="#42-dmatest-测试" class="hash-link" aria-label="Direct link to 4.2. dmatest 测试" title="Direct link to 4.2. dmatest 测试">​</a></h3>
<p>dmatest模块初始化成功后，会在Sysfs目录创建一些节点，测试过程就是通过这些节点配置参数、启动测试。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[aic@] # cd /sys/module/dmatest/parameters/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[aic@parameters] # ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alignment         max_channels      run               transfer_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel           norandom          test_buf_size     verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">device            noverify          test_list         wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dmatest           polled            threads_per_chan  xor_sources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iterations        pq_sources        timeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[aic@parameters] # echo 30 &gt; iterations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[aic@parameters] # echo 8 &gt; max_channels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[aic@parameters] # echo Y &gt; polled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[aic@parameters] # echo Y &gt; run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.696480] dmatest: No channels configured, continue with any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.697377] dmatest: Added 1 threads using dma0chan2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.698061] dmatest: Added 1 threads using dma0chan3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.698695] dmatest: Added 1 threads using dma0chan4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.699334] dmatest: Added 1 threads using dma0chan5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.699964] dmatest: Added 1 threads using dma0chan6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.700599] dmatest: Added 1 threads using dma0chan7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.701248] dmatest: Added 1 threads using dma0chan8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.701883] dmatest: Added 1 threads using dma0chan9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.702328] dmatest: Started 1 threads using dma0chan2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.702776] dmatest: Started 1 threads using dma0chan3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.703223] dmatest: Started 1 threads using dma0chan4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.703671] dmatest: Started 1 threads using dma0chan5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.704118] dmatest: Started 1 threads using dma0chan6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.704564] dmatest: Started 1 threads using dma0chan7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.705011] dmatest: Started 1 threads using dma0chan8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  104.705457] dmatest: Started 1 threads using dma0chan9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  105.006038] dmatest: dma0chan4-copy0: summary 30 tests, 0 failures 106.28 iops 836 KB/s (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  105.306046] dmatest: dma0chan2-copy0: summary 30 tests, 0 failures 106.58 iops 884 KB/s (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  105.606055] dmatest: dma0chan3-copy0: summary 30 tests, 0 failures 106.60 iops 1044 KB/s (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  105.906057] dmatest: dma0chan5-copy0: summary 30 tests, 0 failures 106.59 iops 835 KB/s (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  106.206050] dmatest: dma0chan6-copy0: summary 30 tests, 0 failures 106.59 iops 792 KB/s (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  106.506034] dmatest: dma0chan7-copy0: summary 30 tests, 0 failures 106.61 iops 856 KB/s (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  106.806048] dmatest: dma0chan8-copy0: summary 30 tests, 0 failures 107.64 iops 843 KB/s (0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  107.106044] dmatest: dma0chan9-copy0: summary 30 tests, 0 failures 106.81 iops 993 KB/s (0)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-设计说明">5. 设计说明<a href="#5-设计说明" class="hash-link" aria-label="Direct link to 5. 设计说明" title="Direct link to 5. 设计说明">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-源码说明">5.1. 源码说明<a href="#51-源码说明" class="hash-link" aria-label="Direct link to 5.1. 源码说明" title="Direct link to 5.1. 源码说明">​</a></h3>
<p>源代码位于：drivers/dma/artinchip-dma.c</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-模块架构">5.2. 模块架构<a href="#52-模块架构" class="hash-link" aria-label="Direct link to 5.2. 模块架构" title="Direct link to 5.2. 模块架构">​</a></h3>
<p>Linux提供了一个 DMA Engine 子系统，可封装不同类型的 DMA控制器驱动，便于实现 DMA 用户对硬件细节的透明。</p>
<p>DMA Engine的软件框架如下图：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/sw_system20-170669128264719.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/sw_system20.png" class="img_ev3q"></p>
<p>图 4.6 <em>Linux DMA Engine子系统架构图</em><a href="#id15">¶</a></p>
<p>图中可以看到DMA Engine中有几个概念：</p>
<ul>
<li>
<p>DMA Device</p>
<p>对应物理上的一个DMA Controller。DMA Driver需要提供DMA Controller的一些属性、接口，然后注册为一个DMA Device，供后续DMA Engine框架来调用。支持注册多个DMA Device，会使用一个链表 dma_device_list 来进行管理。</p>
</li>
<li>
<p>DMA channel</p>
<p>和物理上的一个DMA通道（如图中DMA Controller的Chx）一一对应。这些通道也是通过一个链表进行管理，归属于某一个DMA Device。</p>
</li>
<li>
<p>VC（Virtual channel）</p>
<p>基于物理的DMA通道，DMA Engine提供了一种虚拟的通道概念VC，VC数目往往多于物理通道数，比如VC有48个而物理通道只有8个，这样可以提供一个动态的物理通道分配机制。</p>
</li>
<li>
<p>DMA Client</p>
<p>指DMA模块的使用者，DMA用户仅限内核中的其他模块，如SPI、Audio Codec、UART等，暂未提供用户态的使用接口。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-关键流程设计">5.3. 关键流程设计<a href="#53-关键流程设计" class="hash-link" aria-label="Direct link to 5.3. 关键流程设计" title="Direct link to 5.3. 关键流程设计">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="531-初始化流程">5.3.1. 初始化流程<a href="#531-初始化流程" class="hash-link" aria-label="Direct link to 5.3.1. 初始化流程" title="Direct link to 5.3.1. 初始化流程">​</a></h4>
<p>DMA驱动的初始化过程见aic_dma_probe()函数，除了普通platform设备的处理过程（申请regs资源、clk、reset）外，需要调用DMA子系统的接口dma_async_device_register()来注册DMA备。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int dma_async_device_register(struct dma_device *device)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中参数struct dma_device 需要提供的关键信息有：DMA控制器能力描述、DMA操作API等，其初始化内容如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* 配置 DMA 控制器的能力描述信息 */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (of_device_is_compatible(pdev-&gt;dev.of_node,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;artinchip,aic-dma-v0.1&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdev-&gt;slave.copy_align = DMAENGINE_ALIGN_128_BYTES;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdev-&gt;slave.copy_align = DMAENGINE_ALIGN_8_BYTES;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.src_addr_widths = AIC_DMA_BUS_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.dst_addr_widths = AIC_DMA_BUS_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.directions = BIT(DMA_DEV_TO_MEM) | BIT(DMA_MEM_TO_DEV);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.residue_granularity = DMA_RESIDUE_GRANULARITY_BURST;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INIT_LIST_HEAD(&amp;sdev-&gt;slave.channels);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma_cap_set(DMA_PRIVATE, sdev-&gt;slave.cap_mask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma_cap_set(DMA_MEMCPY, sdev-&gt;slave.cap_mask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma_cap_set(DMA_SLAVE, sdev-&gt;slave.cap_mask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma_cap_set(DMA_CYCLIC, sdev-&gt;slave.cap_mask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* 初始化 DMA 操作 API */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_free_chan_resources = aic_dma_free_chan_resources;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_prep_dma_memcpy = aic_dma_prep_dma_memcpy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_prep_slave_sg = aic_dma_prep_slave_sg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_prep_dma_cyclic = aic_dma_prep_dma_cyclic;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_config = aic_dma_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_pause = aic_dma_pause;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_resume = aic_dma_resume;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_terminate_all = aic_dma_terminate_all;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_tx_status = aic_dma_tx_status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_issue_pending = aic_dma_issue_pending;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sdev-&gt;slave.device_release = aic_dma_device_release;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中，DMA控制器的能力特性含义如下：</p>
<table><thead><tr><th>能力特性</th><th>含义</th></tr></thead><tbody><tr><td>DMA_PRIVATE</td><td>不支持异步传输</td></tr><tr><td>DMA_MEMCPY</td><td>支持内存到内存的拷贝操作</td></tr><tr><td>DMA_SLAVE</td><td>支持设备到内存的传输操作</td></tr><tr><td>DMA_CYCLIC</td><td>支持循环Buffer的情况</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="532-dma-client-的调用流程">5.3.2. DMA Client 的调用流程<a href="#532-dma-client-的调用流程" class="hash-link" aria-label="Direct link to 5.3.2. DMA Client 的调用流程" title="Direct link to 5.3.2. DMA Client 的调用流程">​</a></h4>
<p>作为DMA 用户，调用流程如下：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/client_flow1-170669130448321.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/client_flow1.png" class="img_ev3q"></p>
<p>图 4.7 <em>Linux DMA Client调用流程</em></p>
<p>其中有两个操作的概念需要注意：</p>
<ul>
<li>submit，是指传输请求提交给了DMA Engine的缓存中，还没有开始传输数据</li>
<li>issue pending，将传输请求加入到DMA Device的请求队列中，接下来才会启动数据传输动作</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="533-中断处理流程">5.3.3. 中断处理流程<a href="#533-中断处理流程" class="hash-link" aria-label="Direct link to 5.3.3. 中断处理流程" title="Direct link to 5.3.3. 中断处理流程">​</a></h4>
<p>中断处理流程相对简单：</p>
<ol>
<li>逐个DMA通道的查看完成状态；</li>
<li>如果当前传输是循环Buffer的情况，则直接调用预先注册好的回调接口；</li>
<li>如果不是循环模式，则更新相应的通道状态为Complete。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="54-数据结构设计">5.4. 数据结构设计<a href="#54-数据结构设计" class="hash-link" aria-label="Direct link to 5.4. 数据结构设计" title="Direct link to 5.4. 数据结构设计">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="541-aic_dma_dev">5.4.1. aic_dma_dev<a href="#541-aic_dma_dev" class="hash-link" aria-label="Direct link to 5.4.1. aic_dma_dev" title="Direct link to 5.4.1. aic_dma_dev">​</a></h4>
<p>记录DMA控制器的配置信息：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_dma_dev {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void __iomem *base;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int irq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 num_pchans;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 num_vchans;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 max_request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct clk *clk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct reset_control *reset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spinlock_t lock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct dma_pool *pool;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_pchan *pchans;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_vchan *vchans;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct aic_dma_inf *dma_inf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct dma_device slave;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="542-aic_dma_inf">5.4.2. aic_dma_inf<a href="#542-aic_dma_inf" class="hash-link" aria-label="Direct link to 5.4.2. aic_dma_inf" title="Direct link to 5.4.2. aic_dma_inf">​</a></h4>
<p>记录DMA控制器的一些特性，如通道数、端口数、Burst长度、地址宽度，这些特性会因不同SoC而不同，所以此数据结构会用在 of_device_id 中的私有数据，配合 compatible 来区分不同的SoC。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_dma_inf {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 nr_chans; /* count of dma physical channels */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 nr_ports; /* count of dma drq prots */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 nr_vchans; /* total valid transfer types */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 burst_length; /* burst length capacity */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 addr_widths; /* address width support capacity */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="543-dma-通道信息">5.4.3. DMA 通道信息<a href="#543-dma-通道信息" class="hash-link" aria-label="Direct link to 5.4.3. DMA 通道信息" title="Direct link to 5.4.3. DMA 通道信息">​</a></h4>
<p>由 <a href="#ref-dma-engine">模块架构</a> 可知 DMA物理通道 和 DMA虚拟通道 是一对多的关系，所以在设计中它们互相都需要在记录好对方的数据引用指针。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5431-dma-物理通道信息">5.4.3.1. DMA 物理通道信息<a href="#5431-dma-物理通道信息" class="hash-link" aria-label="Direct link to 5.4.3.1. DMA 物理通道信息" title="Direct link to 5.4.3.1. DMA 物理通道信息">​</a></h5>
<p>记录了一个 DMA 物理通道对应的通道号、寄存器基地址、对应的虚拟通道指针等：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_pchan {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 id; /* DMA channel number */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void __iomem *base; /* DMA channel control registers */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_vchan *vchan; /* virtual channel info */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5432-dma-虚拟通道信息">5.4.3.2. DMA 虚拟通道信息<a href="#5432-dma-虚拟通道信息" class="hash-link" aria-label="Direct link to 5.4.3.2. DMA 虚拟通道信息" title="Direct link to 5.4.3.2. DMA 虚拟通道信息">​</a></h5>
<p>记录了一个 DMA 虚拟通道对应的DRQ端口号、传输类型、对应的物理通道指针等：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_vchan {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 port; /* DRQ port number */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 irq_type; /* IRQ types */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool cyclic; /* flag to mark if cyclic transfer one package */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_pchan *pchan; /* physical DMA channel */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_desc *desc; /* current transfer */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* parameter for dmaengine */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct virt_dma_chan vc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct dma_slave_config cfg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum dma_status status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="544-dma-描述符">5.4.4. DMA 描述符<a href="#544-dma-描述符" class="hash-link" aria-label="Direct link to 5.4.4. DMA 描述符" title="Direct link to 5.4.4. DMA 描述符">​</a></h4>
<p>DMA 控制器支持散列（Scatter Gather）的描述符参数形式，需要提前将参数分组（一个Buffer对应一组散列参数）打包到多个描述符中，这些描述符会组成一个链表，然后将这个链表的第一个描述符的物理地址传给DMA控制器。描述符组成的链表结构如下图：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dma_task1-170669135135423.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dma_task1.png" class="img_ev3q"></p>
<p>图 4.8 <em>DMA 描述符链表的结构示意图</em></p>
<p>小技巧</p>
<p><code>End Flag</code> 是DMA控制器硬件预先定义好的一个数值：0xfffff800。</p>
<p>DMA 描述符的数据结构定义如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_dma_task {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 cfg;    /* DMA transfer configuration */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 src;    /* source address of one transfer package */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 dst;    /* destination address of one transfer package */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 len;    /* data length of one transfer package */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 delay;  /* time delay for period transfer */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 p_next; /* next task node for DMA controller */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 mode;   /* the negotiation mode */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * virtual list for driver maintain package list,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * not used by DMA controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_dma_task *v_next;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="55-接口设计">5.5. 接口设计<a href="#55-接口设计" class="hash-link" aria-label="Direct link to 5.5. 接口设计" title="Direct link to 5.5. 接口设计">​</a></h3>
<p>以下接口是 Linux DMA Engine 子系统的标准接口。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="551-aic_dma_config">5.5.1. aic_dma_config<a href="#551-aic_dma_config" class="hash-link" aria-label="Direct link to 5.5.1. aic_dma_config" title="Direct link to 5.5.1. aic_dma_config">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static int aic_dma_config(struct dma_chan *chan, struct dma_slave_config *config)</th></tr></thead><tbody><tr><td>功能说明</td><td>配置指定的DMA物理通道</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道config - 保存了需要的配置信息</td></tr><tr><td>返回值</td><td>0，成功</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="552-aic_dma_pause">5.5.2. aic_dma_pause<a href="#552-aic_dma_pause" class="hash-link" aria-label="Direct link to 5.5.2. aic_dma_pause" title="Direct link to 5.5.2. aic_dma_pause">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static int aic_dma_pause(struct dma_chan *chan)</th></tr></thead><tbody><tr><td>功能说明</td><td>暂停指定通道的传输操作</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道</td></tr><tr><td>返回值</td><td>0，成功</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="553-aic_dma_resume">5.5.3. aic_dma_resume<a href="#553-aic_dma_resume" class="hash-link" aria-label="Direct link to 5.5.3. aic_dma_resume" title="Direct link to 5.5.3. aic_dma_resume">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static int aic_dma_resume(struct dma_chan *chan)</th></tr></thead><tbody><tr><td>功能说明</td><td>恢复指定通道的传输操作</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道</td></tr><tr><td>返回值</td><td>0，成功</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="554-aic_dma_prep_dma_memcpy">5.5.4. aic_dma_prep_dma_memcpy<a href="#554-aic_dma_prep_dma_memcpy" class="hash-link" aria-label="Direct link to 5.5.4. aic_dma_prep_dma_memcpy" title="Direct link to 5.5.4. aic_dma_prep_dma_memcpy">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static struct dma_async_tx_descriptor *aic_dma_prep_dma_memcpy(struct dma_chan *chan,dma_addr_t dest, dma_addr_t src,size_t len, unsigned long flags)</th></tr></thead><tbody><tr><td>功能说明</td><td>memcpy操作的预处理</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道dest - 目标Buffer的物理地址src - 源Buffer的物理地址len - 数据长度flags - 一些标记</td></tr><tr><td>返回值</td><td>成功，则返回一个DMA描述符；失败，返回NULL</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="555-aic_dma_prep_slave_sg">5.5.5. aic_dma_prep_slave_sg<a href="#555-aic_dma_prep_slave_sg" class="hash-link" aria-label="Direct link to 5.5.5. aic_dma_prep_slave_sg" title="Direct link to 5.5.5. aic_dma_prep_slave_sg">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static struct dma_async_tx_descriptor *aic_dma_prep_slave_sg(struct dma_chan *chan,struct scatterlist *sgl, unsigned int sg_len,enum dma_transfer_direction dir, unsigned long flags,void *context)</th></tr></thead><tbody><tr><td>功能说明</td><td>设备与内存之间传输操作的预处理</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道sgl - 指向一个散列列表sg_len - 散列中的数据长度dir - 传输方向，是 Dev to Mem，还是 Mem to Devflags - 一些标记context - 指向一些私有的上下文信息</td></tr><tr><td>返回值</td><td>成功，则返回一个DMA描述符；失败，返回NULL</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="556-aic_dma_prep_dma_cyclic">5.5.6. aic_dma_prep_dma_cyclic<a href="#556-aic_dma_prep_dma_cyclic" class="hash-link" aria-label="Direct link to 5.5.6. aic_dma_prep_dma_cyclic" title="Direct link to 5.5.6. aic_dma_prep_dma_cyclic">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static struct dma_async_tx_descriptor *aic_dma_prep_dma_cyclic(struct dma_chan *chan,dma_addr_t buf_addr, size_t buf_len, size_t period_len,enum dma_transfer_direction dir, unsigned long flags)</th></tr></thead><tbody><tr><td>功能说明</td><td>（设备与内存之间）循环传输操作的预处理</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道buf_addr - 循环Buffer的起始物理地址buf_len - 循环Buffer的总长度period_len - 循环的Buffer片段长度dir - 传输方向，是 Dev to Mem，还是 Mem to Devflags - 一些标记</td></tr><tr><td>返回值</td><td>成功，则返回一个DMA描述符；失败，返回NULL</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="557-aic_dma_issue_pending">5.5.7. aic_dma_issue_pending<a href="#557-aic_dma_issue_pending" class="hash-link" aria-label="Direct link to 5.5.7. aic_dma_issue_pending" title="Direct link to 5.5.7. aic_dma_issue_pending">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static void aic_dma_issue_pending(struct dma_chan *chan)</th></tr></thead><tbody><tr><td>功能说明</td><td>启动指定通道的数据传输</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道</td></tr><tr><td>返回值</td><td>无</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="558-aic_dma_terminate_all">5.5.8. aic_dma_terminate_all<a href="#558-aic_dma_terminate_all" class="hash-link" aria-label="Direct link to 5.5.8. aic_dma_terminate_all" title="Direct link to 5.5.8. aic_dma_terminate_all">​</a></h4>
<table><thead><tr><th>函数原型</th><th>static int aic_dma_terminate_all(struct dma_chan *chan)</th></tr></thead><tbody><tr><td>功能说明</td><td>终止所有通道的数据传输</td></tr><tr><td>参数定义</td><td>chan - 指向一个DMA物理通道</td></tr><tr><td>返回值</td><td>0，成功</td></tr><tr><td>注意事项</td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="56-demo">5.6. Demo<a href="#56-demo" class="hash-link" aria-label="Direct link to 5.6. Demo" title="Direct link to 5.6. Demo">​</a></h3>
<p>SPI 驱动（详见drivers/spi/spi-artinchip.c）中调用了DMA进行数据传输，其使用过程可以当作Demo参考：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="561-dma-通道的申请">5.6.1. DMA 通道的申请<a href="#561-dma-通道的申请" class="hash-link" aria-label="Direct link to 5.6.1. DMA 通道的申请" title="Direct link to 5.6.1. DMA 通道的申请">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static int aic_spi_probe(struct platform_device *pdev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aicspi-&gt;dma_rx = dma_request_slave_channel(aicspi-&gt;dev, &quot;rx&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!aicspi-&gt;dma_rx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dev_warn(aicspi-&gt;dev, &quot;failed to request rx dma channel\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aicspi-&gt;dma_tx = dma_request_slave_channel(aicspi-&gt;dev, &quot;tx&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!aicspi-&gt;dma_tx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dev_warn(aicspi-&gt;dev, &quot;failed to request tx dma channel\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="562-dma-数据提交">5.6.2. DMA 数据提交<a href="#562-dma-数据提交" class="hash-link" aria-label="Direct link to 5.6.2. DMA 数据提交" title="Direct link to 5.6.2. DMA 数据提交">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static int aic_spi_dma_rx_cfg(struct aic_spi *aicspi, struct spi_transfer *t)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct dma_async_tx_descriptor *dma_desc = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct dma_slave_config dma_conf = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_conf.direction = DMA_DEV_TO_MEM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_conf.src_addr = aicspi-&gt;dma_addr_rx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_conf.src_addr_width = DMA_SLAVE_BUSWIDTH_1_BYTE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_conf.dst_addr_width = DMA_SLAVE_BUSWIDTH_1_BYTE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_conf.src_maxburst = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_conf.dst_maxburst = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dmaengine_slave_config(aicspi-&gt;dma_rx, &amp;dma_conf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_desc = dmaengine_prep_slave_sg(aicspi-&gt;dma_rx, t-&gt;rx_sg.sgl,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       t-&gt;rx_sg.nents, dma_conf.direction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       DMA_PREP_INTERRUPT | DMA_CTRL_ACK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!dma_desc) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dev_err(aicspi-&gt;dev, &quot;spi-%d prepare slave sg failed.\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            aicspi-&gt;ctlr-&gt;bus_num);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -EINVAL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_desc-&gt;callback = aic_spi_dma_cb_rx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_desc-&gt;callback_param = (void *)aicspi;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dmaengine_submit(dma_desc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="563-启动-dma-数据传输">5.6.3. 启动 DMA 数据传输<a href="#563-启动-dma-数据传输" class="hash-link" aria-label="Direct link to 5.6.3. 启动 DMA 数据传输" title="Direct link to 5.6.3. 启动 DMA 数据传输">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static int aic_spi_dma_rx_start(struct spi_device *spi, struct spi_transfer *t)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_spi *aicspi = spi_controller_get_devdata(spi-&gt;master);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spi_ctlr_dma_rx_enable(aicspi-&gt;base_addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = aic_spi_dma_rx_cfg(aicspi, t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_async_issue_pending(aicspi-&gt;dma_rx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-常见问题">6. 常见问题<a href="#6-常见问题" class="hash-link" aria-label="Direct link to 6. 常见问题" title="Direct link to 6. 常见问题">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-dmatest-时verify数据报错">6.1. dmatest 时verify数据报错<a href="#61-dmatest-时verify数据报错" class="hash-link" aria-label="Direct link to 6.1. dmatest 时verify数据报错" title="Direct link to 6.1. dmatest 时verify数据报错">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="611-现象">6.1.1. 现象<a href="#611-现象" class="hash-link" aria-label="Direct link to 6.1.1. 现象" title="Direct link to 6.1.1. 现象">​</a></h4>
<p>当运行dmatest测试时，错误log类似如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[  381.878419] dmatest: dma0chan5-copy0: dstbuf[0x3f70] mismatch! Expected cf, got d7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  381.885999] dmatest: dma0chan5-copy0: dstbuf[0x3f71] mismatch! Expected ce, got d6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  381.893611] dmatest: dma0chan5-copy0: dstbuf[0x3f72] mismatch! Expected cd, got d5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  381.901199] dmatest: dma0chan5-copy0: dstbuf[0x3f73] mismatch! Expected cc, got d4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  381.908783] dmatest: dma0chan5-copy0: dstbuf[0x3f74] mismatch! Expected cb, got d3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  381.916350] dmatest: dma0chan5-copy0: dstbuf[0x3f75] mismatch! Expected ca, got d2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="612-原因分析">6.1.2. 原因分析<a href="#612-原因分析" class="hash-link" aria-label="Direct link to 6.1.2. 原因分析" title="Direct link to 6.1.2. 原因分析">​</a></h4>
<p>dmatest的默认配置是需要verify测试数据的。</p>
<p>当进行多通道（max_channels&gt;1）测试时，必须要使能polled属性，以保证通道的测试过程是串行的，否则会报verify错误。</p>
<p>设置polled属性的方法见 [dmatest 测试]</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part3/04-3_DMABook.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/D213-DevKit/part3/04-2_CMUUserGuide"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">CMU 使用指南</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/D213-DevKit/part3/04-4_RTCUserGuide"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">RTC 使用指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-模块介绍" class="table-of-contents__link toc-highlight">1. 模块介绍</a><ul><li><a href="#11-术语定义" class="table-of-contents__link toc-highlight">1.1. 术语定义</a></li><li><a href="#12-模块简介" class="table-of-contents__link toc-highlight">1.2. 模块简介</a></li></ul></li><li><a href="#2-参数配置" class="table-of-contents__link toc-highlight">2. 参数配置</a><ul><li><a href="#21-内核配置" class="table-of-contents__link toc-highlight">2.1. 内核配置</a></li><li><a href="#22-dts-参数配置" class="table-of-contents__link toc-highlight">2.2. DTS 参数配置</a></li></ul></li><li><a href="#3-调试指南" class="table-of-contents__link toc-highlight">3. 调试指南</a><ul><li><a href="#31-调试开关" class="table-of-contents__link toc-highlight">3.1. 调试开关</a></li></ul></li><li><a href="#4-测试指南" class="table-of-contents__link toc-highlight">4. 测试指南</a><ul><li><a href="#41-测试环境" class="table-of-contents__link toc-highlight">4.1. 测试环境</a></li><li><a href="#42-dmatest-测试" class="table-of-contents__link toc-highlight">4.2. dmatest 测试</a></li></ul></li><li><a href="#5-设计说明" class="table-of-contents__link toc-highlight">5. 设计说明</a><ul><li><a href="#51-源码说明" class="table-of-contents__link toc-highlight">5.1. 源码说明</a></li><li><a href="#52-模块架构" class="table-of-contents__link toc-highlight">5.2. 模块架构</a></li><li><a href="#53-关键流程设计" class="table-of-contents__link toc-highlight">5.3. 关键流程设计</a></li><li><a href="#54-数据结构设计" class="table-of-contents__link toc-highlight">5.4. 数据结构设计</a></li><li><a href="#55-接口设计" class="table-of-contents__link toc-highlight">5.5. 接口设计</a></li><li><a href="#56-demo" class="table-of-contents__link toc-highlight">5.6. Demo</a></li></ul></li><li><a href="#6-常见问题" class="table-of-contents__link toc-highlight">6. 常见问题</a><ul><li><a href="#61-dmatest-时verify数据报错" class="table-of-contents__link toc-highlight">6.1. dmatest 时verify数据报错</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>