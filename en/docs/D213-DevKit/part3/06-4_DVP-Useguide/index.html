<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-D213-DevKit/part3/06-4_DVP-Useguide" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">DVP开发指南 | 东山Π</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://artinchip.100ask.net/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://artinchip.100ask.net/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://artinchip.100ask.net/en/docs/D213-DevKit/part3/06-4_DVP-Useguide"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="DVP开发指南 | 东山Π"><meta data-rh="true" name="description" content="模块介绍"><meta data-rh="true" property="og:description" content="模块介绍"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part3/06-4_DVP-Useguide"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part3/06-4_DVP-Useguide" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part3/06-4_DVP-Useguide" hreflang="en"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part3/06-4_DVP-Useguide" hreflang="x-default"><link rel="stylesheet" href="/en/assets/css/styles.d875fe7e.css">
<script src="/en/assets/js/runtime~main.492f0d3e.js" defer="defer"></script>
<script src="/en/assets/js/main.d02687fe.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/en/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">东山Π</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/D213-DevKit/BoardIntroduction">D213-DevKit</a><a class="navbar__item navbar__link" href="/en/docs/category/luban-sdk使用指南">Luban-SDK</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/D213-DevKit/part3/06-4_DVP-Useguide" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">简体中文</a></li><li><a href="/en/docs/D213-DevKit/part3/06-4_DVP-Useguide" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/ArtInChip-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/BoardIntroduction">匠心创D213-DevKit开发板</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/SupportingResources">源码工具文档手册</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/快速启动">快速启动</a><button aria-label="Expand sidebar category &#x27;快速启动&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/ConfigHostEnv">安装并配置开发环境</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/luban-sdk开发">Luban-SDK开发</a><button aria-label="Expand sidebar category &#x27;Luban-SDK开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/luban-linux系统开发">Luban-Linux系统开发</a><button aria-label="Collapse sidebar category &#x27;Luban-Linux系统开发&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-1_BWMUserGuide">BWM 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-2_CMUUserGuide">CMU 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-3_DMABook">DMA 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-4_RTCUserGuide">RTC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-5_TSensorUserGuide">TSensor 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-6_WatchdogUserGuide">Watchdog 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/04-7_WRIUserGuide">WRI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-1_SDMCUserGuide">SDMC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-2_SPI_NANDUserGuide">SPI NAND 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-3_SPI_NORUserGuide">SPI NOR 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/05-4_FileSystemUserGuide">文件系统使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-1_GE-Useguide">GE 开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-2_VE-Useguide">VE 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-3_Display-Useguide">Display 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/D213-DevKit/part3/06-4_DVP-Useguide">DVP开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-8_I2S-Useguide">I2S 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/06-9_AudioCodec-Useguide">AudioCodec 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-1_CAN-Useguide">CAN 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-2_ CIR-Useguide">CIR 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-3_ GPAI-Useguide">GPAI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-4_I2C-Useguide">I2C 开发指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-5_MAC-Useguide">MAC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-6_PBus-Useguide">PBus 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-7_PINCTRL-Useguide">PINCTRL 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-8_PWM-Useguide">PWM 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-9_RTP-Useguide">RTP 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-10_SPI-Useguide">SPI 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-11_UART-Useguide">UART 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-12_USB-Useguide">USB 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/07-13_PSADC-Useguide">PSADC 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-1_SPI-ENC">SPI ENC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-2_CE-Useguide">CE 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-3_eFuse-Useguide">eFuse 使用指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/08-4_HardwareAuthorizationCertification">硬件授权认证</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-1_TouchscreenDebuggingGuide">触摸屏调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-2_DisplayDebuggingGuide">显示屏调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-3_WiFiDebuggingGuide">WiFi调试指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part3/10-4_GuideToUsingTheKeyMatrix">按键矩阵使用指南</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux-bringup参考">Linux-Bringup参考</a><button aria-label="Expand sidebar category &#x27;Linux-Bringup参考&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux-uboot开发">Linux-Uboot开发</a><button aria-label="Expand sidebar category &#x27;Linux-Uboot开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/luban-linux系统开发"><span itemprop="name">Luban-Linux系统开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">DVP开发指南</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>DVP开发指南</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="模块介绍">模块介绍<a href="#模块介绍" class="hash-link" aria-label="Direct link to 模块介绍" title="Direct link to 模块介绍">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-术语定义">1.1. 术语定义<a href="#11-术语定义" class="hash-link" aria-label="Direct link to 1.1. 术语定义" title="Direct link to 1.1. 术语定义">​</a></h3>
<table><thead><tr><th>术语</th><th>定义</th><th>注释说明</th></tr></thead><tbody><tr><td>CMA</td><td>Contiguous Memory Allocator</td><td>连续内存分配器</td></tr><tr><td>DVP</td><td>Digital Video Port</td><td>用于接收视频数据数据，转换格式后存放到内存中</td></tr><tr><td>V4L2</td><td>Video For Linux Two</td><td>Linux中的视频框架第二版</td></tr><tr><td>VBI</td><td>Vertical Blanking Interval</td><td>垂直消隐期</td></tr><tr><td>ISP</td><td>Image Signal Processing</td><td>图像信号处理，一般指对前端图像传感器输出信号的处理</td></tr><tr><td>MBUS</td><td>Media Bus</td><td>V4L2框架中用到的一种媒体类型，用于两个V4L2设备之间的协商</td></tr><tr><td>Sensor</td><td>即Camera</td><td>本文中指摄像头</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-模块简介">1.2. 模块简介<a href="#12-模块简介" class="hash-link" aria-label="Direct link to 1.2. 模块简介" title="Direct link to 1.2. 模块简介">​</a></h3>
<p>DVP模块负责从Sensor中获取到数据，然后经过格式转换、或者缩放，输出到DRAM。支持特性：</p>
<ul>
<li>最大支持 1080P@30帧 录像</li>
<li>支持 5M 拍照</li>
<li>支持 YUV422 和 BT.656 两种方式，BT.656支持隔行模式，最大支持8位输入</li>
<li>支持针对图像帧中的行和列分别做裁剪</li>
</ul>
<p>DVP的硬件框图：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/hw_structure5-17066896093681.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/hw_structure5.png" class="img_ev3q"></p>
<p>图 6.23 <em>DVP硬件架构示意图</em></p>
<p>从整个系统看，有两种应用场景：</p>
<ol>
<li>从Sensor采集数据到内存中，然后让DE将其显示到屏幕上；</li>
<li>从Sensor采集数据到内存中，使用CPU或者VE进行编码，最后再将编码后的数据保存到内存中。</li>
</ol>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/hw_data_flow1-17066896177463.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/hw_data_flow1.jpg" class="img_ev3q"></p>
<p>图 6.24 <em>DVP应用的数据流示意图</em></p>
<p>DVP驱动设计需要基于Linux中的成熟框架V4L2，详细介绍见 <a href="/en/docs/D213-DevKit/part3/5_design_guide.html">设计说明</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-参数配置">2. 参数配置<a href="#2-参数配置" class="hash-link" aria-label="Direct link to 2. 参数配置" title="Direct link to 2. 参数配置">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-内核配置">2.1. 内核配置<a href="#21-内核配置" class="hash-link" aria-label="Direct link to 2.1. 内核配置" title="Direct link to 2.1. 内核配置">​</a></h3>
<p>DVP驱动依赖dma-buf、CMA、V4L2模块，所以需要提前打开。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="211-打开-cma">2.1.1. 打开 CMA<a href="#211-打开-cma" class="hash-link" aria-label="Direct link to 2.1.1. 打开 CMA" title="Direct link to 2.1.1. 打开 CMA">​</a></h4>
<p>在luban根目录下执行 make kernel-menuconfig，进入kernel的功能配置，按如下选择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Memory Management options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         [*] Contiguous Memory Allocator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>还需要设置CMA区域的大小，在内核配置的另外一个地方，如下配置为 16MB：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Library routines</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [*] DMA Contiguous Memory Allocator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (16)  Size in Mega Bytes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="212-打开-dma-buf">2.1.2. 打开 dma-buf<a href="#212-打开-dma-buf" class="hash-link" aria-label="Direct link to 2.1.2. 打开 dma-buf" title="Direct link to 2.1.2. 打开 dma-buf">​</a></h4>
<p>在luban根目录下执行 make kernel-menuconfig，进入kernel的功能配置，按如下选择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Device Drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DMABUF options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*] Explicit Synchronization Framework</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*]   Sync File Validation Framework</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*] userspace dmabuf misc driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*] DMA-BUF Userland Memory Heaps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                [*]   DMA-BUF CMA Heap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="213-打开-v4l2">2.1.3. 打开 V4L2<a href="#213-打开-v4l2" class="hash-link" aria-label="Direct link to 2.1.3. 打开 V4L2" title="Direct link to 2.1.3. 打开 V4L2">​</a></h4>
<p>在 kernel 的 menuconfig 中，按如下选  择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Device Drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Multimedia support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Media core support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;*&gt; Video4Linux core</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>打开 V4L2 的相关选项：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Device Drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Multimedia support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Video4Linux options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                [*] V4L2 sub-device userspace API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                [*] Enable advanced debug functionality on V4L2 drivers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="214-打开-dvp">2.1.4. 打开 DVP<a href="#214-打开-dvp" class="hash-link" aria-label="Direct link to 2.1.4. 打开 DVP" title="Direct link to 2.1.4. 打开 DVP">​</a></h4>
<p>在 kernel 的 menuconfig 中，按如下选择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Device Drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Multimedia support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Media drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                [*] V4L platform devices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;*&gt;   Artinchip Digital Video Port Support</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-dts-参数配置">2.2. DTS 参数配置<a href="#22-dts-参数配置" class="hash-link" aria-label="Direct link to 2.2. DTS 参数配置" title="Direct link to 2.2. DTS 参数配置">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="221-d211-配置">2.2.1. D211 配置<a href="#221-d211-配置" class="hash-link" aria-label="Direct link to 2.2.1. D211 配置" title="Direct link to 2.2.1. D211 配置">​</a></h4>
<p>DTS分别存放在两个目录：common/和board/，board中存放sensor配置、以及和DVP关联的配置。</p>
<p>common/d211.dtsi中的参数配置：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dvp0: dvp@18830000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #address-cells = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #size-cells = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compatible = &quot;artinchip,aic-dvp-v1.0&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reg = &lt;0x0 0x18830000 0x0 0x1000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interrupts-extended = &lt;&amp;plic0 57 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clocks = &lt;&amp;cmu CLK_DVP&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clock-rate = &lt;200000000&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resets = &lt;&amp;rst RESET_DVP&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>xxx/board.dts中的配置参数：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&amp;dvp0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-names = &quot;default&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-0 = &lt;&amp;dvp_pins&gt;;        /* dvp 接口引脚 */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port@0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reg = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dvp0_in: endpoint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            remote-endpoint = &lt;&amp;ov5640_out&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*          bus-type = &lt;6&gt;; /* V4L2_FWNODE_BUS_TYPE_BT656 */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bus-width = &lt;8&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hsync-active = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vsync-active = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            field-even-active = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pclk-sample = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>小技巧</p>
<p>DVP驱动支持标准的 V4L2参数，如上面的 bus-type、bus-type、hsync-active 等，更完整的参数定义可以见Linux中的代码 drivers/media/v4l2-core/v4l2-fwnode.c，v4l2_fwnode_endpoint_parse_parallel_bus()。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-调试指南">3. 调试指南<a href="#3-调试指南" class="hash-link" aria-label="Direct link to 3. 调试指南" title="Direct link to 3. 调试指南">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-调试开关">3.1. 调试开关<a href="#31-调试开关" class="hash-link" aria-label="Direct link to 3.1. 调试开关" title="Direct link to 3.1. 调试开关">​</a></h3>
<p>在luban根目录下执行 make kernel-menuconfig，进入kernel的功能配置，可以打开DVP模块的DEBUG选项：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Kernel hacking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Artinchip Debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [*] DVP driver debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此DEBUG选项打开的影响：</p>
<ol>
<li>DVP驱动以-O0编译</li>
<li>DVP的pr_dbg()和dev_dbg()调试信息会被编译</li>
</ol>
<p>在系统运行时，如果要打印pr_dbg()和dev_dbg()信息，还需要调整loglevel为8，两个方法：</p>
<ol>
<li>在board.dts中修改bootargs，增加“loglevel=8”</li>
<li>在板子启动到Linux shell后，执行命令：</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo 8 &gt; /proc/sys/kernel/printk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-sysfs-节点">3.2. Sysfs 节点<a href="#32-sysfs-节点" class="hash-link" aria-label="Direct link to 3.2. Sysfs 节点" title="Direct link to 3.2. Sysfs 节点">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="321-查看v4l2设备">3.2.1. 查看V4L2设备<a href="#321-查看v4l2设备" class="hash-link" aria-label="Direct link to 3.2.1. 查看V4L2设备" title="Direct link to 3.2.1. 查看V4L2设备">​</a></h4>
<p>在 Sysfs 中查看video设备的信息：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ls /dev/video0 -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crw-------    1 root     root       81,   0 Jan  1  1970 /dev/video0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ls /sys/class/video4linux/v4l-subdev0/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dev        dev_debug  device     index      name       subsystem  uevent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/class/video4linux/v4l-subdev0/name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ov5640 3-003c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/class/video4linux/v4l-subdev1/name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aic-dvp-sd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ls -l /sys/class/video4linux/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 root     root             0 Jan  1 00:12 v4l-subdev0 -&gt; ../../devices/platform/soc/99223000.i2c/i2c-3/3-003c/video4linux/v4l-subdev0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 root     root             0 Jan  1 00:12 v4l-subdev1 -&gt; ../../devices/platform/soc/98830000.dvp/video4linux/v4l-subdev1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx    1 root     root             0 Jan  1 00:12 video0 -&gt; ../../devices/platform/soc/98830000.dvp/video4linux/video0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="322-打开v4l2的debug开关">3.2.2. 打开V4L2的debug开关<a href="#322-打开v4l2的debug开关" class="hash-link" aria-label="Direct link to 3.2.2. 打开V4L2的debug开关" title="Direct link to 3.2.2. 打开V4L2的debug开关">​</a></h4>
<p>在V4L2子系统中，用dprintk(level)接口来控制调试信息，大于代码中的dprintk(level)调用时的level就可以打印出信息。dprintk()一般用到两个debug level：</p>
<table><thead><tr><th>1</th><th>显示ioctl名称</th></tr></thead><tbody><tr><td>2</td><td>显示API的传入参数</td></tr></tbody></table>
<p>向对应的Sysfs节点写入一个整数值，可以修改该debug level：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo 0x3 &gt; /sys/module/videobuf2_v4l2/parameters/debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo 0x3 &gt; /sys/module/videobuf2_common/parameters/debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo 0x3 &gt; /sys/devices/platform/soc/18830000.dvp/video4linux/v4l-subdev1/dev_debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo 0x3 &gt; /sys/devices/platform/soc/18830000.dvp/video4linux/video0/dev_debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="323-查看-dvp-的-buf-队列情况">3.2.3. 查看 DVP 的 Buf 队列情况<a href="#323-查看-dvp-的-buf-队列情况" class="hash-link" aria-label="Direct link to 3.2.3. 查看 DVP 的 Buf 队列情况" title="Direct link to 3.2.3. 查看 DVP 的 Buf 队列情况">​</a></h4>
<p>DVP驱动中实现了一个sysfs节点buflist，查看当前三个Qbuf、DQbuf、DVP驱动中的buf list状态：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># cat /sys/devices/platform/soc/18830000.dvp/buflist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In dvp-&gt;buf_list, the current buf in list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0]: empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1]: empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2]: empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In V4L2 Q-buf list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0]: empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1]: empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2]: empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In V4L2 DQ-buf list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0], state: Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1], state: Done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2], state: Done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-v4l2-相关的其他工具">3.3. V4L2 相关的其他工具<a href="#33-v4l2-相关的其他工具" class="hash-link" aria-label="Direct link to 3.3. V4L2 相关的其他工具" title="Direct link to 3.3. V4L2 相关的其他工具">​</a></h3>
<ul>
<li>V4l2-ctl，v4l2的瑞士军刀</li>
<li>V4l2兼容性测试</li>
<li>V4l2-dbg，</li>
<li>qv4l2，QT测试程序</li>
</ul>
<p>小技巧</p>
<p>TODO：以上工具的使用方法待验证和整理</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-测试指南">4. 测试指南<a href="#4-测试指南" class="hash-link" aria-label="Direct link to 4. 测试指南" title="Direct link to 4. 测试指南">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-测试环境">4.1. 测试环境<a href="#41-测试环境" class="hash-link" aria-label="Direct link to 4.1. 测试环境" title="Direct link to 4.1. 测试环境">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="411-硬件">4.1.1. 硬件<a href="#411-硬件" class="hash-link" aria-label="Direct link to 4.1.1. 硬件" title="Direct link to 4.1.1. 硬件">​</a></h4>
<ul>
<li>开发板，或者D211的FPGA板</li>
<li>可转接摄像头的子板</li>
<li>摄像头，如OV5640</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="412-软件">4.1.2. 软件<a href="#412-软件" class="hash-link" aria-label="Direct link to 4.1.2. 软件" title="Direct link to 4.1.2. 软件">​</a></h4>
<ul>
<li>PC端的串口终端软件，用于PC和开发板进行串口通信</li>
<li>DVP模块的测试demo：test_dvp</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="413-软件配置">4.1.3. 软件配置<a href="#413-软件配置" class="hash-link" aria-label="Direct link to 4.1.3. 软件配置" title="Direct link to 4.1.3. 软件配置">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="4131-配置-ov5640-摄像头">4.1.3.1. 配置 OV5640 摄像头<a href="#4131-配置-ov5640-摄像头" class="hash-link" aria-label="Direct link to 4.1.3.1. 配置 OV5640 摄像头" title="Direct link to 4.1.3.1. 配置 OV5640 摄像头">​</a></h5>
<p>测试中需要用到摄像头，以OV5640为例，在luban的根目录下通过make kernel-menuconfig，按如下选择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Device Drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Multimedia support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Media ancillary drivers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Camera sensor devices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;*&gt; OmniVision OV5640 sensor support</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在board.dts中，也需要增加OV5640的配置，假设OV5640是接在I2C3通道：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&amp;i2c3 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-names = &quot;default&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pinctrl-0 = &lt;&amp;i2c3_pins_a&gt;,  &lt;&amp;clk_out1_pins&gt;;          /* i2c3 引脚及 clock 引脚 */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status = &quot;okay&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ov5640: camera@3C {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        compatible = &quot;ovti,ov5640&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reg = &lt;0x3C&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clocks = &lt;&amp;cmu CLK_APB1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clock-names = &quot;xclk&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reset-gpios = &lt;&amp;gpio_p 5 GPIO_ACTIVE_LOW&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        powerdown-gpios = &lt;&amp;gpio_p 6 GPIO_ACTIVE_HIGH&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ov5640_out: endpoint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                remote-endpoint = &lt;&amp;dvp0_in&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /* V4L2_FWNODE_BUS_TYPE_BT656</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bus-type = &lt;6&gt;; */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bus-width = &lt;8&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                data-shift = &lt;2&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hsync-active = &lt;0&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                vsync-active = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pclk-sample = &lt;1&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注解</p>
<ol>
<li>如果要使用BT656模式，请打开bus-type参数；</li>
<li>如果是YUV422，不需要配置bus-type，代码中默认采用YUV422（即V4L2_FWNODE_BUS_TYPE_PARALLEL，定义在drivers/media/v4l2-core/v4l2-fwnode.c）。</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="4132-test_dvp-配置">4.1.3.2. test_dvp 配置<a href="#4132-test_dvp-配置" class="hash-link" aria-label="Direct link to 4.1.3.2. test_dvp 配置" title="Direct link to 4.1.3.2. test_dvp 配置">​</a></h5>
<p>在luban根目录，运行make menuconfig，按如下选择：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Artinchip packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Sample code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [*] test-dvp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-test_dvp-测试">4.2. test_dvp 测试<a href="#42-test_dvp-测试" class="hash-link" aria-label="Direct link to 4.2. test_dvp 测试" title="Direct link to 4.2. test_dvp 测试">​</a></h3>
<p>test_dvp的主要功能是将摄像头的数据采集后，传给DE模块的Video图层去显示。其设计详见 <a href="/en/docs/D213-DevKit/part3/5_design_guide.html#ref-dvp-demo">APP Demo</a></p>
<p>在打开test_dvp的编译后，板子上的test_dvp位于 <code>/usr/local/bin/</code>，无需进入该目录，直接运行test_dvp即可：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[aic@] # test_dvp -u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage: test_dvp [options]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -f, --format       format of input video, NV12/NV16 etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -c, --count        the number of capture frame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -w, --width        the width of sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -h, --height       the height of sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -r, --framerate    the framerate of sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -u, --usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -v, --verbose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Example: test_dvp -f nv16 -c 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用示例：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置摄像头的分辨率为 720*576，帧率为15帧/s，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用 NV12 格式（默认）输出到 Video Layer 显示，共采集并显示100帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[aic@] # test_dvp -w 720 -h 576 -r 15 -c 100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-设计说明">5. 设计说明<a href="#5-设计说明" class="hash-link" aria-label="Direct link to 5. 设计说明" title="Direct link to 5. 设计说明">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-源码说明">5.1. 源码说明<a href="#51-源码说明" class="hash-link" aria-label="Direct link to 5.1. 源码说明" title="Direct link to 5.1. 源码说明">​</a></h3>
<p>本模块源代码在内核目录linux-5.4/drivers/media/platform/artinchip下，目录结构如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">drivers/media/platform/artinchip/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── aic_buf.c  // 和buf管理相关的处理代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── aic_dvp.c  // DVP驱动的初始化入口，主要实现了probe、Notifier接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── aic_dvp.h  // DVP 驱动共用的头文件，其中定义了寄存器、共用数据结构、全局函数等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── aic_dvp_hw.c  // 对寄存器的访问封装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── aic_video.c // 和V4L2框架强相关的一些接口定义，如file_ops、ioctl_ops的接口实现等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Kconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── Makefile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-模块架构">5.2. 模块架构<a href="#52-模块架构" class="hash-link" aria-label="Direct link to 5.2. 模块架构" title="Direct link to 5.2. 模块架构">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="521-v4l2-软件框架">5.2.1. V4L2 软件框架<a href="#521-v4l2-软件框架" class="hash-link" aria-label="Direct link to 5.2.1. V4L2 软件框架" title="Direct link to 5.2.1. V4L2 软件框架">​</a></h4>
<p>Linux中的V4L2框架是一个专门为视频输入输出设备而设计的成熟方案，DVP驱动需要基于V4L2。</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_system-17066903681595.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_system.jpg" class="img_ev3q"></p>
<p>图 6.25 <em>Linux V4L2子系统架构图</em></p>
<ol>
<li>V4L2，Video For Linux 第2版，最早出现在1998年，一个针对无线广播（收音机）、视频捕获、视频输出设备的通用框架，源码目录drivers/media/v4l2-core。V4L2中支持的5大类接口设备：</li>
</ol>
<blockquote>
<ul>
<li>Video capture interface：影像捕获接口；</li>
<li>Video output interface：视频输出接口，主要用于电视信号类；</li>
<li>Video overlay interface：视频覆盖接口，方便视频显示设备直接从捕获设备上获取数据；</li>
<li>VBI interface：垂直消隐接口，可提供垂直消隐区的数据接入，包括raw和sliced两种；</li>
<li>Radio interface：广播接口，主要是从AM或FM调谐器中获取音频数据。</li>
</ul>
</blockquote>
<ol>
<li>
<p>V4L2为用户空间提供了字符设备的通用接口，设备节点/dev/videoX，主设备号81，次设备号的分配跟设备类型有关，规则定义如下：</p>
<blockquote>
<table><thead><tr><th>设备类型</th><th>次设备号</th></tr></thead><tbody><tr><td>视频设备</td><td>0~63</td></tr><tr><td>Radio设备</td><td>64~127</td></tr><tr><td>Teletext设备</td><td>192~233</td></tr><tr><td>VBI设备</td><td>224~255</td></tr></tbody></table>
</blockquote>
</li>
</ol>
<blockquote>
<p>用户态APP通过ioctl控制video设备，通过mmap进行内存映射。在/dev目录中会产生videoX、radioX和vbiX设备节点。</p>
</blockquote>
<ol>
<li>在V4L2框架中，将每一个Sensor、DVP硬件设备都看作一个subdev，相应的有一个字符设备节点/dev/v4l-subdevX，用户态通过这些节点的ioctl接口可以完成subdev的格式协商、时序配置等功能。</li>
<li>Notifier子模块是为了解决多个设备之间的初始化顺序、以及媒体流对接的匹配检查，如DVP需要等Sensor初始化完成后，才能去真正完成video device的注册。可见，DVP和Sensor要有一个绑定的  关系，这个关系是由DTS中的remote-endpoint来指定的。Notifier会调用Fwnode系列接口来解析和获取remote-endpoint的属性字段。</li>
<li>为了进行数据流的管理，V4l2维护了一个Media device链表，每一个video device、v4l2 device、v4l2-subdev都是一个Media device实例，这些Media device在数据结构的设计上第一个成员变量都是一个struct media_entity，其中有list_head成员，借此互相链接起来。见下一节详述。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="522-v4l2-的实例管理">5.2.2. V4L2 的实例管理<a href="#522-v4l2-的实例管理" class="hash-link" aria-label="Direct link to 5.2.2. V4L2 的实例管理" title="Direct link to 5.2.2. V4L2 的实例管理">​</a></h4>
<p>一个完整的V4L2驱动涉及4种设备实例：V4l2 device、Video device、V4l2 subdev、Media device，这4个实例都需要在DVP驱动中去定义。它们的引用关系如下图：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_instance-17066903914407.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_instance.jpg" class="img_ev3q"></p>
<p>图 6.26 <em>Linux V4L2的实例关系示意图</em></p>
<ul>
<li>
<ul>
<li>
<p>V4l2 device</p>
<p>可以理解为最高统帅，它纵览全局，用成员指针指向以下其他实例，只服务于内核态，不包含面向用户态的接口。 <strong>整个内核中只有一个v4l2 device实例。</strong></p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>V4l2 subdev</p>
<p>V4L2将每一个硬件模块都看作一个subdev，如DVP、Sensor都各自注册一个subdev，并且每个subdev会向用户态透出一个/dev/v4l-subdevX设备节点（该设备节点的编号X取决于注册顺序）。这些subdev会形成一个链表，都挂在v4l2 device下面的subdevs链表中。在subdev的ops数据接口v4l2_subdev_ops将回调按设备类型进行划分（这里区分设备类型）</p>
</li>
</ul>
</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct v4l2_subdev_ops {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_core_ops   *core;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_tuner_ops  *tuner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_audio_ops  *audio;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_video_ops  *video;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_vbi_ops    *vbi;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_ir_ops     *ir;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_sensor_ops *sensor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const struct v4l2_subdev_pad_ops    *pad;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于DVP控制器来说，它对应的ops只提供pad_ops即可；对于Sensor设备来说，要提供pad_ops和video_ops。</p>
<ul>
<li>
<ul>
<li>
<p>Video device</p>
<p>是给用户态提供/dev/videoX接口的设备实例，这里不区分设备类型，统一使用V4L2标准的80+个ioctl命令接口。video device更像是逻辑功能，如果未来我们的DVP增加了ISP功能，就需要注册两个video device，但是DVP对应的subdev只需要一个。</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>Media device</p>
<p>主要作用是为了将有上下游关系的entity串联起来（通过连接各entity的pad或interface属性），形成一个媒体流（V4L2启动/停止命令称作start/stop stream）。并且会透出一个/dev/mediaX设备节点，目前用户态还没有用到，所以在上图中未体现。</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>Media entity</p>
<p>以上实例除了最高统帅V4l2 device其他都可以看作一个media entity，都挂在Media device维护的一个media entity链表。</p>
</li>
</ul>
</li>
</ul>
<p>实际上，在上图中的每个subdev，注册的时候也是生成一个Video device，由Video device向用户态透一个/dev/v4l-subdevX设备过去，这样做的好处是由Video device统一处理对接用户态的接口。所以完整的实例关系图应该再加一层Video device，如下图：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_instance_full-17066904017719.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_instance_full.jpg" class="img_ev3q"></p>
<p>图 6.27 <em>Linux V4L2的完整实例关系示意图</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="523-v4l2-的-media-管理">5.2.3. V4L2 的 Media 管理<a href="#523-v4l2-的-media-管理" class="hash-link" aria-label="Direct link to 5.2.3. V4L2 的 Media 管理" title="Direct link to 5.2.3. V4L2 的 Media 管理">​</a></h4>
<p>V4L2提供了一个Media Framework来管理Media数据组成pipeline，在运行过程中可以调整pipeline中各个节点的配置，达到“运行时设备控制”的效果。</p>
<p>需要用到5个关键数据结构：media_device、media_entity、media_link、media_pad、media interface。</p>
<ul>
<li>Media device是框架管理者，下面维护4个链表：entity、pad、link、interface。</li>
<li>将每个硬件设备、或者一个软件模块抽象成一个entity，如DVP控制器、Sensor、DMA通道、连接器</li>
<li>Entity之间通过link来连接，link的两端是pad。数据流是从一个source pad（源）到一个sink pad（目的/接收端）。Pad：硬件设备上的端口抽象，类似于芯片上面的管脚pad概念。</li>
</ul>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_pad-170669041625911.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_pad.png" class="img_ev3q"></p>
<p>图 6.28 <em>Linux V4L2的pad和link关系示意图</em></p>
<ul>
<li>另外还有一个media_interface结构，表示提供给用户态什么接口，目前只有一种类型：device node</li>
<li>link有两种：pad to pad、Interface to entity（暂未用到）。从media_link的定义看它们的连接关系：</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct media_link {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct media_gobj graph_obj; // 是对entity、pad、link、Interface的抽象，它们的公共头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct list_head list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct media_gobj *gobj0; // 是pad和Interface头部的公共数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct media_pad *source; // 源pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct media_interface *intf; // 需要连接到entity的interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct media_gobj *gobj1; // 同上，是pad和entity头部的公共数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct media_pad *sink; // 目的pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct media_entity *entity; // 需要连接到Interface的entity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct media_link *reverse; // 指向对称（两端pad相同方向相反）的那个media_link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unsigned long flags;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool is_backlink; // 是否逆方向（相对于数据流方向）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>从数据结构定义来看一个entity，可以有多个pad（注意其中的pads成员是个指针，指向的实例需要DVP驱动先定义好），当然随之而来会有多个link，定义如下：</li>
</ul>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_media_entity-170669042542213.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_media_entity.jpg" class="img_ev3q"></p>
<p>图 6.29 <em>Linux V4L2的Media entity和pad的引用关系</em></p>
<p>结合我们的DVP硬件结构，media entity、pad和link的关系如下：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_media_entity-170669043699817.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_media_entity.png" class="img_ev3q"></p>
<p>图 6.30 <em>DVP驱动中的Media entity设计</em></p>
<p>从上图中可以看到，如果要设置DVP的 <strong>输入</strong> 格式，就通过DVP subdev；如果要设置DVP的 <strong>输出</strong> 格式，则通过Video device。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="524-v4l2-的-ioctl-调用关系">5.2.4. V4L2 的 ioctl 调用关系<a href="#524-v4l2-的-ioctl-调用关系" class="hash-link" aria-label="Direct link to 5.2.4. V4L2 的 ioctl 调用关系" title="Direct link to 5.2.4. V4L2 的 ioctl 调用关系">​</a></h4>
<p>在“实例管理”中已经知道，用户态看到的/dev/videoX和 /dev/v4l-subdevX两个设备节点，进入内核态后都是直接先跟Video device设备实例对接，那么当用户调用ioctl命令时，是如何传给下面V4L2 subdev呢？依靠注册时传入的参数struct v4l2_file_operations *fops。</p>
<ul>
<li>V4L2 subdev在为自己注册Video device时（见v4l2-device.c中的v4l2_device_register_subdev_nodes()）传入的fops是预定义好的v4l2_subdev_fops（定义见v4l2-subdev.c），其中的ioctl接口指向框架中提供的接口subdev_ioctl()。而subdev_ioctl会逐层调用到“实例管理”中提到的 v4l2_subdev_ops。</li>
<li>而DVP驱动在为自己注册Video device时，传入的fops是自己定义的aic_dvp_fops，其中ioctl接口指向框架中的公共接口video_ioctl2()。</li>
<li>为解决不同硬件设备有不同的ioctl处理需求，DVP驱动还需要另外提供一个专门为ioctl定义的扩展ops：aic_dvp_ioctl_ops（数据结构定义见struct v4l2_ioctl_ops）。</li>
</ul>
<p>针对一个从用户态传来的ioctl()命令，其内部调用关系如下图：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_ioctl-170669045034119.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_ioctl.jpg" class="img_ev3q"></p>
<p>图 6.31 <em>Linux V4L2的ioctl处理关系图</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="525-v4l2-的-buf-队列管理">5.2.5. V4L2 的 Buf 队列管理<a href="#525-v4l2-的-buf-队列管理" class="hash-link" aria-label="Direct link to 5.2.5. V4L2 的 Buf 队列管理" title="Direct link to 5.2.5. V4L2 的 Buf 队列管理">​</a></h4>
<p>V4L2的Buffer管理由videobuf子模块实现，从源头看分为两种方式的Buffer：</p>
<ol>
<li>
<ul>
<li>
<p>驱动申请Buffer</p>
<p>用户态通过VIDIOC_REQBUFS ioctl命令触发Buffer申请，然后使用mmap接口来获取用户态的Buffer地址。这种方式，Buffer个数一般有个最大值32 VIDEO_MAX_FRAME。</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>用户态申请Buffer</p>
<p>用户态根据实际需要知道要申请多少Buffer，然后借助其他机制（可以是dma-buf）在用户态完成Buffer（当然必须是物理连续的）申请，并将物理地址告诉Video驱动。</p>
</li>
</ul>
</li>
</ol>
<p>按照Buffer的物理连续，又可以分为三种情况：（详见Documentationmediakapiv4l2-videobuf.rst）</p>
<ol>
<li>
<ul>
<li>
<p>物理连续、不连续的Buffer混用</p>
<p>几乎所有用户空间的Buffer都属于这种情况，这样最大可能的发挥虚拟内存管理的灵活性。缺点也很明显，这些Buffer给硬件的话需要有支持scatter的DMA。</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>物理不连续、虚拟地址连续的Buffer</p>
<p>它们由vmalloc()分配，也用于支持scatter接口的DMA硬件。</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>物理连续的Buffer</p>
<p>非常适合DMA类硬件的访问。</p>
</li>
</ul>
</li>
</ol>
<p>驱动开发者必须三选一，对于我们的DVP模块来说，要选择3。并且底层用到dma-buf。</p>
<p>注解</p>
<p>V4L第二版不再支持Overlay类型，而V4L第一版不支持DMABUF类型。</p>
<p>V4L2在数据流传输的时候需要多个Buf切换，通过struct vb2_queue结构中的Qbuf两个Buf队列来管理，DVP驱动中还需要维护一个buf_list来配合DVP控制器的地址更新。整个Buf流转的过程如下图：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_buf_list-170669046258621.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_buf_list.jpg" class="img_ev3q"></p>
<p>图 6.32 <em>DVP 驱动中的 Buf 队列管理</em></p>
<ul>
<li>Qbuf队列（在代码中见struct vb2_queue-&gt;queued_list）：是一些空闲Buf，等待Sensor的数据到来后，DVP驱动会从这个队列中找可用Buf来保存下一帧数据。</li>
<li>DQbuf队列（在代码中见struct vb2_queue-&gt;done_list）：是一些填了视频数据的Buf，等待用户来处理这些数据，一般用户处理完后需要将Buf还给驱动，也就是还给Qbuf。</li>
<li>从Qbuf和DQbuf来的buf格式是struct vb2_buffer，其中没有字段可以保存物理地址（DVP控制器需要），同时还需要为每个buf记录一个是否正在被DVP使用的状态，所以DVP驱动中定义了基于vb2_buffer结构的封装vb2_v4l2_buffer，并且维护一个和Qbuf几乎同步的队列。</li>
<li>从图中的流转过程看，运行期间，在某一时刻，DVP需要使用一个Buf，APP需要使用一个Buf，QBuf需要有一个Buf在等待（否则DVP的done中断来了后发现没有等待的Qbuf会发生丢帧），一共至少要有3个Buf。</li>
<li>以YUV422格式计算，有两个plane，在V4L2框架中这一组plane算一个Buf，3个Buf就需要申请6个plane，<code>总大小 = 长 * 宽 * 2 * 3</code>。</li>
<li>DVP驱动中需要定义一个struct vb2_queue实例，Video device中会有一个指针*queue指向该实例。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="526-dvp-驱动的子模块结构">5.2.6. DVP 驱动的子模块结构<a href="#526-dvp-驱动的子模块结构" class="hash-link" aria-label="Direct link to 5.2.6. DVP 驱动的子模块结构" title="Direct link to 5.2.6. DVP 驱动的子模块结构">​</a></h4>
<p>基于以上对V4L2框架的分析，DVP驱动内部可以分为以下5个子模块：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_drv_structure-170669047119323.jpg" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_drv_structure.jpg" class="img_ev3q"></p>
<p>图 6.33 <em>DVP 驱动的子模块结构</em><a href="#id20">¶</a></p>
<ul>
<li>Video Dvice管理，主要实现和Video device相关的注册、ioctl处理；</li>
<li>Notifier管理，主要处理和Sensor设备的初始化次序的依赖关系；</li>
<li>Buf管理，主要实现Buf的入队、出队，以及在中断响应时切换DVP控制器的输出地址等；</li>
<li>Subdev管理，主要实现输入格式相关的接口；</li>
<li>寄存器访问，封装了对DVP控制器寄存器的读写访问。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-关键流程设计">5.3. 关键流程设计<a href="#53-关键流程设计" class="hash-link" aria-label="Direct link to 5.3. 关键流程设计" title="Direct link to 5.3. 关键流程设计">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="531-初始化流程">5.3.1. 初始化流程<a href="#531-初始化流程" class="hash-link" aria-label="Direct link to 5.3.1. 初始化流程" title="Direct link to 5.3.1. 初始化流程">​</a></h4>
<p>总体上看，DVP驱动的初始化过程分为两大段：</p>
<ol>
<li>阶段一：由probe()接口完成，完成资源申请、注册subdev、注册buf、注册notifier等；</li>
<li>阶段二：由notifier的complete()接口完成，是需要等Sensor执行完初始化（其probe()接口）后才能执行，完成的操作有：注册video device、注册media device、配置link等。</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5311-probe-过程">5.3.1.1. probe 过程<a href="#5311-probe-过程" class="hash-link" aria-label="Direct link to 5.3.1.1. probe 过程" title="Direct link to 5.3.1.1. probe 过程">​</a></h5>
<p>注册DVP控制器的注册过程：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_probe_flow-170669047937225.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_probe_flow.png" class="img_ev3q"></p>
<p>图 6.34 <em>DVP 驱动的注册过程</em></p>
<ul>
<li>初始化media device，</li>
<li>注册subdev，提供subdev_ops（其中定义了pad_ops）；</li>
<li>注册pad，包括为subdev注册两个pad：source + sink；为video device注册一个sink pad。</li>
<li>注册buf，初始化vb2_queue，需要提供vb2_ops（驱动相关）和vb2_mem_ops（内存分配的回调）</li>
<li>注册v4l2 device，主要是将DVP的dev关联到v4l2_device-&gt;dev</li>
<li>注册notifier，为了解决sensor和DVP控制 器之间的初始化顺序依赖问题，需要dts中定义好endpoint，并提供notifier_ops。</li>
</ul>
<p>初始化notifier的时候，会去调用v4l2_fwnode_endpoint_parse ()解析DTS中关于endpoint中的配置，包括bus-type（BT656等）、极性等，将这些信息保存在vep-&gt;bus中（在aic_dvp-&gt;bus需要有备份）。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5312-notifier-初始化过程">5.3.1.2. notifier 初始化过程<a href="#5312-notifier-初始化过程" class="hash-link" aria-label="Direct link to 5.3.1.2. notifier 初始化过程" title="Direct link to 5.3.1.2. notifier 初始化过程">​</a></h5>
<p>在Sensor的probe()过程中也会调用Notifier注册，因为DTS中两个设备用remote-endpoint已经有关联，DVP驱动注册过的notifier_ops-&gt;bound()接口首先会被触发，对方（Sensor）会传过来一个pad编号，DVP将其记录下来方便后续使用（调用Sensor的subdev接口完成stream启动、停止操作）。</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_notify_call-170669048777427.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_notify_call.png" class="img_ev3q"></p>
<p>图 6.35 <em>V4L2 中notify的调用过程</em></p>
<p>随后，DVP的notifier_ops-&gt;complete()接口也会被触发调用，DVP驱动中完成后续的初始化，包括：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_notify_complete-170669049555329.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/v4l2_notify_complete.png" class="img_ev3q"></p>
<p>图 6.36 <em>V4L2 中notify的complete处理流程</em></p>
<ul>
<li>关联v4l2_device 和subdev</li>
<li>注册video device，</li>
<li>注册media device</li>
<li>创建pad之间的link，会用到media_link结构</li>
</ul>
<p>注解</p>
<p>media device出现了两次，是为了在所有media graph完全初始化之前就可以提供media device给用户态空间。所以 一开始先用一部分entity初始化media device。</p>
<p>其中：</p>
<ul>
<li>Master设备执行probe函数的时候，先使用component_match_add()接口声明一个match队列。</li>
<li>然后，使用component_master_add_with_match函数将自己作为master注册到component框架。</li>
<li>各component slave设备执行probe函数的时候，仅使用component_add()完成slave注册。</li>
<li>以上各模块的probe()函数调用先后顺序并不影响。</li>
<li>各个component都要实现自己的bind()和unbind()接口（struct component_ops），component框架在判断所有match队列中的模块都完成了probe，就会按 <strong>先slave、后master</strong> 的去调用他们的bind()接口。而各模块真正的初始化动作都是在各自的bind()中去实现。</li>
<li>在执行各bind()接口时，各slave间的先后顺序和match队列一致。Component保证master最后执行。</li>
<li>aicfb-&gt;bind()中，主要完成framebuffer申请、fb设备注册、使能UI图层、使能panel等动作。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="532-buf-管理">5.3.2. Buf 管理<a href="#532-buf-管理" class="hash-link" aria-label="Direct link to 5.3.2. Buf 管理" title="Direct link to 5.3.2. Buf 管理">​</a></h4>
<p>DVP的Buf管理需要用到V4L2框架提供的Video queue机制外，还需要用到dma-buf和CMA（详见DE设计文档中的描述）。</p>
<p>对于每一帧图像数据来说，DVP的输出有两个plane：Y和UV。针对DVP的两种输出格式：YUV422_COMBINED_NV16和YUV420_COMBINED_NV12，两个plane的空间大小如下表：</p>
<table><thead><tr><th></th><th>YUV422_COMBINED_NV16</th><th>YUV420_COMBINED_NV12</th></tr></thead><tbody><tr><td>Plane Y</td><td>Width * height</td><td>Width * height</td></tr><tr><td>Plane UV</td><td>Width * height</td><td>Width * height / 2</td></tr></tbody></table>
<p>根据前面对“Buf队列管理”的分析可知：我们要分配的内存空间 <strong>至少要有3个Buf，每个Buf有两个Plane</strong>。</p>
<p>对应到Buf的ioctl接口，我们要用到*_MPLANE结尾的接口。</p>
<p>注册video queue时提需要提供vb2_ops，其中需要DVP驱动实现的有五个接口：</p>
<ul>
<li>
<ul>
<li>
<p>queue_setup</p>
<p>在APP发起申请buf时调用，这里面主要设置plane个数、各plane的大小；</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>buf_prepare和buf_queue</p>
<p>在APP每次调用QBuf时会调用，分别完成获取Buf物理地址、同步Qbuf list的处理；</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>Stream start和stream stop</p>
<p>启动和停止媒体数据（处理流程详见下节描述）。</p>
</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="533-stream-启动流程">5.3.3. Stream 启动流程<a href="#533-stream-启动流程" class="hash-link" aria-label="Direct link to 5.3.3. Stream 启动流程" title="Direct link to 5.3.3. Stream 启动流程">​</a></h4>
<p>Stream的启动是由APP发起的，APP通过ioctl接口传入命令VIDIOC_STREAMON（相应的，停止的命令是VIDIOC_STREAMOFF）。</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_stream_on-170669052618531.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_stream_on.png" class="img_ev3q"></p>
<p>图 6.37 <em>DVP 驱动中Stream启动过程</em><a href="#id24">¶</a></p>
<p>Stream的停止流程相对简单很多，会调用到Sensor的停止传输接口：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_stream_off-170669053323633.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_stream_off.png" class="img_ev3q"></p>
<p>图 6.38 <em>DVP 驱动中Stream停止过程</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="534-中断处理流程">5.3.4. 中断处理流程<a href="#534-中断处理流程" class="hash-link" aria-label="Direct link to 5.3.4. 中断处理流程" title="Direct link to 5.3.4. 中断处理流程">​</a></h4>
<p>DVP的中断处理函数中主要处理Buf的队列切换操作。 DVP硬件提供的中断可以反映出多个状态（包括出错状态），其中有两个比较重要：</p>
<ol>
<li>
<ul>
<li>
<p>Update done</p>
<p>表示硬件已经读走了当前的Register值（影子寄存器），软件可以为下一帧去修改了；</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>Frame done</p>
<p>表示当前帧的数据传输完成。</p>
</li>
</ul>
</li>
</ol>
<p>可见，Update done会先于Frame done发生，驱动中用Update done判断当前Register是否可以修改，用Frame done判断当前buf是否完成（done状态），该buf就可以从QBuf list切换到DQbuf list了。</p>
<p>按照DVP硬件设计的逻辑，Update done和Frame done会间隔着产生（不会连续两个Update done）： <code>Update done -&gt; Frame done -&gt; Update done -&gt; Frame done -&gt; Update done -&gt; Frame done ...</code></p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_irq_flow1-170669054724535.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_irq_flow1.png" class="img_ev3q"></p>
<p>图 6.39 <em>DVP 驱动中IRQ处理流程</em></p>
<p>“处理Frame done事件”的子流程如下：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_frame_done_flow1-170669055625037.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_frame_done_flow1.png" class="img_ev3q"></p>
<p>图 6.40 <em>DVP 驱动中Frame done处理流程</em></p>
<p>“处理Update done事件”的子流程如下：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_update_done_flow1-170669056253039.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/dvp_update_done_flow1.png" class="img_ev3q"></p>
<p>图 6.41 <em>DVP 驱动中Update done处理流程</em></p>
<ul>
<li>
<ul>
<li>
<p>“异常！DVP同时使用了两个Buf”</p>
<p>理论上不应该发生，可认为是DVP硬件异常，但因为DVP还在向Buf写数据，所以先不执行stop，软件上报错。</p>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>“DVP在使用”</p>
<p>表示“DVP控制器硬件正在使用”。</p>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="54-数据结构设计">5.4. 数据结构设计<a href="#54-数据结构设计" class="hash-link" aria-label="Direct link to 5.4. 数据结构设计" title="Direct link to 5.4. 数据结构设计">​</a></h3>
<p>DVP自定义的数据结构都在aic_dvp.h中。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="541-aic_dvp">5.4.1. aic_dvp<a href="#541-aic_dvp" class="hash-link" aria-label="Direct link to 5.4.1. aic_dvp" title="Direct link to 5.4.1. aic_dvp">​</a></h4>
<p>定义了DVP控制器的设备管理信息：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_dvp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Device resources */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct device           *dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void __iomem            *regs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct clk          *clk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct reset_control        *rst;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32             clk_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int             irq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int             ch;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct vb2_v4l2_buffer      *vbuf[DVP_MAX_BUF];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aic_dvp_config       cfg; /* The configuration of DVP HW */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_fwnode_bus_parallel bus; /* The format of input data */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_pix_format_mplane   fmt; /* The format of output data */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Main Device */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_device      v4l2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct media_device     mdev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct video_device     vdev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct media_pad        vdev_pad;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Local subdev */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_subdev      subdev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct media_pad        subdev_pads[DVP_SUBDEV_PAD_NUM];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_mbus_framefmt   subdev_fmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* V4L2 Async variables */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_async_subdev    asd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_async_notifier  notifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_subdev      *src_subdev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int             src_pad;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* V4L2 variables */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct mutex            lock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Videobuf2 */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct vb2_queue        queue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct list_head        buf_list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spinlock_t          qlock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unsigned int            sequence;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="542-aic_dvp_config">5.4.2. aic_dvp_config<a href="#542-aic_dvp_config" class="hash-link" aria-label="Direct link to 5.4.2. aic_dvp_config" title="Direct link to 5.4.2. aic_dvp_config">​</a></h4>
<p>定义了V4L2媒体数据的配置信息：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Save the configuration information for DVP controller.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @code:   media bus format code (MEDIA_BUS_FMT_*, in media-bus-format.h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @field:  used interlacing type (enum v4l2_field)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @width:  frame width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @height: frame height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_dvp_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Input format */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum dvp_input      input;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum dvp_input_yuv_seq  input_seq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum v4l2_field     field;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /* Output format */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum dvp_output output;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32     width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32     height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32     stride[DVP_MAX_PLANE];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32     sizeimage[DVP_MAX_PLANE];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="543-aic_dvp_buf">5.4.3. aic_dvp_buf<a href="#543-aic_dvp_buf" class="hash-link" aria-label="Direct link to 5.4.3. aic_dvp_buf" title="Direct link to 5.4.3. aic_dvp_buf">​</a></h4>
<p>定义了DVP驱动的Buf管理信息：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_dvp_buf {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct vb2_v4l2_buffer  vb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct list_head    list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dma_addr_t      paddr[DVP_MAX_PLANE];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool            dvp_using;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="544-输入输出的数据格式">5.4.4. 输入输出的数据格式<a href="#544-输入输出的数据格式" class="hash-link" aria-label="Direct link to 5.4.4. 输入输出的数据格式" title="Direct link to 5.4.4. 输入输出的数据格式">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5441-enum-dvp_input">5.4.4.1. enum dvp_input<a href="#5441-enum-dvp_input" class="hash-link" aria-label="Direct link to 5.4.4.1. enum dvp_input" title="Direct link to 5.4.4.1. enum dvp_input">​</a></h5>
<p>定义了DVP输入数据的格式：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum dvp_input {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_IN_RAW  = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_IN_YUV422   = 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_IN_BT656    = 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5442-enum-dvp_input_yuv_seq">5.4.4.2. enum dvp_input_yuv_seq<a href="#5442-enum-dvp_input_yuv_seq" class="hash-link" aria-label="Direct link to 5.4.4.2. enum dvp_input_yuv_seq" title="Direct link to 5.4.4.2. enum dvp_input_yuv_seq">​</a></h5>
<p>定义了DVP输入数据的YUV格式：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum dvp_input_yuv_seq {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_YUV_DATA_SEQ_YUYV   = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_YUV_DATA_SEQ_YVYU   = 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_YUV_DATA_SEQ_UYVY   = 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_YUV_DATA_SEQ_VYUY   = 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5443-enum-dvp_output">5.4.4.3. enum dvp_output<a href="#5443-enum-dvp_output" class="hash-link" aria-label="Direct link to 5.4.4.3. enum dvp_output" title="Direct link to 5.4.4.3. enum dvp_output">​</a></h5>
<p>定义了DVP输出数据的格式：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum dvp_output {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_OUT_RAW_PASSTHROUGH     = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_OUT_YUV422_COMBINED_NV16    = 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DVP_OUT_YUV420_COMBINED_NV12    = 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="55-接口设计">5.5. 接口设计<a href="#55-接口设计" class="hash-link" aria-label="Direct link to 5.5. 接口设计" title="Direct link to 5.5. 接口设计">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="551-v4l2-device-的外部接口">5.5.1. V4l2 device 的外部接口<a href="#551-v4l2-device-的外部接口" class="hash-link" aria-label="Direct link to 5.5.1. V4l2 device 的外部接口" title="Direct link to 5.5.1. V4l2 device 的外部接口">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="5511-ioctl-接口">5.5.1.1. ioctl 接口<a href="#5511-ioctl-接口" class="hash-link" aria-label="Direct link to 5.5.1.1. ioctl 接口" title="Direct link to 5.5.1.1. ioctl 接口">​</a></h5>
<p>用户态通过/dev/videoX节点的ioctl()接口与内核态V4L2框架、DVP驱动进行交互。主要功能有：</p>
<ul>
<li>获取、设置格式</li>
<li>申请、释放Buf</li>
<li>QBuf、DQBuf</li>
<li>导出dma-buf文件描述符</li>
<li>启动、停止Stream</li>
</ul>
<p>定义在include/uapi/linux/videodev2.h：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_QUERYCAP      _IOR(&#x27;V&#x27;,  0, struct v4l2_capability)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_ENUM_FMT         _IOWR(&#x27;V&#x27;,  2, struct v4l2_fmtdesc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_FMT        _IOWR(&#x27;V&#x27;,  4, struct v4l2_format)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_FMT        _IOWR(&#x27;V&#x27;,  5, struct v4l2_format)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_REQBUFS      _IOWR(&#x27;V&#x27;,  8, struct v4l2_requestbuffers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_QUERYBUF     _IOWR(&#x27;V&#x27;,  9, struct v4l2_buffer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_FBUF        _IOR(&#x27;V&#x27;, 10, struct v4l2_framebuffer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_FBUF        _IOW(&#x27;V&#x27;, 11, struct v4l2_framebuffer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_OVERLAY       _IOW(&#x27;V&#x27;, 14, int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_QBUF     _IOWR(&#x27;V&#x27;, 15, struct v4l2_buffer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_EXPBUF       _IOWR(&#x27;V&#x27;, 16, struct v4l2_exportbuffer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_DQBUF        _IOWR(&#x27;V&#x27;, 17, struct v4l2_buffer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_STREAMON      _IOW(&#x27;V&#x27;, 18, int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_STREAMOFF     _IOW(&#x27;V&#x27;, 19, int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_PARM       _IOWR(&#x27;V&#x27;, 21, struct v4l2_streamparm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_PARM       _IOWR(&#x27;V&#x27;, 22, struct v4l2_streamparm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_STD         _IOR(&#x27;V&#x27;, 23, v4l2_std_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_STD         _IOW(&#x27;V&#x27;, 24, v4l2_std_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_ENUMSTD      _IOWR(&#x27;V&#x27;, 25, struct v4l2_standard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_ENUMINPUT    _IOWR(&#x27;V&#x27;, 26, struct v4l2_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_CTRL       _IOWR(&#x27;V&#x27;, 27, struct v4l2_control)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_CTRL       _IOWR(&#x27;V&#x27;, 28, struct v4l2_control)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_QUERYCTRL    _IOWR(&#x27;V&#x27;, 36, struct v4l2_queryctrl)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_QUERYMENU    _IOWR(&#x27;V&#x27;, 37, struct v4l2_querymenu)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_INPUT       _IOR(&#x27;V&#x27;, 38, int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_INPUT      _IOWR(&#x27;V&#x27;, 39, int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_OUTPUT      _IOR(&#x27;V&#x27;, 46, int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_OUTPUT     _IOWR(&#x27;V&#x27;, 47, int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_ENUMOUTPUT   _IOWR(&#x27;V&#x27;, 48, struct v4l2_output)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_FREQUENCY  _IOWR(&#x27;V&#x27;, 56, struct v4l2_frequency)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_FREQUENCY   _IOW(&#x27;V&#x27;, 57, struct v4l2_frequency)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_CROPCAP      _IOWR(&#x27;V&#x27;, 58, struct v4l2_cropcap)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_CROP       _IOWR(&#x27;V&#x27;, 59, struct v4l2_crop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_CROP        _IOW(&#x27;V&#x27;, 60, struct v4l2_crop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_JPEGCOMP    _IOR(&#x27;V&#x27;, 61, struct v4l2_jpegcompression)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_JPEGCOMP    _IOW(&#x27;V&#x27;, 62, struct v4l2_jpegcompression)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_QUERYSTD      _IOR(&#x27;V&#x27;, 63, v4l2_std_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_TRY_FMT      _IOWR(&#x27;V&#x27;, 64, struct v4l2_format)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_PRIORITY    _IOR(&#x27;V&#x27;, 67, __u32) /* enum v4l2_priority */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_PRIORITY    _IOW(&#x27;V&#x27;, 68, __u32) /* enum v4l2_priority */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_SLICED_VBI_CAP _IOWR(&#x27;V&#x27;, 69, struct v4l2_sliced_vbi_cap)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_LOG_STATUS         _IO(&#x27;V&#x27;, 70)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_EXT_CTRLS  _IOWR(&#x27;V&#x27;, 71, struct v4l2_ext_controls)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_S_EXT_CTRLS  _IOWR(&#x27;V&#x27;, 72, struct v4l2_ext_controls)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_TRY_EXT_CTRLS    _IOWR(&#x27;V&#x27;, 73, struct v4l2_ext_controls)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_ENUM_FRAMESIZES  _IOWR(&#x27;V&#x27;, 74, struct v4l2_frmsizeenum)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_ENUM_FRAMEINTERVALS _IOWR(&#x27;V&#x27;, 75, struct v4l2_frmivalenum)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_G_ENC_INDEX       _IOR(&#x27;V&#x27;, 76, struct v4l2_enc_idx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_ENCODER_CMD      _IOWR(&#x27;V&#x27;, 77, struct v4l2_encoder_cmd)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_TRY_ENCODER_CMD  _IOWR(&#x27;V&#x27;, 78, struct v4l2_encoder_cmd)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="552-v4l2-subdev-的外部接口">5.5.2. V4l2 subdev 的外部接口<a href="#552-v4l2-subdev-的外部接口" class="hash-link" aria-label="Direct link to 5.5.2. V4l2 subdev 的外部接口" title="Direct link to 5.5.2. V4l2 subdev 的外部接口">​</a></h4>
<p>用户态通过/dev/v4l-subdevX节点的ioctl()接口与内核态V4L2框架、DVP驱动、Sensor驱动进行交互。主要功能有：</p>
<ul>
<li>获取、设置格式</li>
<li>获取、设置帧间隔</li>
<li>枚举支持的mbus类型</li>
<li>枚举支持的分辨率</li>
<li>获取、设置区域裁剪</li>
</ul>
<p>定义在 include/uapi/linux/v4l2-subdev.h：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_G_FMT         _IOWR(&#x27;V&#x27;,  4, struct v4l2_subdev_format)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_S_FMT         _IOWR(&#x27;V&#x27;,  5, struct v4l2_subdev_format)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_G_FRAME_INTERVAL      _IOWR(&#x27;V&#x27;, 21, struct v4l2_subdev_frame_interval)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_S_FRAME_INTERVAL      _IOWR(&#x27;V&#x27;, 22, struct v4l2_subdev_frame_interval)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_ENUM_MBUS_CODE        _IOWR(&#x27;V&#x27;,  2, struct v4l2_subdev_mbus_code_enum)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_ENUM_FRAME_SIZE       _IOWR(&#x27;V&#x27;, 74, struct v4l2_subdev_frame_size_enum)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_ENUM_FRAME_INTERVAL   _IOWR(&#x27;V&#x27;, 75, struct v4l2_subdev_frame_interval_enum)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_G_CROP            _IOWR(&#x27;V&#x27;, 59, struct v4l2_subdev_crop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_S_CROP            _IOWR(&#x27;V&#x27;, 60, struct v4l2_subdev_crop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_G_SELECTION       _IOWR(&#x27;V&#x27;, 61, struct v4l2_subdev_selection)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_S_SELECTION       _IOWR(&#x27;V&#x27;, 62, struct v4l2_subdev_selection)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* The following ioctls are identical to the ioctls in videodev2.h */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_G_STD         _IOR(&#x27;V&#x27;, 23, v4l2_std_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_S_STD         _IOW(&#x27;V&#x27;, 24, v4l2_std_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_ENUMSTD           _IOWR(&#x27;V&#x27;, 25, struct v4l2_standard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_G_EDID            _IOWR(&#x27;V&#x27;, 40, struct v4l2_edid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_S_EDID            _IOWR(&#x27;V&#x27;, 41, struct v4l2_edid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_QUERYSTD          _IOR(&#x27;V&#x27;, 63, v4l2_std_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_S_DV_TIMINGS      _IOWR(&#x27;V&#x27;, 87, struct v4l2_dv_timings)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_G_DV_TIMINGS      _IOWR(&#x27;V&#x27;, 88, struct v4l2_dv_timings)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_ENUM_DV_TIMINGS       _IOWR(&#x27;V&#x27;, 98, struct v4l2_enum_dv_timings)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_QUERY_DV_TIMINGS      _IOR(&#x27;V&#x27;, 99, struct v4l2_dv_timings)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDIOC_SUBDEV_DV_TIMINGS_CAP        _IOWR(&#x27;V&#x27;, 100, struct v4l2_dv_timings_cap)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="56-app-demo">5.6. APP Demo<a href="#56-app-demo" class="hash-link" aria-label="Direct link to 5.6. APP Demo" title="Direct link to 5.6. APP Demo">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="561-app层的处  理流程">5.6.1. APP层的处理流程<a href="#561-app层的处理流程" class="hash-link" aria-label="Direct link to 5.6.1. APP层的处理流程" title="Direct link to 5.6.1. APP层的处理流程">​</a></h4>
<p>APP 中实现从Sensor -&gt; DVP -&gt; DE的数据通路，整体的处理流程如下图（图中按照访问对象分为三列，实际上整体是串行执行）：</p>
<p><img loading="lazy" src="https://photos.100ask.net/artinchip-docs/d213-devkit/demo_flow-170669068848241.png" alt="../../../_https://photos.100ask.net/artinchip-docs/d213-devkit/demo_flow.png" class="img_ev3q"></p>
<p>图 6.42 <em>APP 中的处理流程</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="562-app-demo参考实现">5.6.2. APP Demo参考实现<a href="#562-app-demo参考实现" class="hash-link" aria-label="Direct link to 5.6.2. APP Demo参考实现" title="Direct link to 5.6.2. APP Demo参考实现">​</a></h4>
<p>Demo代码见test-dvp/test_dvp.c，如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;linux/dma-buf.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;linux/dma-heap.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;linux/videodev2.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;linux/v4l2-subdev.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;video/artinchip_fb.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;artinchip/sample_base.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Global macro and variables */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VID_BUF_NUM     3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DVP_PLANE_NUM       2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define CMA_BUF_MAX     (8 * 1024 * 1024)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DMA_HEAP_DEV        &quot;/dev/dma_heap/reserved&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define FB_DEV          &quot;/dev/fb0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define VIDEO_DEV       &quot;/dev/video0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_DEV      &quot;/dev/v4l-subdev0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DVP_SUBDEV_DEV      &quot;/dev/v4l-subdev1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static const char sopts[] = &quot;f:c:u&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static const struct option lopts[] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {&quot;format&quot;,    required_argument, NULL, &#x27;f&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {&quot;capture&quot;,   required_argument, NULL, &#x27;c&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {&quot;usage&quot;,       no_argument, NULL, &#x27;u&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {0, 0, 0, 0}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct video_plane {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int buf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct video_buf_info {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *vaddr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u32 offset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct video_plane planes[DVP_PLANE_NUM];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct aic_video_data {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int frame_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int frame_cnt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int fmt;  // output format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_subdev_format src_fmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct video_buf_info binfo[VID_BUF_NUM];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int g_fb_fd = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int g_video_fd = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int g_sensor_fd = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static int g_dvp_subdev_fd = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static struct aic_video_data g_vdata = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Functions */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void usage(char *program)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;Usage: %s [options]: \n&quot;, program);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;\t -f, --format\t\tformat of input video, NV16/NV12 etc\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;\t -c, --count\t\tthe number of capture frame \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;\t -u, --usage \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;Example: %s -f yuv422 -c 1\n&quot;, program);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* Open a device file to be needed. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int device_open(char *_fname, int _flag)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s32 fd = -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fd = open(_fname, _flag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (fd &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;Failed to open %s errno: %d[%s]\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _fname, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exit(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int set_ui_layer_alpha(int val)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aicfb_alpha_config alpha = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alpha.layer_id = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alpha.enable = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alpha.mode = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alpha.value = val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = ioctl(g_fb_fd, AICFB_UPDATE_ALPHA_CONFIG, &amp;alpha);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! errno: %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void vidbuf_dmabuf_begin(struct aic_video_data *vdata)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i, j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aicfb_dmabuf_fd fds = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (i = 0; i &lt; VID_BUF_NUM; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct video_plane *plane = (struct video_plane *)&amp;vdata-&gt;binfo[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (j = 0; j &lt; DVP_PLANE_NUM; j++, plane++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fds.fd = plane-&gt;fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ioctl(g_fb_fd, AICFB_GET_DMABUF, &amp;fds) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ERR(&quot;ioctl() failed! err %d[%s]\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void vidbuf_dmabuf_end(struct aic_video_data *vdata)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i, j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aicfb_dmabuf_fd fds = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (i = 0; i &lt; VID_BUF_NUM; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct video_plane *plane = (struct video_plane *)&amp;vdata-&gt;binfo[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (j = 0; j &lt; DVP_PLANE_NUM; j++, plane++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fds.fd = plane-&gt;fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ioctl(g_fb_fd, AICFB_PUT_DMABUF, &amp;fds) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ERR(&quot;ioctl() failed! err %d[%s]\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int sensor_get_fmt(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_subdev_format f = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_sensor_fd = device_open(SENSOR_DEV, O_RDWR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_sensor_fd &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.pad = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.which = V4L2_SUBDEV_FORMAT_ACTIVE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_sensor_fd, VIDIOC_SUBDEV_G_FMT, &amp;f) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.format.code = MEDIA_BUS_FMT_YUYV8_2X8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_sensor_fd, VIDIOC_SUBDEV_S_FMT, &amp;f) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_vdata.src_fmt = f;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_vdata.w = g_vdata.src_fmt.format.width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_vdata.h = g_vdata.src_fmt.format.height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_subdev_set_fmt(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_subdev_format f = g_vdata.src_fmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_dvp_subdev_fd = device_open(DVP_SUBDEV_DEV, O_RDWR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_dvp_subdev_fd &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.pad = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.which = V4L2_SUBDEV_FORMAT_ACTIVE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_dvp_subdev_fd, VIDIOC_SUBDEV_S_FMT, &amp;f) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_cfg(int width, int height, int format)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_format f = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.fmt.pix_mp.width = g_vdata.src_fmt.format.width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.fmt.pix_mp.height = g_vdata.src_fmt.format.height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.fmt.pix_mp.pixelformat = g_vdata.fmt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.fmt.pix_mp.num_planes = DVP_PLANE_NUM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_video_fd, VIDIOC_S_FMT, &amp;f) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_expbuf(int index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct video_buf_info *binfo = &amp;g_vdata.binfo[index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_exportbuffer expbuf = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (i = 0; i &lt; DVP_PLANE_NUM; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;expbuf, 0, sizeof(struct v4l2_exportbuffer));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expbuf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expbuf.index = index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expbuf.plane = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ioctl(g_video_fd, VIDIOC_EXPBUF, &amp;expbuf) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ERR(&quot;ioctl() failed! err %d[%s]\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        binfo-&gt;planes[i].fd = expbuf.fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_request_buf(int num)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_buffer buf = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_requestbuffers req = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_plane planes[DVP_PLANE_NUM];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req.count  = num;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req.type   = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req.memory = V4L2_MEMORY_MMAP; // Only MMAP will do alloc memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_video_fd, VIDIOC_REQBUFS, &amp;req) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (i = 0; i &lt; num; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dvp_expbuf(i) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;buf, 0, sizeof(struct v4l2_buffer));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buf.index = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buf.length = DVP_PLANE_NUM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buf.memory = V4L2_MEMORY_DMABUF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buf.m.planes = planes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ioctl(g_video_fd, VIDIOC_QUERYBUF, &amp;buf) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ERR(&quot;ioctl() failed! err %d[%s]\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void dvp_release_buf(int num)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct video_buf_info *binfo = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (i = 0; i &lt; num; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        binfo = &amp;g_vdata.binfo[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (binfo-&gt;vaddr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            munmap(binfo-&gt;vaddr, binfo-&gt;len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            binfo-&gt;vaddr = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_queue_buf(int index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_buffer buf = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_plane planes[DVP_PLANE_NUM] = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.type   = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.memory = V4L2_MEMORY_MMAP;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.index  = index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.length = DVP_PLANE_NUM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.m.planes = planes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_video_fd, VIDIOC_QBUF, &amp;buf) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_dequeue_buf(int *index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_buffer buf = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct v4l2_plane planes[DVP_PLANE_NUM] = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.type   = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.memory = V4L2_MEMORY_MMAP;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.length = DVP_PLANE_NUM;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf.m.planes = planes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_video_fd, VIDIOC_DQBUF, &amp;buf) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *index = buf.index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_start(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum v4l2_buf_type type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_video_fd, VIDIOC_STREAMON, &amp;type) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int dvp_stop(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum v4l2_buf_type type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_video_fd, VIDIOC_STREAMOFF, &amp;type) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int video_layer_set(struct aic_video_data *vdata, int index)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct aicfb_layer_data layer = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct video_buf_info *binfo = &amp;vdata-&gt;binfo[index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.layer_id = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.enable = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.scale_size.width = vdata-&gt;w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.scale_size.height = vdata-&gt;h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.scale_size.width = 780;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.scale_size.height = 600;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.pos.x = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.pos.y = 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.buf.size.width = vdata-&gt;w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.buf.size.height = vdata-&gt;h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.buf.format = AIC_FMT_NV16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.buf.dmabuf_fd[0] = binfo-&gt;planes[0].fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.buf.dmabuf_fd[1] = binfo-&gt;planes[1].fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.buf.stride[0] = vdata-&gt;w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer.buf.stride[1] = vdata-&gt;w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ioctl(g_fb_fd, AICFB_UPDATE_LAYER_CONFIG, &amp;layer) &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ERR(&quot;ioctl() failed! err %d[%s]\n&quot;, errno, strerror(errno));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char **argv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int c, frame_cnt = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i, index = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DBG(&quot;Compile time: %s\n&quot;, __TIME__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_vdata.fmt = V4L2_PIX_FMT_NV16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while ((c = getopt_long(argc, argv, sopts, lopts, NULL)) != -1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &#x27;f&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (strncasecmp(&quot;nv12&quot;, optarg, strlen(optarg)) == 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                g_vdata.fmt = V4L2_PIX_FMT_NV12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &#x27;c&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            frame_cnt = str2int(optarg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &#x27;u&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            usage(argv[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (sensor_get_fmt() &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dvp_subdev_set_fmt() &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_vdata.fmt == V4L2_PIX_FMT_NV16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g_vdata.frame_size = g_vdata.w * g_vdata.h * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_vdata.fmt == V4L2_PIX_FMT_NV12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g_vdata.frame_size = (g_vdata.w * g_vdata.h * 3) &gt;&gt; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_fb_fd = device_open(FB_DEV, O_RDWR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_fb_fd &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (set_ui_layer_alpha(128) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_video_fd = device_open(VIDEO_DEV, O_RDWR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_video_fd &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dvp_cfg(g_vdata.w, g_vdata.h, g_vdata.fmt) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dvp_request_buf(VID_BUF_NUM) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vidbuf_dmabuf_begin(&amp;g_vdata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (i = 0; i &lt; VID_BUF_NUM; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dvp_queue_buf(i) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            goto end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dvp_start() &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        goto end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (i = 0; i &lt; frame_cnt; i++ ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dvp_dequeue_buf(&amp;index) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DBG(&quot;Set the buf %d to video layer\n&quot;, index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (video_layer_set(&amp;g_vdata, index) &lt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dvp_queue_buf(index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dvp_stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vidbuf_dmabuf_end(&amp;g_vdata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dvp_release_buf(VID_BUF_NUM);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_fb_fd &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        close(g_fb_fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_video_fd &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        close(g_video_fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_sensor_fd &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        close(g_sensor_fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (g_dvp_subdev_fd &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        close(g_dvp_subdev_fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-常见问题">6. 常见问题<a href="#6-常见问题" class="hash-link" aria-label="Direct link to 6. 常见问题" title="Direct link to 6. 常见问题">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-摄像头初始化失败">6.1. 摄像头初始化失败<a href="#61-摄像头初始化失败" class="hash-link" aria-label="Direct link to 6.1. 摄像头初始化失败" title="Direct link to 6.1. 摄像头初始化失败">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="611-现象">6.1.1. 现象<a href="#611-现象" class="hash-link" aria-label="Direct link to 6.1.1. 现象" title="Direct link to 6.1.1. 现象">​</a></h4>
<p>板子启动后，摄像头的V4L2 device注册失败，此时DVP的注册流程也因此不完整，在Sysfs中会找不到 /dev/video0 不存在。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="612-原因分析">6.1.2. 原因分析<a href="#612-原因分析" class="hash-link" aria-label="Direct link to 6.1.2. 原因分析" title="Direct link to 6.1.2. 原因分析">​</a></h4>
<p>一般情况下，摄像头需要通过 I2C 来访问，所以要确保 I2C和摄像头两个模块是否打开。</p>
<ul>
<li>摄像头的打开方法： <a href="/en/docs/D213-DevKit/part3/4_test_guide.html#ref-dvp-camera">配置 OV5640 摄像头</a></li>
<li>I2C的打开方法，请参考I2C模块的使用说明</li>
</ul>
<p>同时，要确认以下配置是否正确：</p>
<ol>
<li>硬件上，摄像头是连接到哪个I2C通道，对应的DTS配置是否正确，配置参见 <a href="/en/docs/D213-DevKit/part3/4_test_guide.html#ref-dvp-camera">配置 OV5640 摄像头</a></li>
<li>摄像头的I2C 设备地址是否正确，参见 <a href="/en/docs/D213-DevKit/part3/4_test_guide.html#ref-dvp-camera">配置 OV5640 摄像头</a> 中的参数 <code>camera@3C</code></li>
<li>摄像头的供电是否正常。</li>
</ol>
<p>#ifdef AIC_ONLY</p>
<p><strong>以下内容仅供内部使用</strong></p>
<p>注意</p>
<p>在FPGA环境中，摄像头的电源GPIO在上电时已正常工作，不能去复位，否则会导致摄像头的寄存器读写失败。</p>
<p>屏蔽OV5640的GPIO复位的patch：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    ov5640: Must not set the power GPIO in FPGA.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Signed-off-by: matteo &lt;duanmt@artinchip.com&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Change-Id: I55b163f8c59f257532e0c047931765bda6a89c85</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">diff --git a/drivers/media/i2c/ov5640.c b/drivers/media/i2c/ov5640.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index 8f0812e85..c240ead99 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- a/drivers/media/i2c/ov5640.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ b/drivers/media/i2c/ov5640.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -1857,7 +1857,7 @@ static void ov5640_power(struct ov5640_dev *sensor, bool enable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gpiod_set_value_cansleep(sensor-&gt;pwdn_gpio, enable ? 0 : 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+#ifndef CONFIG_DEBUG_ON_FPGA_BOARD_ARTINCHIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> static void ov5640_reset(struct ov5640_dev *sensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!sensor-&gt;reset_gpio)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -1877,6 +1877,7 @@ static void ov5640_reset(struct ov5640_dev *sensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gpiod_set_value_cansleep(sensor-&gt;reset_gpio, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        usleep_range(20000, 25000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> static int ov5640_set_power_on(struct ov5640_dev *sensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -1898,8 +1899,10 @@ static int ov5640_set_power_on(struct ov5640_dev *sensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                goto xclk_off;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+#ifndef CONFIG_DEBUG_ON_FPGA_BOARD_ARTINCHIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ov5640_reset(sensor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ov5640_power(sensor, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = ov5640_init_slave_id(sensor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>&gt;&gt;&gt;&gt; 以上内容仅供内部使用</p>
<p>#endif</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-画面的流畅度问题">6.2. 画面的流畅度问题<a href="#62-画面的流畅度问题" class="hash-link" aria-label="Direct link to 6.2. 画面的流畅度问题" title="Direct link to 6.2. 画面的流畅度问题">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="621-现象">6.2.1. 现象<a href="#621-现象" class="hash-link" aria-label="Direct link to 6.2.1. 现象" title="Direct link to 6.2.1. 现象">​</a></h4>
<p>界面显示的摄像头画面有 明显卡顿情况。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="622-解决方法">6.2.2. 解决方法<a href="#622-解决方法" class="hash-link" aria-label="Direct link to 6.2.2. 解决方法" title="Direct link to 6.2.2. 解决方法">​</a></h4>
<ol>
<li>如果DVP驱动中的调试信息打开了，每一帧数据处理都有输出log，会影响帧率，需要关掉。修改方法见 <a href="/en/docs/D213-DevKit/part3/3_debug_guide.html#ref-dvp-debug">调试开关</a></li>
<li>尝试增加test_dvp中的buffer数量，保证buf队列中有充裕的空闲buf。buffer数量定义见：</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define VID_BUF_NUM     3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part3/06-4_DVP-Useguide.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/D213-DevKit/part3/06-3_Display-Useguide"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Display 使用指南</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/D213-DevKit/part3/06-8_I2S-Useguide"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">I2S 使用指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#模块介绍" class="table-of-contents__link toc-highlight">模块介绍</a><ul><li><a href="#11-术语定义" class="table-of-contents__link toc-highlight">1.1. 术语定义</a></li><li><a href="#12-模块简介" class="table-of-contents__link toc-highlight">1.2. 模块简介</a></li></ul></li><li><a href="#2-参数配置" class="table-of-contents__link toc-highlight">2. 参数配置</a><ul><li><a href="#21-内核配置" class="table-of-contents__link toc-highlight">2.1. 内核配置</a></li><li><a href="#22-dts-参数配置" class="table-of-contents__link toc-highlight">2.2. DTS 参数配置</a></li></ul></li><li><a href="#3-调试指南" class="table-of-contents__link toc-highlight">3. 调试指南</a><ul><li><a href="#31-调试开关" class="table-of-contents__link toc-highlight">3.1. 调试开关</a></li><li><a href="#32-sysfs-节点" class="table-of-contents__link toc-highlight">3.2. Sysfs 节点</a></li><li><a href="#33-v4l2-相关的其他工具" class="table-of-contents__link toc-highlight">3.3. V4L2 相关的其他工具</a></li></ul></li><li><a href="#4-测试指南" class="table-of-contents__link toc-highlight">4. 测试指南</a><ul><li><a href="#41-测试环境" class="table-of-contents__link toc-highlight">4.1. 测试环境</a></li><li><a href="#42-test_dvp-测试" class="table-of-contents__link toc-highlight">4.2. test_dvp 测试</a></li></ul></li><li><a href="#5-设计说明" class="table-of-contents__link toc-highlight">5. 设计说明</a><ul><li><a href="#51-源码说明" class="table-of-contents__link toc-highlight">5.1. 源码说明</a></li><li><a href="#52-模块架构" class="table-of-contents__link toc-highlight">5.2. 模块架构</a></li><li><a href="#53-关键流程设计" class="table-of-contents__link toc-highlight">5.3. 关键流程设计</a></li><li><a href="#54-数据结构设计" class="table-of-contents__link toc-highlight">5.4. 数据结构设计</a></li><li><a href="#55-接口设计" class="table-of-contents__link toc-highlight">5.5. 接口设计</a></li><li><a href="#56-app-demo" class="table-of-contents__link toc-highlight">5.6. APP Demo</a></li></ul></li><li><a href="#6-常见问题" class="table-of-contents__link toc-highlight">6. 常见问题</a><ul><li><a href="#61-摄像头初始化失败" class="table-of-contents__link toc-highlight">6.1. 摄像头初始化失败</a></li><li><a href="#62-画面的流畅度问题" class="table-of-contents__link toc-highlight">6.2. 画面的流畅度问题</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>