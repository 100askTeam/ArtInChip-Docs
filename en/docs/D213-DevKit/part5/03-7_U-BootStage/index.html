<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-D213-DevKit/part5/03-7_U-BootStage" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">U-Boot 阶段 | 东山Π</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://artinchip.100ask.net/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://artinchip.100ask.net/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://artinchip.100ask.net/en/docs/D213-DevKit/part5/03-7_U-BootStage"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="U-Boot 阶段 | 东山Π"><meta data-rh="true" name="description" content="U-Boot 在 Artinchip 平台上承担两个功能角色："><meta data-rh="true" property="og:description" content="U-Boot 在 Artinchip 平台上承担两个功能角色："><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part5/03-7_U-BootStage"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-7_U-BootStage" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/en/docs/D213-DevKit/part5/03-7_U-BootStage" hreflang="en"><link data-rh="true" rel="alternate" href="https://artinchip.100ask.net/docs/D213-DevKit/part5/03-7_U-BootStage" hreflang="x-default"><link rel="stylesheet" href="/en/assets/css/styles.d875fe7e.css">
<script src="/en/assets/js/runtime~main.492f0d3e.js" defer="defer"></script>
<script src="/en/assets/js/main.d02687fe.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/en/img/logo.svg" alt="东山PI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">东山Π</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/D213-DevKit/BoardIntroduction">D213-DevKit</a><a class="navbar__item navbar__link" href="/en/docs/category/luban-sdk使用指南">Luban-SDK</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/D213-DevKit/part5/03-7_U-BootStage" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">简体中文</a></li><li><a href="/en/docs/D213-DevKit/part5/03-7_U-BootStage" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/ArtInChip-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/BoardIntroduction">匠心创D213-DevKit开发板</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/SupportingResources">源码工具文档手册</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/快速启动">快速启动</a><button aria-label="Expand sidebar category &#x27;快速启动&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/D213-DevKit/ConfigHostEnv">安装并配置开发环境</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/luban-sdk开发">Luban-SDK开发</a><button aria-label="Expand sidebar category &#x27;Luban-SDK开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/luban-linux系统开发">Luban-Linux系统开发</a><button aria-label="Expand sidebar category &#x27;Luban-Linux系统开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux-bringup参考">Linux-Bringup参考</a><button aria-label="Expand sidebar category &#x27;Linux-Bringup参考&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/linux-uboot开发">Linux-Uboot开发</a><button aria-label="Collapse sidebar category &#x27;Linux-Uboot开发&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-1_BasicIntroduction">ArtInChip U-Boot介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-2_StartupParameter">启动参数</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-3_MemoryDependent">内存相关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-4_EnvironmentVariables">环境变量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-5_DTS">DTS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-6_SPLStage">SPL 阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/D213-DevKit/part5/03-7_U-BootStage">U-Boot 阶段</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-8_DriverSupport">驱动支持</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-9_PartitionConfiguration">分区配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-10_BootKernel">启动内核</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-11_PackImage">打包镜像</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-12_ImageBurn">镜像烧录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-13_UserIDBurn">模块介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-14_ImageDisplay">图像显示</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-15_DebugConfiguration">调试配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-16_OpenSBI">OpenSBI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/D213-DevKit/part5/03-17_PBP">Pre-Boot Program</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/linux-uboot开发"><span itemprop="name">Linux-Uboot开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">U-Boot 阶段</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>U-Boot 阶段</h1>
<p>U-Boot 在 Artinchip 平台上承担两个功能角色：</p>
<ul>
<li>引导内核</li>
<li>镜像烧录</li>
</ul>
<p>本章重点描述 U-Boot 这一级引导程序的主要启动流程以及在不同启动介质下的处理。 镜像烧录功能将在 <a href="/en/docs/D213-DevKit/fw_upg/index.html#ref-fw-upgrade">镜像烧录</a> 章节进行描述。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-前初始化">1. 前初始化<a href="#1-前初始化" class="hash-link" aria-label="Direct link to 1. 前初始化" title="Direct link to 1. 前初始化">​</a></h2>
<p>U-Boot 的前初始化是指执行代码重定位之前的初始化，此时 U-Boot 在 DRAM 的前端空间执行。</p>
<p>前初始化分为两个阶段：</p>
<blockquote>
<ol>
<li>芯片架构相关的初始化代码</li>
<li>板子相关的前初始化代码</li>
</ol>
</blockquote>
<p><strong>阶段一：</strong> 芯片架构相关初始化</p>
<p>这个阶段主要是对 CPU 进行了基本的初始化，并且将上一级引导程序传递过来的参数保存起来。 ArtInChip 平台上实现了对应的 <code>save_boot_params</code> 处理函数，并且将调用现场的关键寄存器信息保存到 <code>boot_params_stash</code> 全局变量中。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">_start // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; save_boot_params // arch/riscv/mach-artinchip/lowlevel_init.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // BROM 或者 SPL 跳转到 U-Boot 执行的时候，传递了一些参数，这里首先将这</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 些参数保存起来。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; la  t0, trap_entry // 设置异常处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; li  t1, CONFIG_SYS_INIT_SP_ADDR // 设置初始栈</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; jal     board_init_f_alloc_reserve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; jal harts_early_init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>后续的程序在需要了解当前的启动介质时，可以从中读取相关的信息。</p>
<p><strong>阶段二：</strong> 板子相关的前初始化</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">_start // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; save_boot_params // arch/riscv/mach-artinchip/lowlevel_init.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; la  t5, board_init_f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>board_init_f()</code> 函数内逐个调用初始化函数列表 <code>init_sequence_f</code> 中的函数：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static const init_fnc_t init_sequence_f[] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setup_mon_len,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_OF_CONTROL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fdtdec_setup,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initf_malloc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initf_bootstage,        /* uses its own timer, so does not need DM */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setup_spl_handoff,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initf_console_record,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    arch_cpu_init,          /* basic arch cpu dependent setup */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mach_cpu_init,          /* SoC/machine dependent CPU setup */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initf_dm,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    arch_cpu_init_dm,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_BOARD_EARLY_INIT_F)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    board_early_init_f,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env_init,               /* initialize environment */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init_baud_rate,         /* initialze baudrate settings */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serial_init,            /* serial communications setup */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console_init_f,         /* stage 1 init of console */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_options,        /* say that we are here */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_text_info,      /* show debugging info if required */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_INIT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_MISC_INIT_F)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    misc_init_f,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_SYS_I2C)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    init_func_i2c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    announce_dram_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dram_init,              /* configure available RAM banks */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setup_dest_addr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_round_4k,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_ARM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_mmu,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_video,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_trace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_uboot,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_malloc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_board,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setup_machine,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_global_data,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_fdt,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_bootstage,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_bloblist,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_arch,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_stacks,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dram_init_banksize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    show_dram_config,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_new_sp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_OF_BOARD_FIXUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fix_fdt,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reloc_fdt,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reloc_bootstage,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reloc_bloblist,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setup_reloc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>由于 DRAM 在 PBP 阶段已经初始化，这里的 <code>dram_init</code> 只是初始化 DRAM 驱动， 用于获取 DRAM 基本信息。</p>
<p>DTS 相关的流程可参考 <code>fdtdec_setup</code> 和 <code>initf_dm</code> ：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fdtdec_setup(); // lib/fdtdec.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; gd-&gt;fdt_blob = board_fdt_blob_setup(); // lib/fdtdec.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   // 对于 U-Boot, DTB 的位置是 _end 开始的位置，此处加载 dtb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; fdtdec_prepare_fdt();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; fdt_check_header(gd-&gt;fdt_blob);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">initf_dm(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; dm_init_and_scan(true); // drivers/core/root.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-&gt; dm_init(IS_ENABLED(CONFIG_OF_LIVE)); // drivers/core/root.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-&gt; dm_scan_platdata(pre_reloc_only=true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-&gt; dm_extended_scan_fdt(gd-&gt;fdt_blob, pre_reloc_only=true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |-&gt; dm_scan_fdt(blob, pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |   |-&gt; dm_scan_fdt_node(gd-&gt;dm_root, blob, 0, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |       |-&gt; lists_bind_fdt(parent, offset_to_ofnode(offset), NULL,true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |           |   // drivers/core/lists.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |           |   // 此阶段仅处理设置了 &quot;u-boot,dm-pre-reloc&quot; 的并且</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |           |   // 对应驱动也是设置了 DM_FLAG_PRE_RELOC 的设备和驱动的绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |           |-&gt; device_bind_with_driver_data(parent, entry, name,id-&gt;data,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |               |                            node, &amp;dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |               |-&gt; device_bind_common(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev = calloc(1, sizeof(struct udevice));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev-&gt;platdata = platdata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev-&gt;driver_data = driver_data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev-&gt;name = name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev-&gt;node = node;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev-&gt;parent = parent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev-&gt;driver = drv;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // dev-&gt;uclass = uc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |   // 创建 udevice，并将 driver 挂上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |                   |-&gt; uclass_bind_device(dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |-&gt; dm_scan_fdt_ofnode_path(&quot;/clocks&quot;, pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |   |-&gt; dm_scan_fdt_ofnode_path(&quot;/firmware&quot;, pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-&gt; dm_scan_other(pre_reloc_only);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此阶段并没有对 DTS 中列出的所有设备和驱动进行初始化处理，仅对标记了 “u-boot,dm-pre-reloc” 的设备， 以及驱动中标记了 DM_FLAG_PRE_RELOC 的驱动进行处理，以缩短这个阶段的处理时间。</p>
<p>注意</p>
<p>initf_dm 和 initr_dm 都会搜索一遍 DTB，花费的时间比较多，如果这里能够节省搜索的数量， 对于快速启动会有比较大的帮助。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-代码重定位">2. 代码重定位<a href="#2-代码重定位" class="hash-link" aria-label="Direct link to 2. 代码重定位" title="Direct link to 2. 代码重定位">​</a></h2>
<p>通常内核的代码段放在 DRAM 的开始位置，U-Boot 的代码位置放到 DRAM 的末端。 但是由于不同项目所用的 DRAM 大小不一致，为了方便，将 U-Boot 的链接地址也定义在 DRAM 比较前面的固定位置。在加载 U-Boot 初始化完 DRAM 之后，U-Boot 读取当前平台的 DRAM 大小， 然后在加载 Kernel 之前将自身代码段和数据段等信息重定位到 DRAM 的末端继续运行， 将 DRAM 的前端空间让给 Kernel。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">_start // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; save_boot_params // arch/riscv/mach-artinchip/lowlevel_init.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; board_init_f(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; setup_reloc(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; jump_to_copy(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; relocate_code(); // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |       // RISCV 上的实现，relocate 之后，函数不返回，直接跳转到 board_init_r 执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; invalidate_icache_all()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; flush_dcache_all()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; board_init_r();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>重定位的具体位置 <code>gd-&gt;relocaddr</code> 的计算可查看 <code>common/board_f.c</code> ：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static const init_fnc_t init_sequence_f[] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setup_dest_addr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_round_4k,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_mmu,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_video,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_trace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reserve_uboot,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setup_reloc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NULL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终 <code>gd-&gt;reloc_off</code> 的计算，在 <code>setup_reloc</code> 中完成。</p>
<p>注解</p>
<p>如果 CONFIG_SYS_TEXT_BASE == relocation address，则不需要做重定位的工作， 可以节省启动时间。这个需要根据当前项目的 DRAM 大小进行计算 CONFIG_SYS_TEXT_BASE 的值。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-后初始化">3. 后初始化<a href="#3-后初始化" class="hash-link" aria-label="Direct link to 3. 后初始化" title="Direct link to 3. 后初始化">​</a></h2>
<p>后初始化阶段是代码重定位之后执行的初始化流程，由下面的 <code>board_init_r</code> 开始。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">_start // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; save_boot_params // arch/riscv/mach-artinchip/lowlevel_init.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; board_init_f(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; setup_reloc(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; jump_to_copy(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; relocate_code(); // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |       // RISCV 上的实现，relocate 之后，函数不返回，直接跳转到 board_init_r 执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; invalidate_icache_all()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; flush_dcache_all()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; board_init_r();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>board_init_r</code> 函数中逐个执行函数列表 <code>init_sequence_r</code> 中的初始化函数。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static init_fnc_t init_sequence_r[] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_trace,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_reloc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_ARM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_caches,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_reloc_global_data,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_barrier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_malloc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_bootstage,    /* Needs malloc() but has its own timer */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_console_record,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_SYS_NONCACHED_MEMORY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_noncached,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bootstage_relocate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_OF_LIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_of_live,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_DM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_dm,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_ARM) || defined(CONFIG_NDS32) || defined(CONFIG_RISCV) || \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defined(CONFIG_SANDBOX)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    board_init,    /* Setup chipselects */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stdio_init_tables,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_serial,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_announce,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if CONFIG_IS_ENABLED(WDT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_watchdog,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_manual_reloc_cmdtable,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_ADDR_MAP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_addr_map,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_BOARD_EARLY_INIT_R)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    board_early_init_r,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_POST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_post_backlog,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_ARCH_EARLY_INIT_R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    arch_early_init_r,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    power_init_board,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_MTD_NOR_FLASH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_flash,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_CMD_NAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_nand,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_CMD_ONENAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_onenand,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_MMC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_mmc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_env,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_SYS_BOOTPARAMS_LEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_malloc_bootparams,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_secondary_cpu,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_ID_EEPROM) || defined(CONFIG_SYS_I2C_MAC_OFFSET)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mac_read_from_eeprom,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stdio_add_devices,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_jumptable,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_api,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console_init_r,        /* fully init console as a device */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_DISPLAY_BOARDINFO_LATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console_announce_r,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    show_board_info,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_ARCH_MISC_INIT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    arch_misc_init,        /* miscellaneous arch-dependent init */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_MISC_INIT_R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    misc_init_r,        /* miscellaneous platform-dependent init */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interrupt_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_ARM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_enable_interrupts,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_CMD_NET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_ethaddr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_BOARD_LATE_INIT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    board_late_init,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_CMD_NET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_net,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef CONFIG_POST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_post,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_PRAM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initr_mem,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run_main_loop,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中下面几个重要的阶段需要留意。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_dm  // 初始化设备驱动，这次扫描所有的设备，并且绑定到匹配的驱动上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; dm_init_and_scan(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; dm_init(IS_ENABLED(CONFIG_OF_LIVE)); // drivers/core/root.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; dm_scan_platdata(pre_reloc_only=true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; dm_extended_scan_fdt(gd-&gt;fdt_blob, pre_reloc_only=true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; dm_scan_other(pre_reloc_only);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_flash // SPI NOR 的初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; flash_size = flash_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_nand  // RAW NAND 的初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_mmc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; mmc_initialize(gd-&gt;bd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; initr_env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; env_relocate(); // env/common.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; env_load(); // env/env.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; stdio_add_devices();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; board_late_init(); // board/artinchip/d211/d211.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; setup_boot_device();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; env_set(&quot;boot_device&quot;, &quot;mmc&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Cache Enable</strong></p>
<p>RISCV 上，U-Boot 运行在 S-Mode，没有权限开关 Cache，因此只能由 SPL 来开关 Cache。</p>
<p><strong>Device Model</strong></p>
<p>在后初始化阶段，会扫描所有的设备和驱动，并且将设备和对应的驱动进行绑定。</p>
<p><strong>存储介质的初始化</strong></p>
<p>NOR/NAND/MMC 等存储介质的驱动在这个阶段开始初始化。</p>
<p><strong>环境变量加载</strong></p>
<p>环境变量中保存着 U-Boot 的配置，以及相关的启动信息，此时需要从对应的存储介质中加载使用。</p>
<p><strong>显示驱动</strong></p>
<p>如果项目使能了 U-Boot 阶段的显示，此时在 <code>stdio_add_devices()</code> 中对显示和按键驱动进行初始化。</p>
<p><strong>其他配置</strong></p>
<p>在 <code>board_late_init()</code> 中，将从 SPL 传递过来的启动设备信息，更新到环境变量中，使得后续的启动脚本 可以获知当前的启动设备信息。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-环境变量加载如前面所述环境变量的处理有两个阶段">4. 环境变量加载如前面所述，环境变量的处理有两个阶段：<a href="#4-环境变量加载如前面所述环境变量的处理有两个阶段" class="hash-link" aria-label="Direct link to 4. 环境变量加载如前面所述，环境变量的处理有两个阶段：" title="Direct link to 4. 环境变量加载如前面所 述，环境变量的处理有两个阶段：">​</a></h2>
<blockquote>
<ol>
<li>环境变量初始</li>
<li>环境变量读取</li>
</ol>
</blockquote>
<p>如下面的调用流程， <code>env_init()</code> 在 <code>board_init_f()</code> 阶段执行，但具体的加载过程 在 <code>board_init_r()</code> 阶段执行。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reset // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; save_boot_params // arch/riscv/mach-artinchip/lowlevel_init.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; board_init_f(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; setup_reloc(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; jump_to_copy(); // common/board_f.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; relocate_code(); // arch/riscv/cpu/start.S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; invalidate_icache_all()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; flush_dcache_all()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; board_init_r();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |   // 逐个调用 init_sequence_r 里面的函数，其中包括 initr_env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                |-&gt; initr_env(); // common/board_r.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; should_load_env(void);// common/board_r.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |   // 由于没有在 DTS 中进行配置，总是返回 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |   // fdtdec_get_config_int(gd-&gt;fdt_blob, &quot;load-environment&quot;, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |-&gt; env_relocate(); // env/common.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        |-&gt; env_load(); // env/env.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>U-Boot 支持在多种存储介质中保存环境变量，并且提供了一个插拔式的机制，用于实现从 不同的存储介质中加载环境变量内容。</p>
<p>在添加新的环境变量加载器时，只需要实现对应存储介质的 <code>load</code> 和 <code>save</code> 函数， 然后通过宏 <code>U_BOOT_ENV_LOCATION</code> 将对应的信息添加到 <code>.u_boot_list_2</code> 链接段中。 比如下面的定义，将生成 <code>.u_boot_list_2_env_driver_2_spinand</code> 信息。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">U_BOOT_ENV_LOCATION(spinand) = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .location   = ENVL_SPINAND,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENV_NAME(&quot;SPINAND&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .load       = env_spinand_load,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CMD_SAVEENV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .save       = env_save_ptr(env_spinand_save),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>env_driver_lookup()</code> 函数首先通过检查当前的启动设备，然后从 <code>.u_boot_list_2</code> 段中查找对应启动设备的 ENV 加载驱动，最后调用对应的驱动读取并导入环境变量内容。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">env_load(); // env/env.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; env_driver_lookup(ENVOP_LOAD, prio);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; loc = env_get_location(); // board/artinchip/d211/env_location.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |   |-&gt; bd = aic_get_boot_device(); // 获取当前的启动设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   |-&gt; _env_driver_lookup(loc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       |-&gt; drv = ll_entry_start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|       // 查找指定存储介质的 env 加载驱动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; drv-&gt;load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 此处调用个存储介质的对应函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env_ram_load(); // board/artinchip/d211/env_location.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env_spinand_load(); // env/spinand.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env_sf_load(); // env/sf.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env_mmc_load(); // env/mmc.c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>具体各种存储介质中，环境变量保存的位置可参考 <a href="/en/docs/D213-DevKit/env_setting/index.html#env-store-setting">存储介质上的保存</a> 。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-命令行阶段">5. 命令行阶段<a href="#5-命令行阶段" class="hash-link" aria-label="Direct link to 5. 命令行阶段" title="Direct link to 5. 命令行阶段">​</a></h2>
<p><code>board_init_r</code> 函数最后进入 <code>run_main_loop</code> 执行 Autoboot 命令或者进入控制台。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">board_init_r(); // common/board_r.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-&gt; run_main_loop(); // common/board_r.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-&gt; main_loop(); // common/main.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; cli_init();    // 初始化 command line</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |--&gt;u_boot_hush_start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; bootdelay_process(); // common/autoboot.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   | // 获取boot delay时间参数，从env中获取bootcmd参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   |-&gt; s = env_get(&quot;bootcmd&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |           // 获取 bootcmd 的内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; cli_process_fdt(); // common/cli.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   // 尝试从 DTS 中获取 bootcmd 参数，DTS 的配置优先级高于 ENV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-&gt; autoboot_command(); // common/autoboot.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; abortboot();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |   // 检查是否需要终止启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-&gt; run_command_list(); // common/cli.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 执行 bootcmd 的内容，一般是执行脚本</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>倒计时读秒</strong></p>
<p>进入命令行的主循环之后，U-Boot 首先获取 boot delay 的时间设置。Boot delay 的时间 是指 U-Boot 在执行启动命令之前的倒计时读秒的时间，该时间在 ArtInChip 平台上在环境变量 env.txt 中进行配置:</p>
<blockquote>
<ul>
<li><code>bootdelay=3</code></li>
</ul>
</blockquote>
<p>如果不需要倒计时读秒，可以将该设置改为 0 。</p>
<p><strong>启动命令</strong></p>
<p>U-Boot 检查并且默认执行 <code>bootcmd</code> 所指定的启动命令。该启动命令可以在两个地方设置：</p>
<blockquote>
<ul>
<li>环境变量中设置</li>
<li>DTS 中设置</li>
</ul>
</blockquote>
<p>ArtInChip 平台上通过环境变量 env.txt 设置，同行是一段启动脚本。</p>
<p><strong>按键中断</strong></p>
<p>进入 <code>autoboot_command</code> 在执行启动命令之前，U-Boot 还会检查用户是否有通过串口 按键中断启动流程。该检查无论 bootdelay 时间是否为 0 都会进行。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/ArtInChip-Docs/tree/master/docs/D213-DevKit/part5/03-7_U-BootStage.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/D213-DevKit/part5/03-6_SPLStage"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">SPL 阶段</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/D213-DevKit/part5/03-8_DriverSupport"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">驱动支持</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-前初始化" class="table-of-contents__link toc-highlight">1. 前初始化</a></li><li><a href="#2-代码重定位" class="table-of-contents__link toc-highlight">2. 代码重定位</a></li><li><a href="#3-后初始化" class="table-of-contents__link toc-highlight">3. 后初始化</a></li><li><a href="#4-环境变量加载如前面所述环境变量的处理有两个阶段" class="table-of-contents__link toc-highlight">4. 环境变量加载如前面所述，环境变量的处理有两个阶段：</a></li><li><a href="#5-命令行阶段" class="table-of-contents__link toc-highlight">5. 命令行阶段</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>